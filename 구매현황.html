<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>발주·입고 현황</title>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
      --r-lg:16px; --shadow-1:0 4px 16px rgba(15,23,42,.08);
      --ok:#16a34a; --danger:#ef4444; --done:#e8f7ee; --light-red:#f43f5e;
    }
    *{box-sizing:border-box}
    html,body{-webkit-text-size-adjust:100%; overflow-x:hidden;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;}
    .wrap{max-width:980px;margin:10px auto;padding:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-1);padding-bottom:72px}
    .card-head{padding:12px;display:grid;gap:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1 1 auto}
    .btn, a.btn{
      border:1px solid var(--border);background:#fff;border-radius:12px;
      padding:0 12px;height:34px;font-weight:800;cursor:pointer;font-size:13px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      white-space:nowrap; min-width:64px; text-decoration: none; color: var(--text);
    }
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.green{background:var(--ok);color:#fff;border-color:var(--ok)}
    .btn.red{background:var(--danger);color:#fff;border-color:var(--danger)}
    .btn.ghost, a.btn.ghost{background:#f8fafc;border-color:var(--border);color:#334155}
    .btn:active, a.btn:active{transform:translateY(1px)}
    input[type="date"], input[type="number"]{
      border:1px solid var(--border);border-radius:12px;padding:0 8px;height:34px;font-size:13px;background:#fff;outline:none;min-width:0;text-align:center;
    }
    input[type="number"]{ width:68px; }
    input:focus{box-shadow:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);border-color:transparent}
    .subtabs{ display:flex; gap:6px; align-items:center; }
    .subtab{ padding:8px 10px; font-weight:900; color:#5b677a; background:transparent; border:none; border-bottom:3px solid transparent; cursor:pointer;}
    .subtab.active{ color:var(--accent); border-bottom-color:var(--accent); }
    .datebar{ display:flex; gap:8px; align-items:center; padding:0 6px; }
    .itemline{ display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); padding:6px; }
    .itemtabs{ display:flex; gap:6px; flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .itemtabs::-webkit-scrollbar{height:6px}
    .itemtab{ padding:8px 12px; font-weight:900; color:#5b677a; background:transparent; border:none; border-bottom:3px solid transparent; cursor:pointer; white-space:nowrap;}
    .itemtab.active{ color:var(--accent); border-bottom-color:var(--accent); }
    .patient-tabs{ display:flex; gap:6px; padding:6px 6px 0 6px;}
    .ptab{ padding:6px 10px; font-weight:900; color:#5b677a; background:#f8fafc; border:1px solid var(--border); border-bottom:2px solid transparent; border-radius:10px; cursor:pointer; white-space:nowrap;}
    .ptab.active{ color:#fff; background:var(--accent); border-color:var(--accent); }
    .table-wrap{border-radius:12px;border:1px solid var(--border);margin:8px 6px;overflow:hidden}
    table{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);font-size:12px;height:30px}
    td,th{border-bottom:1px solid var(--border);padding:6px 8px;text-align:center;font-size:12px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .tbl-receipts td, .tbl-receipts th { vertical-align: middle; }
    .tbl-receipts td:nth-child(2), .tbl-receipts th:nth-child(2){ width:80px; }
    .tbl-receipts td:nth-child(3), .tbl-receipts th:nth-child(3){ width:70px; }
    .tbl-receipts td:nth-child(4), .tbl-receipts th:nth-child(4){ width:65px; }
    .tbl-receipts input[type="number"] { width: 52px; }
    .o-cell, .pcell{ font-variant-numeric: tabular-nums; }
    .pcell{ text-align:center; overflow:visible; min-width:3.5ch; }
    .done td{ background:var(--done); }
    .over td:last-child{ color:var(--light-red); font-weight:800; }
    .pcell.pc100{ color:var(--accent); font-weight:900; }
    .name-cell{ position:relative; }
    .badge-dot{ position:absolute; right:4px; top:4px; width:14px; height:14px; border-radius:999px; background:#ef4444; color:#fff; font-weight:900; font-size:10px; display:flex; align-items:center; justify-content:center; line-height:12px; }
    .is-hidden{ display:none !important; }
    .tbl-summary th, .tbl-summary td { padding-left: 4px; padding-right: 4px; }
    .tbl-summary th:first-child, .tbl-summary td:first-child { width: auto; text-align: left; padding-left: 10px; }
    .tbl-summary th:not(:first-child), .tbl-summary td:not(:first-child) { width: 60px; }
    .tbl-summary .editable-row:hover { background-color: #f1f5f9; cursor: pointer; }
    .progress{height:16px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:6px}
    .progress > div{height:100%;background:var(--accent);text-align:center;font-size:11px;color:#fff;line-height:16px}
    .savebar{
      position:fixed; left:0; right:0; bottom:0; z-index:300;
      background:#fff; border-top:1px solid var(--border); box-shadow:0 -6px 16px rgba(15,23,42,.08);
      padding:10px; display:flex; gap:10px; align-items:center;
    }
    .savebar .btn, .savebar a.btn{height:42px; border-radius:12px; font-size:15px; padding:0 16px;}
    .sec-title{font-weight:900; font-size:13px; color:#334155; padding:8px 10px; margin:6px 6px 0;}
    .divider-strong{border-top:2px solid #cbd5e1; margin:4px 6px;}
    .txt-normal{ color:#16a34a; font-weight:800;}
    .txt-ortho{  color:#2563eb; font-weight:800;}
    .neg{ color:#f43f5e; font-weight:900;}
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: none; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; backdrop-filter: blur(2px);
    }
    .spinner {
      width: 48px; height: 48px; border: 5px solid #e5e7eb; border-top: 5px solid var(--accent);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    .loader-overlay p { margin-top: 15px; font-weight: 800; color: var(--text); }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.6);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; backdrop-filter: blur(2px);
    }
    .modal-content {
      background: var(--card); padding: 20px; border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2);
      width: 90%; max-width: 480px;
      animation: modal-appear 0.3s ease-out;
    }
    @keyframes modal-appear { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px;
    }
    .modal-header h3 { margin: 0; font-size: 18px; }
    .modal-header .close-btn {
      background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);
      line-height: 1; padding: 4px;
    }
    .modal-body ul {
      list-style: none; padding: 0; margin: 15px 0; max-height: 300px; overflow-y: auto;
      border: 1px solid var(--border); border-radius: 10px; padding: 10px;
    }
    #confirmationModal .modal-body li {
      padding: 8px 4px; border-bottom: 1px solid #f1f5f9;
      display: flex; justify-content: space-between; align-items: center;
    }
    #confirmationModal .modal-body li:last-child { border-bottom: none; }
    #confirmationModal .modal-body li .item-name { font-weight: 600; color: var(--text); }
    #confirmationModal .modal-body li .item-qty { font-weight: 800; color: var(--accent); font-size: 14px; }
    #editModal .modal-body li {
      display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; padding: 10px 4px;
      border-bottom: 1px solid #f1f5f9;
    }
    #editModal .modal-body li:last-child { border-bottom: none; }
    #editModal .modal-body li.is-deleted { opacity: 0.5; }
    #editModal .modal-body li.is-deleted .item-details { text-decoration: line-through; }
    #editModal .modal-body li .item-details {
      display: flex; flex-direction: column; text-align: left;
      line-height: 1.3; white-space: nowrap;
    }
    #editModal .modal-body li .item-details .item-name { font-weight: 600; font-size: 14px; }
    #editModal .modal-body li .item-details .sub-info { font-size: 11px; color: var(--muted); margin-top: 2px; }
    #editModal .modal-body li .qty-input { width: 60px; height: 30px; border-radius: 8px; font-size: 13px;}
    #editModal .modal-body li .btn { min-width: auto; height: 30px; padding: 0 8px; font-size: 12px; }
    #editModal .modal-body .spinner { width: 32px; height: 32px; border-width: 4px; margin: 20px auto; }
    .modal-footer {
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px; padding-top: 15px; border-top: 1px solid var(--border);
    }
    .modal-tabs {
      display: flex; gap: 6px; padding: 0 10px;
      border-bottom: 2px solid var(--border); margin-bottom: 10px;
    }
    .modal-tab {
      padding: 8px 12px; font-weight: 900; color: var(--muted); background: transparent;
      border: none; border-bottom: 3px solid transparent; cursor: pointer;
    }
    .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    #editModal .modal-body ul {
      list-style: none; padding: 0; margin: 0;
      max-height: 350px; overflow-y: auto;
    }
    .month-title-editable { display: flex; align-items: center; gap: 6px; }
    .month-checkbox { margin-left: auto; cursor: pointer; width: 18px; height: 18px; }
  </style>
  </head>

<body>
  <div id="loader" class="loader-overlay"><div class="spinner"></div><p id="loaderMsg">서버와 연결중…</p></div>
  <div class="wrap">
    <div class="card">
      <div class="card-head">
        <div class="row">
          <div class="subtabs" role="tablist">
            <button id="tab-orders" class="subtab active" data-mode="orders">발주현황</button>
            <button id="tab-receipts" class="subtab" data-mode="receipts">입고현황</button>
          </div>
        </div>
        <div class="datebar">
          <input id="entryDate" type="date" aria-label="기록 날짜" />
        </div>
        <div style="padding:6px 6px 0">
          <div id="gaugeStats" style="font-size:12px;color:#475569;margin:4px 0 2px">발주수량 0개 · 입고수량 0개 — 0% 입고됨</div>
          <div class="progress" aria-label="진행률"><div id="progressBarInner" style="width:0%">0%</div></div>
        </div>
        <div id="ordersTopLine" class="itemline">
          <div id="tabsWrap" class="itemtabs" role="tablist">
            <button class="itemtab active" data-tab="sheet">시트류</button>
            <button class="itemtab" data-tab="patient">환자복</button>
            <button class="itemtab" data-tab="summary">발주내역</button>
          </div>
          <div class="spacer"></div>
        </div>
        <div id="patientTabs" class="patient-tabs" style="display:none">
          <button class="ptab active" data-kind="normal">일반환의</button>
          <button class="ptab" data-kind="ortho">정형환의</button>
          <button class="ptab" data-kind="hip">고관절</button>
        </div>
      </div>
      <div id="formBox"></div>
      </div>
  </div>

  <div class="savebar">
    <a href="뉴업로더.html" target="_blank" class="btn ghost"><i data-feather="upload"></i> 엑셀 업로드</a>
    <button id="btnExcelBottom" class="btn green"><i data-feather="download"></i> 엑셀로 내려받기</button>
    <div class="spacer"></div>
    <button id="btnSaveBottom" class="btn primary"><i data-feather="save"></i> <span id="saveLabel">발주 저장</span></button>
  </div>
  <div id="toast" role="status" aria-live="polite" style="display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:#111827;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;z-index:1100;"></div>
  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">저장 내역 확인</h3>
        <button id="modalCloseBtn" class="close-btn" aria-label="닫기">&times;</button>
      </div>
      <div class="modal-body">
        <p>아래 내역으로 저장하시겠습니까?</p>
        <ul id="modalSummaryList"></ul>
      </div>
      <div class="modal-footer">
        <button id="modalCancelBtn" class="btn ghost">취소</button>
        <button id="modalConfirmBtn" class="btn primary">확인</button>
      </div>
    </div>
  </div>
  <div id="editModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="editModalTitle">상세내역 수정</h3>
        <button class="close-btn" aria-label="닫기">&times;</button>
      </div>
      <div id="editModalBody" class="modal-body">
        <div class="spinner"></div>
      </div>
      <div class="modal-footer">
        <button class="close-btn btn ghost">취소</button>
        <button id="saveEditsBtn" class="btn primary"><i data-feather="save"></i> 변경사항 저장</button>
      </div>
    </div>
  </div>
  <script type="module">
    /* ▷▷▷ Firebase 초기화 시작 ▷▷▷ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
      authDomain: "hallymlinen.firebaseapp.com",
      databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
      projectId: "hallymlinen",
      storageBucket: "hallymlinen.appspot.com",
      messagingSenderId: "867775830688",
      appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
      measurementId: "G-T02ZFK18L3"
    };

    const app  = initializeApp(firebaseConfig);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    signInAnonymously(auth).catch((error) => {
      console.error("Anonymous sign-in failed:", error);
      showToast("인증 오류: 새로고침해주세요.");
    });
    /* ▷▷▷ Firebase 초기화 종료 ▷▷▷ */

    /* ▷▷▷ 공용 유틸 시작 ▷▷▷ */
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const pad2 = n => String(n).padStart(2,'0');
    const ymOf = (d)=> (d||'').slice(0,7);
    const toInt = v => Math.round(Number(v)||0);
    const isYM = k => /^\d{4}-\d{2}$/.test(k);
    const successAudio = new Audio('제출성공.mp3');

    function showToast(msg='완료'){
      const t = $('#toast');
      t.textContent = msg; t.style.display='block';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.display='none', 1600);
    }

    function showLoader(msg='서버와 연결중…'){
      const loader = $('#loader');
      const msgEl = $('#loaderMsg');
      if(msgEl) msgEl.textContent = msg;
      loader.style.display = 'flex';
    }
    function hideLoader(){
      $('#loader').style.display = 'none';
    }

    async function fetchWithRetry(url, options = {}, { retries = 3, baseDelay = 500 } = {}){
      let lastErr;
      for(let attempt=0; attempt<=retries; attempt++){
        try{
          const res = await fetch(url, options);
          if(!res.ok){
            if(res.status === 403) return res;
            throw new Error(`HTTP ${res.status}`);
          }
          return res;
        }catch(err){
          lastErr = err;
          if(attempt < retries){
            const delay = baseDelay * Math.pow(2, attempt) + Math.random()*150;
            await new Promise(r => setTimeout(r, delay));
          }
        }
      }
      throw lastErr;
    }
    /* ▷▷▷ 공용 유틸 종료 ▷▷▷ */

    /* ▷▷▷ 서버 API 호출 시작 ▷▷▷ */
    const API = {
      getPurchaseData: 'https://getpurchasedata-t7cbh6uw5a-uc.a.run.app',
      updatePurchaseData: 'https://updatepurchasedata-t7cbh6uw5a-uc.a.run.app'
    };

    async function getStatusOnce(){
      const token = localStorage.getItem('adminToken');
      if (!token) {
        showToast("인증 토큰 없음. 다시 로그인해주세요.");
        window.location.href = './index.html';
        return {};
      }
      const res = await fetchWithRetry(API.getPurchaseData, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok){
        if (res.status === 403){
          localStorage.removeItem('adminToken');
          window.location.href = './index.html';
        }
        throw new Error(`Server error: ${res.status}`);
      }
      return await res.json();
    }

    async function updatePurchaseStatus(updates) {
      const token = localStorage.getItem('adminToken');
      if (!token) { showToast("인증 만료. 다시 로그인해주세요."); return; }
      if (Object.keys(updates).length === 0) return;
      await fetchWithRetry(API.updatePurchaseData, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ updates })
      });
    }
    /* ▷▷▷ 서버 API 호출 종료 ▷▷▷ */

    /* ▷▷▷ 도메인 상수/상태 시작 ▷▷▷ */
    const state = {
      mode:'orders', tab:'sheet',
      entryDate:'', snapshot:null,
      draftOrders:{ sheet:new Map(), patient:new Map(), hip:new Map() },
      patientKind:'normal',
      selectedMonths: new Set() 
    };

    const BASE_SHEETS = ["대시트","반시트","베갯잇","수건","중환의","얼음포","억제대"];
    const HIP_NEW     = ["고관절XL","고관절L","고관절M"];
    const NORMAL_SIZES = ["4XL","3XL","2XL","XL","L","M","S"];
    const ORTHO_SIZES  = ["3XL","2XL","XL","L","M","S"];
    const labelOf = (kind, tb, size) => `${kind}${tb==='상의'?'상의':'하의'}${size}`;
    /* ▷▷▷ 도메인 상수/상태 종료 ▷▷▷ */

    /* ▷▷▷ 초기 이벤트 바인딩 & 첫 로딩 시작 ▷▷▷ */
    document.addEventListener('DOMContentLoaded', async ()=>{
      try {
        showLoader('서버와 연결중…');
        const t = new Date();
        const ymd = `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`;
        $('#entryDate').value = ymd; state.entryDate=ymd;

        $$('.subtab').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            $$('.subtab').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            state.mode = btn.dataset.mode;
            const showOrdersUI = (state.mode === 'orders');
            $('#ordersTopLine').style.display = showOrdersUI ? 'flex' : 'none';
            $('#patientTabs').style.display   = (showOrdersUI && state.tab==='patient') ? 'flex' : 'none';
            $('#saveLabel').textContent = (state.mode==='orders') ? '발주 저장' : '입고 완료';
            renderBody(); 
          });
        });

        $$('.itemtab').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            $$('.itemtab').forEach(b=> b.classList.toggle('active', b===btn));
            state.tab = btn.dataset.tab;
            $('#patientTabs').style.display = (state.mode==='orders' && state.tab==='patient') ? 'flex' : 'none';
            renderBody();
          });
        });

        $$('.ptab').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            $$('.ptab').forEach(b=> b.classList.toggle('active', b===btn));
            state.patientKind = btn.dataset.kind;
            if(state.tab==='patient' && state.mode==='orders') renderBody();
          });
        });

        $('#entryDate').addEventListener('change', ()=>{ state.entryDate = $('#entryDate').value; });
        $('#btnSaveBottom').addEventListener('click', onSaveAll);
        $('#btnExcelBottom').addEventListener('click', onExportExcel_AllData);
        $('#modalConfirmBtn').addEventListener('click', proceedWithSave);
        $('#confirmationModal').querySelectorAll('.close-btn, #modalCancelBtn').forEach(btn => btn.addEventListener('click', () => { $('#confirmationModal').style.display = 'none'; }));
        $('#editModal').querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => { $('#editModal').style.display = 'none'; }));
        $('#saveEditsBtn').addEventListener('click', saveEdits);

        $('#formBox').addEventListener('click', (e) => {
          if (state.tab !== 'summary') return;
          if (e.target.classList.contains('month-checkbox')) return;
          const monthTitle = e.target.closest('.month-title-editable');
          if (monthTitle) {
            openEditModalForMonth(monthTitle.dataset.month);
          }
        });

        $('#formBox').addEventListener('change', e => {
          if (e.target.classList.contains('month-checkbox')) {
            const month = e.target.dataset.month;
            if (e.target.checked) {
              state.selectedMonths.add(month);
            } else {
              state.selectedMonths.delete(month);
            }
            localStorage.setItem('selectedMonths', JSON.stringify(Array.from(state.selectedMonths)));
            if (state.tab === 'summary') {
              renderOrderSummary($('#formBox'));
              feather.replace({ width: '1em', height: '1em' });
            } else if (state.mode === 'receipts') {
              renderReceiptsUI($('#formBox'));
            }
            refreshProgress();
          }
        });

        state.snapshot = await getStatusOnce();
        const savedMonthsJSON = localStorage.getItem('selectedMonths');
        if (savedMonthsJSON) {
            state.selectedMonths = new Set(JSON.parse(savedMonthsJSON));
        } else {
            const allMonths = collectAllMonths(state.snapshot);
            state.selectedMonths = new Set(allMonths);
        }

        renderBody();
        refreshProgress();
        feather.replace({ width:'1em', height:'1em' });
      } catch (error) {
        console.error("초기화 실패:", error);
        showToast("초기 로딩 오류: 잠시 후 다시 시도해주세요.");
      } finally {
        hideLoader();
      }
    });
    /* ▷▷▷ 초기 이벤트 바인딩 & 첫 로딩 종료 ▷▷▷ */

    /* ▷▷▷ 아이템/데이터 헬퍼 시작 ▷▷▷ */
    function buildItems(snapshot){
      const hasHipNew = HIP_NEW.some(k=> snapshot[k]);
      const hasHipOld = !!snapshot['고관절'];
      const sheetList = [...BASE_SHEETS, ...(hasHipNew ? HIP_NEW : (hasHipOld ? ['고관절'] : HIP_NEW))];
      const items = [];
      sheetList.forEach(n=> items.push({label:n, key:n, tb:'', group:'sheet'}));
      NORMAL_SIZES.forEach(sz=>{
        ['상의','하의'].forEach(tb=> items.push({label:labelOf('일반',tb,sz), key:`일반환의${sz}`, tb, group:'normal'}));
      });
      ORTHO_SIZES.forEach(sz=>{
        ['상의','하의'].forEach(tb=> items.push({label:labelOf('정형',tb,sz), key:`정형환의${sz}`, tb, group:'ortho'}));
      });
      return items;
    }

    function collectAllMonths(data){
      const set = new Set();
      Object.values(data||{}).forEach(it=>{
        Object.keys(it.orders||{}).forEach(m=>{ if(isYM(m)) set.add(m); });
        Object.keys(it.receipts||{}).forEach(m=>{ if(isYM(m)) set.add(m); });
      });
      return Array.from(set).sort();
    }
    const sortDescYM = list => [...list].sort((a,b)=> a<b ? 1 : (a>b ? -1 : 0));
    /* ▷▷▷ 아이템/데이터 헬퍼 종료 ▷▷▷ */

    /* ▷▷▷ 렌더링 함수 시작 ▷▷▷ */
    async function renderBody(){
      if(!state.snapshot) state.snapshot = await getStatusOnce();
      const container = $('#formBox'); 
      container.innerHTML='';
      if(state.mode === 'orders'){
        renderOrdersUI(container);
      } else {
        await renderReceiptsUI(container);
      }
      feather.replace({ width:'1em', height:'1em' });
    }

    function renderOrdersUI(container){
      const tabRenderers = {
        sheet: renderSheetOrders,
        patient: renderPatientOrders,
        summary: renderOrderSummary
      };
      (tabRenderers[state.tab] || renderSheetOrders)(container);
    }

    function renderSheetOrders(container) {
        container.innerHTML = `
          <div class="table-wrap"><table><thead><tr><th>품목</th><th>수량</th></tr></thead><tbody>
          ${BASE_SHEETS.map(n=>`<tr><td>${n}</td><td><input type="number" min="0" inputmode="numeric" class="q-input" data-group="sheet" data-item="${n}" value="${state.draftOrders.sheet.get(n)||''}"/></td></tr>`).join('')}
          </tbody></table></div>`;
        addInputListeners('sheet');
    }

    function renderPatientOrders(container) {
        if(state.patientKind==='hip'){
          container.innerHTML = `<div class="table-wrap"><table><thead><tr><th>품목</th><th>수량</th></tr></thead><tbody>
          ${HIP_NEW.map(n=>`<tr><td>${n}</td><td><input type="number" min="0" inputmode="numeric" class="q-input" data-group="hip" data-item="${n}" value="${state.draftOrders.hip.get(n)||''}"/></td></tr>`).join('')}
          </tbody></table></div>`;
          addInputListeners('hip');
        }else{
          const sizes = state.patientKind==='normal' ? NORMAL_SIZES : ORTHO_SIZES;
          const kindLabel = state.patientKind==='normal' ? '일반' : '정형';
          const colorCls  = state.patientKind==='normal' ? 'txt-normal' : 'txt-ortho';
          const rows = [];
          sizes.forEach(sz=>{
            ['상의','하의'].forEach(tb=>{
              const itemKey = `${state.patientKind === 'normal' ? '일반환의' : '정형환의'}${sz}__${tb}`;
              rows.push({label: `${kindLabel}${tb}${sz}`, key:itemKey});
            });
          });
          container.innerHTML = `<div class="table-wrap"><table><thead><tr><th>품목</th><th>수량</th></tr></thead><tbody>
          ${rows.map(r=>`<tr><td class="${colorCls}">${r.label}</td><td><input type="number" min="0" inputmode="numeric" class="q-input" data-group="patient" data-item="${r.key}" value="${state.draftOrders.patient.get(r.key)||''}"/></td></tr>`).join('')}
          </tbody></table></div>`;
          addInputListeners('patient');
        }
    }

    function addInputListeners(group) {
        $$('.q-input').forEach(i => i.addEventListener('input', e => {
            const { group, item } = e.target.dataset;
            const value = toInt(e.target.value);
            const draftMap = state.draftOrders[group];
            if (value > 0) draftMap.set(item, value);
            else draftMap.delete(item);
        }));
    }

//■■■■■■■■◇◇◇바인딩 시작
    function renderOrderSummary(container){
  const data = state.snapshot||{};
  const allMonths = collectAllMonths(data);
  const monthsDesc = sortDescYM(allMonths);
  const ITEMS = buildItems(data);

  const getCarryOverData = (item, months) => {
      let carryOverQty = 0;
      months.forEach(m => {
          const orders = (((data[item.key] || {}).orders || {})[m]) || {};
          Object.values(orders).forEach(order => {
              if (order.note && order.note.includes('이월분') && (item.tb ? order.topBottom === item.tb : true)) {
                  carryOverQty += toInt(order.qty);
              }
          });
      });
      return carryOverQty;
  };

  const sumMonth=(name,month,tb='',kind='orders', excludeCarryOver = false)=>{
    const node=(((data[name]||{})[kind]||{})[month])||{};
    return Object.values(node)
        .filter(e => {
            const tbMatch = tb ? (e.topBottom||'')===tb : true;
            const carryOverMatch = excludeCarryOver ? !(e.note && e.note.includes('이월분')) : true;
            return tbMatch && carryOverMatch;
        })
        .reduce((s,e)=> s+toInt(e.qty),0);
  };

  const parts=[];
  const selectedMonths = Array.from(state.selectedMonths);
  const hasAnyCarryOver = ITEMS.some(item => getCarryOverData(item, selectedMonths) > 0);

  const summaryRows = ITEMS.map(r => {
    const carryOver = getCarryOverData(r, selectedMonths);
    const newOrders = selectedMonths.reduce((acc, m) => acc + sumMonth(r.key, m, r.tb, 'orders', true), 0);
    const totalOrders = carryOver + newOrders;
    const totalReceipts = allMonths.reduce((acc, m) => acc + sumMonth(r.key, m, r.tb, 'receipts'), 0);
    const unfulfilled = totalOrders - totalReceipts;

    if (!totalOrders && !totalReceipts) return '';

    const color = r.group === 'normal' ? 'txt-normal' : (r.group === 'ortho' ? 'txt-ortho' : '');
    const negCls = unfulfilled < 0 ? 'neg' : '';
    let rowHtml = `<tr class="summary-row"><td class="${color}">${r.label}</td>`;
    if (hasAnyCarryOver) rowHtml += `<td style="color:#78716C;">${carryOver}</td>`;
    rowHtml += `<td>${newOrders}</td>`;
    if (hasAnyCarryOver) rowHtml += `<td>${totalOrders}</td>`;
    rowHtml += `<td>${totalReceipts}</td><td class="${negCls}">${unfulfilled}</td></tr>`;
    return rowHtml;
  }).join('');

  const summaryHeaders = ['품목'];
  if (hasAnyCarryOver) summaryHeaders.push('이월');
  summaryHeaders.push('발주');
  if (hasAnyCarryOver) summaryHeaders.push('총 발주');
  summaryHeaders.push('입고', '미입고');

  parts.push(`
    <div class="sec-title">전체 요약 (발주:선택월 / 입고:전체)</div>
    <div class="table-wrap"><table class="tbl-summary">
    <thead><tr><th>${summaryHeaders.join('</th><th>')}</th></tr></thead>
    <tbody>${summaryRows}</tbody>
    </table></div>`);

  monthsDesc.forEach(m=>{
    // ▼▼▼ 문제가 되었던 이 라인을 삭제했습니다 ▼▼▼

    const rowsM = ITEMS.map(r => {
      const o = sumMonth(r.key,m,r.tb,'orders');
      const i = sumMonth(r.key,m,r.tb,'receipts');
      if (!o && !i) return '';
      const n=o-i; 
      const negCls = n<0 ? 'neg' : '';
      const color = r.group==='normal' ? 'txt-normal' : (r.group==='ortho' ? 'txt-ortho' : '');
      return `<tr class="editable-row" data-month="${m}" data-item-key="${r.key}" data-item-label="${r.label}" data-item-tb="${r.tb}"><td class="${color}">${r.label}</td><td>${o}</td><td>${i}</td><td class="${negCls}">${n}</td></tr>`;
    }).join('');

    if(rowsM){
      const year = m.substring(2, 4); 
      const month = parseInt(m.substring(5, 7), 10);
      const isChecked = state.selectedMonths.has(m) ? 'checked' : '';
      parts.push(`
        <div class="sec-title month-title-editable" data-month="${m}">
          <div style="cursor: pointer; display: flex; align-items: center; gap: 6px;" title="${year}년 ${month}월 상세 내역 수정">
          <span>${year}년 ${month}월 발주</span><i data-feather="edit-2" style="width:14px; height:14px;"></i>
          </div>
          <input type="checkbox" class="month-checkbox" data-month="${m}" ${isChecked} title="요약에 포함/제외">
        </div>
        <div class="table-wrap"><table class="tbl-summary">
        <thead><tr><th>품목</th><th>발주량</th><th>입고량</th><th>미입고</th></tr></thead>
        <tbody>${rowsM}</tbody>
        </table></div>`);
    }
  });
  container.innerHTML = parts.join('');
}

    async function renderReceiptsUI(container){
      const data = state.snapshot||{};
      const selectedMonths = Array.from(state.selectedMonths);
      const allMonths = collectAllMonths(data);
      if(allMonths.length===0){ container.innerHTML=''; return; }
      const ITEMS = buildItems(data);

      const calculateTotal = (item, kind, monthList) => {
        return monthList.reduce((acc, m) => {
            const node = (((data[item.key] || {})[kind] || {})[m]) || {};
            const sum = Object.values(node)
                .filter(e => item.tb ? (e.topBottom || '') === item.tb : true)
                .reduce((s, e) => s + toInt(e.qty), 0);
            return acc + sum;
        }, 0);
      };

      const renderTableRows = (items) => {
        return items.map(r => {
          const o = calculateTotal(r, 'orders', selectedMonths);
          const rv = calculateTotal(r, 'receipts', allMonths);
          if (o <= 0 && rv <= 0) return '';
          const done = rv >= o ? 'done' : '';
          const over = rv > o ? 'over' : '';
          const prDisp = (o > 0) ? (rv <= o ? `${Math.round((rv/o)*100)}%` : `-${Math.round(((rv-o)/o)*100)}%`) : (rv > 0 ? '100%+' : '0%');
          const overCnt = Math.max(0, rv - o);
          const badgeClass = overCnt ? '' : 'is-hidden';
          const pc100Class = (o > 0 && rv === o) ? 'pc100' : '';
          const colorClass = r.group === 'normal' ? 'txt-normal' : (r.group === 'ortho' ? 'txt-ortho' : '');
          return `<tr class="rec-row ${done} ${over}" data-item="${r.key}" data-tb="${r.tb}">
              <td class="name-cell"><span class="name ${colorClass}">${r.label}</span><span class="badge-dot ${badgeClass}" title="추가입고 ${overCnt}개">+</span></td>
              <td class="o-cell"><span class="o" data-o="${o}" data-r="${rv}">${o}/${rv}</span></td>
              <td><input type="number" min="0" inputmode="numeric" class="rq" data-item="${r.key}" data-tb="${r.tb}" /></td>
              <td class="pcell ${pc100Class}">${prDisp}</td>
            </tr>`;
        }).join('');
      };

      const sheetRows = renderTableRows(ITEMS.filter(x => x.group === 'sheet'));
      const normalRows = renderTableRows(ITEMS.filter(x => x.group === 'normal'));
      const orthoRows = renderTableRows(ITEMS.filter(x => x.group === 'ortho'));

      container.innerHTML = `
        <div class="table-wrap"><table class="tbl-receipts"><thead><tr><th>품목</th><th>총발주</th><th>총입고</th><th>진행률</th></tr></thead><tbody>${sheetRows}</tbody></table></div>
        ${normalRows ? `<div class="divider-strong"></div><div class="table-wrap"><table class="tbl-receipts"><thead><tr><th>품목</th><th>총발주</th><th>총입고</th><th>진행률</th></tr></thead><tbody>${normalRows}</tbody></table></div>` : ''}
        ${orthoRows ? `<div class="divider-strong"></div><div class="table-wrap"><table class="tbl-receipts"><thead><tr><th>품목</th><th>총발주</th><th>총입고</th><th>진행률</th></tr></thead><tbody>${orthoRows}</tbody></table></div>` : ''}
      `;
      
      $$('.rq').forEach(inp => {
        inp.addEventListener('input', (e) => {
            const tr = e.target.closest('tr');
            const oEl = tr.querySelector('.o');
            const o = toInt(oEl.dataset.o), r0 = toInt(oEl.dataset.r);
            const v = toInt(e.target.value);
            const rNew = r0 + v;
            oEl.textContent = `${o}/${rNew}`;
            const pcell = tr.querySelector('.pcell');
            tr.classList.toggle('done', rNew >= o);
            tr.classList.toggle('over', rNew > o);
            const badge = tr.querySelector('.badge-dot');
            if (rNew > o) {
                const over = rNew - o;
                pcell.textContent = `-${Math.round((over/o)*100)}%`;
                badge.classList.remove('is-hidden');
                badge.title = `추가입고 ${over}개`;
            } else {
                pcell.textContent = o > 0 ? `${Math.round((rNew/o)*100)}%` : '100%+';
                badge.classList.add('is-hidden');
            }
            pcell.classList.toggle('pc100', o > 0 && rNew === o);
        });
      });
    }
    /* ▷▷▷ 렌더링 함수 종료 ▷▷▷ */

    /* ▷▷▷ 진행률 갱신 시작 ▷▷▷ */
    async function refreshProgress(){
      if(!state.snapshot) state.snapshot = await getStatusOnce();
      const data = state.snapshot||{};
      const ITEMS = buildItems(data);
      const selectedMonths = Array.from(state.selectedMonths);
      const allMonths = collectAllMonths(data);

      const calculateTotal = (kind, monthList) => {
        let total = 0;
        ITEMS.forEach(it => {
          monthList.forEach(m => {
            const node = (((data[it.key] || {})[kind] || {})[m]) || {};
            total += Object.values(node)
              .filter(e => it.tb ? (e.topBottom || '') === it.tb : true)
              .reduce((s, e) => s + toInt(e.qty), 0);
          });
        });
        return total;
      };

      const totO = calculateTotal('orders', selectedMonths);
      const totR = calculateTotal('receipts', allMonths);
      
      const p = totO > 0 ? Math.round((totR / totO) * 100) : (totR > 0 ? 100 : 0);
      const bar = $('#progressBarInner');
      bar.style.width = Math.min(100, p) + '%';
      bar.textContent = p + '%';
      $('#gaugeStats').textContent = `총발주 ${totO}개 · 총입고 ${totR}개 (입고율 ${p}%)`;
    }
    /* ▷▷▷ 진행률 갱신 종료 ▷▷▷ */

    /* ▷▷▷ 저장(발주/입고) 플로우 시작 ▷▷▷ */
    let entriesToSave = [];

    async function onSaveAll() {
      const displayEntries = [];
      const { sheet, patient, hip } = state.draftOrders;
      
      sheet.forEach((qty, item) => { if(qty>0) displayEntries.push({name: item, qty}); });
      hip.forEach((qty, item) => { if(qty>0) displayEntries.push({name: item, qty}); });
      patient.forEach((qty, key) => {
          const [itemName, tb] = key.split('__');
          const kindLabel = itemName.includes('일반') ? '일반' : '정형';
          const size = itemName.replace('일반환의','').replace('정형환의','');
          if(qty>0) displayEntries.push({name: labelOf(kindLabel, tb, size), qty});
      });

      if(state.mode === 'receipts') {
        $$('.rq').forEach(inp => {
          const qty = toInt(inp.value);
          if(qty > 0){ 
            const name = inp.closest('tr').querySelector('.name').textContent;
            displayEntries.push({name, qty}); 
          }
        });
      }

      if(displayEntries.length === 0){ showToast((state.mode === 'orders' ? '발주' : '입고') + ' 입력값이 없습니다.'); return; }

      if (state.mode === 'orders') {
        entriesToSave = [...sheet.entries(), ...hip.entries(), ...patient.entries()]
          .map(([key, qty]) => {
            const [itemName, topBottom] = key.includes('__') ? key.split('__') : [key, ''];
            return { itemName, qty, topBottom };
          }).filter(e => e.qty > 0);
      } else {
        entriesToSave = $$('.rq').filter(inp => toInt(inp.value) > 0)
          .map(inp => ({ itemName: inp.dataset.item, topBottom: inp.dataset.tb || '', qty: toInt(inp.value) }));
      }
      
      $('#modalSummaryList').innerHTML = displayEntries.map(e => `<li><span class="item-name">${e.name}</span> <span class="item-qty">${e.qty}개</span></li>`).join('');
      $('#modalTitle').textContent = state.mode === 'orders' ? '발주 내역 확인' : '입고 내역 확인';
      $('#confirmationModal').style.display = 'flex';
    }

    async function proceedWithSave() {
      const ymd = state.entryDate;
      const ym  = ymOf(ymd);
      const updates = {};
      const currentYear = parseInt(ymd.substring(0, 4), 10);

      try {
        showLoader('저장 처리중…');

        if (state.mode === 'orders') {
          let latestYear = 0;
          if (state.snapshot) {
            Object.values(state.snapshot).forEach(item => {
              Object.keys(item.orders || {}).forEach(month => {
                const year = parseInt(month.substring(0, 4), 10);
                if (year > latestYear) latestYear = year;
              });
            });
          }

          if (latestYear > 0 && currentYear > latestYear) {
            const ITEMS = buildItems(state.snapshot);
            const prevYearMonths = collectAllMonths(state.snapshot).filter(m => m.startsWith(String(latestYear)));
            const sumForYear = (item, kind) => prevYearMonths.reduce((acc, m) => {
              const node = (((state.snapshot[item.key] || {})[kind] || {})[m]) || {};
              return acc + Object.values(node).filter(e => item.tb ? (e.topBottom || '') === item.tb : true).reduce((s, e) => s + toInt(e.qty), 0);
            }, 0);

            const carryOverItems = [];
            ITEMS.forEach(item => {
                const unfulfilled = sumForYear(item, 'orders') - sumForYear(item, 'receipts');
                if (unfulfilled > 0) carryOverItems.push({ itemName: item.key, qty: unfulfilled, topBottom: item.tb || '' });
            });

            if (carryOverItems.length > 0) {
              showToast(`${latestYear}년 미입고 ${carryOverItems.length}개 품목 자동 이월...`);
              await new Promise(r => setTimeout(r, 1000));
              carryOverItems.forEach(({ itemName, qty, topBottom }) => {
                const k = push(ref(rtdb)).key;
                updates[`purchase_status/${itemName}/name`] = itemName;
                updates[`purchase_status/${itemName}/orders/${ym}/${k}`] = { qty, topBottom, ts: Date.now(), note: `${latestYear}년 이월분` };
              });
            }
          }
        }
        
        const saveEntries = (entries, type) => {
          entries.forEach(({ itemName, qty, topBottom }) => {
            const q = toInt(qty); if (q <= 0) return;
            const k = push(ref(rtdb)).key;
            updates[`purchase_status/${itemName}/name`] = itemName;
            if (type === 'orders') {
              updates[`purchase_status/${itemName}/orders/${ym}/${k}`] = { qty: q, topBottom: topBottom || '', ts: Date.now() };
            } else {
              const day = Number(ymd.split('-')[2] || '1');
              updates[`purchase_status/${itemName}/receipts/${ym}/${k}`] = { day, qty: q, topBottom: topBottom || '', ts: Date.now() };
            }
          });
        };

        if (state.mode === 'orders') {
          saveEntries(entriesToSave, 'orders');
          state.draftOrders.sheet.clear();
          state.draftOrders.patient.clear();
          state.draftOrders.hip.clear();
          showToast('발주 저장 완료');
        } else {
          saveEntries(entriesToSave, 'receipts');
          showToast('입고 완료');
        }
        
        if (Object.keys(updates).length > 0) await updatePurchaseStatus(updates);

        successAudio.play();
        $('#confirmationModal').style.display = 'none';
        entriesToSave = [];
        state.snapshot = await getStatusOnce();
        renderBody();
        refreshProgress();
      } catch (err) {
        console.error('저장 중 오류:', err);
        showToast('저장 실패: 잠시 후 재시도해주세요.');
      } finally {
        hideLoader();
      }
    }
    /* ▷▷▷ 저장(발주/입고) 플로우 종료 ▷▷▷ */

    /* ▷▷▷ 상세 수정(모달) 시작 ▷▷▷ */
    async function openEditModalForMonth(month) {
      const modal = $('#editModal');
      const body = $('#editModalBody');
      modal.style.display = 'flex';
      body.innerHTML = '<div class="spinner"></div>';

      const year = month.substring(2, 4);
      const mon = parseInt(month.substring(5, 7), 10);
      $('#editModalTitle').textContent = `${year}년 ${mon}월 전체 내역 수정`;

      try {
        const getTimestamp = (t, m) => (t.type === 'receipts' && t.day) ? new Date(`${m}-${String(t.day).padStart(2, '0')}`).getTime() : t.ts || 0;
        
        const allTransactions = [];
        const ITEMS = buildItems(state.snapshot);
        ITEMS.forEach(item => {
          const itemData = state.snapshot[item.key] || {};
          const orders = Object.entries((itemData.orders || {})[month] || {}).map(([id, data]) => ({ id, type: 'orders', itemKey: item.key, itemLabel: item.label, ...data }));
          const receipts = Object.entries((itemData.receipts || {})[month] || {}).map(([id, data]) => ({ id, type: 'receipts', itemKey: item.key, itemLabel: item.label, ...data }));
          allTransactions.push(...orders, ...receipts);
        });

        const sorted = allTransactions.sort((a, b) => getTimestamp(a, month) - getTimestamp(b, month));
        const ordersList = sorted.filter(t => t.type === 'orders');
        const receiptsList = sorted.filter(t => t.type === 'receipts');

        if (sorted.length === 0) {
          body.innerHTML = '<p style="text-align:center;padding:20px 0;">해당 월에 수정할 상세 내역이 없습니다.</p>';
          return;
        }

        const createListItemHtml = (t) => {
          const dateStr = t.type === 'receipts' ? `${mon}월 ${t.day}일` : (t.ts ? new Date(t.ts).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' }) : '날짜 정보 없음');
          const typeLabel = t.type === 'orders' ? '발주' : '입고';
          const colorCls = t.itemLabel.includes('일반') ? 'txt-normal' : (t.itemLabel.includes('정형') ? 'txt-ortho' : '');
          const noteHtml = t.note ? `<small class="sub-info" style="color:var(--accent);font-weight:600;">(${t.note})</small>` : '';

          return `<li data-id="${t.id}" data-type="${t.type}" data-item-key="${t.itemKey}" data-month="${month}" data-original-qty="${t.qty}">
              <div class="item-details">
                <span class="item-name ${colorCls}">${t.itemLabel} ${noteHtml}</span>
                <small class="sub-info">${dateStr} ${typeLabel}</small>
              </div>
              <input type="number" class="qty-input" value="${t.qty}" min="0">
              <button class="btn ghost red delete-btn">삭제</button>
            </li>`;
        };

        body.innerHTML = `
          <div class="modal-tabs">
            <button class="modal-tab active" data-tab="orders-list">발주 (${ordersList.length}건)</button>
            <button class="modal-tab" data-tab="receipts-list">입고 (${receiptsList.length}건)</button>
          </div>
          <ul id="orders-list">${ordersList.map(createListItemHtml).join('')}</ul>
          <ul id="receipts-list" class="is-hidden">${receiptsList.map(createListItemHtml).join('')}</ul>`;

        body.querySelector('.modal-tabs').addEventListener('click', e => {
          if (e.target.classList.contains('modal-tab')) {
            body.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            e.target.classList.add('active');
            body.querySelectorAll('ul').forEach(ul => ul.classList.add('is-hidden'));
            body.querySelector(`#${e.target.dataset.tab}`).classList.remove('is-hidden');
          }
        });

        body.addEventListener('click', e => {
          if (e.target.classList.contains('delete-btn')) e.target.closest('li')?.classList.toggle('is-deleted');
        });

      } catch (err) {
        console.error("월별 상세 내역 로딩 실패:", err);
        body.innerHTML = '<p style="text-align:center;padding:20px 0;">오류가 발생했습니다.</p>';
      }
    }

    async function saveEdits() {
      try {
        showLoader('변경내용 저장중…');
        const updates = {};
        $$('#editModalBody li').forEach(li => {
          const { id, type, itemKey, month, originalQty } = li.dataset;
          const path = `purchase_status/${itemKey}/${type}/${month}/${id}`;
          if (li.classList.contains('is-deleted')) {
            updates[path] = null;
          } else {
            const newQty = toInt(li.querySelector('.qty-input').value);
            if (newQty !== toInt(originalQty)) {
              updates[`${path}/qty`] = newQty;
            }
          }
        });

        if (Object.keys(updates).length > 0) await updatePurchaseStatus(updates);
        $('#editModal').style.display = 'none';
        showToast('수정 완료!');
        successAudio.play();
        state.snapshot = await getStatusOnce();
        renderBody();
        refreshProgress();
      } catch (err) {
        console.error("수정사항 저장 실패:", err);
        showToast('수정 저장 실패: 잠시 후 재시도해주세요.');
      } finally {
        hideLoader();
      }
    }
    /* ▷▷▷ 상세 수정(모달) 종료 ▷▷▷ */

    /* ▷▷▷ 엑셀 내보내기 시작 ▷▷▷ */
    async function onExportExcel_AllData(){
  try {
    showLoader('엑셀 생성중…');
    if(!state.snapshot) state.snapshot=await getStatusOnce();
    const all=state.snapshot||{};
    const selectedMonths = Array.from(state.selectedMonths).sort((a,b)=>a.localeCompare(b));
    const allMonths = collectAllMonths(all).sort((a,b)=>a.localeCompare(b));
    if (selectedMonths.length === 0) {
      showToast("요약에 포함할 발주 월이 선택되지 않았습니다.");
      return;
    }

    const ITEMS = buildItems(all);
    const wb=new ExcelJS.Workbook();

    const getCarryOverData = (item, months) => {
      return months.reduce((acc, m) => {
        const orders = (((all[item.key] || {}).orders || {})[m]) || {};
        return acc + Object.values(orders).filter(order => order.note?.includes('이월') && (item.tb ? order.topBottom === item.tb : true)).reduce((s, e) => s + toInt(e.qty), 0);
      }, 0);
    };

    const sumMonth = (it, kind, m, tb, excludeCarryOver) => {
      const node = (((all[it.key]||{})[kind]||{})[m])||{};
      return Object.values(node).filter(e => (tb ? (e.topBottom||'')===tb : true) && (!excludeCarryOver || !e.note?.includes('이월분'))).reduce((s,e)=>s+toInt(e.qty),0);
    };
    const sumRange = (it, kind, months, tb, excludeCarryOver) => months.reduce((acc,m)=>acc+sumMonth(it,kind,m,tb,excludeCarryOver), 0);
    
    const hasAnyCarryOver = ITEMS.some(item => getCarryOverData(item, selectedMonths) > 0);

    const wsSum = wb.addWorksheet('전체현황');
    const summaryHeaders = hasAnyCarryOver ? ['품목','이월','신규발주','총 발주량', '전체입고량','미입고','진행률'] : ['품목','발주량','입고량','미입고','진행률'];
    wsSum.addRow(summaryHeaders);
    wsSum.views = [{state:'frozen', xSplit:1, ySplit:1}];
    
    let grandTotals = { carry: 0, new: 0, orders: 0, receipts: 0 };

    ITEMS.forEach(r => {
      const carryOver = getCarryOverData(r, selectedMonths);
      const newOrders = sumRange(r, 'orders', selectedMonths, r.tb, true);
      const totalOrders = carryOver + newOrders;
      const totalReceipts = sumRange(r, 'receipts', allMonths, r.tb, false);
      
      if(totalOrders || totalReceipts){
        grandTotals.carry += carryOver; grandTotals.new += newOrders;
        grandTotals.orders += totalOrders; grandTotals.receipts += totalReceipts;
        
        const unfulfilled = totalOrders - totalReceipts;
        const pctText = totalOrders > 0 ? (totalReceipts <= totalOrders ? `${Math.round((totalReceipts/totalOrders)*100)}%` : `-${Math.round(((totalReceipts-totalOrders)/totalOrders)*100)}%`) : 'N/A';
        const rowData = hasAnyCarryOver ? [r.label, carryOver, newOrders, totalOrders, totalReceipts, unfulfilled, pctText] : [r.label, totalOrders, totalReceipts, unfulfilled, pctText];
        const row = wsSum.addRow(rowData);
        
        if(r.group==='normal') row.getCell(1).font={color:{argb:'FF16A34A'},bold:true};
        if(r.group==='ortho')  row.getCell(1).font={color:{argb:'FF2563EB'},bold:true};
        if (hasAnyCarryOver) {
            if (carryOver > 0) row.getCell(2).font = {color:{argb:'FF78716C'}, bold:true};
            if (unfulfilled < 0) row.getCell(6).font = { color: { argb: 'FFF43F5E' }, bold: true };
            if (pctText.startsWith('-')) row.getCell(7).font = { color: { argb: 'FFF43F5E' }, bold: true };
            else if (pctText === '100%') row.getCell(7).font = { color: { argb: 'FF2563EB' }, bold: true };
        } else {
            if (unfulfilled < 0) row.getCell(4).font = { color: { argb: 'FFF43F5E' }, bold: true };
            if (pctText.startsWith('-')) row.getCell(5).font = { color: { argb: 'FFF43F5E' }, bold: true };
            else if (pctText === '100%') row.getCell(5).font = { color: { argb: 'FF2563EB' }, bold: true };
        }
      }
    });
    
    const gtUnfulfilled = grandTotals.orders - grandTotals.receipts;
    const gtPctText = grandTotals.orders > 0 ? (grandTotals.receipts <= grandTotals.orders ? `${Math.round((grandTotals.receipts/grandTotals.orders)*100)}%` : `-${Math.round(((grandTotals.receipts-grandTotals.orders)/grandTotals.orders)*100)}%`) : 'N/A';
    const totalRowData = hasAnyCarryOver ? ['종합', grandTotals.carry, grandTotals.new, grandTotals.orders, grandTotals.receipts, gtUnfulfilled, gtPctText] : ['종합', grandTotals.orders, grandTotals.receipts, gtUnfulfilled, gtPctText];
    const totalRow = wsSum.addRow(totalRowData);
    totalRow.eachCell(c => { c.fill = {type:'pattern', pattern:'solid', fgColor:{argb:'FF1E293B'}}; c.font = {bold:true, color:{argb:'FFFFFFFF'}}; });

    const wsOrd = wb.addWorksheet('발주월별(선택월)');
    const ordHeaders = hasAnyCarryOver ? ['품목', '이월합계', ...selectedMonths.map(m => `${m.substring(2,4)}년 ${parseInt(m.substring(5,7),10)}월`)] : ['품목', ...selectedMonths.map(m => `${m.substring(2,4)}년 ${parseInt(m.substring(5,7),10)}월`)];
    wsOrd.addRow(ordHeaders);
    wsOrd.views = [{state:'frozen', xSplit: hasAnyCarryOver ? 2 : 1, ySplit:1}];
    ITEMS.forEach(r=>{
      const carryOverTotal = getCarryOverData(r, selectedMonths);
      const monthlyVals = selectedMonths.map(m => sumMonth(r, 'orders', m, r.tb, true));
      if(carryOverTotal || monthlyVals.some(v=>v)){
        const rowData = hasAnyCarryOver ? [r.label, carryOverTotal, ...monthlyVals] : [r.label, ...monthlyVals];
        const added=wsOrd.addRow(rowData);
        if(r.group==='normal') added.getCell(1).font={color:{argb:'FF16A34A'},bold:true};
        if(r.group==='ortho')  added.getCell(1).font={color:{argb:'FF2563EB'},bold:true};
        if(hasAnyCarryOver && carryOverTotal > 0) added.getCell(2).font = {color:{argb:'FF78716C'}, bold:true};
      }
    });

    const wsRecv = wb.addWorksheet('입고_날짜별(전체)');
    const monthToDays = {};
    allMonths.forEach(m => {
      const days = new Set();
      ITEMS.forEach(r => Object.values(((all[r.key]||{}).receipts||{})[m]||{}).forEach(e => e.day && days.add(e.day)));
      monthToDays[m] = Array.from(days).sort((a,b)=>a-b);
    });
const recvHeaders = ['품목', ...allMonths.flatMap(m => monthToDays[m].map(d=>`${parseInt(m.slice(5,7),10)}월 ${d}일`))];

    wsRecv.addRow(recvHeaders);
    wsRecv.views = [{state:'frozen', xSplit:1, ySplit:1}];
    ITEMS.forEach(r => {
      const vals = allMonths.flatMap(m => monthToDays[m].map(d => {
        const node = ((all[r.key]||{}).receipts||{})[m]||{};
        return Object.values(node).filter(e => e.day==d && (r.tb ? e.topBottom===r.tb : true)).reduce((s,e)=>s+toInt(e.qty),0);
      }));
      if(vals.some(v=>v)) {
        const added = wsRecv.addRow([r.label, ...vals]);
        // ▼▼▼ 누락되었던 '입고' 시트의 색상 스타일링 로직 복원 ▼▼▼
        if(r.group==='normal') added.getCell(1).font={color:{argb:'FF16A34A'},bold:true};
        if(r.group==='ortho')  added.getCell(1).font={color:{argb:'FF2563EB'},bold:true};
      }
    });
    
    [wsSum, wsOrd, wsRecv].forEach(ws => {
      ws.getRow(1).eachCell(c=>{ c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF1E293B'}}; c.font={bold:true,color:{argb:'FFFFFFFF'}}; c.alignment={horizontal:'center'}; });
      for(let r=2; r<=ws.rowCount; r++){ ws.getRow(r).eachCell((c,ci)=>{ c.alignment={vertical:'middle',horizontal:(ci===1?'left':'center')}; }); }
      ws.columns.forEach(col => {
        let maxLen = 0;
        col.eachCell({includeEmpty:true}, cell => maxLen=Math.max(maxLen, (cell.value||'').toString().length));
        col.width = Math.max(10, maxLen + 2);
      });
      ws.getColumn(1).width = 11.88;
    });

    const buf = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf]), `구매현황(${new Date().getFullYear().toString().slice(2)}년).xlsx`);

  } catch (e) {
    console.error("엑셀 생성 실패:", e);
    showToast("엑셀 생성 실패: 다시 시도해주세요.");
  } finally {
    hideLoader();
  }
}

    /* ▷▷▷ 엑셀 내보내기 종료 ▷▷▷ */
  </script>
  </body>
</html>
