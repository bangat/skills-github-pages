<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2563eb" />
<title>ë°©ëª…ë¡ Â· ì‹¤ì‹œê°„</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
    --r-lg:16px; --r-md:12px; --navH:56px;
    --shadow-1:0 4px 16px rgba(15,23,42,.08); --shadow-2:0 10px 30px rgba(15,23,42,.10);
    --focus:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%}
  body{margin:0;font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;background:var(--bg);color:var(--text)}

  /* ìƒë‹¨ë°” */
  .topBar{
    position:sticky; top:0; z-index:80;
    background:rgba(255,255,255,.86); backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid var(--border);
  }
  .topBar .wrap{ max-width:980px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:8px; }
  .backBtn{ display:inline-grid; place-items:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow-1); cursor:pointer; }
  .title{ font-weight:900; font-size:18px; letter-spacing:-.2px; }
  .sender{
    margin-left:auto; font-size:13px; color:#475569; display:flex; align-items:center; gap:6px;
    background:#fff; border:1px solid var(--border); padding:6px 8px; border-radius:10px;
  }
  .sender .chip{ font-weight:800; color:#0b3fb8; }
  .sender a{ color:#64748b; text-underline-offset:2px; }

  /* ë³¸ë¬¸ */
  main{ max-width:980px; margin:0 auto; padding:10px 12px calc(100px + env(safe-area-inset-bottom)); }
  .panel{
    background:#fff; border:1px solid rgba(15,23,42,.06); border-radius:18px; box-shadow:0 16px 44px rgba(15,23,42,.10);
    min-height:50vh; display:flex; flex-direction:column; overflow:hidden;
  }

  /* ìŠ¤í¬ë¡¤ ì˜ì—­ */
  .chatScroll{ flex:1; min-height:300px; overflow:auto; padding:12px; background:
    linear-gradient(#fff,#fff) padding-box,
    linear-gradient(180deg,rgba(37,99,235,.06),rgba(37,99,235,0)) border-box;
  }

  /* ë‚ ì§œ êµ¬ë¶„ì„  */
  .dayHeader{ text-align:center; margin:6px 0 10px; }
  .dayHeader .badge{
    display:inline-block; font-size:12px; color:#475569; background:#eef2f7; border:1px solid var(--border);
    padding:4px 10px; border-radius:999px; box-shadow:var(--shadow-1);
  }

  /* ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ */
  .msgs{ list-style:none; padding:0; margin:6px 0 0; display:flex; flex-direction:column; gap:10px; }

  /* ì¢Œ/ìš° í–‰ */
  .msgRow{ display:flex; align-items:flex-end; gap:6px; }
  .msgRow.left{ justify-content:flex-start; }
  .msgRow.right{ justify-content:flex-end; }

  /* ë§í’ì„  */
  .msg{ max-width:78%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); box-shadow:0 6px 20px rgba(15,23,42,.06); }
  .msg .line{ font-size:15px; line-height:1.35; }
  .msg .from{ font-weight:900; color:#0b3fb8; white-space:nowrap; margin-right:4px; }
  .msg .text{ white-space:pre-wrap; word-break:break-word; }

  /* ìƒ‰ìƒ: mine(ì—°ë…¸ë‘), theirs(í•˜ì–‘) */
  .msg.mine{ background:#fff9c2; border-color:#f5e58a; }
  .msg.theirs{ background:#ffffff; border-color:#e6eaf2; }
  .msg.mine .from{ display:none; }

  /* ë§í’ì„  ì˜† ì‹œê°„ */
  .msgTime{ font-size:12px; color:#64748b; line-height:1; white-space:nowrap; }
  .msgRow.left  .msgTime{ margin-left:6px; }
  .msgRow.right .msgTime{ margin-right:6px; order:-1; }

  /* ìŠ¤í¬ë¡¤ë°” */
  .chatScroll::-webkit-scrollbar{ width:10px; }
  .chatScroll::-webkit-scrollbar-thumb{ background:#e5eaf3; border-radius:999px; border:3px solid #fff; }

  /* ì…ë ¥ ë°•ìŠ¤ */
  .inputBar{
    position:fixed; left:0; right:0; bottom:0; z-index:60; background:#fff; border-top:1px solid var(--border);
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  }
  .inputWrap{ max-width:980px; margin:0 auto; display:flex; gap:8px; }
  .textbox{
    flex:1; min-height:44px; max-height:140px; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
    font-size:15px; resize:vertical; outline:none; background:#fff; color:#var(--text);
  }
  .textbox:focus{ border-color:var(--accent); box-shadow:var(--focus); }
  .sendBtn{
    flex:0 0 auto; padding:0 16px; border:none; border-radius:12px; font-weight:900; font-size:15px; cursor:pointer;
    background:linear-gradient(180deg,#4f83ff,#2563eb); color:#fff; box-shadow:0 10px 28px rgba(37,99,235,.25);
  }
  .sendBtn:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }
</style>
</head>
<body>

<!-- ìƒë‹¨ ë°” -->
<div class="topBar">
  <div class="wrap">
    <button class="backBtn" id="goBack" title="ë’¤ë¡œ">â†</button>
    <div class="title">ì‹¤ì‹œê°„ ë°©ëª…ë¡</div>
    <div class="sender" id="whoAmI" title="ë°œì‹ ì ë³‘ë™">
      ë°œì‹ ì <span class="chip" id="wardChip">-</span>
      <a href="./" id="changeWard">ë³€ê²½</a>
    </div>
  </div>
</div>

<main>
  <section class="panel" aria-label="ì‹¤ì‹œê°„ ë©”ì‹œì§€">
    <div class="chatScroll" id="chatScroll">
      <!-- ë‚ ì§œ êµ¬ë¶„ì„ ì€ JSê°€ li.dayHeaderë¡œ ìë™ ì‚½ì… -->
      <ul class="msgs" id="msgList"></ul>
      <div id="bottomSentinel" aria-hidden="true" style="height:1px"></div>
    </div>
  </section>
</main>

<!-- í•˜ë‹¨ ì…ë ¥ -->
<div class="inputBar">
  <div class="inputWrap">
    <textarea id="msgBox" class="textbox" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." rows="2" maxlength="500"></textarea>
    <button id="sendBtn" class="sendBtn" disabled>ì „ì†¡</button>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, serverTimestamp, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
    authDomain: "hallymlinen.firebaseapp.com",
    databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
    projectId: "hallymlinen",
    storageBucket: "hallymlinen.appspot.com",
    messagingSenderId: "867775830688",
    appId: "1:867775830688:web:cef3ed4e70ae9818f347c5"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const el = s => document.querySelector(s);

  /* ë³‘ë™ ê°€ì ¸ì˜¤ê¸° */
  function getWard(){
    const qp = new URL(location.href).searchParams.get("ward");
    const w  = qp && qp.trim() ? qp.trim() : (localStorage.getItem("linen/ward")||"").trim();
    return w || "";
  }

  /* ì´ìŠ¤ì¼€ì´í”„ */
  function escapeHTML(str=""){
    return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  /* ì‹œê°„/ë‚ ì§œ í¬ë§· */
  function fmtAmPmTime(ts){
    const d = new Date(ts);
    let h = d.getHours(), m = d.getMinutes();
    const ampm = h < 12 ? "ì˜¤ì „" : "ì˜¤í›„";
    h = h % 12 || 12;
    return `${ampm} ${h}:${String(m).padStart(2,"0")}`;
  }
  function fmtDateBadge(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,"0")}.${String(d.getDate()).padStart(2,"0")}`;
  }

  /* ì „ì—­ ìƒíƒœ */
  const ward = getWard();
  el("#wardChip").textContent = ward ? `${ward}ë³‘ë™` : "ë¯¸ì§€ì •";
  el("#changeWard").addEventListener("click", (e)=>{ e.preventDefault(); location.href="./"; });

  /* ë’¤ë¡œê°€ê¸° â†’ ì…ë ¥í™”ë©´(í˜„ì¬ ward ìœ ì§€) */
  el("#goBack").addEventListener("click", (e) => {
    e.preventDefault();
    const base = "./";
    const url = ward ? `${base}?ward=${encodeURIComponent(ward)}` : base;
    location.href = url;
  });

  const msgBox = el("#msgBox");
  const sendBtn = el("#sendBtn");
  const scrollBox = el("#chatScroll");
  const msgList = el("#msgList");
  const bottomSentinel = el("#bottomSentinel");

  function refreshSendState(){
    sendBtn.disabled = !(msgBox.value.trim().length > 0 && ward);
  }
  msgBox.addEventListener("input", refreshSendState);
  msgBox.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendBtn.click();
    }
  });
  refreshSendState();

  /* ===== ë°”ë‹¥ ê³ ì •(ìŠ¤í‹±) ê°ì§€ ===== */
  let stickBottom = true; // ì²˜ìŒì—” ë°”ë‹¥ì— ë¶™ì–´ìˆë‹¤ê³  ê°€ì •
  const io = new IntersectionObserver((entries)=>{
    // sentinelì´ ë³´ì´ë©´ ë°”ë‹¥
    stickBottom = entries.some(en => en.isIntersecting);
  }, { root: scrollBox, threshold: 1.0 });
  io.observe(bottomSentinel);

  function scrollToBottom(){
    // sentinelë¡œ ìŠ¤í¬ë¡¤ (ë ˆì´ì•„ì›ƒ ë³€í™”ì—ë„ íŠ¼íŠ¼)
    bottomSentinel.scrollIntoView({ block: 'end' });
  }

  /* ===== ë‚ ì§œ í—¤ë” ===== */
  let __lastDayKey = null;
  function dayKey(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function ensureDayHeader(ts){
    const key = dayKey(ts);
    if (key !== __lastDayKey){
      const sep = document.createElement('li');
      sep.className = 'dayHeader';
      sep.innerHTML = `<span class="badge">${fmtDateBadge(ts)}</span>`;
      msgList.appendChild(sep);
      __lastDayKey = key;
    }
  }

  /* ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ íŒë³„ */
  function isMineMessage(v){
    const my = (ward||"").trim();
    if (!my) return false;
    const a = (v.author||"").replace(/ë³‘ë™$/,'').trim();
    const w = (v.ward||"").trim();
    return (a === my) || (w === my);
  }

  /* TTS (í¬ê·¸ë¼ìš´ë“œ ì „ìš©) */
  function speak(text){
    try{
      if (document.hidden) return;              // ë°±ê·¸ë¼ìš´ë“œëŠ” X
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ko-KR';
      u.rate = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(_){}
  }

  /* ë Œë” */
  function renderMessage({ward:w, text, ts, isMine}){
    const row = document.createElement("li");
    row.className = `msgRow ${isMine ? 'right' : 'left'}`;

    const bubble = document.createElement("div");
    bubble.className = `msg ${isMine ? 'mine' : 'theirs'}`;
    bubble.innerHTML = `
      <div class="line">
        <span class="from">${w||"ìµëª…"}</span>
        <span class="text">${escapeHTML(text)}</span>
      </div>
    `;

    const time = document.createElement("div");
    time.className = "msgTime";
    time.textContent = fmtAmPmTime(ts);

    if (isMine){
      row.appendChild(time);
      row.appendChild(bubble);
    } else {
      row.appendChild(bubble);
      row.appendChild(time);
    }

    msgList.appendChild(row);
  }

  // ì „ì†¡
  async function sendMessage(){
    const text = msgBox.value.trim();
    if (!text) return;

    const roomRef = ref(db, `guestbook/messages`);
    await push(roomRef, {
      text,
      author: `${ward}ë³‘ë™`,
      ward,
      ts: Date.now(),
      ts_server: serverTimestamp(),
      url: "/skills-github-pages/ë°©ëª…ë¡.html"
    });

    msgBox.value = "";
    refreshSendState();
    // ë‚´ê°€ ë°©ê¸ˆ ë³´ëƒˆìœ¼ë©´ í•˜ë‹¨ì— ë¶™ì—¬ë‘ê¸°
    scrollToBottom();
  }
  sendBtn.addEventListener("click", sendMessage);

  // êµ¬ë…: ë§ˆì§€ë§‰ 200ê°œ
  const q = query(ref(db, `guestbook/messages`), limitToLast(200));
  let initialLoaded = false;
  onChildAdded(q, snap=>{
    const v = snap.val() || {};
    const mine = isMineMessage(v);
    const ts   = v.ts || Date.now();

    // ë‚ ì§œ í—¤ë” -> ë©”ì‹œì§€
    ensureDayHeader(ts);
    renderMessage({
      ward: v.author || v.ward || "ìµëª…",
      text: v.text || "",
      ts,
      isMine: mine
    });

    // ì²« ë¡œë”©ì€ ì „ì²´ ê·¸ë¦° ë’¤ í•œ ë²ˆë§Œ ë‚´ë¦¬ê¸°
    if (!initialLoaded){
      clearTimeout(onChildAdded._t);
      onChildAdded._t = setTimeout(()=>{ initialLoaded = true; scrollToBottom(); }, 0);
    } else if (stickBottom){
      // ì‚¬ìš©ìê°€ ë°”ë‹¥ì— ë¶™ì–´ ìˆìœ¼ë©´ ê³„ì† ë”°ë¼ê°
      scrollToBottom();
    }

    // ğŸ”Š í¬ê·¸ë¼ìš´ë“œ TTS/ì§„ë™: "ë‚¨ì´ ë³´ë‚¸ ê²ƒ"ë§Œ
    if (!mine){
      try { navigator.vibrate && navigator.vibrate([60,40,60]); } catch {}
      speak('ë¦°ë„¨ì‹¤ ë©”ì„¸ì§€ ë„ì°©!');
    }
  });

  msgBox.focus();
</script>


</body>
</html>

