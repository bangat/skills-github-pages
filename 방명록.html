<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2563eb" />
<title>ë°©ëª…ë¡ Â· ì‹¤ì‹œê°„</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
    --r-lg:16px; --r-md:12px; --navH:56px;
    --shadow-1:0 4px 16px rgba(15,23,42,.08); --shadow-2:0 10px 30px rgba(15,23,42,.10);
    --focus:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%}
  body{margin:0;font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;background:var(--bg);color:var(--text)}

  /* ìƒë‹¨ë°” */
  .topBar{
    position:sticky; top:0; z-index:80;
    background:rgba(255,255,255,.86); backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid var(--border);
  }
  .topBar .wrap{ max-width:980px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:8px; }
  .backBtn{ display:inline-grid; place-items:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow-1); cursor:pointer; }
  .title{ font-weight:900; font-size:18px; letter-spacing:-.2px; }
  .sender{
    margin-left:auto; font-size:13px; color:#475569; display:flex; align-items:center; gap:6px;
    background:#fff; border:1px solid var(--border); padding:6px 8px; border-radius:10px;
  }
  .sender .chip{ font-weight:800; color:#0b3fb8; }
  .sender a{ color:#64748b; text-underline-offset:2px; }

  /* ë³¸ë¬¸ */
  main{ max-width:980px; margin:0 auto; padding:10px 12px calc(100px + env(safe-area-inset-bottom)); }
  .panel{
    background:#fff; border:1px solid rgba(15,23,42,.06); border-radius:18px; box-shadow:0 16px 44px rgba(15,23,42,.10);
    min-height:50vh; display:flex; flex-direction:column; overflow:hidden;
  }

  /* ë©”ì‹œì§€ ìŠ¤í¬ë¡¤ ë°•ìŠ¤ */
  .chatScroll{ flex:1; min-height:300px; overflow:auto; padding:12px; background:
    linear-gradient(#fff,#fff) padding-box,
    linear-gradient(180deg,rgba(37,99,235,.06),rgba(37,99,235,0)) border-box;
  }

  /* ë‚ ì§œ ê·¸ë£¹ ë¦¬ìŠ¤íŠ¸(ìµœìƒë‹¨ = ìµœì‹  ë‚ ì§œ) */
  .list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:12px; }

  .dayGroup{ }
  .dayGroup .daySep{ text-align:center; margin:6px 0 2px; }
  .dayGroup .daySep .badge{
    display:inline-block; font-size:12px; color:#475569; background:#eef2f7; border:1px solid var(--border);
    padding:4px 10px; border-radius:999px; box-shadow:var(--shadow-1);
  }

  /* ê° ë‚ ì§œì˜ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸(í•´ë‹¹ ë‚ ì§œ ë‚´ì—ì„œë„ ìµœì‹ ì´ ìœ„) */
  .msgs{ list-style:none; padding:0; margin:6px 0 0; display:flex; flex-direction:column; gap:10px; }

  .msg{
    background:#f8fafc; border:1px solid var(--border); border-radius:14px; padding:10px 12px;
    box-shadow:0 6px 20px rgba(15,23,42,.06);
  }
  .msg .line{ font-size:15px; line-height:1.35; }
  .msg .from{ font-weight:900; color:#0b3fb8; white-space:nowrap; }
  .msg .text{ white-space:pre-wrap; word-break:break-word; }
  .msg .meta{ margin-top:6px; font-size:12px; color:#64748b; }

  /* ìŠ¤í¬ë¡¤ë°” ì‚´ì§ */
  .chatScroll::-webkit-scrollbar{ width:10px; }
  .chatScroll::-webkit-scrollbar-thumb{ background:#e5eaf3; border-radius:999px; border:3px solid #fff; }

  /* ì…ë ¥ ë°•ìŠ¤(í•˜ë‹¨ ê³ ì •) */
  .inputBar{
    position:fixed; left:0; right:0; bottom:0; z-index:60; background:#fff; border-top:1px solid var(--border);
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  }
  .inputWrap{ max-width:980px; margin:0 auto; display:flex; gap:8px; }
  .textbox{
    flex:1; min-height:44px; max-height:140px; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
    font-size:15px; resize:vertical; outline:none; background:#fff; color:var(--text);
  }
  .textbox:focus{ border-color:var(--accent); box-shadow:var(--focus); }
  .sendBtn{
    flex:0 0 auto; padding:0 16px; border:none; border-radius:12px; font-weight:900; font-size:15px; cursor:pointer;
    background:linear-gradient(180deg,#4f83ff,#2563eb); color:#fff; box-shadow:0 10px 28px rgba(37,99,235,.25);
  }
  .sendBtn:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }

  @media (max-width:430px){
    .backBtn{ width:34px;height:34px; }
    .sender{ display:none; } /* ëª¨ë°”ì¼ì—ì„  ìˆ¨ê¹€ */
  }
</style>
</head>
<body>

<!-- ìƒë‹¨ ë°” -->
<div class="topBar">
  <div class="wrap">
    <button class="backBtn" id="goBack" title="ë’¤ë¡œ">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M15 19L8 12L15 5" stroke="#1f2a44" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div class="title">ì‹¤ì‹œê°„ ë°©ëª…ë¡</div>
    <div class="sender" id="whoAmI" title="ë°œì‹ ì ë³‘ë™">
      ë°œì‹ ì <span class="chip" id="wardChip">-</span>
      <a href="./" id="changeWard">ë³€ê²½</a>
    </div>
  </div>
</div>

<main>
  <section class="panel" aria-label="ì‹¤ì‹œê°„ ë©”ì‹œì§€">
    <div class="chatScroll" id="chatScroll">
      <!-- ë‚ ì§œ ê·¸ë£¹ë“¤ì´ ë“¤ì–´ê°(ìµœì‹  ë‚ ì§œê°€ ìœ„) -->
      <ul class="list" id="chatList"></ul>
    </div>
  </section>
</main>

<!-- í•˜ë‹¨ ì…ë ¥ ë°” -->
<div class="inputBar" role="group" aria-label="ë©”ì‹œì§€ ì…ë ¥">
  <div class="inputWrap">
    <textarea id="msgBox" class="textbox" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." rows="2" maxlength="500"></textarea>
    <button id="sendBtn" class="sendBtn" disabled>ì „ì†¡</button>
  </div>
</div>

<!-- Firebase RTDB -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, serverTimestamp, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // === Firebase config (ë©”ì¸ê³¼ ë™ì¼) ===
  const firebaseConfig = {
    apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
    authDomain: "hallymlinen.firebaseapp.com",
    databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
    projectId: "hallymlinen",
    storageBucket: "hallymlinen.appspot.com",
    messagingSenderId: "867775830688",
    appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
    measurementId: "G-T02ZFK18L3"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // === Helpers ===
  const el = s => document.querySelector(s);

  function getWard(){
    const qp = new URL(location.href).searchParams.get("ward");
    const w  = qp && qp.trim() ? qp.trim() : (localStorage.getItem("linen/ward")||"").trim();
    return w || "";
  }

  function escapeHTML(str=""){
    return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  // "2025.08.31 ì˜¤í›„8ì‹œ35ë¶„" í¬ë§·
  function fmtTs(ts){
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd= String(d.getDate()).padStart(2,"0");
    let h  = d.getHours();
    const ampm = (h>=12) ? "ì˜¤í›„" : "ì˜¤ì „";
    h = (h%12) || 12;
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}.${m}.${dd} ${ampm}${h}ì‹œ${mm}ë¶„`;
  }

  function dayKey(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,"0")}.${String(d.getDate()).padStart(2,"0")}`;
  }

  // === UI ë°”ì¸ë”© ===
  const ward = getWard();
  el("#wardChip").textContent = ward ? `${ward}ë³‘ë™` : "ë¯¸ì§€ì •";
  el("#changeWard").addEventListener("click", (e)=>{
    e.preventDefault();
    const q = ward ? `?ward=${encodeURIComponent(ward)}` : "";
    location.href = "./" + q;
  });
  el("#goBack").addEventListener("click", ()=> history.length>1 ? history.back() : location.href="./");
// === ë©”ì‹œì§€ ì“°ê¸° ===
const roomRef = ref(db, "guestbook/messages");

async function sendMessage(){
  const text = (msgBox.value||"").trim();
  if(!text || !ward) return;

  const payload = { ward, text, ts: Date.now() };
  try{
    sendBtn.disabled = true;

    // 1) RTDBì— ì €ì¥
    await push(roomRef, { ...payload, ts_server: serverTimestamp() });

    // 2) ğŸ”” ì €ì¥ ì§í›„, ì›Œì»¤ë¡œ í‘¸ì‹œ ìš”ì²­ (ì—¬ê¸°ì— ë„£ìŠµë‹ˆë‹¤)
    const myUid = localStorage.getItem('pushUid') || '';
    const link  = location.origin + '/ë°©ëª…ë¡.html' + (ward ? ('?ward=' + encodeURIComponent(ward)) : '');
    fetch('https://YOUR_WORKER_SUBDOMAIN.workers.dev/notify-guest', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ward,
        name: `${ward}ë³‘ë™`,   // ì›í•˜ë©´ ë‹‰ë„¤ì„/ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ë„ ë¨
        text,
        link,
        excludeUid: myUid      // ë³¸ì¸ ê¸°ê¸°ë¡œëŠ” ì•Œë¦¼ ì•ˆ ì˜¤ê²Œ
      })
    }).catch(console.warn);

    // 3) UI ì •ë¦¬
    msgBox.value = "";
    refreshSendState();
    scrollBox.scrollTop = 0;
  }catch(err){
    alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
    console.warn(err);
    refreshSendState();
  }
}

  sendBtn.addEventListener("click", sendMessage);

  // === ë Œë”ë§(ë‚ ì§œ ê·¸ë£¹ ë‹¨ìœ„, ìµœì‹ ì´ í•­ìƒ ìœ„) ===
  const list = el("#chatList");
  const scrollBox = el("#chatScroll");
  const groups = new Map(); // dayKey -> <li.dayGroup>

  function isNearTop(){ return scrollBox.scrollTop <= 12; }

  function withStableScroll(renderFn){
    const nearTop = isNearTop();
    const prevH = scrollBox.scrollHeight;
    renderFn();
    if(nearTop){
      scrollBox.scrollTop = 0; // ë§¨ ìœ„ ê³ ì •
    }else{
      // ì‚¬ìš©ìê°€ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ ì¤‘ì´ë©´ í˜„ì¬ ê°€ì‹œ ìœ„ì¹˜ ìœ ì§€
      const diff = scrollBox.scrollHeight - prevH;
      scrollBox.scrollTop += diff;
    }
  }

  function getOrCreateGroup(day){
    let g = groups.get(day);
    if(g) return g;

    // ìƒˆ ê·¸ë£¹(ìµœì‹ ì´ ìœ„ë¡œ ìŒ“ì´ë„ë¡ í•­ìƒ ìµœìƒë‹¨ì— ì‚½ì…)
    g = document.createElement("li");
    g.className = "dayGroup";
    g.dataset.day = day;
    g.innerHTML = `
      <div class="daySep"><span class="badge">${day}</span></div>
      <ul class="msgs"></ul>
    `;
    list.insertBefore(g, list.firstChild);
    groups.set(day, g);
    return g;
  }

  function renderMessage({ward: w, text, ts}){
    const day = dayKey(ts);
    const group = getOrCreateGroup(day);
    const ul = group.querySelector(".msgs");

    const li = document.createElement("li");
    li.className = "msg";
    const who = (w && String(w).trim()) ? `${w}ë³‘ë™` : "ìµëª…";
    li.innerHTML = `
      <div class="line"><span class="from">${who}</span> : <span class="text">${escapeHTML(text)}</span></div>
      <div class="meta">${fmtTs(ts)}</div>
    `;

    // ë‚ ì§œ ë‚´ì—ì„œë„ ìµœì‹ ì´ ìœ„(ì•ìª½ì— ì‚½ì…)
    ul.insertBefore(li, ul.firstChild);
  }

  // === ì‹¤ì‹œê°„ êµ¬ë…(ìµœê·¼ 200ê°œ) ===
  const q = query(roomRef, limitToLast(200));
  onChildAdded(q, snap => {
    const v = snap.val()||{};
    const ts = v.ts || Date.now();

    withStableScroll(()=> renderMessage({ ward: v.ward, text: v.text||"", ts }));
  });

  // ìµœì´ˆ í¬ì»¤ìŠ¤
  msgBox.focus();
  // ì´ˆê¸° ìœ„ì¹˜ë¥¼ ìµœì‹ (ë§¨ ìœ„)ë¡œ
  scrollBox.scrollTop = 0;
</script>
</body>
</html>

