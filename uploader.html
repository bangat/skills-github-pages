<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- ▷▷▷ head 메타 시작 ▷▷▷ -->
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="color-scheme" content="light">
  <title>구매현황 엑셀 업로더</title>
  <!-- ▷▷▷ head 메타 종료 ▷▷▷ -->

  <!-- ▷▷▷ 전역 스타일 시작 ▷▷▷ -->
  <style>
    :root{
      color-scheme: light;
      --bg:#f4f7fb; --card:#fff; --text:#0f172a; --muted:#5b677a; --border:#e6eaf2; --accent:#2563eb;
      --r:14px; --shadow:0 10px 30px rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Apple SD Gothic Neo,sans-serif}
    .wrap{max-width:980px;margin:22px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    label{display:block;margin:12px 0 6px;color:#334155;font-weight:800}
    input[type="text"],select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    input[type="file"]{margin-top:6px}
    .btn{padding:10px 16px;border:none;border-radius:10px;background:linear-gradient(180deg,#4f83ff,#2563eb);color:#fff;font-weight:900;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .log{font-family:ui-monospace,Consolas,monospace;background:#0b1220;color:#bfe0ff;padding:12px;border-radius:10px;white-space:pre-wrap;min-height:160px}
    table{border-collapse:collapse;width:100%;margin-top:8px}
    th,td{border:1px solid var(--border);padding:6px 8px;font-size:12px}
    th{background:#f1f5fb}
    .ok{color:#16a34a} .err{color:#ef4444}
  </style>
  <!-- ▷▷▷ 전역 스타일 종료 ▷▷▷ -->

  <!-- ▷▷▷ 라이브러리 로드 시작 ▷▷▷ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- ▷▷▷ 라이브러리 로드 종료 ▷▷▷ -->
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>구매현황 엑셀 업로더</h1>
    <p style="margin:0 0 10px;color:#475569">엑셀(.xlsx)을 선택하면 브라우저에서 파싱해 <b>Firebase RTDB</b>로 바로 업로드합니다.</p>

    <!-- ▷▷▷ 입력 영역 시작 ▷▷▷ -->
    <div class="row">
      <div style="flex:1 1 240px">
        <label>Firebase Database URL</label>
        <input id="dbURL" type="text" placeholder="https://hallymlinen-default-rtdb.firebaseio.com">
      </div>
      <div style="flex:1 1 220px">
        <label>업로드 기준 경로</label>
        <input id="basePath" type="text" placeholder="/purchase/2025">
      </div>
      <div style="flex:1 1 220px">
        <label>엑셀 파일(.xlsx)</label>
        <input id="filePick" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
      </div>
      <div style="flex:0 0 auto">
        <button id="runBtn" class="btn" disabled>업로드 시작</button>
      </div>
    </div>
    <!-- ▷▷▷ 입력 영역 종료 ▷▷▷ -->

    <!-- ▷▷▷ 시트/미리보기 시작 ▷▷▷ -->
    <div id="sheetArea" style="margin-top:12px;display:none">
      <label>시트 선택</label>
      <select id="sheetSel"></select>
      <div id="preview"></div>
    </div>
    <!-- ▷▷▷ 시트/미리보기 종료 ▷▷▷ -->

    <label style="margin-top:14px">진행 로그</label>
    <div id="log" class="log"></div>
  </div>
</div>

<!-- ▷▷▷ 스크립트(엑셀 파싱 + RTDB 업로드) 시작 ▷▷▷ -->
<script>
/* ------------주석(helper-basic) 시작 ------------ */
const $ = s=>document.querySelector(s);
const logEl = $("#log");
const log = (m,cls='')=>{
  logEl.innerHTML += (cls?`<span class="${cls}">`:'') + m + (cls?'</span>':'') + "\n";
  logEl.scrollTop = logEl.scrollHeight;
};
const okInput = ()=> $("#dbURL").value.trim().startsWith("https://") && $("#basePath").value.trim().startsWith("/");
const updateBtn = ()=> $("#runBtn").disabled = !(okInput() && $("#filePick").files.length>0);
/* ------------주석(helper-basic) 종료 ------------ */

/* ------------주석(file-parse-xlsx) 시작 ------------ */
let workbook = null, sheetNames = [];
$("#filePick").addEventListener('change', async (e)=>{
  $("#preview").innerHTML = ""; $("#sheetArea").style.display = "none"; workbook=null; sheetNames=[];
  updateBtn();
  const f = e.target.files[0];
  if (!f) return;

  try{
    const buf = await f.arrayBuffer();
    workbook = XLSX.read(buf, { type:'array' });
    sheetNames = workbook.SheetNames || [];
    if (!sheetNames.length) { log("시트를 찾을 수 없습니다.", 'err'); return; }

    // 시트 셀렉트 채움
    const sel = $("#sheetSel");
    sel.innerHTML = sheetNames.map(n=>`<option value="${n}">${n}</option>`).join("");
    $("#sheetArea").style.display = "";
    renderPreview(sel.value);
    log(`엑셀 로드 성공: 시트 ${sheetNames.length}개`);
  }catch(err){
    log(`엑셀 파싱 실패: ${err}`, 'err');
  }
});
$("#sheetSel").addEventListener('change', ()=> renderPreview($("#sheetSel").value));

function renderPreview(name){
  const ws = workbook.Sheets[name];
  const json = XLSX.utils.sheet_to_json(ws, { defval:"" });
  const head = Object.keys(json[0]||{});
  const rows = json.slice(0,20);

  let html = `<table><thead><tr>${head.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>`;
  for (const r of rows){
    html += `<tr>${head.map(h=>`<td>${String(r[h])}</td>`).join("")}</tr>`;
  }
  html += `</tbody></table>`;
  $("#preview").innerHTML = html;
}
/* ------------주석(file-parse-xlsx) 종료 ------------ */

/* ------------주석(schema-map) 시작 ------------ */
// 컬럼 자동 인식(한국어/영문 공통 스펙)
function pick(obj, keys){ for (const k of keys){ if (obj[k]!==undefined && obj[k]!==null && String(obj[k]).trim()!=="") return obj[k]; } return ""; }
function mapRecord(r){
  const date = pick(r, ["날짜","입고일","발주일","date","입고","발주"]);
  const item = pick(r, ["품목","항목","item","name"]) || "_unknown";
  const qty  = pick(r, ["수량","입고수량","발주수량","qty","수량(개)"]) || r["수량(합계)"] || 0;

  const y = (String(date).match(/\b(20\d{2})\b/)||[])[1] || "unknownYear";
  const m = (String(date).match(/\b(0?[1-9]|1[0-2])\b/)||[])[1] || "unknownMonth";
  return { date:String(date), item:String(item), qty:Number(qty)||0, y, m, _raw:r };
}
function slug(s){ return String(s||'').trim().replace(/[./[\]#$\u0000-\u001F]/g,'_').replace(/\s+/g,'_').slice(0,120); }
/* ------------주석(schema-map) 종료 ------------ */

/* ------------주석(uploader-rest) 시작 ------------ */
// RTDB REST PATCH로 절대경로 업데이트
async function uploadSheet(sheetName, basePath){
  const ws = workbook.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
  const mapped = rows.map(mapRecord);

  const chunkSize = 500;
  let uploaded = 0;

  // root patch 엔드포인트
  const root = $("#dbURL").value.replace(/\/$/,'') + '/.json';

  for (let i=0; i<mapped.length; i+=chunkSize){
    const part = mapped.slice(i, i+chunkSize);
    const updates = {};
    for (const r of part){
      const key = `${slug(r.item)}_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
      const path = `${basePath}/${r.y}/${r.m}/${key}`;
      updates[path] = { item:r.item, qty:r.qty, date:r.date, _sheet:sheetName, _raw:r._raw };
    }
    const res = await fetch(root, {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(updates)
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(`PATCH 실패 ${res.status}: ${t}`);
    }
    uploaded += part.length;
    log(`+ ${sheetName}: ${uploaded}/${mapped.length} 업로드됨`);
  }
}
/* ------------주석(uploader-rest) 종료 ------------ */

/* ------------주석(run-handler) 시작 ------------ */
$("#dbURL").addEventListener('input', updateBtn);
$("#basePath").addEventListener('input', updateBtn);

$("#runBtn").addEventListener('click', async ()=>{
  if (!workbook) { log("엑셀을 먼저 선택하세요.", 'err'); return; }
  const base = $("#basePath").value.trim().replace(/\/+$/,'');
  if (!base.startsWith('/')) { log("업로드 기준 경로는 '/'로 시작해야 합니다.", 'err'); return; }

  // 보안 메모: 업로드 전에 RTDB 규칙에서 base 경로 쓰기 허용(임시), 업로드 후 다시 잠그세요.
  $("#runBtn").disabled = true; logEl.textContent = "";
  try{
    const names = sheetNames.length ? sheetNames : workbook.SheetNames;
    for (const name of names){
      await uploadSheet(name, base);
    }
    log(`[완료] 모든 시트 업로드 성공`, 'ok');
  }catch(e){
    log(String(e), 'err');
  }finally{
    $("#runBtn").disabled = false;
  }
});
updateBtn();
/* ------------주석(run-handler) 종료 ------------ */
</script>
<!-- ▷▷▷ 스크립트(엑셀 파싱 + RTDB 업로드) 종료 ▷▷▷ -->

</body>
</html>
