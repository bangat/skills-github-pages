<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë¦°ë„¨ì‹¤ ì¶œê³ ê´€ë¦¬</title>
<style>
  :root{ --bg:#f9fafb; --card:#ffffff; --accent:#2563eb; --muted:#6b7280; --text:#111827; --border:#e5e7eb; }
  *{box-sizing:border-box}
  html, body { -webkit-text-size-adjust: 100%; }
  body{margin:0;font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;background:var(--bg);color:var(--text)}
  /* ìƒë‹¨ íƒ€ì´í‹€ */
  .topTitle{
    text-align:center; font-size:22px; font-weight:800; padding:14px 0;
    border-bottom:1px solid var(--border); background:#fff; cursor:pointer;
    user-select:none;
  }
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
  .left{display:flex;gap:12px;align-items:center;flex-wrap:nowrap}
  .right{display:flex;gap:8px}
  label.head{font-weight:800;white-space:nowrap;margin-right:6px}
  select{padding:10px 12px;font-size:16px;border:1px solid var(--border);border-radius:12px;background:#fff}
  #wardSelect{width:170px}
  button{border:0;border-radius:12px;padding:10px 14px;font-size:15px;font-weight:700;cursor:pointer}
  .btn{background:#94a3b8;color:#fff}
  .btn.acc{background:var(--accent);color:#fff}
  main{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:18px 0 8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .tabs{display:flex;gap:8px;margin:12px 0}
  .tab{flex:1;text-align:center;padding:10px;background:#e5e7eb;color:#374151;font-weight:700;border-radius:12px;cursor:pointer}
  .tab.active{background:#2563eb;color:#fff}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden}
  th,td{border-bottom:1px solid var(--border);padding:12px;font-size:16px;text-align:center}
  td:first-child, th:first-child{text-align:left}
  .col-item{width:42%} .col-qty{width:58%}
  th.item-name, td.item-name{white-space:nowrap;word-break:keep-all;overflow:hidden;text-overflow:ellipsis}
  .qtyCell{display:flex;align-items:center;gap:6px;justify-content:flex-end;flex-wrap:nowrap}
  .chip{height:40px;min-width:40px;padding:0 10px;border:1px solid var(--border);background:#eef2f7;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-size:15px}
  .chip.reset{background:#ffe8ea;border-color:#ffd5da}
  .qtyCell input{width:76px;height:40px;text-align:center;font-size:16px;padding:0 6px;border:1px solid var(--border);border-radius:12px;background:#fff}
  input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  .empty{margin-top:20px;padding:20px;border:2px dashed var(--border);border-radius:16px;text-align:center;color:#6b7280}

  /* ===== í‘¸í„° ===== */
  .footerBar{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:12px;display:flex;justify-content:center;z-index:50}
  .footerCol{display:flex;flex-direction:column;gap:8px;align-items:stretch;justify-content:center;width:100%;max-width:980px}
  #saveAll{width:100%; font-size:18px; padding:12px 16px; border-radius:14px}
  #appDownloadBtn{width:100%; font-size:16px; padding:12px 16px; border-radius:12px; background:#6b7280}
  #saveAll, #appDownloadBtn{ display:block; }
  #exportXLSXBtn{ display:none; }

  /* ===== í†µê³„ í™”ë©´ ì „ìš© ===== */
  body.mode-stats header{display:none;}
  body.mode-stats #saveAll{ display:none; }
  body.mode-stats #appDownloadBtn{ display:none; }
  body.mode-stats #exportXLSXBtn{ display:block; width:100%; font-size:16px; padding:12px 16px; border-radius:12px }

  /* â˜… ì•±(WebView/PWA) í™˜ê²½ì—ì„  ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€ */
  body.app #appDownloadBtn{ display:none !important; }

  #sec-stats .row-wrap{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
  #sec-stats .row-wrap>*{flex:0 0 auto}
  #sec-stats .row-wrap.dates input[type=date]{flex:1 1 0; min-width:0; font-size:15px; padding:6px; border:1px solid var(--border); border-radius:12px; background:#fff}
  #sec-stats .row-wrap select{padding:8px 10px;border:1px solid var(--border);border-radius:12px}
  #statsWrap{overflow-x:hidden}

  .statsTable{ table-layout:fixed; border-collapse:collapse; width:100%; max-width:100vw; }
  .statsTable th, .statsTable td{
    padding:6px; text-align:center; border:1px solid var(--border);
    font-size:13px; line-height:1.05; font-variant-numeric:tabular-nums;
  }
  .statsTable th.firstCol{ width:50px; }
  .statsTable th.sumCol{   width:44px; }
  .statsTable th.rot{
    writing-mode: vertical-rl;
    text-orientation: upright;
    line-height:1;
    letter-spacing:0;
    white-space:nowrap;
    width:24px;
    padding:4px 2px;
  }

  @media (max-width:480px){
    .chip{min-width:34px;height:34px;font-size:14px;padding:0 8px}
    .qtyCell input{height:34px;width:68px;font-size:15px}
    th,td{padding:10px}
  }
</style>
</head>
<body>

<!-- âœ… í´ë¦­ ì‹œ ë©”ì¸ íƒ­ìœ¼ë¡œ ì´ë™í•˜ëŠ” ìƒë‹¨ íƒ€ì´í‹€ -->
<div id="gotoMain" class="topTitle">ë³‘ë™ ì¶œê³ ê´€ë¦¬</div>

<header>
  <div class="left">
    <label class="head" for="wardSelect">ë³‘ë™ëª…</label>
    <select id="wardSelect">
      <option value="">ì„ íƒâ€¦</option>
      <option>93</option><option>83</option><option>73</option><option>71</option>
      <option>63</option><option>62</option><option>61</option>
      <option>52</option><option>51</option><option>42</option><option>41</option>
      <option>ê¸°íƒ€</option>
    </select>
  </div>
  <div class="right">
    <button class="btn" id="gotoStats">í†µê³„</button>
  </div>
</header>

<main>
  <!-- ì…ë ¥ -->
  <section id="sec-input">
    <h1>
      <span style="display:flex;gap:10px;align-items:center">
        <label for="issueDate">ì¶œê³ ì¼</label>
        <input type="date" id="issueDate" />
      </span>
    </h1>

    <div class="tabs">
      <div class="tab active" data-cat="ì‹œíŠ¸">ì‹œíŠ¸</div>
      <div class="tab" data-cat="í™˜ìë³µ">í™˜ìë³µ</div>
      <div class="tab" data-cat="ê¸°íƒ€">ê¸°íƒ€</div>
    </div>

    <table id="inputTable" aria-label="í’ˆëª© ì…ë ¥ í‘œ">
      <colgroup><col class="col-item" /><col class="col-qty" /></colgroup>
      <thead><tr><th class="item-name">í’ˆëª©</th><th>ìˆ˜ëŸ‰</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- í†µê³„ -->
  <section id="sec-stats" style="display:none">
    <h1>ê¸°ê°„ í†µê³„</h1>

    <!-- ë‚ ì§œ -->
    <div class="row-wrap dates" style="margin-bottom:8px">
      <input type="date" id="dateStart" />
      <span aria-hidden="true">~</span>
      <input type="date" id="dateEnd" />
    </div>

    <!-- ë³‘ë™ -->
    <div class="row-wrap" style="margin-bottom:12px">
      <label for="wardFilter">ë³‘ë™</label>
      <select id="wardFilter">
        <option value="ì „ì²´">ì „ì²´</option>
        <option>93</option><option>83</option><option>73</option><option>71</option>
        <option>63</option><option>62</option><option>61</option>
        <option>52</option><option>51</option><option>42</option><option>41</option>
        <option>ê¸°íƒ€</option>
      </select>
    </div>

    <div id="statsWrap"></div>
    <div id="statsEmpty" class="empty" style="display:none">í•´ë‹¹ ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  </section>
</main>

<!-- í‘¸í„°: ë©”ì¸=ì œì¶œÂ·ì•± / í†µê³„=ì—‘ì…€ -->
<div class="footerBar">
  <div class="footerCol">
    <button class="btn acc" id="saveAll">ì œì¶œí•˜ê¸°</button>
    <button class="btn" id="appDownloadBtn">ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ë¡œë“œ</button>
    <button class="btn" id="exportXLSXBtn">ì—‘ì…€ë¡œ ë‚´ë ¤ë°›ê¸°</button>
  </div>
</div>

<!-- ì €ì¥ ì„±ê³µ íš¨ê³¼ìŒ -->
<audio id="submitSound" preload="auto"
  src="https://blog.kakaocdn.net/dna/nDY4i/dJMb9MW0NzU/AAAAAAAAAAAAAAAAAAAAAPx9B-3G2pvytNqx-vR3eYmHXaIga9OYo8N_ydqJ4RH2/%EC%A0%84%EC%86%A1.mp3?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1756652399&allow_ip=&allow_referer=&signature=NKOSow0S2fb7Q%2FBB560terQ0zko%3D&attach=1&knm=tfile.mp3">
</audio>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase (ì¸ì¦ ì—†ìŒ / ëˆ„êµ¬ë‚˜ ì½ê¸°/ì“°ê¸° ê·œì¹™ ê°€ì •) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, query, orderByChild, startAt, endAt, onValue, off } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
    authDomain: "hallymlinen.firebaseapp.com",
    databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
    projectId: "hallymlinen",
    storageBucket: "hallymlinen.appspot.com",
    messagingSenderId: "867775830688",
    appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
    measurementId: "G-T02ZFK18L3"
  };

  const app = initializeApp(firebaseConfig);
  const rtdb = getDatabase(app);

  /* === ê³µìš© ìœ í‹¸ === */
  function dayStart(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); }
  function dayEndInclusiveMs(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999).getTime(); }

  /* === ì €ì¥ === */
  async function saveLogsToRTDB(batchArray){
    const baseRef = ref(rtdb, "logs");
    await Promise.all(batchArray.map(d => push(baseRef, d)));
  }

  /* === ê¸°ê°„ êµ¬ë… (ì‹¤ì‹œê°„) === */
  let _liveRef = null, _liveCb = null;
  function startStatsLiveWatcher(startDate, endDateInclusive, onData){
    if (_liveRef && _liveCb){
      off(_liveRef, "value", _liveCb);
      _liveRef = null; _liveCb = null;
    }
    const sMs = dayStart(startDate);
    const eMs = dayEndInclusiveMs(endDateInclusive);
    const qy = query(ref(rtdb, "logs"), orderByChild("ts"), startAt(sMs), endAt(eMs));

    const cb = (snap)=>{
      const val = snap.val() || {};
      const arr = Object.keys(val).map(k => ({ id:k, ...val[k] }));
      onData(arr);
    };
    onValue(qy, cb);
    _liveRef = qy; _liveCb = cb;
  }

  // ë…¸ì¶œ(ì €ì¥/ì‹¤ì‹œê°„)
  window.__fb = { saveLogsToRTDB, startStatsLiveWatcher };
</script>

<!-- App Script -->
<script>
const APP_DOWNLOAD_URL = "https://github.com/bangat/linenward/releases/download/v1.0.0/ward.apk"; // í•„ìš” ì‹œ ì‹¤ì œ URLë¡œ êµì²´

/* â˜… í™˜ê²½ ê°ì§€: WebView/PWA ì¸ì§€ íŒë³„ */
function isAppEnv(){
  const ua = (navigator.userAgent||"") + " " + (navigator.vendor||"");
  // PWA ìŠ¤íƒ ë“œì–¼ë¡ 
  const isStandalonePWA =
    (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
    (window.navigator && window.navigator.standalone === true); // iOS

  // ì•ˆë“œë¡œì´ë“œ WebView í”ì : ; wv í† í°, Headless ëŸ°íƒ€ì„, í•˜ì´ë¸Œë¦¬ë“œ í”„ë ˆì„ì›Œí¬ UA
  const isAndroidWebView =
    /\b; wv\b/i.test(ua) || /\bVersion\/\d+\.\d+ Chrome\/\d+.* Mobile Safari\/\d+/i.test(ua) ||
    /\bCordova\b|\bCrosswalk\b|\bwv\b/i.test(ua);

  // ì„ íƒ: ì»¤ìŠ¤í…€ UAê°€ ê°€ëŠ¥í•˜ë©´ ì—¬ê¸° í‚¤ì›Œë“œ ì¶”ê°€ (ì˜ˆ: MyLinenApp)
  const isCustomUA = /\bMyLinenApp\b/i.test(ua);

  // ê°•ì œ ìŠ¤ìœ„ì¹˜ (?app=1 ì €ì¥ / localStorage)
  const forced = localStorage.getItem('appMode') === '1';

  return isStandalonePWA || isAndroidWebView || isCustomUA || forced;
}

/* í’ˆëª© */
const ITEMS={
  "ì‹œíŠ¸":["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ê±´"],
  "í™˜ìë³µ":["ì¼ë°˜ìƒì˜","ì¼ë°˜í•˜ì˜","ì •í˜•ìƒì˜","ì •í˜•í•˜ì˜"],
  "ê¸°íƒ€":["ì–µì œëŒ€","ì–¼ìŒí¬","ê¸°íƒ€"]
};
const COLORED_ITEMS = new Set(["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ê±´"]);
const ALL_ITEMS = Object.values(ITEMS).flat();
const WARDS=["93","83","73","71","63","62","61","52","51","42","41","ê¸°íƒ€"];

const LS={ ward:"linen/ward", logs:"linen/logs", draft:(ward)=>`linen/draft/${ward||'_none_'}` };
let state={ ward:localStorage.getItem(LS.ward)||"", section:"input", cat:"ì‹œíŠ¸" };
const el=s=>document.querySelector(s), els=s=>Array.from(document.querySelectorAll(s));

function vibrateOnce(ms=1000){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(_){} }

function rangeMsByDates(startStr, endStr){
  const sParts = startStr.split("-").map(Number);
  const eParts = endStr.split("-").map(Number);
  let s = new Date(sParts[0], sParts[1]-1, sParts[2], 0,0,0,0);
  let e = new Date(eParts[0], eParts[1]-1, eParts[2], 23,59,59,999);
  if(e.getTime() < s.getTime()){ const tmp=s; s=e; e=tmp; }
  return [s.getTime(), e.getTime()+1];
}

function getLogs(){ return JSON.parse(localStorage.getItem(LS.logs)||"[]"); }
function setLogs(a){ localStorage.setItem(LS.logs, JSON.stringify(a)); }
function getDraft(){ try{ return JSON.parse(localStorage.getItem(LS.draft(state.ward))||"{}"); }catch(_){ return {}; } }
function setDraft(obj){ localStorage.setItem(LS.draft(state.ward), JSON.stringify(obj||{})); }
function setDraftQty(item, qty){ const d=getDraft(); d[item]=Math.max(0, qty|0); setDraft(d); }
function getDraftQty(item){ const d=getDraft(); return Math.max(0, parseInt(d[item]||0) || 0); }

/* ì…ë ¥ í…Œì´ë¸” */
function buildTable(){
  const tb = el("#inputTable tbody");
  tb.innerHTML = "";

  ITEMS[state.cat].forEach(name=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="item-name">${name}</td>
      <td class="qtyCell">
        <button type="button" class="chip reset" data-reset>ë¦¬ì…‹</button>
        <button type="button" class="chip" data-delta="-1">âˆ’1</button>
        <input type="number" inputmode="numeric" min="0" value="0" aria-label="${name} ìˆ˜ëŸ‰"/>
        <button type="button" class="chip" data-delta="+1">ï¼‹1</button>
        <button type="button" class="chip" data-delta="+5">ï¼‹5</button>
      </td>`;

    const inp = tr.querySelector("input");
    const draftVal = getDraftQty(name);

    if (draftVal > 0) {
      inp.value = String(draftVal);
    } else if (COLORED_ITEMS.has(name)) {
      inp.value = "10";
      setDraftQty(name, 10);
    } else {
      inp.value = "0";
    }
    inp.dataset.prev = String(parseInt(inp.value || "0") || 0);

    // ìˆ˜ê¸° ì…ë ¥
    inp.addEventListener("input", ()=>{
      const prev = parseInt(inp.dataset.prev || "0") || 0;
      const cur = Math.max(0, parseInt(inp.value || "0") || 0);
      inp.value = String(cur);
      setDraftQty(name, cur);
      if (state.cat === "ì‹œíŠ¸" && COLORED_ITEMS.has(name) && prev <= 20 && cur > 20) {
        vibrateOnce(1000);
      }
      inp.dataset.prev = String(cur);
    });

    // +/âˆ’ ë²„íŠ¼
    tr.querySelectorAll("[data-delta]").forEach(btn=>{
      btn.onclick = ()=>{
        const prev = parseInt(inp.dataset.prev || "0") || 0;
        const delta = btn.dataset.delta === "-1" ? -1 : (btn.dataset.delta === "+1" ? 1 : 5);
        const v = Math.max(0, (parseInt(inp.value || "0") || 0) + delta);
        inp.value = v;
        setDraftQty(name, v);
        if (state.cat === "ì‹œíŠ¸" && COLORED_ITEMS.has(name) && prev <= 20 && v > 20) {
          vibrateOnce(1000);
        }
        inp.dataset.prev = String(v);
      };
    });

    // ë¦¬ì…‹
    tr.querySelector("[data-reset]").onclick = ()=>{
      inp.value = "0";
      setDraftQty(name, 0);
      inp.dataset.prev = "0";
    };

    tb.appendChild(tr);
  });

  // ğŸ”» ê¸°íƒ€ íƒ­ ì•ˆë‚´ ë¬¸êµ¬(í…ìŠ¤íŠ¸ë§Œ)
  if (state.cat === "ê¸°íƒ€") {
    const noteRow = document.createElement("tr");
    noteRow.innerHTML = `
      <td colspan="2" style="text-align:left; padding:12px; font-size:14px; color:#6b7280;">
        ê¸°íƒ€í’ˆëª© : ê³ ê´€ì ˆ, ì¤‘í™˜ì˜, í•œìª½ëˆ, ì–‘ìª½ëˆ
      </td>`;
    tb.appendChild(noteRow);
  }
}


/* ì €ì¥ (RTDB ì—…ë¡œë“œ ì„±ê³µ ì‹œ ë¡œì»¬ ìë™ ì •ë¦¬) */
async function saveAll(){
  if(!state.ward){ alert("ë³‘ë™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }

  // ì¶œê³ ì¼(ì—†ìœ¼ë©´ ì˜¤ëŠ˜)
  const issue = el("#issueDate").value;
  let ts;
  if(issue){
    const [y,m,d] = issue.split("-").map(Number);
    ts = new Date(y, m-1, d, 12, 0, 0, 0).getTime(); // ì„ íƒì¼ 12:00
  }else{
    ts = Date.now();
  }

  const draft = getDraft();
  const batch = [];
  ALL_ITEMS.forEach(item=>{
    const qty = Math.max(0, parseInt(draft[item]||"0") || 0);
    if(qty>0) batch.push({ ts, yyyymm: new Date(ts).toISOString().slice(0,7), ward: state.ward, item, qty });
  });
  if(batch.length===0){ alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ 0)"); return; }

  // ë¡œì»¬ ì„ ê¸°ë¡
  const logs = getLogs(); batch.forEach(b=> logs.unshift(b)); setLogs(logs.slice(0, 10000));

  // RTDB ì—…ë¡œë“œ
  let rtdbOK = false;
  try {
    if(window.__fb){
      await window.__fb.saveLogsToRTDB(batch);
      rtdbOK = true;
    }
  } catch(e){
    console.warn("RTDB ì—…ë¡œë“œ ì‹¤íŒ¨ -> ë¡œì»¬ë§Œ ì €ì¥", e);
  }

  // ì—…ë¡œë“œ ì„±ê³µ ì‹œ: ì´ë²ˆ ë°°ì¹˜ë¥¼ ë¡œì»¬ì—ì„œ ì œê±°(ì¤‘ë³µ ë°©ì§€)
  if (rtdbOK) {
    const cur = getLogs();
    const keyOf = L => [L.ts, L.ward, L.item, L.qty].join("|");
    const removeSet = new Set(batch.map(keyOf));
    const cleaned = cur.filter(L => !removeSet.has(keyOf(L)));
    setLogs(cleaned);
  }

  // ì…ë ¥ê°’ ì´ˆê¸°í™”
  const cleared = {}; ALL_ITEMS.forEach(i=> cleared[i]=0); setDraft(cleared);
  els("#inputTable tbody input").forEach(inp=> { inp.value="0"; inp.dataset.prev="0"; });

  // íš¨ê³¼ìŒ
  const snd = el("#submitSound");
  snd && snd.play().catch(err=>console.warn("ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨:", err));

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

  /* ğŸ”„ ì œì¶œ ì§í›„ í†µê³„ ì¦‰ì‹œ ë°˜ì˜: ì €ì¥í•œ ì¶œê³ ì¼ë¡œ ê°•ì œ ë™ê¸°í™” */
  if (document.body.classList.contains("mode-stats")) {
    const savedDate = new Date(ts).toISOString().slice(0,10);
    el("#dateStart").value = savedDate;
    el("#dateEnd").value   = savedDate;
    await renderStats(); // êµ¬ë…ë„ í•´ë‹¹ ë²”ìœ„ë¡œ ì¬ì‹œì‘
  }
}

/* í†µê³„ ìƒ‰ìƒ */
function colorStyle(item, value){
  if(!COLORED_ITEMS.has(item)) return "";
  const v = Number(value)||0;
  if(v>=20) return ' style="color:#dc2626;font-weight:700"';
  if(v>=15) return ' style="color:#2563eb;font-weight:700"';
  if(v===10) return ' style="color:#f59e0b;font-weight:700"';
  return "";
}

/* í”¼ë²— */
function pivotFromLogsRange(logs, startStr, endStr, wardFilter){
  const [s,e] = rangeMsByDates(startStr, endStr);
  const selected = logs.filter(L => L.ts>=s && L.ts<e && (wardFilter==="ì „ì²´" || L.ward===wardFilter));
  const p={}; const wardList = (wardFilter==="ì „ì²´")? WARDS : WARDS.filter(w=>w===wardFilter);
  wardList.forEach(w=>p[w]={}); ALL_ITEMS.forEach(i=> wardList.forEach(w=> p[w][i]=0));
  selected.forEach(L=>{
    if(!(L.ward in p)) p[L.ward]={};
    if(typeof p[L.ward][L.item]!=="number") p[L.ward][L.item]=0;
    p[L.ward][L.item]+=Number(L.qty)||0;
  });
  return {pivot:p, wards: wardList};
}

/* í†µê³„ ë Œë”: RTDB ì‹¤ì‹œê°„ + ë¡œì»¬ ë³‘í•© */
async function renderStats(){
  const todayStr = new Date().toISOString().slice(0,10);
  const s = el("#dateStart").value || todayStr;
  const e = el("#dateEnd").value   || todayStr;
  const wardFilter = el("#wardFilter").value || "ì „ì²´";
  if(!s || !e){ return; }

  if (window.__fb && typeof window.__fb.startStatsLiveWatcher === "function") {
    window.__fb.startStatsLiveWatcher(new Date(s+"T00:00:00"), new Date(e+"T00:00:00"), (logsRT)=>{
      const [sMs, eMs] = rangeMsByDates(s, e);

      // ë¡œì»¬ ë¡œê·¸(ê°™ì€ ê¸°ê°„)
      let logsLS = [];
      try {
        logsLS = getLogs().filter(L => L.ts>=sMs && L.ts<eMs);
      } catch {}

      // ë³‘í•©(ì¤‘ë³µ í‚¤ ì œê±°)
      const uniq = new Map();
      [...logsRT, ...logsLS].forEach(L=>{
        const key = [L.ts, L.ward, L.item, L.qty].join("|");
        if(!uniq.has(key)) uniq.set(key, L);
      });
      const mergedLogs = Array.from(uniq.values());

      // í”¼ë²— & ë Œë”
      const {pivot, wards} = pivotFromLogsRange(mergedLogs, s, e, wardFilter);
      const items=ALL_ITEMS;

      let html=`<table class="statsTable"><thead><tr>
        <th class="firstCol">ë³‘ë™</th>
        ${items.map(i=>`<th class="rot">${i}</th>`).join("")}
        <th class="sumCol">í•©ê³„</th>
      </tr></thead><tbody>`;

      let grand=0;
      wards.forEach(w=>{
        let sum=0; 
        const cells=items.map(i=>{
          const v=(pivot[w]?.[i])||0; 
          sum+=v; 
          return `<td${colorStyle(i, v)}>${v}</td>`;
        }).join("");
        grand+=sum; 
        html+=`<tr><td>${w}</td>${cells}<td><b>${sum}</b></td></tr>`;
      });

      const itemTotals = items.map(i=>wards.reduce((a,w)=>a+(pivot[w]?.[i]||0),0));
      html+=`<tr><th>í•©ê³„</th>${itemTotals.map((sv,idx)=>`<th${colorStyle(items[idx], sv)}>${sv}</th>`).join("")}<th>${grand}</th></tr>`;
      html+="</tbody></table>";
      el("#statsWrap").innerHTML=html;
      el("#statsEmpty").style.display = grand ? "none" : "block";
    });
  }
}

/* .xlsx ë‚´ë³´ë‚´ê¸° */
function exportXLSX(){
  const table = document.querySelector("#statsWrap table");
  if(!table){ alert("í†µê³„ í‘œê°€ ì—†ìŠµë‹ˆë‹¤. í†µê³„ í™”ë©´ì—ì„œ ë‚ ì§œ/ë³‘ë™ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
  const s = el("#dateStart").value || "";
  const e = el("#dateEnd").value || "";
  const wb = XLSX.utils.table_to_book(table, {sheet:"í†µê³„"});
  XLSX.writeFile(wb, `stats_${s}_to_${e}.xlsx`);
}

/* ìœ í‹¸: ë””ë°”ìš´ìŠ¤ */
function debounce(fn, delay=200){
  let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), delay); };
}

/* ì´ˆê¸°í™” */
window.addEventListener("DOMContentLoaded",()=>{
  /* â˜… ì•± ëª¨ë“œ ê°•ì œ í† ê¸€ (?app=1 / ?app=0) */
  const urlApp = new URL(location.href).searchParams.get("app");
  if(urlApp === "1"){ localStorage.setItem("appMode", "1"); }
  if(urlApp === "0"){ localStorage.removeItem("appMode"); }

  /* â˜… ì•± í™˜ê²½ì´ë©´ bodyì— .app í´ë˜ìŠ¤ ë¶€ì—¬ & ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€ */
  if(isAppEnv()){
    document.body.classList.add("app");
    const btn = el("#appDownloadBtn");
    if(btn) btn.style.display = "none";
  }

  // ë³‘ë™ ìºì‹±
  const urlWard=new URL(location.href).searchParams.get("ward");
  if(urlWard){ state.ward=urlWard; localStorage.setItem(LS.ward,state.ward); }
  el("#wardSelect").value = state.ward;
  el("#wardSelect").onchange = e=>{ state.ward = e.target.value || ""; localStorage.setItem(LS.ward, state.ward); buildTable(); };

  // ì˜¤ëŠ˜ ë””í´íŠ¸
  const d=new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  el("#issueDate").value = `${yyyy}-${mm}-${dd}`;
  el("#dateStart").value = `${yyyy}-${mm}-${dd}`;
  el("#dateEnd").value   = `${yyyy}-${mm}-${dd}`;

  // í‘œ/ë²„íŠ¼
  buildTable();
  el("#saveAll").onclick = saveAll;
  el("#exportXLSXBtn").onclick = exportXLSX;

  // ì•± ë‹¤ìš´ë¡œë“œ
  el("#appDownloadBtn").onclick = ()=> {
    if(APP_DOWNLOAD_URL && APP_DOWNLOAD_URL.startsWith("http")){
      window.location.href = APP_DOWNLOAD_URL;
    }else{
      alert("ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. APP_DOWNLOAD_URL ê°’ì„ ìˆ˜ì •í•˜ì„¸ìš”.");
    }
  };

  // í†µê³„ë¡œ ì´ë™
  el("#gotoStats").onclick = ()=> {
    document.body.classList.add("mode-stats");
    el("#sec-input").style.display="none";
    el("#sec-stats").style.display="block";
    // ì¶œê³ ì¼ì„ í†µê³„ ê¸°ê°„ìœ¼ë¡œ ìë™ ì„¤ì •
    const chosen = el("#issueDate").value || new Date().toISOString().slice(0,10);
    el("#dateStart").value = chosen;
    el("#dateEnd").value   = chosen;
    renderStats();
  };

  // âœ… ìƒë‹¨ íƒ€ì´í‹€ í´ë¦­ â†’ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
  el("#gotoMain").onclick = ()=>{
    document.body.classList.remove("mode-stats");
    el("#sec-input").style.display="block";
    el("#sec-stats").style.display="none";
  };

  // íƒ­
  els(".tab").forEach(t=> t.onclick=()=>{
    state.cat = t.dataset.cat;
    els(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    buildTable();
  });

  // í†µê³„ ìë™ ë°˜ì˜(ë‚ ì§œ/ë³‘ë™ ë³€ê²½ ì‹œ)
  const rerender = debounce(renderStats, 200);
  ["#dateStart","#dateEnd","#wardFilter"].forEach(sel=>{
    const node = el(sel);
    node && node.addEventListener("change", rerender);
    node && node.addEventListener("input", rerender);
  });
});
</script>
</body>
</html>