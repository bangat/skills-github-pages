<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <title>Ìå°Ìå°Í≤åÏûÑ</title>
  <style>
    body {
      margin: 0;
      background: #fdfdfd;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      user-select: none;
      position: relative;
    }
    /* ====== Í≥µÌÜµ ÏãúÏûëÌôîÎ©¥ ====== */
    #start-screen {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      user-select: none;
    }
    #start-screen button {
      padding: 16px 48px;
      font-size: 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #3399ff;
      color: #fff;
      box-shadow: 0 0 20px #3399ff;
    }
    #start-screen button + button {
      margin-top: 12px;
    }
    #start-screen button:hover {
      background: #2288ee;
    }

    /* ====== Ìå°Ìå°Í≤åÏûÑ ÏòÅÏó≠ ====== */
    .timer-bar {
      width: 90vw;
      height: 30px;
      background: rgba(0,0,0,0.1);
      border-radius: 15px;
      margin: 12px 0;
      position: relative;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2);
      display: none;
    }
    .timer-fill {
      position: absolute;
      height: 100%;
      background: #3399ff;
      border-radius: 15px;
      width: 100%;
      transition: width 1s linear;
    }
    .timer-text {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 0;
      font-size: 20px;
      line-height: 30px;
      font-weight: 600;
      color: #004c99;
      pointer-events: none;
      text-shadow: 0 0 2px #ddd;
    }
    .board {
      position: relative;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 6px;
      max-width: 90vw;
      max-height: 90vh;
      margin: 0 auto;
      user-select: none;
      display: none;
    }
    .tile {
      background-color: #ffffff;
      border: 2px solid #ccc;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      width: 100%;
      height: 100%;
      user-select: none;
      overflow: hidden;
    }
    .tile img {
      width: 80%;
      height: 80%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
      border-radius: 10px;
      transition: transform 0.1s ease;
    }
    .tile.selected {
      transform: scale(1.15);
      box-shadow: 0 0 15px #3399ff;
      z-index: 2;
    }
    .gameover {
      position: absolute;
      top: 40%;
      text-align: center;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 20px 40px;
      box-shadow: 0 0 20px #3399ff;
      font-size: 24px;
      color: #333;
      z-index: 100;
      user-select: none;
      display: none;
    }
    .gameover button {
      margin-top: 12px;
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      background: #3399ff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ====== ÎçîÌïòÍ∏∞ Í≤åÏûÑ(Í∞ôÏù¥ÌïòÍ∏∞) ÏòÅÏó≠ ====== */
    #math-mode {
      position: absolute;
      inset: 0;
      background: #fafafa;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      overflow-y: auto;
    }
    #math-problem {
      font-size: 2.5rem;
      margin: 20px 0;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    #math-status {
      margin: 12px 0;
      min-height: 1.5em;
      font-size: 1.2rem;
      text-align: center;
    }
    #math-scoreBox {
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: #444;
      text-align: center;
    }
    #math-startBtn, #math-backBtn {
      width: 100%;
      background: #4CAF50;
      color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    #math-backBtn {
      background: #777;
      margin-top: 5px;
    }
    #math-startBtn:hover {
      background: #45a049;
    }
    .number-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .num-btn {
      background: #f0f0f0;
      font-size: 1.3rem;
      border: 2px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .num-btn:hover {
      background: #ddd;
    }
    .correct { color: #4CAF50; font-weight: bold; }
    .wrong { color: #f44336; font-weight: bold; }
  </style>
</head>
<body>
  <!-- ÏãúÏûë ÌôîÎ©¥ -->
  <div id="start-screen">
    <button id="start-button">ÌòºÏûêÌïòÍ∏∞</button>
    <button id="multi-button">Í∞ôÏù¥ÌïòÍ∏∞</button>
  </div>

  <!-- Ìå°Ìå°Í≤åÏûÑ (ÌòºÏûêÌïòÍ∏∞) UI -->
  <div class="timer-bar">
    <div class="timer-fill" id="timer-fill"></div>
    <div class="timer-text" id="timer-text">90Ï¥à</div>
  </div>
  <div class="board" id="board"></div>
  <div id="gameover" class="gameover">
    <div id="gameover-text">Í≤åÏûÑÏò§Î≤Ñ</div>
    <button id="restart-button">Îã§Ïãú ÏãúÏûë</button>
  </div>

  <!-- Í∞ôÏù¥ÌïòÍ∏∞: ÎçîÌïòÍ∏∞ Í≤åÏûÑ (ÏùåÏÑ±Ïù∏Ïãù + Î≤ÑÌäº ÏÑ†ÌÉù) -->
  <div id="math-mode">
    <div id="math-problem">ÏãúÏûë Î≤ÑÌäºÏùÑ ÎàåÎü¨Î≥¥ÏÑ∏Ïöî.</div>
    <div id="math-status"></div>
    <div id="math-scoreBox">Ï†êÏàò: <span id="math-score">0</span></div>
    <button id="math-startBtn">Í≤åÏûÑ ÏãúÏûë</button>
    <button id="math-backBtn">‚Üê Î©îÏù∏ÏúºÎ°ú</button>
    <div class="number-grid" id="math-numberGrid"></div>
  </div>

  <!-- Ìö®Í≥ºÏùå -->
  <audio id="match-sound" src="https://blog.kakaocdn.net/dn/sfC9c/btsOsytKxVK/NssSFFb6HyZMrSALw78pS0/%EC%A1%B0%ED%95%A9%EC%84%B1%EA%B3%B5.mp3?attach=1&knm=tfile.mp3" preload="auto"></audio>
  <audio id="gameover-sound" src="https://blog.kakaocdn.net/dn/buAhnr/btsOsP26Zg7/mh0rQhx79hXkMjbm9haFdk/gameover.mp3?attach=1&knm=tfile.mp3" preload="auto"></audio>

<script>
/* =========================================================
   Ìå°Ìå°Í≤åÏûÑ (ÌòºÏûêÌïòÍ∏∞)
   ========================================================= */
const images = [
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbB2Nbp%2FbtsOtII3ACz%2FIJDpkiIGzyQgSkt32877f0%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FrWL76%2FbtsOslIhSXm%2F3jbQlb7JoeDTLCgWnn4ooK%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fdrqou1%2FbtsOsln3jNp%2FaBzqIgKorGcVvw3UkGi4J1%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FGk7Sn%2FbtsOsf88LKD%2F7oIF6fjz9lGGvFNJY5Bc70%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fu8HL0%2FbtsOrvrsSbI%2FLougpJ0miZtEiWhD7XAjy1%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fd4sIF5%2FbtsOrBrFNbx%2FvbXXdahRLfOcJF0PXggWX0%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fbtj3Xz%2FbtsOslasSQR%2FJOE9uKB1BfueEosEtMsHTk%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FtWqKG%2FbtsOrUkd4we%2FkKVsC2sxzTnISUBMIcCr30%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcvJc5M%2FbtsOsEgwiML%2FEl5pgFf2TeE3t3ebkT8ULK%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FF6GlQ%2FbtsOsixrT0H%2FuATRLDw9mVN0BjaWhoMuq1%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fn5t3U%2FbtsOtg0yJ08%2FnwYXUhv8aHXS9k8KnROk00%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FBFvG5%2FbtsOsDBTT3x%2Fe4VurtKk9EKU1G10z9xLOK%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fl0nlA%2FbtsOrWvyWCK%2FSjSJX70GbKAGaFaSSbuqK1%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fb0Kris%2FbtsOs4eKlqv%2FVYZD1KAMtY2fHgCKrFu42K%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fdqhr5h%2FbtsOqRBq2PN%2Fmy8eXFoZiYe8pGNJG0pM4k%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2F0cKaC%2FbtsOr1QO0BQ%2FERHrOAlbaHZAQADKcYIH61%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FDJoAa%2FbtsOr6khRdw%2F1lcbOWsKkEmhrS5eVF4wAK%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FOz4VW%2FbtsOs1I42zk%2F9eJtADOxtBYU6qUUOvCH0K%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbXJ8Tv%2FbtsOr2ChT1P%2FieszL5E3pHwWNpJjhEpj91%2Fimg.png',
  'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FphiZr%2FbtsOslIifmg%2FTeQSjpm4k6GY17k6QgM4e1%2Fimg.png'
];

const board = document.getElementById('board');
const timerBar = document.querySelector('.timer-bar');
const timerFill = document.getElementById('timer-fill');
const timerText = document.getElementById('timer-text');
const gameoverElem = document.getElementById('gameover');
const gameoverText = document.getElementById('gameover-text');
const restartButton = document.getElementById('restart-button');
const startScreen = document.getElementById('start-screen');
const startButton = document.getElementById('start-button');
const multiButton = document.getElementById('multi-button');
const matchSound = document.getElementById('match-sound');
const gameoverSound = document.getElementById('gameover-sound');

const ROWS = 10;
const COLS = 5;
const TOTAL_CELLS = ROWS * COLS; // 50
const EMPTY_CELLS = 0;
const TILE_COUNT = TOTAL_CELLS - EMPTY_CELLS;

let tiles = [];
let selectedTile = null;
let timer = 90;
let timerId = null;
let gameStarted = false;

function generateTiles() {
  tiles = new Array(TOTAL_CELLS).fill(-1);

  const pairsCount = Math.floor(Math.random() * 4) + 3; // 3~6Ïåç
  const totalPairs = TILE_COUNT / 2; // 25Ïåç

  const adjacentPairs = [];
  for (let i = 0; i < pairsCount; i++) {
    adjacentPairs.push(Math.floor(Math.random() * images.length));
  }

  const otherPairs = [];
  for (let i = 0; i < totalPairs - pairsCount; i++) {
    otherPairs.push(Math.floor(Math.random() * images.length));
  }

  const possiblePositions = [];
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const idx = r * COLS + c;
      if (c < COLS - 1) possiblePositions.push([idx, idx + 1]);     // Í∞ÄÎ°ú
      if (r < ROWS - 1) possiblePositions.push([idx, idx + COLS]);  // ÏÑ∏Î°ú
    }
  }

  for (let i = possiblePositions.length -1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [possiblePositions[i], possiblePositions[j]] = [possiblePositions[j], possiblePositions[i]];
  }

  const usedPositions = new Set();
  let adjacentPlaced = 0;
  for (let i = 0; i < possiblePositions.length && adjacentPlaced < pairsCount; i++) {
    const [pos1, pos2] = possiblePositions[i];
    if (!usedPositions.has(pos1) && !usedPositions.has(pos2)) {
      tiles[pos1] = adjacentPairs[adjacentPlaced];
      tiles[pos2] = adjacentPairs[adjacentPlaced];
      usedPositions.add(pos1);
      usedPositions.add(pos2);
      adjacentPlaced++;
    }
  }

  const emptyPositions = [];
  for (let i = 0; i < TOTAL_CELLS; i++) {
    if (tiles[i] === -1) emptyPositions.push(i);
  }

  let pairIdx = 0;
  for (let i = 0; i < emptyPositions.length; i += 2) {
    const imgIndex = otherPairs[pairIdx];
    tiles[emptyPositions[i]] = imgIndex;
    tiles[emptyPositions[i + 1]] = imgIndex;
    pairIdx++;
  }

  // Ï†ÑÏ≤¥ ÏÖîÌîå (Ïù∏Ï†ëÏåç Ïú†ÏßÄ x, ÎÇúÏù¥ÎèÑ‚Üë)
  for (let i = tiles.length -1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
  }
}

function renderBoard() {
  board.innerHTML = '';
  for (let i = 0; i < TOTAL_CELLS; i++) {
    const tileDiv = document.createElement('div');
    tileDiv.classList.add('tile');
    tileDiv.dataset.index = i;
    if (tiles[i] === -1) {
      tileDiv.style.visibility = 'hidden';
    } else {
      const img = document.createElement('img');
      img.src = images[tiles[i]];
      tileDiv.appendChild(img);
    }
    board.appendChild(tileDiv);
  }
}

function deselectTile() {
  if (selectedTile !== null) {
    selectedTile.classList.remove('selected');
    selectedTile = null;
  }
}

function checkClear() {
  for (let i = 0; i < tiles.length; i++) {
    if (tiles[i] !== -1) return false;
  }
  return true;
}

function onTileClick(e) {
  if (!gameStarted) return;
  const target = e.currentTarget;
  const idx = Number(target.dataset.index);
  if (tiles[idx] === -1) return;

  if (selectedTile === null) {
    selectedTile = target;
    selectedTile.classList.add('selected');
  } else if (selectedTile === target) {
    deselectTile();
  } else {
    const idx1 = Number(selectedTile.dataset.index);
    const idx2 = idx;
    if (tiles[idx1] === tiles[idx2]) {
      tiles[idx1] = -1;
      tiles[idx2] = -1;
      selectedTile.style.visibility = 'hidden';
      target.style.visibility = 'hidden';
      matchSound.currentTime = 0;
      matchSound.play();
      deselectTile();
      if (checkClear()) endGame(true);
    } else {
      deselectTile();
    }
  }
}

function startTimer() {
  timer = 90;
  timerFill.style.width = '100%';
  timerText.textContent = `${timer}Ï¥à`;

  timerId = setInterval(() => {
    timer--;
    timerFill.style.width = `${(timer / 90) * 100}%`;
    timerText.textContent = `${timer}Ï¥à`;
    if (timer <= 0) {
      clearInterval(timerId);
      endGame(false);
    }
  }, 1000);
}

function endGame(isClear) {
  gameStarted = false;
  clearInterval(timerId);
  gameoverElem.style.display = 'block';
  if (isClear) {
    gameoverText.textContent = 'üéâ ÌÅ¥Î¶¨Ïñ¥! üéâ';
  } else {
    gameoverText.textContent = '‚è∞ ÏãúÍ∞Ñ Ï¢ÖÎ£å! Í≤åÏûÑÏò§Î≤Ñ';
    gameoverSound.currentTime = 0;
    gameoverSound.play();
  }
}

function resizeBoard() {
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const cols = COLS;
  const rows = ROWS;
  const gap = 6;

  const boardRatio = cols / rows;
  const viewportRatio = vw / vh;

  let boardWidth, boardHeight;
  if (viewportRatio > boardRatio) {
    boardHeight = vh * 0.9;
    boardWidth = boardHeight * boardRatio;
  } else {
    boardWidth = vw * 0.9;
    boardHeight = boardWidth / boardRatio;
  }

  board.style.width = `${boardWidth}px`;
  board.style.height = `${boardHeight}px`;
}

function startPangPangGame() {
  // Ìå°Ìå° Î≥¥Ïù¥Í∏∞, ÏàòÌïô Í≤åÏûÑ Ïà®Í∏∞Í∏∞
  document.getElementById('math-mode').style.display = 'none';
  startScreen.style.display = 'none';
  board.style.display = 'grid';
  timerBar.style.display = 'block';
  gameoverElem.style.display = 'none';

  generateTiles();
  renderBoard();
  deselectTile();

  gameStarted = true;
  startTimer();

  window.addEventListener('resize', resizeBoard);
  resizeBoard();
}

/* Ïù¥Î≤§Ìä∏ Îì±Î°ù (Ìå°Ìå°) */
board.addEventListener('click', (e) => {
  if (e.target.classList.contains('tile') || e.target.parentElement.classList.contains('tile')) {
    const tile = e.target.classList.contains('tile') ? e.target : e.target.parentElement;
    onTileClick({ currentTarget: tile });
  }
});
restartButton.addEventListener('click', startPangPangGame);
startButton.addEventListener('click', startPangPangGame);

/* =========================================================
   ÎçîÌïòÍ∏∞ Í≤åÏûÑ (Í∞ôÏù¥ÌïòÍ∏∞)
   ========================================================= */
const mathMode = document.getElementById('math-mode');
const mathProblemEl = document.getElementById('math-problem');
const mathStatusEl = document.getElementById('math-status');
const mathScoreEl = document.getElementById('math-score');
const mathStartBtn = document.getElementById('math-startBtn');
const mathBackBtn = document.getElementById('math-backBtn');
const mathNumberGrid = document.getElementById('math-numberGrid');

let m_currentA = 0, m_currentB = 0, m_answer = 0;
let m_score = 0;
let m_q = 0;
const m_total = 10; // 1~5: Ìï© 4~10, 6~10: Ìï© 10~20

let m_recognition = null;
let m_useSTT = false;
const SpeechRecognition2 = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition2) {
  m_recognition = new SpeechRecognition2();
  m_recognition.lang = 'ko-KR';
  m_recognition.interimResults = false;
  m_recognition.maxAlternatives = 1;
  m_useSTT = true;
}

function speak(text, onend) {
  if (!('speechSynthesis' in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ko-KR';
  utter.rate = 1.0;
  utter.onend = onend || null;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

multiButton.addEventListener('click', () => {
  // ÏàòÌïô Í≤åÏûÑ Î≥¥Ïù¥Í∏∞, Ìå°Ìå° UI Ïà®Í∏∞Í∏∞
  startScreen.style.display = 'none';
  timerBar.style.display = 'none';
  board.style.display = 'none';
  gameoverElem.style.display = 'none';

  mathMode.style.display = 'flex';
  // Ï¥àÍ∏∞Ìôî
  m_score = 0;
  m_q = 0;
  mathProblemEl.textContent = "ÏãúÏûë Î≤ÑÌäºÏùÑ ÎàåÎü¨Î≥¥ÏÑ∏Ïöî.";
  mathStatusEl.textContent = "";
  mathScoreEl.textContent = m_score;
  mathNumberGrid.innerHTML = "";
});

mathBackBtn.addEventListener('click', () => {
  // Î©îÏù∏ÏúºÎ°ú
  mathMode.style.display = 'none';
  startScreen.style.display = 'flex';
});

mathStartBtn.addEventListener('click', () => {
  m_score = 0;
  m_q = 0;
  mathScoreEl.textContent = m_score;
  createNumberButtons(20);
  askMath();
});

function createNumberButtons(maxVal) {
  mathNumberGrid.innerHTML = '';
  for (let i = 1; i <= maxVal; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = 'num-btn';
    btn.addEventListener('click', () => checkMathAnswer(i));
    mathNumberGrid.appendChild(btn);
  }
}

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function makeBalancedPair(sum, minOperand) {
  let a = Math.floor(sum / 2);
  let b = sum - a;
  if (a < minOperand) { a = minOperand; b = sum - a; }
  if (b < minOperand) { b = minOperand; a = sum - b; }
  if (a === 1 || b === 1) {
    a = Math.max(2, a);
    b = sum - a;
  }
  return [a, b];
}

function makeMathProblem() {
  let minSum, maxSum;
  if (m_q < 5) {
    minSum = 4; maxSum = 10; // 1~5Î≤à
  } else {
    minSum = 10; maxSum = 20; // 6~10Î≤à
  }
  m_answer = randInt(minSum, maxSum);
  const [a, b] = makeBalancedPair(m_answer, 2);
  m_currentA = a; m_currentB = b;
  mathProblemEl.textContent = `${m_currentA} + ${m_currentB} = ?`;
}

function askMath() {
  if (m_q >= m_total) {
    mathProblemEl.textContent = "Í≤åÏûÑ ÌÅ¥Î¶¨Ïñ¥!";
    mathStatusEl.innerHTML = `<span class="correct">ÏµúÏ¢Ö Ï†êÏàò: ${m_score}Ï†ê</span>`;
    speak(`Í≤åÏûÑ ÌÅ¥Î¶¨Ïñ¥! Ï¥ù Ï†êÏàòÎäî ${m_score}Ï†ê ÏûÖÎãàÎã§.`);
    return;
  }
  makeMathProblem();
  m_q++;
  mathStatusEl.textContent = "";
  speak(`${m_currentA} ÎçîÌïòÍ∏∞ ${m_currentB}Îäî ÏñºÎßàÏùºÍπå?`);
  if (m_useSTT) listenMathAnswer();
}

function checkMathAnswer(selected) {
  if (selected === m_answer) {
    mathStatusEl.innerHTML = `<span class="correct">Ï†ïÎãµ!</span>`;
    speak("Ï†ïÎãµ!");
    m_score++;
  } else {
    mathStatusEl.innerHTML = `<span class="wrong">ÌãÄÎ†∏Ïñ¥! Ïö∞ÌïòÌïòÌïòÌïòÌïò!</span>`;
    speak("ÌãÄÎ†∏Ïñ¥! Ïö∞ÌïòÌïòÌïòÌïòÌïò!");
  }
  mathScoreEl.textContent = m_score;
  setTimeout(askMath, 1000);
}

function listenMathAnswer() {
  m_recognition.start();
  m_recognition.onresult = (event) => {
    m_recognition.stop();
    const transcript = event.results[0][0].transcript;
    const numberMatch = transcript.match(/\d+/);
    const value = numberMatch ? parseInt(numberMatch[0], 10) : NaN;
    checkMathAnswer(value);
  };
  m_recognition.onerror = () => {
    m_recognition.stop();
  };
}
</script>
</body>
</html>