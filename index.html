<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë¦°ë„¨ì‹¤ ì¶œê³ ê´€ë¦¬</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
    --r-lg:16px; --r-md:12px;
    --shadow-1:0 4px 16px rgba(15,23,42,.08); --shadow-2:0 10px 30px rgba(15,23,42,.10);
    --focus:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%}
  body{margin:0;font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;background:var(--bg);color:var(--text)}

  .topTitle{
    position:sticky;top:0;z-index:60;text-align:center;font-size:22px;font-weight:800;
    padding:12px 0;background:var(--card);border-bottom:1px solid var(--border);user-select:none;cursor:pointer;
  }
  header{
    position:sticky;top:48px;z-index:50;display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border);
  }
  .left{display:flex;gap:10px;align-items:center}
  .right{display:flex;gap:8px}
  label.head{font-weight:800;color:#334155;margin-right:6px;white-space:nowrap}
  select,input[type=date]{padding:10px 12px;font-size:16px;border:1px solid var(--border);border-radius:var(--r-md);background:#fff;color:#var(--text);transition:border-color .12s,box-shadow .12s}
  select:focus,input[type=date]:focus{outline:none;border-color:var(--accent);box-shadow:var(--focus)}
  #wardSelect{width:170px}

  button{border:0;border-radius:12px;padding:10px 14px;font-size:15px;font-weight:700;cursor:pointer;transition:transform .12s,filter .12s}
  .btn{background:#eef2f7;color:#1f2a44;border:1px solid var(--border);box-shadow:var(--shadow-1)}
  .btn:hover{filter:brightness(1.02);transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.acc{background:linear-gradient(180deg,#4f83ff,#2563eb);color:#fff;border:1px solid #2856c7;box-shadow:0 6px 22px rgba(37,99,235,.25)}

  main{max-width:980px;margin:0 auto;padding:12px 16px}
  h1{font-size:20px;margin:10px 0 6px;display:flex;align-items:center;gap:10px;color:#0f172a}
  h1 label{color:#475569;font-weight:700}

  .tabs{
    width:100%;display:flex;gap:8px;margin:10px 0;background:#f2f5fb;border:1px solid var(--border);
    border-radius:var(--r-lg);padding:6px;box-shadow:var(--shadow-1)
  }
  .tab{flex:1;text-align:center;padding:10px;border-radius:10px;font-weight:800;color:#334155;cursor:pointer}
  .tab.active{background:#e6efff;color:#0b3fb8;box-shadow:inset 0 0 0 1px rgba(37,99,235,.25)}

  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;box-shadow:var(--shadow-2)}
  thead th{background:#f6f8fc;color:#1e293b;font-weight:800}
  th,td{border-bottom:1px solid var(--border);padding:12px;font-size:16px;text-align:center}
  td:first-child,th:first-child{text-align:left}
  .col-item{width:45%}.col-qty{width:55%}

  .qtyCell{display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:nowrap}
  .chip{height:36px;min-width:34px;padding:0 8px;border:1px solid #d8deea;background:#f3f6fb;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-size:14px;color:#0f172a}
  .qtyCell input{width:56px;height:36px;text-align:center;font-size:15px;padding:0 6px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#0f172a}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}

  .empty{margin-top:16px;padding:18px;border:1px dashed var(--border);border-radius:16px;text-align:center;color:var(--muted);background:#fff}

  .footerBar{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);padding:10px;display:flex;justify-content:center;z-index:50}
  .footerCol{display:flex;flex-direction:column;gap:10px;align-items:stretch;max-width:980px;width:100%}
  #saveAll{width:100%;font-size:18px;padding:12px 16px;border-radius:14px}
  #appDownloadBtn{width:100%;font-size:16px;padding:12px 16px;border-radius:12px;background:#eef2f7;color:#1f2a44;border:1px solid var(--border)}
  #saveAll,#appDownloadBtn{display:block}
  #exportXLSXBtn{display:none}

  body.mode-stats header{display:none}
  body.mode-stats #saveAll, body.mode-stats #appDownloadBtn{display:none}
  body.mode-stats #exportXLSXBtn{display:block;width:100%;font-size:16px;padding:12px 16px;border-radius:12px}

  #sec-stats .row-wrap{display:flex;align-items:center;gap:8px}
  #sec-stats .row-wrap.dates input[type=date]{flex:1 1 0;min-width:0;font-size:15px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#var(--text)}
  #sec-stats .row-wrap select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#var(--text)}

  /* í†µê³„í‘œ */
  #statsWrap{overflow-x:hidden}
  .statsTable{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-2)}
  .statsTable th,.statsTable td{padding:6px;text-align:center;border-bottom:1px solid var(--border);border-right:1px solid var(--border);font-size:13px;line-height:1.05;font-variant-numeric:tabular-nums;color:#0f172a;white-space:nowrap}
  .statsTable thead th{background:#f6f8fc;color:#0f172a;font-weight:800}
  .statsTable th:first-child,.statsTable td:first-child{width:60px} /* ê³ ì •í­ í™•ë³´ */
  .statsTable th.rot{writing-mode:vertical-rl;text-orientation:upright;line-height:1;letter-spacing:0;width:22px;padding:4px 2px}
  .statsTable tr:last-child td,.statsTable tr:last-child th{border-bottom:none}
  .statsTable td[data-num], .statsTable th[data-num]{padding:6px 4px; overflow:hidden;} /* ìˆ«ìì¹¸ ë” íƒ€ì´íŠ¸ */

  /* ìš”ì•½í‘œ(2ë²ˆì§¸ í‘œ) */
  .summaryTable{width:100%;margin-top:12px;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-2)}
  .summaryTable th,.summaryTable td{padding:10px 12px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);font-size:14px;line-height:1.2;color:#0f172a}
  .summaryTable thead th{background:#f6f8fc;font-weight:800}
  .summaryTable tr:last-child td,.summaryTable tr:last-child th{border-bottom:none}
  .summaryTable td:first-child{white-space:nowrap}

  /* ìˆ«ì ì¶•ì†Œ(ê¸€ì í¬ê¸°) */
  .num{display:inline-block; line-height:1; font-variant-numeric:tabular-nums;}
  .d3{font-size:11px}
  .d4{font-size:10px}
  .d5{font-size:9px}

  /* ìµœë‹¤ì‚¬ìš© ë³‘ë™ ê°•ì¡° + ì™•ê´€ ë°€ë¦¼ ë°©ì§€ */
  .maxWardRow td{background:#fff7d6 !important}
  .statsTable td:first-child{position:relative}
  .statsTable td:first-child .wardName{display:inline-block; padding-left:20px; position:relative}
  .maxWardRow td:first-child .wardName::before{
    content:"ğŸ‘‘"; position:absolute; left:2px; top:50%; transform:translateY(-50%);
  }

  @media (max-width:480px){
    .chip{min-width:32px;height:34px;font-size:13px}
    .qtyCell input{height:34px;width:54px;font-size:14px}
  }

  /* í”Œë˜ì‹œ */
  #flashOverlay{position:fixed; inset:0; background:#ef4444; opacity:0; pointer-events:none; animation: flashOverlay3 .24s ease-in-out 3; z-index:9999}
  @keyframes flashOverlay3{0%{opacity:0}50%{opacity:.30}100%{opacity:0}}

  /* ëª¨ë‹¬ */
  .modal-open { overflow:hidden; }
  .modalOverlay{ position:fixed; inset:0; display:none; background:rgba(15,23,42,.5); z-index:10000; }
  .modalCard{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,520px); background:#fff; color:#0f172a; border-radius:16px; box-shadow:0 20px 60px rgba(15,23,42,.25); overflow:hidden; }
  .modalHead{ padding:16px 18px; font-weight:800; font-size:18px; border-bottom:1px solid var(--border); }
  .modalBody{ padding:16px 18px; font-size:14px; line-height:1.5; color:#475569; }
  .modalBody code{ background:#f1f5f9; padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; }
  .modalActions{ display:flex; gap:10px; padding:14px 16px; background:#f8fafc; border-top:1px solid var(--border); }
  .modalActions .btn{ flex:1; }
  .modalActions .btn.cancel{ background:#eef2f7; color:#1f2a44; border:1px solid var(--border); }
  .modalActions .btn.primary{ background:linear-gradient(180deg,#4f83ff,#2563eb); color:#fff; border:1px solid #2856c7; }
</style>
</head>
<body>

<div id="gotoMain" class="topTitle">ë³‘ë™ ì¶œê³ ê´€ë¦¬</div>

<header>
  <div class="left">
    <label class="head" for="wardSelect">ë³‘ë™ëª…</label>
    <select id="wardSelect">
      <option value="">ì„ íƒâ€¦</option>
      <option>93</option><option>83</option><option>73</option><option>71</option>
      <option>63</option><option>62</option><option>61</option>
      <option>52</option><option>51</option><option>42</option><option>41</option>
      <option>ê¸°íƒ€</option>
    </select>
  </div>
  <div class="right">
    <button class="btn" id="gotoStats">í†µê³„</button>
  </div>
</header>

<main>
  <section id="sec-input">
    <h1>
      <span style="display:flex;gap:10px;align-items:center">
        <label for="issueDate">ì¶œê³ ì¼</label>
        <input type="date" id="issueDate" />
      </span>
    </h1>

    <div class="tabs">
      <div class="tab active" data-cat="ì‹œíŠ¸">ì‹œíŠ¸</div>
      <div class="tab" data-cat="í™˜ìë³µ">í™˜ìë³µ</div>
      <div class="tab" data-cat="ê¸°íƒ€">ê¸°íƒ€</div>
    </div>

    <table id="inputTable" aria-label="í’ˆëª© ì…ë ¥ í‘œ">
      <colgroup><col class="col-item" /><col class="col-qty" /></colgroup>
      <thead><tr><th class="item-name">í’ˆëª©</th><th>ìˆ˜ëŸ‰</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="sec-stats" style="display:none">
    <h1>ê¸°ê°„ í†µê³„</h1>

    <div class="row-wrap dates" style="margin-bottom:8px">
      <input type="date" id="dateStart" />
      <span aria-hidden="true">~</span>
      <input type="date" id="dateEnd" />
    </div>

    <div class="row-wrap" style="margin-bottom:10px">
      <label for="wardFilter">ë³‘ë™</label>
      <select id="wardFilter">
        <option value="ì „ì²´">ì „ì²´</option>
        <option>93</option><option>83</option><option>73</option><option>71</option>
        <option>63</option><option>62</option><option>61</option>
        <option>52</option><option>51</option><option>42</option><option>41</option>
        <option>ê¸°íƒ€</option>
      </select>
    </div>

    <div id="statsWrap"></div>
    <div id="statsSummary" class="summaryWrap"></div>
    <div id="statsEmpty" class="empty" style="display:none">í•´ë‹¹ ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  </section>
</main>

<!-- ì œì¶œ ì™„ë£Œ ëª¨ë‹¬ -->
<div id="submitModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="smTitle">
  <div class="modalCard" role="document">
    <div class="modalHead" id="smTitle">ì œì¶œ ì™„ë£Œ</div>
    <div class="modalBody">âœ… <b>ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</b></div>
    <div class="modalActions">
      <button type="button" class="btn primary" id="smOk">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- ë‹¤ìš´ë¡œë“œ ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="downloadModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="dlTitle">
  <div class="modalCard" role="document">
    <div class="modalHead" id="dlTitle">ë‹¤ìš´ë¡œë“œ ì•ˆë‚´</div>
    <div class="modalBody">
      âš  ì´ ì•±ì€ <b>ë¦°ë„¨ì‹¤ ì „ìš©</b> ì–´í”Œë¦¬ì¼€ì´ì…˜ ì…ë‹ˆë‹¤.<br>
      <b>ë¦°ë„¨ì‹¤</b>ì—ì„œ ì œì‘í•˜ì˜€ìœ¼ë©°, ê³µì‹ ë¦´ë¦¬ì¦ˆì—ì„œ
      ë°°í¬ ë©ë‹ˆë‹¤.<br>
      ì•ˆì‹¬í•˜ê³  ì„¤ì¹˜í•˜ì…”ë„ ë©ë‹ˆë‹¤.
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="dlCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="dlConfirm">ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<div class="footerBar">
  <div class="footerCol">
    <button class="btn acc" id="saveAll">ì œì¶œí•˜ê¸°</button>
    <button class="btn" id="appDownloadBtn">ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ë¡œë“œ</button>
    <button class="btn" id="exportXLSXBtn">ì—‘ì…€ë¡œ ë‚´ë ¤ë°›ê¸°</button>
  </div>
</div>

<!-- íš¨ê³¼ìŒ -->
<audio id="submitSound" preload="auto" src="https://blog.kakaocdn.net/dna/MEv0X/dJMb9L4Selx/AAAAAAAAAAAAAAAAAAAAAKXPuVkeMAzxy7Bh1SCt30bi2C_1bwZptqCrwQ0ljMyS/%EC%A0%9C%EC%B6%9C%ED%95%98%EA%B8%B0.mp3"></audio>
<audio id="tabSound" preload="auto" src="https://blog.kakaocdn.net/dna/PzPow/dJMb8597iUU/AAAAAAAAAAAAAAAAAAAAAEfGdwd_aPGAiS8W_xjwE-wiO0YWzNYGwEiMupOPzPpT/%ED%83%AD%EC%9D%B4%EB%8F%99.wav"></audio>
<audio id="btnClickSound" preload="auto" src="https://blog.kakaocdn.net/dna/bwYLog/dJMb9aXTgeJ/AAAAAAAAAAAAAAAAAAAAADmduRzhpb3MzOEfQjYt4_cZMEVg0HqosiW-zgFGI0Ft/%EB%B2%84%ED%8A%BC%ED%81%B4%EB%A6%AD.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

<!-- Firebase (RTDB) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, query, orderByChild, startAt, endAt, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
    authDomain: "hallymlinen.firebaseapp.com",
    databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
    projectId: "hallymlinen",
    storageBucket: "hallymlinen.appspot.com",
    messagingSenderId: "867775830688",
    appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
    measurementId: "G-T02ZFK18L3"
  };

  const app = initializeApp(firebaseConfig);
  const rtdb = getDatabase(app);

  function dayStart(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); }
  function dayEndInclusiveMs(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999).getTime(); }

  async function saveLogsToRTDB(batchArray){
    const baseRef = ref(rtdb, "logs");
    await Promise.all(batchArray.map(d => push(baseRef, d)));
  }

  let _liveRef = null, _liveCb = null;
  function startStatsLiveWatcher(startDate, endDateInclusive, onData){
    if (_liveRef && _liveCb){ off(_liveRef, "value", _liveCb); _liveRef = null; _liveCb = null; }
    const sMs = dayStart(startDate);
    const eMs = dayEndInclusiveMs(endDateInclusive);
    const qy = query(ref(rtdb, "logs"), orderByChild("ts"), startAt(sMs), endAt(eMs));
    const cb = (snap)=>{
      const val = snap.val() || {};
      const arr = Object.keys(val).map(k => ({ id:k, ...val[k] }));
      onData(arr);
    };
    onValue(qy, cb);
    _liveRef = qy; _liveCb = cb;
  }

  window.__fb = { saveLogsToRTDB, startStatsLiveWatcher };
</script>

<!-- App Script -->
<script>
const REPO_SLUG = "bangat/linenward";
const APK_NAME  = "WardLinen.apk";
const LATEST_DIRECT = `https://github.com/${REPO_SLUG}/releases/latest/download/${APK_NAME}`;

const ITEMS={
  "ì‹œíŠ¸":["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ê±´"],
  "í™˜ìë³µ":["ì¼ë°˜ìƒì˜","ì¼ë°˜í•˜ì˜","ì •í˜•ìƒì˜","ì •í˜•í•˜ì˜"],
  "ê¸°íƒ€":["ì–µì œëŒ€","ì–¼ìŒí¬","ê¸°íƒ€"]
};
const COLORED_ITEMS = new Set(["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ê±´"]);
const ALL_ITEMS = Object.values(ITEMS).flat();
const WARDS=["93","83","73","71","63","62","61","52","51","42","41","ê¸°íƒ€"];

const LS={ ward:"linen/ward", logs:"linen/logs", draft:(ward)=>`linen/draft/${ward||'_none_'}` };
let state={ ward:(localStorage.getItem(LS.ward)||"").toString().trim(), section:"input", cat:"ì‹œíŠ¸" };
const el=s=>document.querySelector(s), els=s=>Array.from(document.querySelectorAll(s));

/* ëª¨ë‹¬ */
function openModal(sel, focusSel){ document.body.classList.add('modal-open'); const ov=el(sel); ov.style.display='block'; setTimeout(()=>{ focusSel && el(focusSel)?.focus(); },0); }
function closeModal(sel){ document.body.classList.remove('modal-open'); el(sel).style.display='none'; }

/* ì‚¬ìš´ë“œ */
function playSnd(id){ try{ const a=el(id); if(!a) return; a.currentTime=0; a.play().catch(()=>{});}catch(_){} }

/* ê²½ê³  */
function flashWarn(){ try{ if(navigator.vibrate){ navigator.vibrate([120,80,120,80,120]); } }catch(e){} const ov=document.createElement('div'); ov.id='flashOverlay'; document.body.appendChild(ov); ov.addEventListener('animationend', ()=>{ ov.parentNode && ov.parentNode.removeChild(ov); }); }
function maybeBuzz(prev,next){ const p=Number(prev)||0, n=Number(next)||0; if(p<16 && n>=16){ flashWarn(); } }

/* ë²”ìœ„ */
function rangeMsByDates(startStr,endStr){
  const sParts=startStr.split("-").map(Number), eParts=endStr.split("-").map(Number);
  let s=new Date(sParts[0],sParts[1]-1,sParts[2],0,0,0,0),
      e=new Date(eParts[0],eParts[1]-1,eParts[2],23,59,59,999);
  if(e.getTime()<s.getTime()){ const t=s; s=e; e=t; }
  return [s.getTime(), e.getTime()+1];
}

/* ë¡œì»¬ */
function getLogs(){ return JSON.parse(localStorage.getItem(LS.logs)||"[]"); }
function setLogs(a){ localStorage.setItem(LS.logs, JSON.stringify(a)); }
function getDraft(){ try{ return JSON.parse(localStorage.getItem(LS.draft(state.ward))||"{}"); }catch(_){ return {}; } }
function setDraft(o){ localStorage.setItem(LS.draft(state.ward), JSON.stringify(o||{})); }
function setDraftQty(item,qty){ const d=getDraft(); d[item]=(parseInt(qty)||0); setDraft(d); }

/* ì…ë ¥ í‘œ */
function buildTable(){
  const tb=el("#inputTable tbody"); tb.innerHTML="";
  ITEMS[state.cat].forEach(name=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="item-name">${name}</td>
      <td class="qtyCell">
        <button type="button" class="chip" data-delta="-5">âˆ’5</button>
        <button type="button" class="chip" data-delta="-1">âˆ’1</button>
        <input type="number" inputmode="numeric" value="0" aria-label="${name} ìˆ˜ëŸ‰" />
        <button type="button" class="chip" data-delta="+1">ï¼‹1</button>
        <button type="button" class="chip" data-delta="+5">ï¼‹5</button>
      </td>`;
    const inp=tr.querySelector("input");
    const draft=getDraft();
    const init=Object.prototype.hasOwnProperty.call(draft,name)?(parseInt(draft[name])||0):0;
    inp.value=String(init); inp.dataset.prev=String(init);

    inp.addEventListener("input",()=>{
      const prev=parseInt(inp.dataset.prev||"0")||0;
      const cur=parseInt(inp.value||"0")||0;
      inp.value=String(cur); setDraftQty(name,cur); maybeBuzz(prev,cur); inp.dataset.prev=String(cur);
    });
    tr.querySelectorAll("[data-delta]").forEach(btn=>{
      btn.onclick=()=>{
        const prev=parseInt(inp.dataset.prev||"0")||0;
        const v=(parseInt(inp.value||"0")||0)+parseInt(btn.dataset.delta,10);
        inp.value=v; setDraftQty(name,v); maybeBuzz(prev,v); inp.dataset.prev=String(v);
        playSnd("#btnClickSound");
      };
    });
    tb.appendChild(tr);
  });

  if(state.cat==="ê¸°íƒ€"){
    const noteRow=document.createElement("tr");
    noteRow.innerHTML=`<td colspan="2" style="text-align:left;padding:12px;font-size:14px;color:#64748b;">ê¸°íƒ€ : ì¤‘í™˜ì˜, ê³ ê´€ì ˆ, ì–‘ìª½ëˆ, ì–‘ìª½ê³ ë¬´ì¤„</td>`;
    tb.appendChild(noteRow);
  }
}

/* ì €ì¥ */
async function saveAll(){
  const ward=(state.ward||"").toString().trim();
  if(!ward){ alert("ë³‘ë™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
  const issue=el("#issueDate").value;
  let ts=issue?(()=>{const [y,m,d]=issue.split("-").map(Number); return new Date(y,m-1,d,12,0,0,0).getTime();})():Date.now();

  const draft=getDraft(); const batch=[];
  ALL_ITEMS.forEach(item=>{
    const q=(parseInt(draft[item]||"0")||0);
    if(q!==0) batch.push({ts, yyyymm:new Date(ts).toISOString().slice(0,7), ward, item, qty:q});
  });
  if(!batch.length){ alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ 0)"); return; }

  const logs=getLogs(); batch.forEach(b=>logs.unshift(b)); setLogs(logs.slice(0,10000));
  let ok=false; try{ if(window.__fb){ await window.__fb.saveLogsToRTDB(batch); ok=true; } }catch(e){ console.warn(e); }
  if(ok){
    const cur=getLogs(), keyOf=L=>[L.ts,L.ward,L.item,L.qty].join("|");
    const rm=new Set(batch.map(keyOf));
    setLogs(cur.filter(L=>!rm.has(keyOf(L))));
  }

  const cleared={}; ALL_ITEMS.forEach(i=>cleared[i]=0); setDraft(cleared);
  Array.from(document.querySelectorAll("#inputTable tbody input")).forEach(inp=>{ inp.value="0"; inp.dataset.prev="0"; });

  playSnd("#submitSound");
  openModal('#submitModal', '#smOk');

  if(document.body.classList.contains("mode-stats")){
    const d=new Date(ts).toISOString().slice(0,10);
    el("#dateStart").value=d; el("#dateEnd").value=d; await renderStats();
  }
}

/* ê°•ì¡°ìƒ‰ */
function colorStyle(item,val){
  if(!COLORED_ITEMS.has(item)) return "";
  const v=Number(val)||0;
  if(v>=20) return ' style="color:#dc2626;font-weight:800"';
  if(v>=15) return ' style="color:#1d4ed8;font-weight:800"';
  if(v>=10) return ' style="color:#b45309;font-weight:800"';
  return '';
}

/* ë²”ìœ„ í•„í„° */
function rangeSelect(logs,sStr,eStr,wardFilter){
  const [s,e]=rangeMsByDates(sStr,eStr);
  return logs.filter(L=>L.ts>=s&&L.ts<e&&(wardFilter==="ì „ì²´"||(L.ward||"").toString().trim()===wardFilter));
}

/* í”¼ë²— */
function renderPivot(logs,s,e,wardFilter){
  const selected=rangeSelect(logs,s,e,wardFilter);
  const wards=(wardFilter==="ì „ì²´")?WARDS:WARDS.filter(w=>w===wardFilter);
  const items=ALL_ITEMS; const p={}; wards.forEach(w=>p[w]={}); items.forEach(i=>wards.forEach(w=>p[w][i]=0));
  selected.forEach(L=>{
    if(!(L.ward in p)) p[L.ward]={};
    if(typeof p[L.ward][L.item]!=="number") p[L.ward][L.item]=0;
    p[L.ward][L.item]+=Number(L.qty)||0;
  });
  return {p,wards,items};
}

/* ìˆ«ì ìë¦¬ìˆ˜ì— ë”°ë¥¸ í°íŠ¸ ì¶•ì†Œ(3~5ìë¦¬) - í‘œ ì „ì²´(th/td ëª¨ë‘) */
function shrinkBigNumbers(root){
  Array.from(root.querySelectorAll('[data-num] > .num')).forEach(span=>{
    const len=(span.textContent||'').trim().length;
    if(len>=5) span.classList.add('d5');
    else if(len===4) span.classList.add('d4');
    else if(len===3) span.classList.add('d3');
  });
}

/* === í†µê³„ ë Œë” === */
async function renderStats(){
  const today=new Date().toISOString().slice(0,10);
  const s=el("#dateStart").value||today;
  const e=el("#dateEnd").value||today;
  const wardFilter=el("#wardFilter").value||"ì „ì²´";
  if(!s||!e) return;

  if(window.__fb && typeof window.__fb.startStatsLiveWatcher==="function"){
    window.__fb.startStatsLiveWatcher(new Date(s+"T00:00:00"), new Date(e+"T00:00:00"), (logsRT)=>{
      const [sMs,eMs]=rangeMsByDates(s,e);
      let logsLS=[]; try{ logsLS=getLogs().filter(L=>L.ts>=sMs&&L.ts<eMs);}catch(_){}
      const uniq=new Map(); [...logsRT,...logsLS].forEach(L=>{ const k=[L.ts,L.ward,L.item,L.qty].join("|"); if(!uniq.has(k)) uniq.set(k,L); });
      const merged=Array.from(uniq.values());

      const {p,wards,items}=renderPivot(merged,s,e,wardFilter);

      /* ë³‘ë™ë³„ ì´í•©ìœ¼ë¡œ ìµœë‹¤ ë³‘ë™ ì°¾ê¸° */
      const wardTotals = wards.map(w => items.reduce((a,i)=>a+(p[w]?.[i]||0),0));
      const maxTotal = Math.max(...wardTotals, 0);
      const maxWardIdx = wardTotals.findIndex(v=>v===maxTotal && v>0);

      /* ë©”ì¸ í‘œ */
      let html=`<table class="statsTable"><thead><tr><th>ë³‘ë™</th>${items.map(i=>`<th class="rot">${i}</th>`).join("")}</tr></thead><tbody>`;
      wards.forEach((w,rowIdx)=>{
        const isMax = (wardFilter==="ì „ì²´" && rowIdx===maxWardIdx);
        html+=`<tr class="${isMax?'maxWardRow':''}">
          <td><span class="wardName">${w}</span></td>${
          items.map(i=>{
            const v=(p[w]?.[i]||0);
            return `<td data-num="1"><span class="num"${colorStyle(i,v)}>${v}</span></td>`;
          }).join("")
        }</tr>`;
      });
      const periodTotals=items.map(i=>wards.reduce((a,w)=>a+(p[w]?.[i]||0),0));
      html+=`<tr><th>í•©ê³„</th>${
        periodTotals.map((v,idx)=>`<th data-num="1"><span class="num"${colorStyle(items[idx],v)}>${v}</span></th>`).join("")
      }</tr>`;
      html+=`</tbody></table>`;
      el("#statsWrap").innerHTML=html;

      /* === ìš”ì•½í‘œ (ì¼í‰ê· /ê¸°ê°„í•©ê³„) === */
      const daysCount = Math.max(1, Math.round((new Date(e) - new Date(s)) / (1000*60*60*24)) + 1);
      let sumHtml = `<table class="summaryTable">
        <thead><tr><th>í’ˆëª©</th><th>ì¼í‰ê·  ì‚¬ìš©ëŸ‰</th><th>ê¸°ê°„í•©ê³„</th></tr></thead><tbody>`;
      items.forEach((it,idx)=>{
        const psum=periodTotals[idx]||0;
        const avg=Math.round(psum/daysCount);
        sumHtml+=`<tr><td style="text-align:left">${it}</td>
          <td${colorStyle(it,avg)}>${avg}</td>
          <td${colorStyle(it,psum)}>${psum}</td></tr>`;
      });
      sumHtml+=`</tbody></table>`;
      el("#statsSummary").innerHTML = sumHtml;

      /* ìˆ«ì ì¶•ì†Œ(ë©”ì¸í‘œ ì „ì²´ì— ì ìš©: td+th) */
      shrinkBigNumbers(el("#statsWrap").querySelector("table"));

      const any=wards.some(w=>items.some(i=>(p[w]?.[i]||0)>0));
      el("#statsEmpty").style.display = any ? "none" : "block";
    });
  }
}

/* ì—‘ì…€ (í•©ê³„ ë°‘ì— 'ì¼í‰ê· ' ìë™ì¶”ê°€) */
function exportXLSX(){
  const table=document.querySelector("#statsWrap table"); if(!table){ alert("í†µê³„ í‘œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  const s=el("#dateStart").value||"", e=el("#dateEnd").value||"", ward=el("#wardFilter").value||"ì „ì²´";

  // ë©”ì¸ í‘œ â†’ ì‹œíŠ¸
  const ws=XLSX.utils.table_to_sheet(table,{origin:"A2"});
  const title=`${s} ~ ${e} ${ward}ë³‘ë™ ì¶œê³ ëŸ‰`;
  XLSX.utils.sheet_add_aoa(ws,[[title]],{origin:"A1"});

  // ì œëª© ë¨¸ì§€ & ì„œì‹
  const lastCol=table.rows[0].cells.length-1;
  ws["!merges"]=ws["!merges"]||[]; ws["!merges"].push({s:{r:0,c:0},e:{r:0,c:lastCol}});
  ws["A1"].s={font:{bold:true,sz:14},alignment:{horizontal:"center",vertical:"center"}};
  ws["!rows"]=ws["!rows"]||[]; ws["!rows"][0]={hpt:22};

  // í•©ê³„í–‰ì—ì„œ í•©ê³„ ì½ê³  ì¼í‰ê·  ê³„ì‚°
  const daysCount = Math.max(1, Math.round((new Date(e) - new Date(s)) / (1000*60*60*24)) + 1);
  const tBody = table.tBodies[0];
  const lastRow = tBody.rows[tBody.rows.length-1]; // í•©ê³„
  const totals = Array.from(lastRow.cells).slice(1).map(c=>parseInt(c.innerText)||0);
  const avgs = totals.map(v=>Math.round(v/daysCount));

  // í•©ê³„ ë°‘ì— "ì¼í‰ê· " í–‰ ì¶”ê°€
  XLSX.utils.sheet_add_aoa(ws,[["ì¼í‰ê· ", ...avgs]],{origin:-1});

  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"í†µê³„");
  XLSX.writeFile(wb,`stats_${s}_to_${e}.xlsx`);
}

/* ì´ˆê¸°í™” */
function debounce(fn,delay=200){ let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),delay); }; }
window.addEventListener("DOMContentLoaded",()=>{
  const urlApp=new URL(location.href).searchParams.get("app"); if(urlApp==="1"){localStorage.setItem("appMode","1");} if(urlApp==="0"){localStorage.removeItem("appMode");}
  const ua=(navigator.userAgent||"")+" "+(navigator.vendor||"");
  if((window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||/\b; wv\b/i.test(ua)||/\bMyLinenApp\b/i.test(ua)||localStorage.getItem('appMode')==='1'){ document.body.classList.add("app"); const b=el("#appDownloadBtn"); if(b) b.style.display="none"; }

  const urlWard=new URL(location.href).searchParams.get("ward");
  if(urlWard){ state.ward=(urlWard||"").toString().trim(); localStorage.setItem(LS.ward,state.ward); }
  el("#wardSelect").value=state.ward;
  el("#wardSelect").onchange=e=>{ state.ward=(e.target.value||"").toString().trim(); localStorage.setItem(LS.ward,state.ward); buildTable(); };

  const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  el("#issueDate").value=`${yyyy}-${mm}-${dd}`;
  el("#dateStart").value=`${yyyy}-${mm}-${dd}`;
  el("#dateEnd").value=`${yyyy}-${mm}-${dd}`;

  buildTable();

  el("#saveAll").onclick=saveAll;
  el("#exportXLSXBtn").onclick=exportXLSX;

  /* ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ */
  function openDownloadModal(){ openModal('#downloadModal', '#dlConfirm'); }
  function closeDownloadModal(){ closeModal('#downloadModal'); }
  el("#appDownloadBtn").onclick = openDownloadModal;
  el("#dlCancel").onclick = closeDownloadModal;
  el("#dlConfirm").onclick = () => { closeDownloadModal(); const url = LATEST_DIRECT; if(url && url.startsWith("http")) window.location.href = url; else alert("ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); };
  el("#downloadModal").addEventListener("click",(e)=>{ if(e.target === e.currentTarget) closeDownloadModal(); });

  /* ì œì¶œ ëª¨ë‹¬ */
  el('#submitModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeModal('#submitModal'); });
  el('#smOk').onclick = ()=> closeModal('#submitModal');

  /* íƒ­ ì „í™˜ */
  Array.from(document.querySelectorAll(".tab")).forEach(t=>
    t.onclick=()=>{
      state.cat=t.dataset.cat;
      Array.from(document.querySelectorAll(".tab")).forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      buildTable();
      playSnd("#tabSound");
    }
  );

  /* í†µê³„ ë Œë” ë°”ì¸ë”© */
  const rerender=debounce(renderStats,200);
  ["#dateStart","#dateEnd","#wardFilter"].forEach(sel=>{
    const n=el(sel); n&&n.addEventListener("change",rerender); n&&n.addEventListener("input",rerender);
  });

  /* ì§„ì… */
  el("#gotoStats").onclick=()=>{ 
    document.body.classList.add("mode-stats"); 
    el("#sec-input").style.display="none"; 
    el("#sec-stats").style.display="block"; 
    const chosen=el("#issueDate").value||new Date().toISOString().slice(0,10); 
    el("#dateStart").value=chosen; el("#dateEnd").value=chosen; 
    renderStats(); 
  };
  el("#gotoMain").onclick=()=>{ 
    document.body.classList.remove("mode-stats"); 
    el("#sec-input").style.display="block"; 
    el("#sec-stats").style.display="none"; 
  };
});
</script>
</body>
</html>
