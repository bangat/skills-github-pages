<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2563eb" />

<!-- iOS ì „ìš© -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

<title>ë¦°ë„¨ì‹¤ ì¶œê³ ê´€ë¦¬</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
    --r-lg:16px; --r-md:12px;
    --shadow-1:0 4px 16px rgba(15,23,42,.08); --shadow-2:0 10px 30px rgba(15,23,42,.10);
    --focus:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%}
  body{margin:0;font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;background:var(--bg);color:var(--text)}

  .topTitle{
    position:sticky;top:0;z-index:60;text-align:center;font-size:22px;font-weight:800;
    padding:12px 0;background:var(--card);border-bottom:1px solid var(--border);user-select:none;cursor:pointer;
  }
  header{
    position:sticky;top:48px;z-index:50;display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border);
  }
  .left{display:flex;gap:10px;align-items:center}
  .right{display:flex;gap:8px}
  label.head{font-weight:800;color:#334155;margin-right:6px;white-space:nowrap}
  select,input[type=date]{padding:10px 12px;font-size:16px;border:1px solid var(--border);border-radius:var(--r-md);background:#fff;color:var(--text);transition:border-color .12s,box-shadow .12s}
  select:focus,input[type=date]:focus{outline:none;border-color:var(--accent);box-shadow:var(--focus)}
  #wardSelect{width:170px}

  button{border:0;border-radius:12px;padding:10px 14px;font-size:15px;font-weight:700;cursor:pointer;transition:transform .12s,filter .12s; position:relative; overflow:hidden}
  .btn{background:#eef2f7;color:#1f2a44;border:1px solid var(--border);box-shadow:var(--shadow-1)}
  .btn:hover{filter:brightness(1.02);transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.acc{background:linear-gradient(180deg,#4f83ff,#2563eb);color:#fff;border:1px solid #2856c7;box-shadow:0 6px 22px rgba(37,99,235,.25)}

  /* main spacing: í•˜ë‹¨ stickyì™€ ê²¹ì¹¨ ë°©ì§€ */
  main{max-width:980px;margin:0 auto;padding:12px 16px  calc(110px + env(safe-area-inset-bottom));}

  h1{font-size:20px;margin:6px 0 8px;color:#0f172a}
  .fieldRow{display:flex;align-items:center;gap:10px}
  .fieldRow .lab{flex:0 0 72px; font-weight:800; color:#334155}
  #issueDate{flex:1; min-width:0}

  /* í”„ë¦¬ë¯¸ì—„ ì„¹ì…˜ ì¹´ë“œ + ìµœì†Œ ë†’ì´(í‘¸í„° ìœ„ê¹Œì§€ ì±„ìš°ê¸°) */
  .sectionCard{
    padding:14px;
    border-radius:20px;
    background:#fff;
    box-shadow: 0 16px 44px rgba(15,23,42,.10);
    border:1px solid rgba(15,23,42,.06);
    min-height: var(--fillH, auto);
  }

  /* Tabs */
  .tabs{
    width:100%;display:flex;gap:8px;margin:8px 0;background:#f2f5fb;border:1px solid var(--border);
    border-radius:14px;padding:4px;box-shadow:var(--shadow-1); position:relative;
  }
  .tab{flex:1;text-align:center;padding:8px 10px;border-radius:10px;font-weight:800;color:#334155;cursor:pointer; position:relative; z-index:1}
  .tab.active{color:#0b3fb8}
  .tab-slider{
    position:absolute; top:4px; bottom:4px; width:33.3333%;
    border-radius:10px; background:#e6efff; box-shadow:inset 0 0 0 1px rgba(37,99,235,.25);
    transition:transform .25s cubic-bezier(.2,.8,.2,1);
  }

  /* í‘œ */
  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow-2)}
  thead th{background:#f6f8fc;color:#1e293b;font-weight:800}
  th,td{border-bottom:1px solid var(--border);padding:10px;font-size:16px;text-align:center}
  td:first-child,th:first-child{text-align:left}
  .col-item{width:42%}.col-qty{width:58%}

  /* í’ˆëª©ëª… */
  .item-name{font-size:15px; white-space:nowrap}
  /* 2ê¸€ì(ìˆ˜ê±´/ê¸°íƒ€)ë¥¼ 3ê¸€ì ë„ˆë¹„ì²˜ëŸ¼ ë³´ì´ê²Œ */
  .item-name.k2::after{content:""; display:inline-block; width:.9em;}
  @media (max-width:430px){ .item-name.k2::after{ width:1.05em; } }

  /* ì •í˜• í•­ëª© ê°•ì¡° */
  tr.kind-ortho td.item-name{color:#2563eb; font-weight:800}

  .qtyCell{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:nowrap}
  .qtyInputWrap{ position:relative; display:inline-block; }
  .qtyCell input{width:52px;height:36px;text-align:center;font-size:15px;padding:0 6px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#0f172a}

  .chip{height:36px;min-width:46px;padding:0 12px;border:1px solid #d8deea;background:#f3f6fb;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-size:14px;color:#0f172a;white-space:nowrap;line-height:1}
  .chip.spring{ animation:springy .18s cubic-bezier(.17,.89,.32,1.28); }
  @keyframes springy{0%{transform:scale(1)}40%{transform:scale(.96)}70%{transform:scale(1.06)}100%{transform:scale(1)}}

  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}

  .empty{margin-top:16px;padding:18px;border:1px dashed var(--border);border-radius:16px;text-align:center;color:var(--muted);background:#fff}

  .footerBar{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);padding:10px;display:flex;justify-content:center;z-index:50; padding-bottom: max(10px, env(safe-area-inset-bottom));}
  .footerCol{display:flex;flex-direction:column;gap:10px;align-items:stretch;max-width:980px;width:100%}
  #saveAll{width:100%;font-size:18px;padding:12px 16px;border-radius:14px}
  #appDownloadBtn{width:100%;font-size:16px;padding:12px 16px;border-radius:12px;background:#eef2f7;color:#1f2a44;border:1px solid var(--border)}
  #saveAll,#appDownloadBtn{display:block}
  #exportXLSXBtn{display:none}

  body.mode-stats header{display:none}
  body.mode-stats #saveAll, body.mode-stats #appDownloadBtn{display:none}
  body.mode-stats #exportXLSXBtn{display:block;width:100%;font-size:16px;padding:12px 16px;border-radius:12px}

  #sec-stats .row-wrap{display:flex;align-items:center;gap:8px}
  #sec-stats .row-wrap.dates input[type=date]{flex:1 1 0;min-width:0;font-size:15px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#var(--text)}
  #sec-stats .row-wrap select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#var(--text)}

  /* Stats table */
  #statsWrap{overflow-x:auto}
  .statsTable{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-2)}
  .statsTable th,.statsTable td{padding:6px 4px;text-align:center;border-bottom:1px solid var(--border);border-right:1px solid var(--border);font-size:13px;line-height:1.05;font-variant-numeric:tabular-nums;color:#0f172a;white-space:nowrap}
  .statsTable thead th{background:#f6f8fc;color:#0f172a;font-weight:800}
  .statsTable th:first-child,.statsTable td:first-child{ text-align:left !important; width:60px }
  .statsTable td[data-num], .statsTable th[data-num]{ text-align:center; padding:6px 2px; overflow:hidden; }
  .statsTable .total-row th:first-child{ text-align:left !important; }
  .statsTable tr:last-child td,.statsTable tr:last-child th{border-bottom:none}
  .statsTable th.rot{writing-mode:vertical-rl;text-orientation:upright;line-height:1;letter-spacing:0;width:22px;padding:4px 2px}
  .num{display:inline-block; line-height:1; font-variant-numeric:tabular-nums; max-width:100%}
  .d3{font-size:11px; letter-spacing:-.3px}
  .d4{font-size:10px; letter-spacing:-.4px}
  .d5{font-size:9px;  letter-spacing:-.5px}
  .maxWardRow td{background:#fff7d6 !important}
  .statsTable td:first-child{position:relative}
  .statsTable td:first-child .wardName,
  .statsTable th:first-child .wardName{display:inline-block; padding-left:20px; position:relative}
  .maxWardRow td:first-child .wardName::before{ content:"ğŸ‘‘"; position:absolute; left:2px; top:50%; transform:translateY(-50%); }

  @media (max-width:420px){
    .chip{min-width:44px;height:34px;font-size:14px}
    .qtyCell input{height:34px;width:48px;font-size:14px}
    .item-name{font-size:14.5px}
    .tab{padding:7px 8px}
  }

  #flashOverlay{position:fixed; inset:0; background:#ef4444; opacity:0; pointer-events:none; animation: flashOverlay3 .24s ease-in-out 3; z-index:9999}
  @keyframes flashOverlay3{0%{opacity:0}50%{opacity:.30}100%{opacity:0}}

.modal-open { overflow:hidden; }
.modalOverlay{
  position:fixed; inset:0; display:none;
  background:rgba(15,23,42,.5); z-index:10000;
}

/* === ì¹´ë“œ ì „ì²´ ë ˆì´ì•„ì›ƒ === */
.modalCard{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(92vw,520px);
  max-height:88vh;                 /* í™”ë©´ 88% ì´ìƒ ì•ˆ ë„˜ì–´ê°€ê²Œ */
  display:flex; flex-direction:column; /* ì„¸ë¡œ í”Œë ‰ìŠ¤ */
  background:#fff; color:#0f172a;
  border-radius:16px; box-shadow:0 20px 60px rgba(15,23,42,.25);
  overflow:hidden;
}

.modalHead{
  padding:16px 18px; font-weight:800; font-size:18px;
  border-bottom:1px solid var(--border);
  flex:0 0 auto; /* ë†’ì´ ê³ ì • */
}

.modalBody{
  padding:16px 18px; font-size:14px; line-height:1.5; color:#475569;
  flex:1 1 auto;       /* ë‚¨ì€ ê³µê°„ ì±„ìš°ê¸° */
  min-height:0;        /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ í•µì‹¬ */
  overflow:auto;       /* ë‚´ìš© ë§ìœ¼ë©´ ë³¸ë¬¸ë§Œ ìŠ¤í¬ë¡¤ */
  max-height:50vh;     /* ì ˆë°˜ì¯¤ë¶€í„° ìŠ¤í¬ë¡¤ */
}

.modalActions{
  display:flex; gap:10px; padding:14px 16px;
  background:#f8fafc; border-top:1px solid var(--border);
  flex:0 0 auto; /* í•˜ë‹¨ ê³ ì • */
}
.modalActions .btn{ flex:1; }
.modalActions .btn.cancel{
  background:#eef2f7; color:#1f2a44; border:1px solid var(--border);
}
.modalActions .btn.primary{
  background:linear-gradient(180deg,#4f83ff,#2563eb);
  color:#fff; border:1px solid #2856c7;
}


  /* Toast */
  .toast{
    position:fixed; right:18px; bottom:90px; transform:translateY(20px);
    background:linear-gradient(180deg,#10b981,#059669); color:#fff; font-weight:900;
    padding:12px 14px; border-radius:14px; box-shadow:0 16px 40px rgba(5,150,105,.35);
    opacity:0; pointer-events:none; transition:opacity .18s, transform .18s; z-index:11000;
    display:flex; align-items:center; gap:10px;
  }
  .toast.show{opacity:1; transform:translateY(0)}
  .toast .sub{font-weight:600;opacity:.9;font-size:12px}
  .toast .check{width:18px; height:18px; border-radius:50%; background:#fff; color:#059669; display:inline-grid; place-items:center; font-weight:900}

  /* Charts */
  #statsCharts{margin-top:14px}
  #statsCharts .card{
    background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-2);
    padding:12px;
  }
  #statsCharts h2{margin:10px 2px 8px; font-size:18px}
  .chartControls{display:flex; gap:8px; align-items:center; margin:8px 2px 12px; flex-wrap:wrap}
  .chartControls select{padding:8px 10px; border:1px solid var(--border); border-radius:10px}
  .chartGrid{display:grid; grid-template-columns:1fr; gap:12px}
  @media (min-width:720px){ .chartGrid{grid-template-columns:1fr 1fr} }
  #exportChartXLSXBtn{padding:10px 12px; border-radius:10px}

  @media (prefers-reduced-motion: reduce){
    .chip.spring{ animation:none !important; }
    .tab-slider{ transition:none }
  }

  /* Mobile compact */
  @media (max-width: 430px){
    .sectionCard{ padding:10px 10px 12px; box-shadow:0 8px 22px rgba(15,23,42,.08); }
    h1{ margin:6px 0 8px; font-size:18px; }
    #sec-input h1 span{ width:100%; }
    #issueDate{ flex:1; width:100%; }
    .tabs{ margin:6px 0 8px; padding:2px; border-radius:12px; }
    .tab{ padding:6px 8px; font-size:15px; line-height:1; }
    .tab-slider{ top:2px; bottom:2px; }
    #inputTable{ margin-top:6px; border-radius:12px; }
    #inputTable thead th{ padding:8px 6px; font-size:14px; }
    #inputTable td, #inputTable th{ padding:8px 6px; font-size:14px; }
    .col-item{ width:40%; }
    .col-qty{ width:60%; }
    .qtyCell{ gap:4px; flex-wrap:nowrap; }
    .chip{ height:32px; min-width:40px; padding:0 8px; font-size:13px; white-space:nowrap; }
    .qtyCell input{ width:44px; height:32px; font-size:14px; }
    .item-name{ font-size:14.5px; white-space:nowrap; }
  }

  /* ì•ˆë“œ WebView ê²¹ì¹¨ ë°©ì§€ */
  .tabs{ overflow:hidden; contain:layout paint; }


/* ===== Confirm Modal: tidy & legible ===== */
.modalBody .confirmHeader{font-weight:800;color:#0f172a;margin:2px 0 8px}
.modalBody .confirmHeader .date{font-size:15px}
.modalBody .confirmHeader .ward{color:#0b3fb8}

.confirmList{list-style:none;margin:10px 0 0;padding:0}
.confirmList .itemRow{
  display:flex;justify-content:space-between;align-items:center;gap:12px;
  padding:8px 10px;margin-top:8px;background:#f8fafc;
  border:1px solid var(--border);border-radius:12px;
}
.itemRow .label{font-weight:700;color:#1f2937}
.itemRow.isColored .label{color:#0b3fb8}      /* ì‹œíŠ¸ë¥˜ ê°•ì¡° */
.itemRow.isOrtho  .label{color:#2563eb}       /* ì •í˜• ê°•ì¡° */

.qtyBadge{
  min-width:76px;text-align:right;font-weight:900;
  padding:6px 10px;border-radius:999px;background:#eef2f7;color:#0f172a
}
.qtyBadge.lv1{background:#fff3cd;color:#b45309} /* 10+ */
.qtyBadge.lv2{background:#dbeafe;color:#1d4ed8} /* 15+ */
.qtyBadge.lv3{background:#fee2e2;color:#dc2626} /* 20+ */

.confirmTotal{
  display:flex;justify-content:space-between;align-items:center;
  margin-top:12px;padding:10px;border-top:1px dashed var(--border);
  font-size:16px
}
.confirmTotal strong{font-size:18px}

/* ì‚´ì§ ë” ë„“ê²Œ(ì„ íƒ) */
.modalCard{width:min(92vw,560px)}



</style>
</head>
<body>

<div id="gotoMain" class="topTitle">ë³‘ë™ ì¶œê³ ê´€ë¦¬</div>

<header>
  <div class="left">
    <label class="head" for="wardSelect">ë³‘ë™ëª…</label>
    <select id="wardSelect">
      <option value="">ì„ íƒâ€¦</option>
      <option>93</option><option>83</option><option>73</option><option>71</option>
      <option>63</option><option>62</option><option>61</option>
      <option>52</option><option>51</option><option>42</option><option>41</option>
      <option>ê¸°íƒ€</option>
    </select>
  </div>
  <div class="right">
    <button class="btn" id="gotoStats">í†µê³„</button>
  </div>
</header>

<main>
  <section id="sec-input">
    <div class="sectionCard">
      <h1 class="fieldRow">
        <span class="lab">ì¶œê³ ì¼</span>
        <input type="date" id="issueDate" />
      </h1>

      <div class="tabs">
        <div class="tab-slider" id="tabSlider" aria-hidden="true"></div>
        <div class="tab active" data-cat="ì‹œíŠ¸">ì‹œíŠ¸</div>
        <div class="tab" data-cat="í™˜ìë³µ">í™˜ìë³µ</div>
        <div class="tab" data-cat="ê¸°íƒ€">ê¸°íƒ€</div>
      </div>

      <table id="inputTable" aria-label="í’ˆëª© ì…ë ¥ í‘œ">
        <colgroup><col class="col-item" /><col class="col-qty" /></colgroup>
        <thead><tr><th class="item-name">í’ˆëª©</th><th>ìˆ˜ëŸ‰</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="sec-stats" style="display:none">
    <h1>ê¸°ê°„ í†µê³„</h1>

    <div class="row-wrap dates" style="margin-bottom:8px">
      <input type="date" id="dateStart" />
      <span aria-hidden="true">~</span>
      <input type="date" id="dateEnd" />
    </div>

    <div class="row-wrap" style="margin-bottom:10px">
      <label for="wardFilter">ë³‘ë™</label>
      <select id="wardFilter">
        <option value="ì „ì²´">ì „ì²´</option>
        <option>93</option><option>83</option><option>73</option><option>71</option>
        <option>63</option><option>62</option><option>61</option>
        <option>52</option><option>51</option><option>42</option><option>41</option>
        <option>ê¸°íƒ€</option>
      </select>
    </div>

    <div id="statsWrap"></div>
    <div id="statsSummary" class="summaryWrap"></div>

    <section id="statsCharts">
      <h2>í’ˆëª©ë³„ ì‚¬ìš©ëŸ‰ ì¦ê°€ì¶”ì´</h2>
      <div class="card">
        <div class="chartControls">
          <label for="chartItem">í’ˆëª©</label>
          <select id="chartItem"></select>
          <button class="btn" id="exportChartXLSXBtn">ê·¸ë˜í”„ ë°ì´í„° ì—‘ì…€ë¡œ</button>
        </div>
        <div class="chartGrid">
          <canvas id="lineChart" height="220" aria-label="ì¼ìë³„ ì‚¬ìš©ëŸ‰ ì¶”ì´"></canvas>
          <canvas id="dowChart" height="220" aria-label="ìš”ì¼ë³„ í•©ê³„"></canvas>
        </div>
      </div>
    </section>

    <div id="statsEmpty" class="empty" style="display:none">í•´ë‹¹ ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  </section>
</main>

  <!-- PWA ì„¤ì¹˜ ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="pwaInstallModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="piTitle" style="display:none">
  <div class="modalCard" role="document">
    <div class="modalHead" id="piTitle">ë¦°ë„¨ì‹¤ ì•± ì„¤ì¹˜ì•ˆë‚´</div>
<div class="modalBody">
  ğŸ“± íœ´ëŒ€í°ì—ì„œ ë°”ë¡œ ì‹¤í–‰ <br>
  ğŸ”’ ë³´ì•ˆ ì—°ê²°ë¡œ ì•ˆì „í•˜ê²Œ<br>
  ğŸ–¥ï¸ í° í™”ë©´ ëª¨ë“œ ì§€ì›
</div>

    <div class="modalActions">
      <button type="button" class="btn cancel" id="piCancel">ë‚˜ì¤‘ì—</button>
      <button type="button" class="btn primary" id="piConfirm">ì„¤ì¹˜</button>
    </div>
  </div>
</div>


<!-- ì œì¶œ ì™„ë£Œ ëª¨ë‹¬ -->
<div id="submitModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="smTitle">
  <div class="modalCard" role="document">
    <div class="modalHead" id="smTitle">ì œì¶œ ì™„ë£Œ</div>
    <div class="modalBody">âœ… <b>ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</b></div>
    <div class="modalActions">
      <button type="button" class="btn primary" id="smOk">í™•ì¸</button>
    </div>
  </div>
</div>

  <!-- ì œì¶œ í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="csTitle" style="display:none">
  <div class="modalCard" role="document">
    <div class="modalHead" id="csTitle">ì œì¶œ í™•ì¸</div>
    <div class="modalBody">
      <div id="confirmSummary">
        ì…ë ¥í•˜ì‹  ìˆ˜ëŸ‰ì„ ì œì¶œí• ê¹Œìš”?
      </div>
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="csCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="csOk">ì œì¶œ</button>
    </div>
  </div>
</div>

  
<!-- ë‹¤ìš´ë¡œë“œ ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="downloadModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="dlTitle">
  <div class="modalCard" role="document">
    <div class="modalHead" id="dlTitle">ë‹¤ìš´ë¡œë“œ ì•ˆë‚´</div>
    <div class="modalBody">
      âš  ì´ ì•±ì€ <b>ë¦°ë„¨ì‹¤ ì „ìš©</b> ì–´í”Œë¦¬ì¼€ì´ì…˜ ì…ë‹ˆë‹¤.<br>
      <b>ë¦°ë„¨ì‹¤</b>ì—ì„œ ì œì‘í•˜ì˜€ìœ¼ë©°, ê¹ƒí—ˆë¸Œ ê³µì‹ ë¦´ë¦¬ì¦ˆì—ì„œ
      ë°°í¬ ë˜ê³  ìˆìœ¼ë©°, ì•ˆì‹¬í•˜ê³  ì„¤ì¹˜í•˜ì…”ë„ ë©ë‹ˆë‹¤.
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="dlCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="dlConfirm">ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <span class="check">âœ“</span>
  <div>
    <div id="toastText">ì €ì¥ ì™„ë£Œ</div>
    <div class="sub">RTDB ë™ê¸°í™” & ë¡œì»¬ ë°±ì—…</div>
  </div>
</div>

<div class="footerBar">
  <div class="footerCol">
    <button class="btn acc" id="saveAll" disabled>ì œì¶œí•˜ê¸°</button>
    <button class="btn" id="appDownloadBtn">ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ë¡œë“œ</button>
    <button class="btn" id="exportXLSXBtn">ì—‘ì…€ë¡œ ë‚´ë ¤ë°›ê¸°</button>
  </div>
</div>

<!-- ì‚¬ìš´ë“œ -->
<audio id="submitSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/ì œì¶œí•˜ê¸°.mp3" type="audio/mpeg" />
</audio>
<audio id="tabSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/íƒ­ì´ë™.wav" type="audio/wav" />
</audio>
<audio id="btnClickSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/ë²„íŠ¼í´ë¦­2.mp3" type="audio/mpeg" />
</audio>
  <audio id="warnSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/ê²½ê³ .mp3" type="audio/mpeg" />
</audio>


<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- =================== í…”ë ˆê·¸ë¨ ë¡œê±° =================== -->
<script>
const TELEGRAM_CHAT_ID = "5432510881";
const TELEGRAM_TOKEN   = "7377526562:AAEhb8p-mld6b2tMH7TAct2Jhqg8dpP6p20";
const TG_API = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
const __tgBuf = []; let __tgTimer = null;
function tgFlush() {
  if (!__tgBuf.length) return;
  let payload = __tgBuf.splice(0).join("\n");
  if (payload.length > 3500) payload = payload.slice(0, 3500) + "\n...(truncated)";
  const text = `[linenward]\nURL: ${location.href}\nUA: ${(navigator.userAgent||'')}\nTime: ${new Date().toISOString()}\n\n` + payload;
  const body = { chat_id: TELEGRAM_CHAT_ID, text };
  fetch(TG_API, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body) })
  .catch(()=>{ const url = `${TG_API}?chat_id=${encodeURIComponent(TELEGRAM_CHAT_ID)}&text=${encodeURIComponent(text)}`; try { if (navigator.sendBeacon) navigator.sendBeacon(url); else (new Image()).src = url; } catch(_){}})
}
function tgSendNow(line){ __tgBuf.push(line); if (__tgTimer) return; __tgTimer=setTimeout(()=>{__tgTimer=null; tgFlush();},1000); }
function asLine(arg){ try{ if (arg instanceo<!-- =================== í…”ë ˆê·¸ë¨ ë¡œê±° =================== -->
<script>
const TELEGRAM_CHAT_ID = "5432510881";
const TELEGRAM_TOKEN   = "7377526562:AAEhb8p-mld6b2tMH7TAct2Jhqg8dpP6p20";
const TG_API = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;

const __tgBuf = [];
let __tgTimer = null;

function tgFlush() {
  if (!__tgBuf.length) return;
  let payload = __tgBuf.splice(0).join("\n");
  if (payload.length > 3500) payload = payload.slice(0, 3500) + "\n...(truncated)";
  const text = `[linenward]\nURL: ${location.href}\nUA: ${(navigator.userAgent||'')}\nTime: ${new Date().toISOString()}\n\n` + payload;
  const body = { chat_id: TELEGRAM_CHAT_ID, text };
  fetch(TG_API, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body) })
  .catch(()=>{ const url = `${TG_API}?chat_id=${encodeURIComponent(TELEGRAM_CHAT_ID)}&text=${encodeURIComponent(text)}`; try { if (navigator.sendBeacon) navigator.sendBeacon(url); else (new Image()).src = url; } catch(_){}})
}
function tgSendNow(line){ __tgBuf.push(line); if (__tgTimer) return; __tgTimer=setTimeout(()=>{__tgTimer=null; tgFlush();},1000); }
function asLine(arg){ try{ if (arg instanceof Error) return (arg.stack||arg.message||String(arg)); if (typeof arg==='object') return JSON.stringify(arg); return String(arg);}catch(_){ return String(arg);} }

;["error","warn"].forEach(type=>{
  const orig = console[type];
  console[type] = function(...args){
    try { orig.apply(console, args); } catch(_){}
    let msg = ""; 
    try { msg = args.map(asLine).join(" "); } catch(_){}
    if (type === "warn" && /The play\(\) request was interrupted by a call to pause\(\)|AbortError.*play\(\)|Autoplay|gesture/i.test(msg)) {
      return;
    }
    try { tgSendNow(`[${type.toUpperCase()}] ${msg}`); } catch(_){}
  };
});

window.tgLog=(...args)=> tgSendNow(`[LOG] `+args.map(asLine).join(" "));
window.addEventListener("error", e=> tgSendNow(`[ONERROR] ${e.message} @ ${e.filename}:${e.lineno}:${e.colno}\n${e.error?.stack||''}`));
window.addEventListener("unhandledrejection", e=> tgSendNow(`[UNHANDLED] ${(e.reason && (e.reason.stack||e.reason.message)) || asLine(e.reason)}`));
</script>
<!-- =================== /í…”ë ˆê·¸ë¨ ë¡œê±° =================== -->


<!-- Firebase (RTDB) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, query, orderByChild, startAt, endAt, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
    authDomain: "hallymlinen.firebaseapp.com",
    databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
    projectId: "hallymlinen",
    storageBucket: "hallymlinen.appspot.com",
    messagingSenderId: "867775830688",
    appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
    measurementId: "G-T02ZFK18L3"
  };

  const app = initializeApp(firebaseConfig);
  const rtdb = getDatabase(app);

  function dayStart(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); }
  function dayEndInclusiveMs(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999).getTime(); }

  async function saveLogsToRTDB(batchArray){
    const baseRef = ref(rtdb, "logs");
    await Promise.all(batchArray.map(d => push(baseRef, d)));
  }

  let _liveRef = null, _liveCb = null;
  function startStatsLiveWatcher(startDate, endDateInclusive, onData){
    if (_liveRef && _liveCb){ off(_liveRef, "value", _liveCb); _liveRef = null; _liveCb = null; }
    const sMs = dayStart(startDate);
    const eMs = dayEndInclusiveMs(endDateInclusive);
    const qy = query(ref(rtdb, "logs"), orderByChild("ts"), startAt(sMs), endAt(eMs));
    const cb = (snap)=>{
      const val = snap.val() || {};
      const arr = Object.keys(val).map(k => ({ id:k, ...val[k] }));
      onData(arr);
    };
    onValue(qy, cb);
    _liveRef = qy; _liveCb = cb;
  }

  window.__fb = { saveLogsToRTDB, startStatsLiveWatcher };
</script>

  <!-- (ì´ë¯¸ ìˆëŠ”) Firebase (RTDB) ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€ -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
    authDomain: "hallymlinen.firebaseapp.com",
    projectId: "hallymlinen",
    messagingSenderId: "867775830688",
    appId: "1:867775830688:web:cef3ed4e70ae9818f347c5"
  };

  // ì´ë¯¸ ì´ˆê¸°í™”ë¼ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  // ë„¤ê°€ ì“°ëŠ” SWëŠ” "sw.js" (ë£¨íŠ¸ì— ìˆëŠ” íŒŒì¼). ì ˆëŒ€ê²½ë¡œ(/sw.js) ë§ê³  ë™ì¼í•˜ê²Œ "sw.js"ë¡œ ë§ì¶¤.
  const swReg =
    (await navigator.serviceWorker.getRegistration('sw.js')) ||
    (await navigator.serviceWorker.register('sw.js'));

  // ê¶Œí•œ ìš”ì²­ â†’ í† í° ë°œê¸‰
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    // âš ï¸ ì—¬ê¸° VAPID ê³µê°œí‚¤ë¡œ êµì²´(ì½˜ì†” > Cloud Messaging > Web configuration > Public key)
    const vapidKey = "ì—¬ê¸°ì—_ë³µì‚¬í•œ_VAPID_Public_Key";
    const token = await getToken(messaging, { vapidKey, serviceWorkerRegistration: swReg });
    console.log('FCM token:', token);

    // í† í°ì„ ì„œë²„/RTDBì— ì €ì¥í•´ ì‚¬ìš©ì/ë³‘ë™ê³¼ ë§¤í•‘
    // await fetch('/api/save-fcm-token', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ward: localStorage.getItem('linen/ward')||'', token }) });
  } else {
    console.warn('ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ:', perm);
  }

  // í¬ê·¸ë¼ìš´ë“œ ìˆ˜ì‹ 
  onMessage(messaging, (payload) => {
    console.log('foreground push:', payload);
    // í•„ìš”í•˜ë©´ í† ìŠ¤íŠ¸/ë°°ì§€ ê°±ì‹ 
  });
</script>

  

<!-- App Script -->
<script>
const REPO_SLUG = "bangat/linenward";
const APK_NAME  = "WardLinen.apk";
const LATEST_DIRECT = `https://github.com/${REPO_SLUG}/releases/latest/download/${APK_NAME}`;

const ITEMS={
  "ì‹œíŠ¸":["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ã€€ê±´"],
  "í™˜ìë³µ":["ì¼ë°˜ìƒì˜","ì¼ë°˜í•˜ì˜","ì •í˜•ìƒì˜","ì •í˜•í•˜ì˜"],
  "ê¸°íƒ€":["ì–µì œëŒ€","ì–¼ìŒí¬","ê¸°ã€€íƒ€"]
};
const COLORED_ITEMS = new Set(["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ã€€ê±´"]);
const ORTHO_ITEMS = new Set(["ì •í˜•ìƒì˜","ì •í˜•í•˜ì˜"]);
const ALL_ITEMS = Object.values(ITEMS).flat();
const WARDS=["93","83","73","71","63","62","61","52","51","42","41","ê¸°íƒ€"];

const LS={ ward:"linen/ward", logs:"linen/logs", draft:(ward)=>`linen/draft/${ward||'_none_'}` };
let state={ ward:(localStorage.getItem(LS.ward)||"").toString().trim(), section:"input", cat:"ì‹œíŠ¸" };
const el=s=>document.querySelector(s), els=s=>Array.from(document.querySelectorAll(s));

/* WebAudio fallback + unlock */
let __ac=null, __audioUnlocked=false;
function getAC(){ if(!__ac){ __ac=new (window.AudioContext||window.webkitAudioContext)(); } return __ac; }
function beep(ms=120,freq=660){
  try{
    const ac=getAC(); const o=ac.createOscillator(); const g=ac.createGain();
    o.type="triangle"; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+ms/1000);
    o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+ms/1000+0.02);
  }catch(_){}
}
function unlockAudioOnce(){
  if(__audioUnlocked) return;
  __audioUnlocked=true;
  try{ getAC().resume(); }catch(_){}

  // ğŸ”§ ì¬ìƒ/ì¼ì‹œì •ì§€ ê¸ˆì§€. load()ë§Œ í˜¸ì¶œ
  ["#submitSound","#tabSound","#btnClickSound","#warnSound"].forEach(sel=>{
    const a = el(sel);
    if (!a) return;
    try { a.load(); } catch(_) {}
  });
}

["pointerdown","touchstart","click","keydown"].forEach(evt=>{ window.addEventListener(evt, unlockAudioOnce, { once:true, passive:true }); });

/* Modal */
function openModal(sel, focusSel){ document.body.classList.add('modal-open'); const ov=el(sel); ov.style.display='block'; setTimeout(()=>{ focusSel && el(focusSel)?.focus(); },0); }
function closeModal(sel){ document.body.classList.remove('modal-open'); el(sel).style.display='none'; }

/* Sound */
function playSnd(sel){
  const freqMap = { "#btnClickSound": 880, "#tabSound": 659, "#submitSound": 523, "#warnSound": 988 };
  try{
    const a = el(sel);
    if(!a){ beep(sel==="#submitSound"?180:100, freqMap[sel]||660); return; }

    // ì´ë¯¸ ì¬ìƒ ì¤‘ì´ë©´ ëŠì§€ ë§ê³  ë˜ê°ê¸°ë§Œ
    if (!a.paused) {
      try { a.currentTime = 0; } catch(_) {}
      return;
    }

    try { a.currentTime = 0; } catch(_) {}
    const p = a.play();
    if (p && typeof p.catch === "function") {
      p.catch(err => {
        // ë‹¤ë¥¸ í˜¸ì¶œë¡œ ì¤‘ë‹¨ëœ ì •ìƒ ì¼€ì´ìŠ¤ëŠ” ë¬´ì‹œ
        if (err && (err.name === "AbortError" || err.code === 20)) return;
        console.warn("[audio] play failed:", sel, err?.name||err, err);
        beep(sel==="#submitSound"?180:100, freqMap[sel]||660);
      });
    }
  }catch(e){
    console.warn("[audio] exception:", e);
    beep(sel==="#submitSound"?180:100, (freqMap[sel]||660));
  }
}


/* Warn flash */
function flashWarn(){ try{ if(navigator.vibrate){ navigator.vibrate([120,80,120,80,120]); } }catch(e){} const ov=document.createElement('div'); ov.id='flashOverlay'; document.body.appendChild(ov); ov.addEventListener('animationend', ()=>{ ov.parentNode && ov.parentNode.removeChild(ov); }); }
function maybeBuzz(prev,next){
  const p = Number(prev)||0, n = Number(next)||0;

  // 16ê°œâ†’ì´ìƒ: í”Œë˜ì‹œ/ì§„ë™
  if (p < 16 && n >= 16) { flashWarn(); }

  // 20ê°œâ†’ì´ìƒ: ê²½ê³ ìŒ (ì˜¤íƒ€ n >= 16 â†’ n >= 20 ë¡œ ìˆ˜ì •)
  if (p < 20 && n >= 20) {
    try { playSnd("#warnSound"); } catch(_) {}
  }
}



/* Date helpers */
function rangeMsByDates(startStr,endStr){
  const sParts=startStr.split("-").map(Number), eParts=endStr.split("-").map(Number);
  let s=new Date(sParts[0],sParts[1]-1,sParts[2],0,0,0,0),
      e=new Date(eParts[0],eParts[1]-1,eParts[2],23,59,59,999);
  if(e.getTime()<s.getTime()){ const t=s; s=e; e=t; }
  return [s.getTime(), e.getTime()+1];
}

/* Local storage */
function getLogs(){ return JSON.parse(localStorage.getItem(LS.logs)||"[]"); }
function setLogs(a){ localStorage.setItem(LS.logs, JSON.stringify(a)); }
function getDraft(){ try{ return JSON.parse(localStorage.getItem(LS.draft(state.ward))||"{}"); }catch(_){ return {}; } }
function setDraft(o){ localStorage.setItem(LS.draft(state.ward), JSON.stringify(o||{})); }
function setDraftQty(item,qty){ const d=getDraft(); d[item]=(parseInt(qty)||0); setDraft(d); }

/* í•©ê³„ & ë²„íŠ¼ í™œì„±í™” */
function getCurrentTotal(){
  const draft = getDraft();   // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ëœ í˜„ ìƒíƒœ
  return Object.values(draft).reduce((a,v)=> a + (parseInt(v)||0), 0);
}

function refreshTotalUI(){
  const total = getCurrentTotal();
  const save = el("#saveAll");
  if (save){
    save.disabled = total===0;
    save.style.opacity = total===0 ? .6 : 1;
    save.textContent = total===0 ? "ì œì¶œí•˜ê¸°" : `ì œì¶œí•˜ê¸° Â· ì´ ${total.toLocaleString()}ê°œ`;
  }
}

/* ì¹© ìŠ¤í”„ë§ */
function springOnce(btn){
  try{ btn.classList.remove('spring'); void btn.offsetWidth; btn.classList.add('spring'); }catch(_){}
}

/* ---- ì»¨í…Œì´ë„ˆë¥¼ í‘¸í„° ì§ì „ê¹Œì§€ ì±„ìš°ê¸° ---- */
function fitCardToFooter(){
  const card   = document.querySelector('#sec-input .sectionCard');
  const footer = document.querySelector('.footerBar');
  if(!card || !footer) return;
  card.style.setProperty('--fillH', 'auto');
  const cardTop   = card.getBoundingClientRect().top;
  const footerTop = footer.getBoundingClientRect().top;
  const gap = Math.max(0, Math.floor(footerTop - cardTop - 12)); // í‘¸í„°ì™€ 12px ì—¬ë°±
  card.style.setProperty('--fillH', gap + 'px');
}

/* Input table */
function buildTable(){
  const tb=el("#inputTable tbody"); tb.innerHTML="";
  ITEMS[state.cat].forEach(name=>{
    const isOrtho = ORTHO_ITEMS.has(name);
    const isTwoChar = (name==="ìˆ˜ã€€ê±´" || name==="ê¸°ã€€íƒ€");
    const tr=document.createElement("tr");
    tr.className = isOrtho ? "kind-ortho" : "";
    tr.innerHTML=`
      <td class="item-name${isTwoChar?' k2':''}">${name}</td>
      <td class="qtyCell">
        <button type="button" class="chip" data-delta="-5">-5</button>
        <button type="button" class="chip" data-delta="-1">-1</button>
        <span class="qtyInputWrap">
          <input type="number" inputmode="numeric" value="0" aria-label="${name} ìˆ˜ëŸ‰" />
        </span>
        <button type="button" class="chip" data-delta="+1">+1</button>
        <button type="button" class="chip" data-delta="+5">+5</button>
      </td>`;
    const inp=tr.querySelector("input");
    const draft=getDraft();
    const init=Object.prototype.hasOwnProperty.call(draft,name)?(parseInt(draft[name])||0):0;
    inp.value=String(init); inp.dataset.prev=String(init);

    inp.addEventListener("input",()=>{
      const prev=parseInt(inp.dataset.prev||"0")||0;
      const cur=parseInt(inp.value||"0")||0;
      inp.value=String(cur); setDraftQty(name,cur); maybeBuzz(prev,cur); inp.dataset.prev=String(cur);
      refreshTotalUI();
    });
    tr.querySelectorAll("[data-delta]").forEach(btn=>{
      btn.addEventListener('click', e=>{ addRipple(e); springOnce(btn); });
      btn.onclick=()=>{
        const prev=parseInt(inp.dataset.prev||"0")||0;
        const v=(parseInt(inp.value||"0")||0)+parseInt(btn.dataset.delta,10);
        inp.value=v; setDraftQty(name,v); maybeBuzz(prev,v); inp.dataset.prev=String(v);
        playSnd("#btnClickSound");
        refreshTotalUI();
      };
    });
    tb.appendChild(tr);
  });

  if(state.cat==="ê¸°íƒ€"){
    const noteRow=document.createElement("tr");
    noteRow.innerHTML=`<td colspan="2" style="text-align:left;padding:12px;font-size:14px;color:#64748b;">ê¸°íƒ€ : ì¤‘í™˜ì˜, ê³ ê´€ì ˆ, ì–‘ìª½ëˆ, ì–‘ìª½ê³ ë¬´ì¤„</td>`;
    tb.appendChild(noteRow);
  }

  refreshTotalUI();
  fitCardToFooter(); // í‘œ ê°±ì‹  í›„ ë†’ì´ ì¬ê³„ì‚°
}

 function buildConfirmSummaryHTML() {
  const ward = (state.ward || "").toString().trim() || "ë¯¸ì„ íƒ";
  const dateStr = document.querySelector("#issueDate").value || new Date().toISOString().slice(0,10);
  const draft = (function(){ try { return JSON.parse(localStorage.getItem(LS.draft(state.ward))||"{}"); } catch(_) { return {}; } })();

  // 0ì´ ì•„ë‹Œ í•­ëª©ë§Œ [ì´ë¦„,ìˆ˜ëŸ‰] ë°°ì—´ë¡œ
  let rows = [];
  Object.keys(draft).forEach(k => {
    const v = parseInt(draft[k] || "0", 10) || 0;
    if (v !== 0) rows.push([k, v]);
  });

  // ë³´ê¸° ìˆœì„œ: ìˆ˜ëŸ‰ ë‚´ë¦¼ì°¨ìˆœ(ê°€ì‹œì„± â†‘). ì›ë˜ ìˆœì„œë¥¼ ì›í•˜ë©´ ì´ ì •ë ¬ í•œ ì¤„ì„ ì§€ì›Œë„ ë¨.
  rows.sort((a,b)=> b[1]-a[1]);

  const total = rows.reduce((a, [,v]) => a + v, 0);
  if (total === 0) {
    return `<p>ì œì¶œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ 0)</p>`;
  }

  const MAX = 12;
  const moreHtml = rows.length > MAX ? `<li class="more" style="margin-top:8px;color:#64748b">ì™¸ ${rows.length - MAX}ê°œ í•­ëª©â€¦</li>` : "";

  // ìƒ‰ìƒ ê·œì¹™(í‘œì™€ ë™ì¼ í†¤): 10+ ê°ˆìƒ‰, 15+ íŒŒë‘, 20+ ë¹¨ê°•
  const colored = (name)=> (typeof COLORED_ITEMS!=="undefined" && COLORED_ITEMS.has && COLORED_ITEMS.has(name));
  const ortho   = (name)=> (typeof ORTHO_ITEMS  !=="undefined" && ORTHO_ITEMS.has   && ORTHO_ITEMS.has(name));
  const lv = (v)=> v>=20 ? "lv3" : (v>=15 ? "lv2" : (v>=10 ? "lv1" : ""));

  const list = rows.slice(0, MAX).map(([k,v]) => `
    <li class="itemRow ${colored(k)?'isColored':''} ${ortho(k)?'isOrtho':''}">
      <span class="label">${k}</span>
      <span class="qtyBadge ${lv(v)}">${v.toLocaleString()}ê°œ</span>
    </li>
  `).join("");

  return `
    <div class="confirmHeader">
      <span class="date"><b>${dateStr}</b></span> Â· <span class="ward"><b>${ward}</b>ë³‘ë™</span>
    </div>
    <p class="confirmSub" style="margin:0 0 6px;color:#475569">ì•„ë˜ ë‚´ì—­ìœ¼ë¡œ ì œì¶œí• ê¹Œìš”?</p>
    <ul class="confirmList">${list}${moreHtml}</ul>
    <div class="confirmTotal"><span>í•©ê³„</span><strong>${total.toLocaleString()}ê°œ</strong></div>
  `;
}


  function openConfirmSubmit() {
  // ë‚´ìš© ê°±ì‹ 
  const summary = document.getElementById("confirmSummary");
  if (summary) summary.innerHTML = buildConfirmSummaryHTML();

  // ëª¨ë‹¬ ë„ìš°ê¸°
  if (typeof openModal === "function") {
    openModal("#confirmModal", "#csOk");
  } else {
    // í˜¹ì‹œ openModalì´ ì—†ìœ¼ë©´ ê¸°ë³¸ confirmë¡œ í´ë°±
    if (confirm("ì…ë ¥í•˜ì‹  ìˆ˜ëŸ‰ì„ ì œì¶œí• ê¹Œìš”?")) {
      saveAll();
    }
  }
}

// ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸
// ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸
document.addEventListener("click", (e) => {
  const id = (e.target && e.target.id) || "";
  if (id === "csCancel") {
    if (typeof closeModal === "function") closeModal("#confirmModal");
  }
  if (id === "csOk") {
    if (typeof closeModal === "function") closeModal("#confirmModal");
    saveAll();
  }
});

/* ===== ì—¬ê¸° ì•„ë˜ì— ì¶”ê°€ ===== */
function sizeModalBody(modalSel, fraction=0.5){
  const modal  = document.querySelector(modalSel);
  if (!modal) return;
  const card   = modal.querySelector('.modalCard');
  const head   = modal.querySelector('.modalHead');
  const body   = modal.querySelector('.modalBody');
  const acts   = modal.querySelector('.modalActions');
  const vh     = window.innerHeight || document.documentElement.clientHeight || 640;

  if (card) card.style.maxHeight = Math.round(vh * 0.88) + 'px';

  if (body){
    const reserve = (head?.offsetHeight||0) + (acts?.offsetHeight||0);
    const target  = Math.max(120, Math.floor(vh * fraction) - reserve);
    body.style.maxHeight = target + 'px';
    body.style.overflow  = 'auto';
  }
}



/* Save */
async function saveAll(){
  const ward=(state.ward||"").toString().trim();
  if(!ward){ alert("ë³‘ë™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
  const issue=el("#issueDate").value;
  let ts=issue?(()=>{const [y,m,d]=issue.split("-").map(Number); return new Date(y,m-1,d,12,0,0,0).getTime();})():Date.now();

  const draft=getDraft(); const batch=[];
  ALL_ITEMS.forEach(item=>{
    const q=(parseInt(draft[item]||"0")||0);
    if(q!==0) batch.push({ts, yyyymm:new Date(ts).toISOString().slice(0,7), ward, item, qty:q});
  });
  if(!batch.length){ alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ 0)"); return; }

  const logs=getLogs(); batch.forEach(b=>logs.unshift(b)); setLogs(logs.slice(0,10000));
  let ok=false; try{ if(window.__fb){ await window.__fb.saveLogsToRTDB(batch); ok=true; } }catch(e){ console.warn(e); tgLog("saveAll() ì‹¤íŒ¨:", e); }
  if(ok){
    const cur=getLogs(), keyOf=L=>[L.ts,L.ward,L.item,L.qty].join("|");
    const rm=new Set(batch.map(keyOf));
    setLogs(cur.filter(L=>!rm.has(keyOf(L))));
  }

  const cleared={}; ALL_ITEMS.forEach(i=>cleared[i]=0); setDraft(cleared);
  Array.from(document.querySelectorAll("#inputTable tbody input")).forEach(inp=>{ inp.value="0"; inp.dataset.prev="0"; });
  refreshTotalUI();

  playSnd("#submitSound");
  openModal('#submitModal', '#smOk');
  showToast("ì €ì¥ ì™„ë£Œ", "RTDB ë™ê¸°í™” & ë¡œì»¬ ë°±ì—…");

  if(document.body.classList.contains("mode-stats")){
    const d=new Date(ts).toISOString().slice(0,10);
    el("#dateStart").value=d; el("#dateEnd").value=d; await renderStats();
  }
}

/* ìƒ‰ ê°•ì¡° */
function colorStyle(item,val){
  if(!COLORED_ITEMS.has(item)) return "";
  const v=Number(val)||0;
  if(v>=20) return ' style="color:#dc2626;font-weight:800"';
  if(v>=15) return ' style="color:#1d4ed8;font-weight:800"';
  if(v>=10) return ' style="color:#b45309;font-weight:800"';
  return '';
}

/* Filter */
function rangeSelect(logs,sStr,eStr,wardFilter){
  const [s,e]=rangeMsByDates(sStr,eStr);
  return logs.filter(L=>L.ts>=s&&L.ts<e&&(wardFilter==="ì „ì²´"||(L.ward||"").toString().trim()===wardFilter));
}

/* Pivot */
function renderPivot(logs,s,e,wardFilter){
  const selected=rangeSelect(logs,s,e,wardFilter);
  const wards=(wardFilter==="ì „ì²´")?WARDS:WARDS.filter(w=>w===wardFilter);
  const items=ALL_ITEMS; const p={}; wards.forEach(w=>p[w]={}); items.forEach(i=>wards.forEach(w=>p[w][i]=0));
  selected.forEach(L=>{
    if(!(L.ward in p)) p[L.ward]={};
    if(typeof p[L.ward][L.item]!=="number") p[L.ward][L.item]=0;
    p[L.ward][L.item]+=Number(L.qty)||0;
  });
  return {p,wards,items};
}

/* ìˆ«ì ê¸¸ì´ ì¶•ì†Œ */
function shrinkBigNumbers(root){
  Array.from(root.querySelectorAll('[data-num] > .num')).forEach(span=>{
    const len=(span.textContent||'').trim().length;
    if(len>=5) span.classList.add('d5');
    else if(len===4) span.classList.add('d4');
    else if(len>=3) span.classList.add('d3');
  });
}

/* ===== Charts helpers ===== */
let __mergedCache = []; 
let lineChart=null, dowChart=null;

function fmtYYYYMMDD(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
function dateRangeArray(sStr,eStr){
  const [sMs,eMs]=rangeMsByDates(sStr,eStr);
  const arr=[]; for(let t=sMs; t<eMs; t+=86400000){ arr.push(new Date(t)); }
  return arr;
}
function buildDailySeries(item, sStr, eStr, wardFilter){
  const days = dateRangeArray(sStr,eStr);
  const map = Object.create(null);
  days.forEach(d=>map[fmtYYYYMMDD(d)]=0);
  const selected = rangeSelect(__mergedCache, sStr, eStr, wardFilter);
  selected.forEach(L=>{
    if(item!=="ëª¨ë“  í’ˆëª© í•©ê³„" && L.item!==item) return;
    const key = fmtYYYYMMDD(new Date(L.ts));
    if(!(key in map)) map[key]=0;
    map[key]+= Number(L.qty)||0;
  });
  const labels = days.map(d=>fmtYYYYMMDD(d));
  const values = labels.map(k=>map[k]||0);
  return { labels, values };
}
function buildDowSeries(values, labels){
  const dnames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  const sums = [0,0,0,0,0,0,0];
  labels.forEach((dstr, i)=>{
    const d = new Date(dstr+"T00:00:00");
    const w = d.getDay();
    sums[w] += values[i];
  });
  const order = [1,2,3,4,5,6,0];
  return { labels: order.map(i=>dnames[i]), values: order.map(i=>sums[i]) };
}
function ensureChartItemOptions(){
  const sel = el("#chartItem");
  if(sel.options.length) return;
  const opts = ["ëª¨ë“  í’ˆëª© í•©ê³„", ...ALL_ITEMS];
  opts.forEach(x=>{ const o=document.createElement("option"); o.value=o.textContent=x; sel.appendChild(o); });
}

/* Render charts */
function renderCharts(){
  ensureChartItemOptions();
  const item = el("#chartItem").value || "ëª¨ë“  í’ˆëª© í•©ê³„";
  const s = el("#dateStart").value, e = el("#dateEnd").value, ward = el("#wardFilter").value||"ì „ì²´";

  const {labels,values} = buildDailySeries(item, s, e, ward);
  const {labels: dowLabels, values: dowValues} = buildDowSeries(values, labels);

  const lc = el("#lineChart").getContext("2d");
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(lc, {
    type:"line",
    data:{ labels, datasets:[{ label:`${item} ì¼ìë³„`, data:values, tension:.25, fill:false }]},
    options:{
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.parsed.y.toLocaleString()} ê°œ` } } },
      scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:10 } }, y:{ beginAtZero:true, ticks:{ precision:0 } } }
    }
  });

  const bc = el("#dowChart").getContext("2d");
  if(dowChart) dowChart.destroy();
  dowChart = new Chart(bc, {
    type:"bar",
    data:{ labels:dowLabels, datasets:[{ label:`${item} ìš”ì¼ë³„ í•©ê³„`, data:dowValues }]},
    options:{
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.parsed.y.toLocaleString()} ê°œ` } } },
      scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
    }
  });
}

/* === Stats render === */
async function renderStats(){
  const today=new Date().toISOString().slice(0,10);
  const s=el("#dateStart").value||today;
  const e=el("#dateEnd").value||today;
  const wardFilter=el("#wardFilter").value||"ì „ì²´";
  if(!s||!e) return;

  if(window.__fb && typeof window.__fb.startStatsLiveWatcher==="function"){
    window.__fb.startStatsLiveWatcher(new Date(s+"T00:00:00"), new Date(e+"T00:00:00"), (logsRT)=>{
      const [sMs,eMs]=rangeMsByDates(s,e);
      let logsLS=[]; try{ logsLS=getLogs().filter(L=>L.ts>=sMs&&L.ts<eMs);}catch(_){}
      const uniq=new Map(); [...logsRT,...logsLS].forEach(L=>{ const k=[L.ts,L.ward,L.item,L.qty].join("|"); if(!uniq.has(k)) uniq.set(k,L); });
      const merged=Array.from(uniq.values());
      __mergedCache = merged;

      const {p,wards,items}=renderPivot(merged,s,e,wardFilter);

      const wardTotals = wards.map(w => items.reduce((a,i)=>a+(p[w]?.[i]||0),0));
      const maxTotal = Math.max(...wardTotals, 0);
      const maxWardIdx = wardTotals.findIndex(v=>v===maxTotal && v>0);

      let html=`<table class="statsTable"><thead><tr><th><span class="wardName">ë³‘ë™</span></th>${items.map(i=>`<th class="rot">${i}</th>`).join("")}</tr></thead><tbody>`;
      wards.forEach((w,rowIdx)=>{
        const isMax = (wardFilter==="ì „ì²´" && rowIdx===maxWardIdx);
        html+=`<tr class="${isMax?'maxWardRow':''}">
          <td><span class="wardName">${w}</span></td>${
          items.map(i=>{
            const v=(p[w]?.[i]||0);
            return `<td data-num="1"><span class="num"${colorStyle(i,v)}>${v}</span></td>`;
          }).join("")
        }</tr>`;
      });
      const periodTotals=items.map(i=>wards.reduce((a,w)=>a+(p[w]?.[i]||0),0));
      html+=`<tr class="total-row"><th><span class="wardName">í•©ê³„</span></th>${
        periodTotals.map((v,idx)=>`<th data-num="1"><span class="num"${colorStyle(items[idx],v)}>${v}</span></th>`).join("")
      }</tr>`;
      html+=`</tbody></table>`;
      el("#statsWrap").innerHTML=html;

      const daysCount = Math.max(1, Math.round((new Date(e) - new Date(s)) / (1000*60*60*24)) + 1);
      let sumHtml = `<table class="summaryTable">
        <thead><tr><th>í’ˆëª©</th><th>ì¼í‰ê·  ì‚¬ìš©ëŸ‰</th><th>ê¸°ê°„í•©ê³„</th></tr></thead><tbody>`;
      items.forEach((it,idx)=>{
        const psum=periodTotals[idx]||0;
        const avg=Math.round(psum/daysCount);
        sumHtml+=`<tr><td>${it}</td>
          <td${colorStyle(it,avg)}>${avg}</td>
          <td${colorStyle(it,psum)}>${psum}</td></tr>`;
      });
      sumHtml+=`</tbody></table>`;
      el("#statsSummary").innerHTML = sumHtml;

      shrinkBigNumbers(el("#statsWrap").querySelector("table"));

      el("#statsEmpty").style.display = "none";

      ensureChartItemOptions();
      renderCharts();
    });
  }
}

/* Export stats table to XLSX */
function exportXLSX(){
  const table=document.querySelector("#statsWrap table"); if(!table){ alert("í†µê³„ í‘œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  const s=el("#dateStart").value||"", e=el("#dateEnd").value||"", ward=el("#wardFilter").value||"ì „ì²´";

  const ws=XLSX.utils.table_to_sheet(table,{origin:"A2"});
  const title=`${s} ~ ${e} ${ward}ë³‘ë™ ì¶œê³ ëŸ‰`;
  XLSX.utils.sheet_add_aoa(ws,[[title]],{origin:"A1"});

  const lastCol=table.rows[0].cells.length-1;
  ws["!merges"]=ws["!merges"]||[]; ws["!merges"].push({s:{r:0,c:0},e:{r:0,c:lastCol}});
  ws["A1"].s={font:{bold:true,sz:14},alignment:{horizontal:"center",vertical:"center"}};
  ws["!rows"]=ws["!rows"]||[]; ws["!rows"][0]={hpt:22};

  const daysCount = Math.max(1, Math.round((new Date(e) - new Date(s)) / (1000*60*60*24)) + 1);
  const tBody = table.tBodies[0];
  const lastRow = tBody.rows[tBody.rows.length-1];
  const totals = Array.from(lastRow.cells).slice(1).map(c=>parseInt(c.innerText)||0);
  const avgs = totals.map(v=>Math.round(v/daysCount));

  XLSX.utils.sheet_add_aoa(ws,[["ì¼í‰ê· ", ...avgs]],{origin:-1});

  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"í†µê³„");
  XLSX.writeFile(wb,`stats_${s}_to_${e}.xlsx`);
}

/* Export chart data to XLSX */
function exportChartXLSX(){
  const s=el("#dateStart").value||"", e=el("#dateEnd").value||"", ward=el("#wardFilter").value||"ì „ì²´";
  const item = el("#chartItem").value || "ëª¨ë“  í’ˆëª© í•©ê³„";
  if(!s || !e){ alert("ê¸°ê°„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }

  const {labels,values} = buildDailySeries(item, s, e, ward);
  const {labels: dowLabels, values: dowValues} = buildDowSeries(values, labels);

  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.aoa_to_sheet([["ë‚ ì§œ","ìˆ˜ëŸ‰"], ...labels.map((d,i)=>[d,values[i]])]);
  XLSX.utils.book_append_sheet(wb, ws1, "ì¼ìì¶”ì´");
  const ws2 = XLSX.utils.aoa_to_sheet([["ìš”ì¼","í•©ê³„"], ...dowLabels.map((n,i)=>[n,dowValues[i]])]);
  XLSX.utils.book_append_sheet(wb, ws2, "ìš”ì¼í•©ê³„");
  XLSX.writeFile(wb, `trend_${item}_${s}_to_${e}.xlsx`);
}

/* Ripple */
function addRipple(e){
  const btn=e.currentTarget;
  const rect=btn.getBoundingClientRect();
  const span=document.createElement('span');
  const size=Math.max(rect.width, rect.height);
  span.className='ripple'; span.style.width=span.style.height=size+'px';
  span.style.left=(e.clientX-rect.left-size/2)+'px';
  span.style.top=(e.clientY-rect.top-size/2)+'px';
  span.style.position='absolute'; span.style.borderRadius='50%'; span.style.transform='scale(0)';
  span.style.animation='ripple .5s ease-out'; span.style.background='rgba(255,255,255,.5)'; span.style.pointerEvents='none';
  btn.appendChild(span); setTimeout(()=>span.remove(), 500);
}

/* Toast */
function showToast(msg, sub){
  const t=document.getElementById('toast');
  if(msg) document.getElementById('toastText').textContent = msg;
  if(sub) t.querySelector('.sub').textContent=sub;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1800);
}

/* Init */
function debounce(fn,delay=200){ let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),delay); }; }
window.addEventListener("DOMContentLoaded",()=>{
  const urlApp=new URL(location.href).searchParams.get("app"); if(urlApp==="1"){localStorage.setItem("appMode","1");} if(urlApp==="0"){localStorage.removeItem("appMode");}
  const ua=(navigator.userAgent||"")+" "+(navigator.vendor||"");
  if((window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||/\b; wv\b/i.test(ua)||/\bMyLinenApp\b/i.test(ua)||localStorage.getItem('appMode')==='1'){ document.body.classList.add("app"); const b=el("#appDownloadBtn"); if(b) b.style.display="none"; }

  const urlWard=new URL(location.href).searchParams.get("ward");
  if(urlWard){ state.ward=(urlWard||"").toString().trim(); localStorage.setItem(LS.ward,state.ward); }
  el("#wardSelect").value=state.ward;
  el("#wardSelect").onchange=e=>{ state.ward=(e.target.value||"").toString().trim(); localStorage.setItem(LS.ward,state.ward); buildTable(); fitCardToFooter(); };

  const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  el("#issueDate").value=`${yyyy}-${mm}-${dd}`;
  el("#dateStart").value=`${yyyy}-${mm}-${dd}`;
  el("#dateEnd").value=`${yyyy}-${mm}-${dd}`;

  buildTable();
  refreshTotalUI();
  fitCardToFooter();

  /* viewport ë³€í™”ì—ë„ ë³´ì • */
  window.addEventListener('resize', fitCardToFooter);
  window.addEventListener('orientationchange', fitCardToFooter);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', fitCardToFooter);
    // âœ… ëª¨ë‹¬ ë³¸ë¬¸ ìŠ¤í¬ë¡¤ ë†’ì´ ì¬ê³„ì‚°(íšŒì „/ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘)
  window.addEventListener('resize', ()=> sizeModalBody('#confirmModal', 0.5));
  if (window.visualViewport) window.visualViewport.addEventListener('resize', ()=> sizeModalBody('#confirmModal', 0.5));


  el("#saveAll").addEventListener('click', addRipple);
 el("#saveAll").onclick = (e) => {
  try { addRipple && addRipple(e); } catch(_) {}
  openConfirmSubmit();
};

  el("#exportXLSXBtn").addEventListener('click', addRipple);
  el("#exportXLSXBtn").onclick=exportXLSX;
  el("#appDownloadBtn").addEventListener('click', addRipple);

  function openDownloadModal(){ openModal('#downloadModal', '#dlConfirm'); }
  function closeDownloadModal(){ closeModal('#downloadModal'); }
  // el("#appDownloadBtn").onclick = openDownloadModal;
  el("#dlCancel").onclick = closeDownloadModal;
  el("#dlConfirm").onclick = () => { closeDownloadModal(); const url = LATEST_DIRECT; if(url && url.startsWith("http")) window.location.href = url; else alert("ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); };
  el("#downloadModal").addEventListener("click",(e)=>{ if(e.target === e.currentTarget) closeDownloadModal(); });

  el('#submitModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeModal('#submitModal'); });
  el('#smOk').onclick = ()=> closeModal('#submitModal');

  // Tabs
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const slider = document.getElementById('tabSlider');
  function moveSlider(){ const idx = ["ì‹œíŠ¸","í™˜ìë³µ","ê¸°íƒ€"].indexOf(state.cat); slider.style.transform = `translateX(${idx*100}%)`; }
  tabs.forEach(t=>{
    t.onclick=()=>{
      state.cat=t.dataset.cat;
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      moveSlider();
      buildTable();
      fitCardToFooter();
      playSnd("#tabSound");
    };
  });
  moveSlider();

  // Stats watchers
  const rerender=debounce(()=>{ renderStats(); },200);
  ["#dateStart","#dateEnd","#wardFilter"].forEach(sel=>{
    const n=el(sel); n&&n.addEventListener("change",rerender); n&&n.addEventListener("input",rerender);
  });

  // Charts controls
  ensureChartItemOptions();
  el("#chartItem").addEventListener("change", ()=> renderCharts());
  el("#exportChartXLSXBtn").addEventListener("click", (event)=>{ addRipple(event); exportChartXLSX(); });

  el("#gotoStats").onclick=()=>{ 
    document.body.classList.add("mode-stats"); 
    el("#sec-input").style.display="none"; 
    el("#sec-stats").style.display="block"; 
    const chosen=el("#issueDate").value||new Date().toISOString().slice(0,10); 
    el("#dateStart").value=chosen; el("#dateEnd").value=chosen; 
    renderStats(); 
  };
  el("#gotoMain").onclick=()=>{ 
    document.body.classList.remove("mode-stats"); 
    el("#sec-input").style.display="block"; 
    el("#sec-stats").style.display="none"; 
    fitCardToFooter();
  };
});
</script>

<script>
/** ================= í†µí•© ì„¤ì¹˜ ì œì–´ ìŠ¤í¬ë¦½íŠ¸ ================= */
let deferredPrompt = null;     // beforeinstallprompt ì €ì¥
let canInstall = false;        // ì„¤ì¹˜ê°€ëŠ¥ í”Œë˜ê·¸

/* 1) SW ë“±ë¡ (ìƒˆ ë²„ì „ ë‚˜ì˜¤ë©´ ìë™ ìƒˆë¡œê³ ì¹¨) */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").then(reg => {
      // ìƒˆ SWê°€ ê°ì§€ë˜ë©´ -> controllerchangeì—ì„œ ìƒˆë¡œê³ ì¹¨ ì²˜ë¦¬
      reg.addEventListener("updatefound", () => {
        // í•„ìš”ì‹œ ë¡œê·¸ë§Œ ë‚¨ê¹€
        console.log("[SW] update found");
      });
    }).catch(err => console.warn("[SW] register failed:", err));
  });

  // ìƒˆ SWê°€ í™œì„±í™”ë˜ë©´ controllerê°€ ë°”ë€œ â†’ 1íšŒ ìë™ ìƒˆë¡œê³ ì¹¨
  let refreshed = false;
  navigator.serviceWorker.addEventListener("controllerchange", () => {
    if (refreshed) return;
    refreshed = true;
    try { typeof closeModal === "function" && closeModal("#pwaInstallModal"); } catch(_) {}
    location.reload();
  });
}


/* 2) PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ìº¡ì²˜ */
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  canInstall = true;
  // ì„¤ì¹˜ ë²„íŠ¼ ë…¸ì¶œ
  const b = document.getElementById("appDownloadBtn");
  if (b) b.style.display = "block";
});

/* 3) ì„¤ì¹˜ ì™„ë£Œ */
window.addEventListener("appinstalled", () => {
  deferredPrompt = null;
  canInstall = false;
  const b = document.getElementById("appDownloadBtn");
  if (b) b.style.display = "none";
  if (typeof showToast === "function") showToast("ì„¤ì¹˜ ì™„ë£Œ", "í™ˆ í™”ë©´ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”");
});

/* 4) í™˜ê²½ íŒë³„ */
function isIOS() {
  const ua = navigator.userAgent || "";
  const isTouchMac = /Macintosh/.test(ua) && navigator.maxTouchPoints > 1;
  return /iPhone|iPad|iPod/.test(ua) || isTouchMac;
}
function isStandalone() {
  return (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches)
      || (window.navigator.standalone === true);
}

/* 5) ëª¨ë‹¬/í´ë°± í—¬í¼ë“¤ */
const APK_URL = (typeof LATEST_DIRECT === "string" && LATEST_DIRECT)
  ? LATEST_DIRECT
  : "https://github.com/bangat/linenward/releases/latest/download/WardLinen.apk";

/** APK ë‹¤ìš´ë¡œë“œ ì•ˆë‚´ ëª¨ë‹¬(ì—†ìœ¼ë©´ ë°”ë¡œ ì´ë™) */
function openAPKModal() {
  if (typeof openModal === "function" && document.querySelector("#downloadModal")) {
    openModal('#downloadModal', '#dlConfirm');
  } else {
    location.href = APK_URL;
  }
}
/** iOS ì„¤ì¹˜ ì•ˆë‚´ ëª¨ë‹¬(ì—†ìœ¼ë©´ alert) */
function openIOSInstallModal() {
  if (typeof openModal === "function" && document.querySelector("#iosInstallModal")) {
    openModal('#iosInstallModal', '#iosOk');
  } else {
    alert("Safari â†’ ê³µìœ  â†’ 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”.");
  }
}
/** PWA ì„¤ì¹˜ ìœ ë„ ì»¤ìŠ¤í…€ ëª¨ë‹¬(ì—†ìœ¼ë©´ ì¦‰ì‹œ prompt) */
function openPwaInstallModal() {
  if (typeof openModal === "function") {
    openModal("#pwaInstallModal", "#piConfirm");
    sizeModalBody("#pwaInstallModal", 0.5);
  }
}





/** ì»¤ìŠ¤í…€ ëª¨ë‹¬ ë‹«ê¸° */
function closeModalIfExists(sel) {
  if (typeof closeModal === "function" && document.querySelector(sel)) closeModal(sel);
}

/* 6) ì‹¤ì œ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ */
async function triggerInstallPrompt() {
  if (!deferredPrompt) return;
  const p = deferredPrompt;          // í•œ ë²ˆë§Œ ì‚¬ìš© ê°€ëŠ¥
  deferredPrompt = null;
  canInstall = false;
  try {
    await p.prompt();                // â† ì—¬ê¸°ì„œ ì‹œìŠ¤í…œ ì„¤ì¹˜ ëŒ€í™”ìƒì í‘œì‹œ
    const { outcome } = await p.userChoice;   // "accepted" | "dismissed"
    if (outcome === "accepted") return;
    // ì‚¬ìš©ìê°€ ë‹«ì•˜ìœ¼ë©´ ëŒ€ì•ˆ
    if (isIOS()) { openIOSInstallModal(); return; }
    openAPKModal();
  } catch {
    if (isIOS()) { openIOSInstallModal(); return; }
    openAPKModal();
  }
}

/* 7) ì»¤ìŠ¤í…€ ëª¨ë‹¬ ë²„íŠ¼ ì™€ì´ì–´ë§(ìˆì„ ë•Œë§Œ) */
document.addEventListener("click", (e) => {
  const id = (e.target && e.target.id) || "";
  // PWA ì„¤ì¹˜ ëª¨ë‹¬
if (id === "piConfirm") {            // ì„¤ì¹˜
  closeModalIfExists('#pwaInstallModal');
  if (deferredPrompt) {
    // ì—¬ê¸°ì„œë§Œ ì‹œìŠ¤í…œ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì‹¤í–‰
    triggerInstallPrompt();
  } else {
    // ì„¤ì¹˜ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ëŒ€ì•ˆ ì œì‹œ
    if (isIOS()) openIOSInstallModal();
    else openAPKModal();
  }
}
if (id === "piCancel") {             // ë‚˜ì¤‘ì—
  closeModalIfExists('#pwaInstallModal');
}

  // iOS ì•ˆë‚´ ëª¨ë‹¬
  if (id === "iosOk" || id === "iosClose") {
    closeModalIfExists('#iosInstallModal');
  }
  // ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ì˜ í™•ì¸ ë²„íŠ¼ì´ #dlConfirm ë¼ë©´ ë°”ë¡œ APK
  if (id === "dlConfirm") {
    closeModalIfExists('#downloadModal');
    location.href = APK_URL;
  }
});

  
/* 8) ë©”ì¸ ë²„íŠ¼: ìƒí™©ë³„ íë¦„ */
(function wireInstallButton(){
  const btn = document.getElementById("appDownloadBtn");
  if (!btn) return;
  if (isStandalone()) { btn.style.display = "none"; return; }

  btn.onclick = (event) => {
    try { typeof addRipple === "function" && addRipple(event); } catch(_) {}

    // iOSëŠ” A2HS ì•ˆë‚´, ê·¸ ì™¸ëŠ” ë¬´ì¡°ê±´ ìš°ë¦¬ ëª¨ë‹¬ ë¨¼ì €
    if (isIOS()) {
      openIOSInstallModal();
      return;
    }
    openPwaInstallModal();   // ì„¤ì¹˜ ê°€ëŠ¥ ì—¬ë¶€ëŠ” ëª¨ë‹¬ì˜ "ì„¤ì¹˜"ì—ì„œ íŒë‹¨
  };
})();

</script>



</body>
</html>
