<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

<!-- ë¼ì´íŠ¸ ëª¨ë“œ ê³ ì • -->
<meta name="color-scheme" content="light" />
<meta name="theme-color" content="#f4f7fb" />

<!-- â–·â–·â–· ë©”íƒ€(ê°•ì œ ë¼ì´íŠ¸ ê³ ì •) ì‹œì‘ â–·â–·â–· -->
<!-- iOS/Safari: í¼ì»¨íŠ¸ë¡¤/ìŠ¤í¬ë¡¤ë°” ë“± ì‹œìŠ¤í…œ UIê¹Œì§€ ë¼ì´íŠ¸ë§Œ ì§€ì› -->
<meta name="supported-color-schemes" content="light" />
<!-- í¬ë¡¬/ì•ˆë“œë¡œì´ë“œ/ì‚¼ì„±ì¸í„°ë„·: ë‹¤í¬ í™˜ê²½ì—ì„œë„ ì£¼ì†Œì°½ ìƒ‰ì„ ë¼ì´íŠ¸ë¡œ ê³ ì • -->
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#f4f7fb" />
<!-- ë‹¤í¬ ë¦¬ë”(í™•ì¥í”„ë¡œê·¸ë¨) ê°•ì œ ë°˜ì „ ë¬´ì‹œ -->
<meta name="darkreader-lock" />
<!-- â–·â–·â–· ë©”íƒ€(ê°•ì œ ë¼ì´íŠ¸ ê³ ì •) ì¢…ë£Œ â–·â–·â–· -->


  <!-- PWA/ì•„ì´ì½˜ -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <title>ë¦°ë„¨ì‹¤ ì¶œê³ ê´€ë¦¬</title>

  <style>
    /* ===== ë¼ì´íŠ¸ ëª¨ë“œ ê°•ì œ ê¸°ë³¸ê°’ ===== */
    :root{
      color-scheme: light;
      --bg:#f4f7fb;
      --card:#ffffff;
      --accent:#2563eb;
      --muted:#5b677a;
      --text:#0f172a;
      --border:#e6eaf2;
      --r-lg:16px; --r-md:12px;
      --shadow-1:0 4px 16px rgba(15,23,42,.08);
      --shadow-2:0 10px 30px rgba(15,23,42,.10);
      --focus:0 0 0 2px rgba(37,99,235,.22), 0 0 0 6px rgba(37,99,235,.1);
    }

  /* ===== ì‹œìŠ¤í…œ ë‹¤í¬ëª¨ë“œì—¬ë„ ë¼ì´íŠ¸ ê°’ìœ¼ë¡œ ê°•ì œ ===== */
@media (prefers-color-scheme: dark){
  :root{
    --bg:#f4f7fb !important;
    --card:#ffffff !important;
    --accent:#2563eb !important;
    --muted:#5b677a !important;
    --text:#0f172a !important;
    --border:#e6eaf2 !important;
  }
  html, body{
    background: var(--bg) !important;
    color: var(--text) !important;
  }
}

/* â–·â–·â–· CSS(force-light-mobile) ì‹œì‘ â–·â–·â–· */
/* í„°ì¹˜ ë””ë°”ì´ìŠ¤(ëª¨ë°”ì¼)ì—ì„œ OS/ë¸Œë¼ìš°ì €ì˜ ê°•ì œ ë‹¤í¬ ë°˜ì „ì„ ë¬´ë ¥í™” */
@media (prefers-color-scheme: dark) and (pointer: coarse){
  html, body{
    color-scheme: light !important;
    background: #ffffff !important;
    filter: none !important;
  }
  /* ì´ë¯¸ì§€/ë¹„ë””ì˜¤ê°€ ë°˜ì „ë˜ëŠ” í˜„ìƒ ë°©ì§€ */
  img, picture, video, canvas, svg{
    filter: none !important;
    mix-blend-mode: normal !important;
  }
  /* ì¼ë¶€ ë¸Œë¼ìš°ì €ê°€ htmlì— filter ì¸ë¼ì¸ì„ ì£¼ì…í•  ë•Œ ì°¨ë‹¨ */
  html:where([style*="filter"]){
    filter: none !important;
  }
  /* Dark Reader ë¥˜ê°€ data-ì†ì„±ìœ¼ë¡œ í…Œë§ˆë¥¼ ê°•ì œí•˜ëŠ” ê²½ìš° ì¤‘ë¦½í™” */
  html[data-darkreader-mode], body[data-darkreader-mode],
  :root[data-darkreader-mode], [data-darkreader-scheme]{
    color-scheme: light !important;
    filter: none !important;
    background: #ffffff !important;
  }
}
/* â–·â–·â–· CSS(force-light-mobile) ì¢…ë£Œ â–·â–·â–· */


  /* 2) ë¬¸ì„œ ì „ì—­ ë¼ì´íŠ¸ ë Œë”ë§ íŒíŠ¸ */
  html{
    color-scheme: light !important;
    /* ì¼ë¶€ ë¸Œë¼ìš°ì €ì˜ 'ìë™ ë°˜ì „' ì™„í™” */
    filter: none !important;
    background: var(--bg) !important;
  }
  body{
    background: var(--bg) !important;
    color: var(--text) !important;
    filter: none !important;
  }

  /* 3) ë¯¸ë””ì–´/ë²¡í„° ë°˜ì „ ë°©ì§€ (ìë™ ë‹¤í¬ê°€ ê±¸ë¦¬ë©´ ì´ë¯¸ì§€ê°€ ë’¤ì§‘í˜€ ë³´ì¼ ìˆ˜ ìˆìŒ) */
  img, picture, video, canvas, svg{
    filter: none !important;
    mix-blend-mode: normal !important;
  }

/* â–·â–·â–· CSS(dark-optout) ì¢…ë£Œ â–·â–·â–· */


    *{box-sizing:border-box}
    html,body{height:100%; -webkit-text-size-adjust:100%}
    body{
      margin:0;
      font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
 
  
/* ----- ë¡œë”© ì˜¤ë²„ë ˆì´ ì‹œì‘ ----- */
#loadingOverlay{
  position:fixed; inset:0;
  background:rgba(255,255,255,.8);
  display:none; align-items:center; justify-content:center;
  z-index:20000; flex-direction:column;
  font-weight:800; color:#1f2937;
}
#loadingOverlay .spinner{
  width:48px; height:48px;
border:5px solid #bfdbfe;   /* ì—°í•œ íŒŒë‘ */
border-top:5px solid #2563eb; /* ì§„í•œ íŒŒë‘ */
  border-radius:50%; animation:spin 1s linear infinite;
  margin-bottom:16px;
}

@keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
/* ----- ë¡œë”© ì˜¤ë²„ë ˆì´ ì¢…ë£Œ ----- */

  
  /* --- íŠ¹ì • ìš”ì²­ ë°˜ì˜ ìŠ¤íƒ€ì¼ --- */
  .chip.ctrl.minus{
    background:#fff !important;
    color:#ef4444 !important;
    border:1px solid #e5e7eb !important;
    box-shadow:0 4px 12px rgba(0,0,0,.06) !important;
  }
  .chip.ctrl.minus:hover{ filter:none !important; transform:translateY(-1px) !important; }
  .chip.ctrl.minus:active{ transform:translateY(0) !important; }
  .tabs .tab-slider{ display:none !important; }

  /* --- ìƒë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ --- */
  .topNav{
    position:sticky; top:0; z-index:90;
    background:rgba(255,255,255,.65);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(15,23,42,.08);
    box-shadow: 0 6px 20px rgba(2, 6, 23, .06);
    padding:8px 12px; min-height:64px;
    margin-bottom:10px;
  }
.topNav .nav{
    max-width:980px; margin:0 auto; position:relative;
    display:grid; grid-template-columns:repeat(4,1fr);
    align-items:center; height:48px; padding:0 8px;
    background:transparent; border:none; box-shadow:none;
}
/* --------ì£¼ì„(navTab-style) ì‹œì‘ -------- */
.navTab{
    appearance:none; background:transparent; border:0;
    height:100%; display:flex; align-items:center; justify-content:center;
    font-weight:800; letter-spacing:.1px; color:#334155; cursor:pointer;
    border-radius:10px; padding:0 4px; position:relative; z-index:1;
    transition: color .15s ease;

    /* ì¤„ë°”ê¿ˆ ë°©ì§€ & ì•„ì´ì½˜-í…ìŠ¤íŠ¸ ê°„ê²© */
    white-space: nowrap;          /* í•œ ì¤„ ê³ ì • */
    word-break: keep-all;         /* í•œêµ­ì–´ ë‹¨ì–´ ìª¼ê°œì§€ì§€ ì•Šê²Œ */
    gap: 6px;                     /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ê°„ê²© */
}
/* --------ì£¼ì„(navTab-style) ì¢…ë£Œ -------- */


  .navTab:hover{ color:#1e40af; }
  .navTab.active{ color:#0b3fb8; }
.nav-slider{
    position:absolute; left:8px; right:8px; bottom:6px;
    width:calc(25% - 16px); height:3px; border-radius:999px;
    background:linear-gradient(90deg,#93c5fd,#2563eb);
    box-shadow:0 0 0 1px rgba(37,99,235,.15), 0 6px 14px rgba(37,99,235,.25);
    transition:transform .25s cubic-bezier(.2,.8,.2,1);
    pointer-events:none;
}
  .topNav.elevated{
    box-shadow:0 10px 28px rgba(2, 6, 23, .10);
    border-bottom-color: rgba(15,23,42,.12);
  }

  /* --- í—¤ë” ë° í¼ ìš”ì†Œ --- */
  header{
    position:sticky; top:64px; z-index:50; display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px 16px; background:var(--card); border-bottom:1px solid var(--border);
  }
  .left{display:flex;gap:10px;align-items:center}
  .right{display:flex;gap:8px}
  label.head{font-weight:800;color:#334155;margin-right:6px;white-space:nowrap}
  select,input[type=date]{padding:10px 12px;font-size:16px;border:1px solid var(--border);border-radius:var(--r-md);background:#fff;color:var(--text);transition:border-color .12s,box-shadow .12s}
  select:focus,input[type=date]:focus{outline:none;border-color:var(--accent);box-shadow:var(--focus)}
  #wardSelect{ width:100% !important; }
  .formRow{ grid-template-columns: var(--label-w) 1fr; }
  .formRow > *:nth-child(2){ min-width:0; }
  .formRow select,
  .formRow input[type="date"]{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
    transition:border-color .12s, box-shadow .12s;
  }

  /* --- ë²„íŠ¼ ìŠ¤íƒ€ì¼ --- */
  button{border:0;border-radius:12px;padding:10px 14px;font-size:15px;font-weight:700;cursor:pointer;transition:transform .12s,filter .12s; position:relative; overflow:hidden}
  .btn{background:#eef2f7;color:#1f2a44;border:1px solid var(--border);box-shadow:var(--shadow-1)}
  .btn:hover{filter:brightness(1.02);transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.acc{background:linear-gradient(180deg,#4f83ff,#2563eb);color:#fff;border:1px solid #2856c7;box-shadow:0 6px 22px rgba(37,99,235,.25)}

  /* --- ë©”ì¸ ë ˆì´ì•„ì›ƒ ë° ì¹´ë“œ --- */
  main{max-width:980px;margin:0 auto;padding:12px 16px calc(110px + env(safe-area-inset-bottom));}
  h1{font-size:20px;margin:6px 0 8px;color:#0f172a}
  .fieldRow{display:flex;align-items:center;gap:10px}
  .fieldRow .lab{flex:0 0 72px; font-weight:800; color:#334155}
  #issueDate{flex:1; min-width:0}
  .sectionCard{
    padding:14px; border-radius:20px; background:#fff;
    box-shadow: 0 16px 44px rgba(15,23,42,.10);
    border:1px solid rgba(15,23,42,.06);
    min-height: var(--fillH, auto);
  }

  /* --- í’ˆëª© ì¹´í…Œê³ ë¦¬ íƒ­ --- */
.tabs{
  width:100%;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:8px;
  margin:10px 0;
  padding:0;
  background:transparent;
  border:0;
}
.tab{
  height:48px;
  display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size:16px; letter-spacing:.1px;
  color:#1e3a8a;
  background:#fff;
  border:1px solid #cfe0ff;
  border-radius:12px;
  cursor:pointer;
  transition: background .15s ease, color .15s ease, border-color .15s ease, transform .08s ease, box-shadow .15s ease;
  box-shadow:0 4px 12px rgba(2,6,23,.06);
}
.tab:hover{ background:#f7faff; color:#0b2ea8; transform:translateY(-1px); }
.tab:active{ transform:translateY(0); }
.tab.active{
  color:#fff;
  background:linear-gradient(180deg,#4f83ff,#2563eb);
  border-color:#1d4ed8;
  box-shadow:0 10px 24px rgba(37,99,235,.25), inset 0 0 0 1px rgba(255,255,255,.14);
}
.tab:focus-visible{ outline:none; border-color:#2563eb; box-shadow:var(--focus); }
.tabs .tab-slider{ display:none !important; }
@media (max-width:430px){
  .tabs{ gap:6px; }
  .tab{ height:44px; font-size:15px; }
}

  /* --- í’ˆëª© ì…ë ¥ í…Œì´ë¸” --- */
  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow-2)}
  thead th{background:#f6f8fc;color:#1e293b;font-weight:800}
  th,td{border-bottom:1px solid var(--border);padding:10px;font-size:16px;text-align:center}
  td:first-child,th:first-child{text-align:left}
  .col-item{width:42%}.col-qty{width:58%}

  #inputTable td.item-name{
    position:relative; font-size:16.5px; font-weight:900; color:#1f2937; white-space:nowrap; z-index:0;
  }
  #inputTable td.item-name::before{
    content:""; position:absolute; inset:4px 6px; border-radius:12px;
    background:linear-gradient(180deg,#fff8e1,#fff4c4);
    box-shadow: inset 0 0 0 1px rgba(245,158,11,.22), 0 4px 14px rgba(15,23,42,.06);
    z-index:-1;
  }
  #inputTable td.item-name::after{ content:none !important; }
  @media (max-width:430px){
    #inputTable td.item-name::before{ inset:3px 5px; border-radius:10px; }
  /* âœ… ì—¬ê¸° ë°‘ì— ì¶”ê°€ */
  #inputTable tr.feat td.item-name{
    color:#b45309;   /* ì§„í•œ ì˜¤ë Œì§€ ë¸Œë¼ìš´ */
    font-weight:900; /* ê¸€ì ë‘ê»ê²Œ */
    letter-spacing:.5px; /* ì•½ê°„ ê°„ê²© */
  }
  #inputTable tr.feat td.item-name::before{
    background:#f59e0b;   /* í¬ì¸íŠ¸ ì£¼í™© */
    box-shadow:0 0 0 2px rgba(245,158,11,.15);
  }
    
    #inputTable td.item-name::after{ left:8px; height:56%; }
  }
  .item-name.k2::after{content:""; display:inline-block; width:.9em;}
  @media (max-width:430px){ .item-name.k2::after{ width:1.05em; } }
  tr.kind-ortho td.item-name{ color:#1d4ed8; font-weight:900; }
  tr.kind-ortho td.item-name::after{ background:linear-gradient(180deg,#bfdbfe,#3b82f6); opacity:.75; }

  /* --- ìˆ˜ëŸ‰ ì…ë ¥ ì…€ --- */
  .qtyCell{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:nowrap}
  .qtyInputWrap{ position:relative; display:inline-block; }
  .qtyCell input{
    width:70px; height:42px; font-size:16px; text-align:center; padding:0 12px;
    border:1px solid var(--border); border-radius:12px; background:#fff; color:#0f172a;
  }
  .chip{ height:42px; min-width:54px; font-size:15px; }
  .chip.spring{ animation:springy .18s cubic-bezier(.17,.89,.32,1.28); }
  @keyframes springy{0%{transform:scale(1)}40%{transform:scale(.96)}70%{transform:scale(1.06)}100%{transform:scale(1)}}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}

  /* --- ê¸°íƒ€ UI ìš”ì†Œ --- */
  .empty{margin-top:16px;padding:18px;border:1px dashed var(--border);border-radius:16px;text-align:center;color:var(--muted);background:#fff}

  /* --- í‘¸í„° ì•¡ì…˜ë°” --- */
  .footerBar{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);padding:10px;display:flex;justify-content:center;z-index:50; padding-bottom: max(10px, env(safe-area-inset-bottom));}
  .footerCol{display:flex;flex-direction:column;gap:10px;align-items:stretch;max-width:980px;width:100%}
  #saveAll{width:100%;font-size:18px;padding:12px 16px;border-radius:14px}
  #appDownloadBtn{width:100%;font-size:16px;padding:12px 16px;border-radius:12px;background:#eef2f7;color:#1f2a44;border:1px solid var(--border)}
  #saveAll,#appDownloadBtn{display:block}
  #exportXLSXBtn{display:none}

  /* --- í†µê³„ í™”ë©´ ì „ìš© ìŠ¤íƒ€ì¼ --- */
  body.mode-stats header{display:none}
  body.mode-stats #saveAll, body.mode-stats #appDownloadBtn{display:none}
  body.mode-stats #exportXLSXBtn{display:block;width:100%;font-size:16px;padding:12px 16px;border-radius:12px}
  #sec-stats .row-wrap{display:flex;align-items:center;gap:8px}
  #sec-stats .row-wrap.dates input[type=date]{flex:1 1 0;min-width:0;font-size:15px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#var(--text)}
  #sec-stats .row-wrap select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#var(--text)}

  /* --- í†µê³„ í…Œì´ë¸” --- */
  #statsWrap{overflow-x:auto}
  .statsTable{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-2)}
  .statsTable th,.statsTable td{padding:6px 4px;text-align:center;border-bottom:1px solid var(--border);border-right:1px solid var(--border);font-size:13px;line-height:1.05;font-variant-numeric:tabular-nums;color:#0f172a;white-space:nowrap}
  .statsTable thead th{background:#f6f8fc;color:#0f172a;font-weight:800}
  .statsTable th:first-child,.statsTable td:first-child{ text-align:left !important; width:60px }
  .statsTable td[data-num], .statsTable th[data-num]{ text-align:center; padding:6px 2px; overflow:hidden; }
  .statsTable .total-row th:first-child{ text-align:left !important; }
  .statsTable tr:last-child td,.statsTable tr:last-child th{border-bottom:none}
  .statsTable th.rot{writing-mode:vertical-rl;text-orientation:upright;line-height:1;letter-spacing:0;width:22px;padding:4px 2px}
  .num{display:inline-block; line-height:1; font-variant-numeric:tabular-nums; max-width:100%}
  .d3{font-size:11px; letter-spacing:-.3px}
  .d4{font-size:10px; letter-spacing:-.4px}
  .d5{font-size:9px; letter-spacing:-.5px}
  /* ----- [êµì²´] ìˆœìœ„ í‘œì‹œ ìŠ¤íƒ€ì¼ ì‹œì‘ ----- */
/* 1, 2, 3ë“± í–‰ì— í•˜ì´ë¼ì´íŠ¸ ë°°ê²½ìƒ‰ ì ìš© */
tr[data-rank="1"] td { background: #fffbe6 !important; }
tr[data-rank="2"] td { background: #f7f7f7 !important; }
tr[data-rank="3"] td { background: #fff3e6 !important; }

.statsTable td:first-child{position:relative}
.statsTable td:first-child .wardName,
.statsTable th:first-child .wardName{display:inline-block; padding-left:24px; position:relative}

/* data-rank ì†ì„±ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ì•„ì´ì½˜ í‘œì‹œ */
[data-rank] td:first-child .wardName::before {
  position: absolute;
  left: 2px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px; /* ì•„ì´ì½˜ í¬ê¸° ì¡°ì ˆ */
}
tr[data-rank="1"] td:first-child .wardName::before { content: "ğŸ¥‡"; }
tr[data-rank="2"] td:first-child .wardName::before { content: "ğŸ¥ˆ"; }
tr[data-rank="3"] td:first-child .wardName::before { content: "ğŸ¥‰"; }
/* ----- [êµì²´] ìˆœìœ„ í‘œì‹œ ìŠ¤íƒ€ì¼ ì¢…ë£Œ ----- */

  /* --- ëª¨ë°”ì¼ í™”ë©´ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ (Compact) --- */
  @media (max-width:420px){
    .chip{min-width:44px;height:34px;font-size:14px}
    .qtyCell input{height:34px;width:48px;font-size:14px}
    .item-name{font-size:14.5px}
    .tab{padding:7px 8px}
  }

  /* --- ê²½ê³  íš¨ê³¼ --- */
  #flashOverlay{position:fixed; inset:0; background:#ef4444; opacity:0; pointer-events:none; animation: flashOverlay3 .24s ease-in-out 3; z-index:9999}
  @keyframes flashOverlay3{0%{opacity:0}50%{opacity:.30}100%{opacity:0}}

  /* --- ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
  .modal-open { overflow:hidden; }
  .modalOverlay{ position:fixed; inset:0; display:none; background:rgba(15,23,42,.5); z-index:10000; }
  .modalCard{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(92vw,520px); max-height:88vh; display:flex; flex-direction:column;
    background:#fff; color:#0f172a; border-radius:16px; box-shadow:0 20px 60px rgba(15,23,42,.25); overflow:hidden;
  }

  /* --- ê´€ë¦¬ì PIN ì…ë ¥ ëª¨ë‹¬ --- */
.adminPin .pinLabel{ display:block; font-weight:800; color:#334155; margin:2px 0 8px; }
.adminPin .pinInput{
  width:100%; height:56px; line-height:56px;
  font-size:22px; font-weight:900; text-align:center;
  letter-spacing:6px; border:1px solid var(--border);
  border-radius:12px; background:#fff; color:#0f172a;
  padding:0 12px; caret-color:transparent;
}
.adminPin .pinInput:focus{ outline:none; border-color:#2563eb; box-shadow:var(--focus); }
.pinPad{
  margin-top:12px;
  display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
}
.pinPad button{
  height:54px; font-size:20px; font-weight:900;
  border-radius:12px; border:1px solid var(--border);
  background:#fff; box-shadow:var(--shadow-1);
}
.pinPad button.wide{ grid-column:1 / span 2; }
.pinPad button[aria-label="ì§€ì›€"]{ background:#f8fafc; }
@media (max-width:430px){
  .adminPin .pinInput{ height:52px; font-size:20px; }
  .pinPad button{ height:52px; font-size:19px; }
}

  /* --- ëª¨ë‹¬ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ --- */
  .modalHead{ padding:16px 18px; font-weight:800; font-size:18px; border-bottom:1px solid var(--border); flex:0 0 auto; }
  .modalBody{ padding:16px 18px; font-size:14px; line-height:1.5; color:#475569; flex:1 1 auto; min-height:0; overflow:auto; max-height:50vh; }
  .modalActions{ display:flex; gap:10px; padding:14px 16px; background:#f8fafc; border-top:1px solid var(--border); flex:0 0 auto; }
  .modalActions .btn{ flex:1; }
  .modalActions .btn.cancel{ background:#eef2f7; color:#1f2a44; border:1px solid var(--border); }
  .modalActions .btn.primary{ background:linear-gradient(180deg,#4f83ff,#2563eb); color:#fff; border:1px solid #2856c7; }

  /* --- í† ìŠ¤íŠ¸ ì•Œë¦¼ --- */
  .toast{
    position:fixed; right:18px; bottom:90px; transform:translateY(20px);
    background:linear-gradient(180deg,#10b981,#059669); color:#fff; font-weight:900;
    padding:12px 14px; border-radius:14px; box-shadow:0 16px 40px rgba(5,150,105,.35);
    opacity:0; pointer-events:none; transition:opacity .18s, transform .18s; z-index:11000;
    display:flex; align-items:center; gap:10px;
  }
  .toast.show{opacity:1; transform:translateY(0)}
  .toast .sub{font-weight:600;opacity:.9;font-size:12px}
  .toast .check{width:18px; height:18px; border-radius:50%; background:#fff; color:#059669; display:inline-grid; place-items:center; font-weight:900}

  /* --- í†µê³„ ì°¨íŠ¸ --- */
  #statsCharts{margin-top:14px}
  #statsCharts .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-2); padding:12px; }
  #statsCharts h2{margin:10px 2px 8px; font-size:18px}
  .chartControls{display:flex; gap:8px; align-items:center; margin:8px 2px 12px; flex-wrap:wrap}
  .chartControls select{padding:8px 10px; border:1px solid var(--border); border-radius:10px}
  .chartGrid{display:grid; grid-template-columns:1fr; gap:12px}
  @media (min-width:720px){ .chartGrid{grid-template-columns:1fr 1fr} }
  #exportChartXLSXBtn{padding:10px 12px; border-radius:10px}

  /* --- ì ‘ê·¼ì„± (ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”) --- */
  @media (prefers-reduced-motion: reduce){
    .chip.spring{ animation:none !important; }
    .tab-slider{ transition:none }
    .nav-slider{ transition:none }
  }

  /* --- ëª¨ë°”ì¼ í™”ë©´ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ (ìƒì„¸) --- */
  @media (max-width: 430px){
    .sectionCard{ padding:10px 10px 12px; box-shadow:0 8px 22px rgba(15,23,42,.08); }
    h1{ margin:6px 0 8px; font-size:18px; }
    #sec-input h1 span{ width:100%; }
    #issueDate{ flex:1; width:100%; }
    .tabs{ margin:6px 0 8px; padding:2px; border-radius:12px; }
    .tab{ padding:6px 8px; font-size:15px; line-height:1; }
    .tab-slider{ top:2px; bottom:2px; }
    #inputTable{ margin-top:6px; border-radius:12px; }
    #inputTable thead th{ padding:8px 6px; font-size:14px; }
    #inputTable td, #inputTable th{ padding:8px 6px; font-size:14px; }
    .col-item{ width:40%; }
    .col-qty{ width:60%; }
    .qtyCell{ gap:4px; flex-wrap:nowrap; }
    .chip{ height:32px; min-width:40px; padding:0 8px; font-size:13px; white-space:nowrap; }
    .qtyCell input{ width:44px; height:32px; font-size:14px; padding:0 10px; }
    .item-name{ font-size:14.5px; white-space:nowrap; }
  }

  /* --- ì œì¶œ í™•ì¸ ëª¨ë‹¬ --- */
  .tabs{ overflow:hidden; contain:layout paint; }
  .modalBody .confirmHeader{font-weight:800;color:#0f172a;margin:2px 0 8px}
  .modalBody .confirmHeader .date{font-size:15px}
  .modalBody .confirmHeader .ward{color:#0b3fb8}
  .confirmList{list-style:none;margin:10px 0 0;padding:0}
  .confirmList .itemRow{ display:flex;justify-content:space-between;align-items:center;gap:12px; padding:8px 10px;margin-top:8px;background:#f8fafc; border:1px solid var(--border);border-radius:12px; }
  .itemRow .label{font-weight:700;color:#1f2937}
  .itemRow.isColored .label{color:#0b3fb8}
  .itemRow.isOrtho .label{color:#2563eb}
  .qtyBadge{ min-width:76px;text-align:right;font-weight:900; padding:6px 10px;border-radius:999px;background:#eef2f7;color:#0f172a }
  .qtyBadge.lv1{background:#fff3cd;color:#b45309}
  .qtyBadge.lv2{background:#dbeafe;color:#1d4ed8}
  .qtyBadge.lv3{background:#fee2e2;color:#dc2626}
  .confirmTotal{ display:flex;justify-content:space-between;align-items:center; margin-top:12px;padding:10px;border-top:1px dashed var(--border); font-size:16px }
  .confirmTotal strong{font-size:18px}
  .modalCard{width:min(92vw,560px)}

  /* --- UI ê°œì„  ìŠ¤íƒ€ì¼ --- */
  header{ display:none !important; }
  .formHeader{
    display:flex; flex-direction:column; gap:10px;
    padding:12px; margin-bottom:14px;
    background:linear-gradient(180deg,#fafcff,#f6f9ff);
    border:1px solid var(--border); border-radius:16px;
    box-shadow: inset 0 1px 0 rgba(15,23,42,.03), 0 6px 20px rgba(15,23,42,.06);
  }
  .formRow{
    --label-w: 76px;
    display:grid; grid-template-columns: var(--label-w) 1fr; align-items:center; column-gap:10px;
  }
  .fLabel{ font-weight:800; color:#334155; white-space:nowrap; }
  .formRow select, .formRow input[type="date"]{
    width:100%; padding:10px 12px; font-size:16px; border:1px solid var(--border); border-radius:12px; background:#fff; color:var(--text);
    transition:border-color .12s, box-shadow .12s;
  }
  .formRow select:focus, .formRow input[type="date"]:focus{ outline:none; border-color:var(--accent); box-shadow:var(--focus); }
  @media (max-width:430px){
    .formHeader{ padding:10px; margin-bottom:12px; border-radius:14px; }
    .formRow{ --label-w: 68px; }
  }
  #inputTable thead th{ padding:12px 10px; font-size:15.5px; }
  #inputTable td, #inputTable th{ padding:12px 10px; font-size:16px; }
  #inputTable .item-name{ font-size:16.5px; }
  .qtyCell{ gap:10px }
  .qtyInputWrap{ position:relative; display:inline-block }
  .qtyCell input{
    width:92px; height:46px; font-size:17px; text-align:center;
    padding:0 12px; border-radius:12px; line-height:46px;
  }
  .chip{ height:46px; min-width:56px; font-size:16px; border-radius:12px; }
  .chip.ctrl{ color:#fff; border:1px solid transparent; box-shadow:0 6px 16px rgba(0,0,0,.08) }
  .chip.ctrl.plus { background:linear-gradient(180deg,#60a5fa,#2563eb); border-color:#1d4ed8 }
  .chip.ctrl:hover{ filter:brightness(1.03); transform:translateY(-1px) }
  .chip.ctrl:active{ transform:translateY(0) }
  @media (max-width:430px){
    #inputTable td, #inputTable th{ padding:10px 8px; font-size:15.5px }
    #inputTable .item-name{ font-size:16px }
    .qtyCell input{ width:86px; height:44px; font-size:16.5px; padding:0 10px; line-height:44px }
    .chip{ height:44px; min-width:52px; font-size:15.5px }
  }

  /* --- ê°„ì†Œí™” í—¤ë” --- */
  .miniHeader{ margin:6px 0 10px; }
  .miniBtn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border:1px solid var(--border); border-radius:12px;
    background:#fff; font-weight:800; color:#1f2937;
    box-shadow:var(--shadow-1); cursor:pointer;
  }
  .miniBtn:hover{ filter:brightness(1.02); transform:translateY(-1px); }
  .miniBtn:active{ transform:translateY(0); }
  .miniBtn #curWard{ color:#0b3fb8; }

  /* --- í†µê³„ ìš”ì•½ í…Œì´ë¸” --- */
  #statsSummary .summaryTable { table-layout: fixed; }
  #statsSummary .summaryTable th {
    font-size: 13.5px;
    white-space: nowrap;
    padding: 8px 2px;
  }
  #statsSummary .summaryTable td:first-child {
    font-size: 15px;
    white-space: nowrap;
  }
  #statsSummary .summaryTable td:first-child {
    font-weight: 700;
    font-size: 16px;
    text-align: center;
  }
  #statsSummary .summaryTable td.item-name-justify {
    display: flex;
    justify-content: space-between;
  }

  /* --- ìˆ˜ëŸ‰ ê³„ì‚°ê¸° ëª¨ë‹¬ --- */
  #qtyCalcModal #qcItem{ display:none !important; }
  .qcPad{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    grid-auto-rows: 56px;
    gap:8px;
    user-select:none;
    align-items:stretch;
  }
  .qcPad button{
    height:100%;
    min-height:56px;
    font-size:19px;
    font-weight:800; border-radius:12px;
    border:1px solid var(--border); background:#fff; box-shadow:var(--shadow-1);
    width:100%; display:block;
  }
  .qcPad button:hover{ filter:brightness(1.02); transform:translateY(-1px); }
  .qcPad button:active{ transform:translateY(0); }
  .qcPad .wide3{ grid-column: 1 / span 3; }
  .qcPad .pos-plus{ grid-column: 4; grid-row: 3 / span 2; }
  @media (max-width:430px){
    .qcPad{ grid-auto-rows: 52px; }
    .qcPad button{ min-height:52px; font-size:18px; }
  }
  #qtyCalcModal .qcRow { display: none !important; }
  #qtyCalcModal #qcExpr{
    display:block;
    padding:10px 12px;
    margin-bottom:10px;
    font-weight:900;
    font-size:20px;
    color:#0f172a;
    background:#f8fafc;
    border:1px solid var(--border);
    border-radius:12px;
  }
  #qtyCalcModal #qcExpr{
    box-sizing: border-box;
    display: block;
    width: 100%;
    height: 46px !important;
    line-height: 46px !important;
    padding: 0 12px !important;
    font-weight: 900 !important;
    font-size: 18px !important;
    font-variant-numeric: tabular-nums;
    letter-spacing: .2px;
    white-space: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    color: #0f172a !important;
    background: #ffffff !important;
    border: 1px solid var(--border) !important;
    border-radius: 12px !important;
    margin-bottom: 10px !important;
  }

  /* --- iOS ìë™ ì¤Œ ë°©ì§€ --- */
  input, select, textarea, button { font-size: 16px; }
  button, .navTab, .tab, .chip, .miniBtn { touch-action: manipulation; }

  /* --- ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ Placeholder --- */
  #adminPass::placeholder {
    font-family: sans-serif;
    font-size: 14px;
    font-style: normal;
    color: #999;
  }
/* --- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ íƒ­ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ --- */
.navTab .icon {
  width: 18px;
  height: 18px;
  margin-right: 6px;
  vertical-align: -4px;
  transition: transform 0.2s ease;
}

.navTab:hover .icon {
  transform: scale(1.1);
}

/* --- ì•„ì´ì½˜ ì»¬ëŸ¬ ì§€ì • --- */
.navTab[data-section="input"] .icon { color: #3b82f6; } /* ì…ë ¥: íŒŒë€ìƒ‰ */
.navTab[data-section="stats"] .icon { color: #10b981; } /* í†µê³„: ë…¹ìƒ‰ */
.navTab[data-section="guest"] .icon { color: #f59e0b; } /* ì†Œí†µ: ì£¼í™©ìƒ‰ */
.navTab[data-section="admin"] .icon { color: #6366f1; } /* ê´€ë¦¬ì: ë³´ë¼ìƒ‰ */

/* --- í™œì„±í™”ëœ íƒ­ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ --- */
.navTab.active {
  color: #0b3fb8;
  font-weight: 900;
}
.navTab.active .icon {
  color: #1d4ed8;
}

button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5em; /* Adjusts space between icon and text */
}

.icon {
  width: 1em; /* Makes icon size relative to font size */
  height: 1em;
  stroke-width: 2.5;
  vertical-align: -0.15em; /* Fine-tunes vertical alignment */
}

/* Optional: Specifically for the footer buttons if needed */
.footerBar button .icon {
  margin-right: 8px;
}

#saveAll { /* 'ì œì¶œí•˜ê¸°' ë²„íŠ¼ì˜ ID */
  gap: 8px; 
}

  
</style>
</head>
<body>

<div class="topNav">
  <div class="nav">
    <button class="navTab active" data-section="input"><i class="icon" data-feather="edit-3"></i>ì…ë ¥</button>
    <button class="navTab" data-section="stats"><i class="icon" data-feather="bar-chart-2"></i>í†µê³„</button>
    <button class="navTab" data-section="guest"><i class="icon" data-feather="message-square"></i>ì†Œí†µ</button>
    <button class="navTab" data-section="admin"><i class="icon" data-feather="user-check"></i>ê´€ë¦¬ì</button>
    <div class="nav-slider" id="navSlider" aria-hidden="true"></div>
  </div>
</div>
<main>
    <section id="sec-input">
      <div class="sectionCard">
        <div class="miniHeader">
          <button type="button" class="miniBtn" id="editHeaderBtn" aria-haspopup="dialog" title="ë³‘ë™/ì¶œê³ ì¼ í¸ì§‘">
            <span id="curWard">ë¯¸ì„ íƒ</span> Â· <span id="curDate">0000-00-00</span>
          </button>
        </div>

        <div class="tabs">
          <div class="tab-slider" id="tabSlider" aria-hidden="true"></div>
          <div class="tab active" data-cat="ì‹œíŠ¸">ì‹œíŠ¸</div>
          <div class="tab" data-cat="í™˜ìë³µ">í™˜ìë³µ</div>
          <div class="tab" data-cat="ê¸°íƒ€">ê¸°íƒ€</div>
        </div>

        <table id="inputTable" aria-label="í’ˆëª© ì…ë ¥ í‘œ">
          <colgroup><col class="col-item" /><col class="col-qty" /></colgroup>
          <thead><tr><th class="item-name">í’ˆëª©</th><th>ìˆ˜ëŸ‰</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="sec-stats" style="display:none">
      <h1>ê¸°ê°„ í†µê³„</h1>
      <div class="row-wrap dates" style="margin-bottom:8px">
        <input type="date" id="dateStart" />
        <span aria-hidden="true">~</span>
        <input type="date" id="dateEnd" />
      </div>
      <div class="row-wrap" style="margin-bottom:10px">
        <label for="wardFilter">ë³‘ë™</label>
        <select id="wardFilter">
          <option value="ì „ì²´">ì „ì²´</option>
          <option>93</option><option>83</option><option>73</option><option>71</option>
          <option>63</option><option>62</option><option>61</option>
          <option>52</option><option>51</option><option>42</option><option>41</option>
          <option>ê¸°íƒ€</option>
        </select>
      </div>
      <div id="statsWrap"></div>
      <div id="statsSummary" class="summaryWrap"></div>
      <section id="statsCharts">
        <h2>í’ˆëª©ë³„ ì‚¬ìš©ëŸ‰ ì¦ê°€ì¶”ì´</h2>
        <div class="card">
          <div class="chartControls">
            <label for="chartItem">í’ˆëª©</label>
            <select id="chartItem"></select>
            <button class="btn" id="exportChartXLSXBtn">ê·¸ë˜í”„ ë°ì´í„° ì—‘ì…€ë¡œ</button>
          </div>
          <div class="chartGrid">
            <canvas id="lineChart" height="220" aria-label="ì¼ìë³„ ì‚¬ìš©ëŸ‰ ì¶”ì´"></canvas>
            <canvas id="dowChart" height="220" aria-label="ìš”ì¼ë³„ í•©ê³„"></canvas>
          </div>
        </div>
      </section>
      <div id="statsEmpty" class="empty" style="display:none">í•´ë‹¹ ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </section>
</main>
<div id="wardPromptModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="wpTitle" style="display:none">
  <div class="modalCard" role="document">
    <div class="modalHead" id="wpTitle">ğŸš¨ ë³‘ë™ ì„ íƒ í•„ìš”</div>
    <div class="modalBody">
      <p style="margin-bottom:8px;"><b>ë³‘ë™ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</b></p>
      <small style="color:#5b677a;">â€» ICU, ER, HR, ë‚´ì‹œê²½, ë‚®ë³‘ë™, ì™¸ë˜ëŠ”<br>'ê¸°íƒ€' ë³‘ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.</small>
    </div>
    <div class="modalActions">
      <button type="button" class="btn primary" id="wpOk">í™•ì¸</button>
    </div>
  </div>
</div>
<div id="headerEditModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="heTitle" style="display:none">
  <div class="modalCard" role="document">
    <div class="modalHead" id="heTitle">ì„¤ì •</div>
    <div class="modalBody">
      <div class="formRow">
        <label class="fLabel" for="wardSelect">ë³‘ë™ëª…</label>
        <select id="wardSelect">
          <option value="">ì„ íƒâ€¦</option>
          <option>93</option><option>83</option><option>73</option><option>71</option>
          <option>63</option><option>62</option><option>61</option>
          <option>52</option><option>51</option><option>42</option><option>41</option>
          <option>ê¸°íƒ€</option><option>ë¦°ë„¨ì‹¤</option>
        </select>
      </div>
      <div class="formRow" style="margin-top:8px">
        <label class="fLabel" for="issueDate">ì¶œê³ ì¼</label>
        <input type="date" id="issueDate" />
      </div>
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="heCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="heSave">ì €ì¥</button>
    </div>
  </div>
</div>
<div id="pwaInstallModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="piTitle" style="display:none">
  <div class="modalCard" role="document">
    <div class="modalHead" id="piTitle">ë¦°ë„¨ì‹¤ ì•± ì„¤ì¹˜ì•ˆë‚´</div>
    <div class="modalBody">
      ğŸ“± íœ´ëŒ€í°ì—ì„œ ë°”ë¡œ ì‹¤í–‰ <br>
      ğŸ”’ ë³´ì•ˆ ì—°ê²°ë¡œ ì•ˆì „í•˜ê²Œ<br>
      ğŸ–¥ï¸ í° í™”ë©´ ëª¨ë“œ ì§€ì›
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="piCancel">ë‚˜ì¤‘ì—</button>
      <button type="button" class="btn primary" id="piConfirm">ì„¤ì¹˜</button>
    </div>
  </div>
</div>
<div id="submitModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="smTitle">
  <div class="modalCard" role="document">
    <div class="modalHead" id="smTitle">ì œì¶œ ì™„ë£Œ</div>
    <div class="modalBody">âœ… <b>ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</b></div>
    <div class="modalActions">
      <button type="button" class="btn primary" id="smOk">í™•ì¸</button>
    </div>
  </div>
</div>
<div id="confirmModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="csTitle" style="display:none">
  <div class="modalCard" role="document">
    <div class="modalHead" id="csTitle">ì œì¶œ í™•ì¸</div>
    <div class="modalBody">
      <div id="confirmSummary">
        ì…ë ¥í•˜ì‹  ìˆ˜ëŸ‰ì„ ì œì¶œí• ê¹Œìš”?
      </div>
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="csCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="csOk">ì œì¶œ</button>
    </div>
  </div>
</div>
<div id="adminModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="amTitle" style="display:none">
  <div class="modalCard adminPin" role="document">
    <div class="modalHead" id="amTitle">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <div class="modalBody">
      <label class="pinLabel">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
      <input id="adminPass" class="pinInput" type="password" placeholder="" inputmode="none" readonly />
      <div class="pinPad" id="pinPad">
        <button data-n="1">1</button><button data-n="2">2</button><button data-n="3">3</button>
        <button data-n="4">4</button><button data-n="5">5</button><button data-n="6">6</button>
        <button data-n="7">7</button><button data-n="8">8</button><button data-n="9">9</button>
        <button data-n="0" class="wide">0</button>
        <button data-del="1" aria-label="ì§€ì›€">â†</button>
      </div>
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="adminCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="adminOk">í™•ì¸</button>
    </div>
  </div>
</div>
<div id="qtyCalcModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="qcTitle" style="display:none">
  <div class="modalCard" role="document">
    <div class="modalHead" id="qcTitle">ìˆ˜ëŸ‰ ì…ë ¥</div>
    <div class="modalBody">
      <div id="qcItem" style="font-weight:800;color:#0b3fb8;margin-bottom:6px;">í’ˆëª©</div>
      <div id="qcExpr" class="qcExpr">â€”</div>
      <div class="qcRow">
        <input id="qcEntry" type="text" inputmode="none" readonly aria-readonly="true" placeholder="ìˆ«ì ì…ë ¥" class="qcEntry">
      </div>
     <div class="qcPad">
  <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
  <button data-act="del">â†</button>
  <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
  <button data-op="-">âˆ’</button>
  <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
  <button data-op="+" class="pos-plus">+</button>
  <button data-k="0" class="wide3">0</button>
</div>

    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="qcCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="qcOk">í™•ì¸</button>
    </div>
  </div>
</div>
<div id="downloadModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="dlTitle">
  <div class="modalCard" role="document">
    <div class="modalHead" id="dlTitle">ë‹¤ìš´ë¡œë“œ ì•ˆë‚´</div>
    <div class="modalBody">
      âš  ì´ ì•±ì€ <b>ë¦°ë„¨ì‹¤ ì „ìš©</b> ì–´í”Œë¦¬ì¼€ì´ì…˜ ì…ë‹ˆë‹¤.<br>
      <b>ë¦°ë„¨ì‹¤</b>ì—ì„œ ì œì‘í•˜ì˜€ìœ¼ë©°, ê¹ƒí—ˆë¸Œ ê³µì‹ ë¦´ë¦¬ì¦ˆì—ì„œ
      ë°°í¬ ë˜ê³  ìˆìœ¼ë©°, ì•ˆì‹¬í•˜ê³  ì„¤ì¹˜í•˜ì…”ë„ ë©ë‹ˆë‹¤.
    </div>
    <div class="modalActions">
      <button type="button" class="btn cancel" id="dlCancel">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" id="dlConfirm">ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>
<div class="toast" id="toast">
  <span class="check">âœ“</span>
  <div>
    <div id="toastText">ì €ì¥ ì™„ë£Œ</div>
    <div class="sub">RTDB ë™ê¸°í™” & ë¡œì»¬ ë°±ì—…</div>
  </div>
</div>
<div class="footerBar">
  <div class="footerCol">
<button class="btn acc" id="saveAll" disabled><i class="icon" data-feather="check-circle"></i>ì œì¶œí•˜ê¸°</button>
    
    <button class="btn" id="appDownloadBtn"><i class="icon" data-feather="download"></i>ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ë¡œë“œ</button>
    
    <button class="btn" id="exportXLSXBtn"><i class="icon" data-feather="file-text"></i>ì—‘ì…€ë¡œ ë‚´ë ¤ë°›ê¸°</button>
  </div>
</div>
<audio id="submitSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/ì œì¶œí•˜ê¸°.mp3" type="audio/mpeg" />
</audio>
<audio id="tabSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/íƒ­ì´ë™.mp3" type="audio/wav" />
</audio>
<audio id="btnClickSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/ë²„íŠ¼í´ë¦­2.mp3" type="audio/mpeg" />
</audio>
<audio id="warnSound" preload="auto">
  <source src="https://cdn.jsdelivr.net/gh/bangat/linenward@main/ê²½ê³ .mp3" type="audio/mpeg" />
</audio>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const TELEGRAM_CHAT_ID = "5432510881";
const TELEGRAM_TOKEN = "7377526562:AAEhb8p-mld6b2tMH7TAct2Jhqg8dpP6p20";
const TG_API = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;

const __tgBuf = [];
let __tgTimer = null;

function tgFlush() {
  if (!__tgBuf.length) return;
  let payload = __tgBuf.splice(0).join("\n");
  if (payload.length > 3500) payload = payload.slice(0, 3500) + "\n...(truncated)";
  const text = `[linenward]\nURL: ${location.href}\nUA: ${(navigator.userAgent||'')}\nTime: ${new Date().toISOString()}\n\n` + payload;
  const body = { chat_id: TELEGRAM_CHAT_ID, text };
  fetch(TG_API, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body) })
  .catch(()=>{
    const url = `${TG_API}?chat_id=${encodeURIComponent(TELEGRAM_CHAT_ID)}&text=${encodeURIComponent(text)}`;
    try { if (navigator.sendBeacon) navigator.sendBeacon(url); else (new Image()).src = url; } catch(_){}
  });
}
function tgSendNow(line){
  __tgBuf.push(line);
  if (__tgTimer) return;
  __tgTimer = setTimeout(()=>{ __tgTimer=null; tgFlush(); }, 1000);
}
function asLine(arg){
  try {
    if (arg instanceof Error) return (arg.stack || arg.message || String(arg));
    if (typeof arg === 'object') return JSON.stringify(arg);
    return String(arg);
  } catch(_) { return String(arg); }
}

/* â–·â–·â–· console-warn-filter í™•ì¥ ì‹œì‘ â–·â–·â–· */
;["error","warn"].forEach(type=>{
  const orig = console[type];
  console[type] = function(...args){
    try { orig.apply(console, args); } catch(_){}
    let msg = "";
    try { msg = args.map(asLine).join(" "); } catch(_){}
    // ì˜¤ë””ì˜¤ ê´€ë ¨ ê²½ê³ /ì°¨ë‹¨ì€ ì „ì†¡ ì œì™¸
    const ignoreAudio = /The play\(\) request was interrupted by a call to pause\(\)|AbortError.*play\(\)|Autoplay|gesture|NotAllowedError|^\[audio\]\s*play failed|^\[audio\]\s*exception/i.test(msg);
    if (type === "warn" && ignoreAudio) return;
    if (type === "error" && /NotAllowedError|AbortError.*play\(\)/i.test(msg)) return;
    try { tgSendNow(`[${type.toUpperCase()}] ${msg}`); } catch(_){}
  };
});
/* â–·â–·â–· console-warn-filter í™•ì¥ ì¢…ë£Œ â–·â–·â–· */


window.tgLog = (...args)=> tgSendNow(`[LOG] ` + args.map(asLine).join(" "));
window.addEventListener("error", e=> tgSendNow(`[ONERROR] ${e.message} @ ${e.filename}:${e.lineno}:${e.colno}\n${e.error?.stack||''}`));
/* â–·â–·â–· unhandledrejection-audio-filter ì‹œì‘ â–·â–·â–· */
window.addEventListener("unhandledrejection", e=>{
  const r = e.reason;
  const text = (r && (r.stack || r.message)) || asLine(r) || "";
  if (/NotAllowedError|AbortError.*play\(\)|Autoplay|gesture|^\[audio\]/i.test(text)) return;
  tgSendNow(`[UNHANDLED] ${text}`);
});
/* â–·â–·â–· unhandledrejection-audio-filter ì¢…ë£Œ â–·â–·â–· */

</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, query, orderByChild, startAt, endAt, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
    authDomain: "hallymlinen.firebaseapp.com",
    databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
    projectId: "hallymlinen",
    storageBucket: "hallymlinen.appspot.com",
    messagingSenderId: "867775830688",
    appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
    measurementId: "G-T02ZFK18L3"
  };

  const app = initializeApp(firebaseConfig);
  const rtdb = getDatabase(app);

  function dayStart(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); }
  function dayEndInclusiveMs(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999).getTime(); }

  async function saveLogsToRTDB(batchArray){
    const baseRef = ref(rtdb, "logs");
    await Promise.all(batchArray.map(d => push(baseRef, d)));
  }

  let _liveRef = null, _liveCb = null;
  function startStatsLiveWatcher(startDate, endDateInclusive, onData){
    if (_liveRef && _liveCb){ off(_liveRef, "value", _liveCb); _liveRef = null; _liveCb = null; }
    const sMs = dayStart(startDate);
    const eMs = dayEndInclusiveMs(endDateInclusive);
    const qy = query(ref(rtdb, "logs"), orderByChild("ts"), startAt(sMs), endAt(eMs));
    const cb = (snap)=>{
      const val = snap.val() || {};
      const arr = Object.keys(val).map(k => ({ id:k, ...val[k] }));
      onData(arr);
    };
    onValue(qy, cb);
    _liveRef = qy; _liveCb = cb;
  }

  window.__fb = { saveLogsToRTDB, startStatsLiveWatcher };
</script>
<script>
/* === ì „ì—­ ìƒìˆ˜ ë° ì„¤ì • === */
const REPO_SLUG = "bangat/linenward";
const APK_NAME = "WardLinen.apk";
const LATEST_DIRECT = `https://github.com/${REPO_SLUG}/releases/latest/download/${APK_NAME}`;
const ADMIN_PASS = "2398";

const ITEMS={
  "ì‹œíŠ¸":["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ã€€ê±´"],
  "í™˜ìë³µ":["ì¼ë°˜ìƒì˜","ì¼ë°˜í•˜ì˜","ì •í˜•ìƒì˜","ì •í˜•í•˜ì˜"],
  "ê¸°íƒ€":["ì–µì œëŒ€","ì–¼ìŒí¬","ê¸°ã€€íƒ€"]
};
const COLORED_ITEMS = new Set(["ëŒ€ì‹œíŠ¸","ë°˜ì‹œíŠ¸","ë² ê°¯ì‡","ìˆ˜ã€€ê±´"]);
const ORTHO_ITEMS = new Set(["ì •í˜•ìƒì˜","ì •í˜•í•˜ì˜"]);
const ALL_ITEMS = Object.values(ITEMS).flat();
const WARDS=["93","83","73","71","63","62","61","52","51","42","41","ê¸°íƒ€","ë¦°ë„¨ì‹¤"];

const LS={ ward:"linen/ward", logs:"linen/logs", draft:(ward)=>`linen/draft/${ward||'_none_'}` };
let state={ ward:(localStorage.getItem(LS.ward)||"").toString().trim(), section:"input", cat:"ì‹œíŠ¸" };
const el=s=>document.querySelector(s), els=s=>Array.from(document.querySelectorAll(s));

/* === ê´€ë¦¬ì ì¸ì¦ ê²Œì´íŠ¸ í•¨ìˆ˜ === */
function openAdminGate(){
  openModal("#adminModal", "#adminOk");

  const $in  = el("#adminPass");
  const $ok  = el("#adminOk");
  const $can = el("#adminCancel");
  const pad  = el("#pinPad");
  let pin = "";

  $in.placeholder = "";
  $in.setAttribute("readonly","readonly");
  $in.setAttribute("inputmode","none");
  ["focus","pointerdown","touchstart","click"].forEach(ev=>{
    $in.addEventListener(ev, (e)=>{ e.preventDefault(); $ok.focus(); }, { passive:false });
  });

  function render(){ $in.value = pin; }
  function push(n){ if (pin.length >= 6) return; pin += String(n); render(); }
  function backspace(){ pin = pin.slice(0,-1); render(); }
  function clearPin(){ pin = ""; render(); }
  function tryLogin(){
    if (pin === ADMIN_PASS){
      closeModal("#adminModal");
      location.href = "ì¶œê·¼ë¶€.html?back=1";
    }else{
      clearPin();
      $in.placeholder = "í‹€ë ¸ìŠµë‹ˆë‹¤.";
      try{ playSnd("#warnSound"); }catch(_){}
      $ok.focus();
    }
  }

  if (pad){
  pad.onclick = (e)=>{
    const b = e.target.closest("button");
    if (!b) return;
    const n = b.getAttribute("data-n");
    const del = b.hasAttribute("data-del");
    if (n !== null){
      push(n);
      if (navigator.vibrate) navigator.vibrate(15);   // âœ… ìˆ«ì ì…ë ¥ ì‹œ ì§„ë™
      return;
    }
    if (del){
      backspace();
      if (navigator.vibrate) navigator.vibrate(25);   // âœ… ì§€ì›€ì€ ì¡°ê¸ˆ ë” ê¸¸ê²Œ
      return;
    }
  };
}

  $ok.onclick = tryLogin;
  $can.onclick = ()=>{ closeModal("#adminModal"); clearPin(); };
  document.addEventListener("keydown", function onKey(e){
    if (el("#adminModal").style.display !== "block") { document.removeEventListener("keydown", onKey); return; }
    if (e.key === "Enter") { e.preventDefault(); tryLogin(); }
  });

  render();
}

/* === ì˜¤ë””ì˜¤ ì œì–´ ë° ìœ í‹¸ë¦¬í‹° === */
let __ac=null, __audioUnlocked=false;
function getAC(){ if(!__ac){ __ac=new (window.AudioContext||window.webkitAudioContext)(); } return __ac; }
function beep(ms=120,freq=660){
  try{
    const ac=getAC(); const o=ac.createOscillator(); const g=ac.createGain();
    o.type="triangle"; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+ms/1000);
    o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+ms/1000+0.02);
  }catch(_){}
}
function unlockAudioOnce(){
  if(__audioUnlocked) return;
  __audioUnlocked=true;
  try{ getAC().resume(); }catch(_){}
  ["#submitSound","#tabSound","#btnClickSound","#warnSound"].forEach(sel=>{
    const a = el(sel);
    if (!a) return;
    try { a.load(); } catch(_) {}
  });
}
["pointerdown","touchstart","click","keydown"].forEach(evt=>{ window.addEventListener(evt, unlockAudioOnce, { once:true, passive:true }); });

function playSnd(sel){
  const freqMap = { "#btnClickSound": 880, "#tabSound": 659, "#submitSound": 523, "#warnSound": 988 };
  try{
    const a = el(sel);
    if(!a){ beep(sel==="#submitSound"?180:100, freqMap[sel]||660); return; }
    if (!a.paused) { try { a.currentTime = 0; } catch(_) {} return; }
    try { a.currentTime = 0; } catch(_) {}
    const p = a.play();
    if (p && typeof p.catch === "function") {
      p.catch(err => {
        if (err && (err.name === "AbortError" || err.code === 20)) return;
        console.warn("[audio] play failed:", sel, err?.name||err, err);
        beep(sel==="#submitSound"?180:100, freqMap[sel]||660);
      });
    }
  }catch(e){
    console.warn("[audio] exception:", e);
    beep(sel==="#submitSound"?180:100, (freqMap[sel]||660));
  }
}

/* === ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜ === */
function openModal(sel, focusSel){ document.body.classList.add('modal-open'); const ov=el(sel); ov.style.display='block'; setTimeout(()=>{ focusSel && el(focusSel)?.focus(); },0); }
function closeModal(sel){ document.body.classList.remove('modal-open'); el(sel).style.display='none'; }

function sizeModalBody(modalSel, fraction=0.5){
  const modal = document.querySelector(modalSel);
  if (!modal) return;
  const card = modal.querySelector('.modalCard');
  const head = modal.querySelector('.modalHead');
  const body = modal.querySelector('.modalBody');
  const acts = modal.querySelector('.modalActions');
  const vh = window.innerHeight || document.documentElement.clientHeight || 640;

  if (card) card.style.maxHeight = Math.round(vh * 0.88) + 'px';
  if (body){
    const reserve = (head?.offsetHeight||0) + (acts?.offsetHeight||0);
    const target = Math.max(120, Math.floor(vh * fraction) - reserve);
    body.style.maxHeight = target + 'px';
    body.style.overflow = 'auto';
  }
}

/* === ìˆ˜ëŸ‰ ê³„ì‚°ê¸° ë¡œì§ === */
let __qc = { exprParts: [], terms: [], entry: "", lastOp: "+", onConfirm: null, title: "" };

function qcReset(initOp = "+"){ __qc.exprParts = []; __qc.terms = []; __qc.entry = ""; __qc.lastOp = initOp; }
function qcPushEntryIfAny(){
  if (__qc.entry === "") return false;
  const n = parseInt(__qc.entry, 10);
  if (isNaN(n)) { __qc.entry = ""; return false; }
  const signed = (__qc.lastOp === "-") ? -n : n;
  __qc.terms.push(signed);
  __qc.exprParts.push(String(n));
  __qc.entry = "";
  return true;
}
function qcPreviewSum(){
  const base = __qc.terms.reduce((a,b)=>a+b, 0);
  const curN = parseInt(__qc.entry || "0", 10);
  if (!__qc.entry) return base;
  return base + ((__qc.lastOp === "-") ? -curN : curN);
}
// â–·â–·â–· (1) qcApplyOperator ë³€ê²½ì½”ë“œ ì‹œì‘ â–·â–·â–·
function qcApplyOperator(opRaw){
  const op = (opRaw === "-" || opRaw === "âˆ’") ? "-" : "+";
  const disp = op === "-" ? "âˆ’" : "+";
  const pushed = qcPushEntryIfAny();
  const lastTok = __qc.exprParts[__qc.exprParts.length - 1];

  if (!pushed){
    if (__qc.exprParts.length === 0){ __qc.lastOp = op; qcRender(); return; }
    if (lastTok === "+" || lastTok === "âˆ’"){ __qc.exprParts[__qc.exprParts.length - 1] = disp; __qc.lastOp = op; qcRender(); return; }
  }
  __qc.exprParts.push(disp);
  __qc.lastOp = op;
  // (ë³€ê²½) ì…ë ¥ì°½ ë™ì‘ì—ì„œëŠ” ì†Œë¦¬ ì—†ìŒ
  qcRender();
}
// â–·â–·â–· (1) qcApplyOperator ë³€ê²½ì½”ë“œ ì¢…ë£Œ â–·â–·â–·

function qcComputeFinal(){ qcPushEntryIfAny(); return __qc.terms.reduce((a,b)=>a+b, 0); }
function qcRender(){
  const box = document.getElementById("qcExpr");
  if (!box) return;
  const expr = __qc.entry ? [...__qc.exprParts, __qc.entry].join(" ") : __qc.exprParts.join(" ");
  const sumPreview = qcPreviewSum();
  box.textContent = expr ? `${expr} = ${sumPreview}` : "";
}

function openQtyKeypad({ title="ìˆ˜ëŸ‰", onConfirm } = {}){
  __qc.onConfirm = (typeof onConfirm === "function") ? onConfirm : null;
  __qc.title = title;
  qcReset("+");

  const headEl = document.getElementById("qcTitle");
  if (headEl) headEl.textContent = title;

  const box = document.getElementById("qcExpr");
  if (box) box.textContent = "â€”";

  const ent = document.getElementById("qcEntry");
  if (ent){
    ent.value = "";
    ent.setAttribute("readonly", "readonly");
    ent.setAttribute("inputmode", "none");
    ["pointerdown","touchstart","focus"].forEach(ev=>{
      ent.addEventListener(ev, (e)=>{ e.preventDefault(); ent.blur(); }, { passive:false });
    });
    ent.oninput = ()=>{};
  // â–·â–·â–· (2) openQtyKeypad/ent.onkeydown ë³€ê²½ì½”ë“œ ì‹œì‘ â–·â–·â–·
ent.onkeydown = (e)=>{
  if (e.key==="Escape"){ e.preventDefault(); closeModal("#qtyCalcModal"); }
  if (e.key==="Enter" || e.key==="NumpadEnter"){
    e.preventDefault();
    const result = qcComputeFinal();
    const b = document.getElementById("qcExpr");
    if (b){ const shown = __qc.exprParts.join(" "); b.textContent = shown ? `${shown} = ${result}` : String(result); }
    // (ë³€ê²½) ì…ë ¥ì°½ í™•ì¸ì—ì„œëŠ” ì†Œë¦¬ ì—†ìŒ
    setTimeout(()=>{
      __qc.onConfirm && __qc.onConfirm(result);
      qcReset("+");
      if (b) b.textContent = "â€”";
      ent.value = "";
      closeModal("#qtyCalcModal");
    }, 120);
  }
  if (e.key==="+" || e.key==="-"){ e.preventDefault(); qcApplyOperator(e.key==="+" ? "+" : "-"); }
};
// â–·â–·â–· (2) openQtyKeypad/ent.onkeydown ë³€ê²½ì½”ë“œ ì¢…ë£Œ â–·â–·â–·

  }
  if (!openQtyKeypad._wired){
    const pad = document.querySelector("#qtyCalcModal .qcPad");
    pad.addEventListener("click", (e)=>{
      const b = e.target.closest("button");
      if (!b) return;
// âœ… ì§„ë™ ì¶”ê°€ (15ms)
 if (navigator.vibrate) navigator.vibrate(15);
      const k = b.getAttribute("data-k"), del = b.getAttribute("data-act")==="del", op = b.getAttribute("data-op");
      if (k !== null){ if (__qc.entry.length < 6){ __qc.entry = (__qc.entry==="0") ? k : (__qc.entry + k); if (ent) ent.value = __qc.entry; qcRender(); } return; }
      if (del){ __qc.entry = __qc.entry.slice(0,-1); if (ent) ent.value = __qc.entry; qcRender(); return; }
      if (op){ qcApplyOperator(op); return; }
    });
    document.getElementById("qcCancel").onclick = ()=>{
      const b = document.getElementById("qcExpr"), ent = document.getElementById("qcEntry");
      qcReset("+");
      if (b) b.textContent = "â€”"; if (ent) ent.value = "";
      const headEl = document.getElementById("qcTitle"); if (headEl) headEl.textContent = "ìˆ˜ëŸ‰ ì…ë ¥";
      closeModal("#qtyCalcModal");
    };
    // â–·â–·â–· (3) openQtyKeypad/#qcOk.onclick ë³€ê²½ì½”ë“œ ì‹œì‘ â–·â–·â–·
document.getElementById("qcOk").onclick = ()=>{
  const result = qcComputeFinal();
  const box = document.getElementById("qcExpr");
  if (box){ const shown = __qc.exprParts.join(" "); box.textContent = shown ? `${shown} = ${result}` : String(result); }
  // (ë³€ê²½) ì…ë ¥ì°½ í™•ì¸ ë²„íŠ¼ì—ì„œë„ ì†Œë¦¬ ì—†ìŒ
  setTimeout(()=>{
    __qc.onConfirm && __qc.onConfirm(result);
    qcReset("+");
    if (box) box.textContent = "â€”"; if (ent) ent.value = "";
    const headEl = document.getElementById("qcTitle"); if (headEl) headEl.textContent = "ìˆ˜ëŸ‰ ì…ë ¥";
    closeModal("#qtyCalcModal");
  }, 120);
};
// â–·â–·â–· (3) openQtyKeypad/#qcOk.onclick ë³€ê²½ì½”ë“œ ì¢…ë£Œ â–·â–·â–·

    openQtyKeypad._wired = true;
  }
  qcRender();
  openModal("#qtyCalcModal", "#qcOk");
}

/* === UI ìƒí˜¸ì‘ìš© ë° í—¬í¼ í•¨ìˆ˜ === */
function flashWarn(){ try{ if(navigator.vibrate){ navigator.vibrate([120,80,120,80,120]); } }catch(e){} const ov=document.createElement('div'); ov.id='flashOverlay'; document.body.appendChild(ov); ov.addEventListener('animationend', ()=>{ ov.parentNode && ov.parentNode.removeChild(ov); }); }
function maybeBuzz(prev,next){
  if (state.cat !== "ì‹œíŠ¸") return;
  const p = Number(prev)||0, n = Number(next)||0;
  if (p < 16 && n >= 16) { flashWarn(); }
  if (p < 20 && n >= 20) { try { playSnd("#warnSound"); } catch(_) {} }
}
function rangeMsByDates(startStr,endStr){
  const sParts=startStr.split("-").map(Number), eParts=endStr.split("-").map(Number);
  let s=new Date(sParts[0],sParts[1]-1,sParts[2],0,0,0,0), e=new Date(eParts[0],eParts[1]-1,eParts[2],23,59,59,999);
  if(e.getTime()<s.getTime()){ const t=s; s=e; e=t; }
  return [s.getTime(), e.getTime()+1];
}
function getLogs(){ return JSON.parse(localStorage.getItem(LS.logs)||"[]"); }
function setLogs(a){ localStorage.setItem(LS.logs, JSON.stringify(a)); }
function getDraft(){ try{ return JSON.parse(localStorage.getItem(LS.draft(state.ward))||"{}"); }catch(_){ return {}; } }
function setDraft(o){ localStorage.setItem(LS.draft(state.ward), JSON.stringify(o||{})); }
function setDraftQty(item,qty){ const d=getDraft(); d[item]=(parseInt(qty)||0); setDraft(d); }
function getCurrentTotal(){ return Object.values(getDraft()).reduce((a,v)=> a + (parseInt(v)||0), 0); }
function refreshTotalUI(){
  const total = getCurrentTotal();
  const save = el("#saveAll");
  if (save){
    save.disabled = total===0;
    save.style.opacity = total===0 ? .6 : 1;
        const totalStr = total > 0 ? ` Â· ì´ <span class="mono">${total.toLocaleString()}</span>ê°œ` : '';
  save.innerHTML = `<i class="icon" data-feather="check-circle"></i>ì œì¶œí•˜ê¸°${totalStr}`;

    // [ì¤‘ìš”] ì•„ì´ì½˜ì„ ë‹¤ì‹œ ê·¸ë ¤ì£¼ëŠ” ëª…ë ¹ì–´ë¥¼ ê¼­ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
    feather.replace({ width: '1em', height: '1em' });
  }
}
function springOnce(btn){ try{ btn.classList.remove('spring'); void btn.offsetWidth; btn.classList.add('spring'); }catch(_){} }
function fitCardToFooter(){
  const card = document.querySelector('#sec-input .sectionCard'), footer = document.querySelector('.footerBar');
  if(!card || !footer) return;
  card.style.setProperty('--fillH', 'auto');
  const cardTop = card.getBoundingClientRect().top, footerTop = footer.getBoundingClientRect().top;
  const gap = Math.max(0, Math.floor(footerTop - cardTop - 12));
  card.style.setProperty('--fillH', gap + 'px');
}
function wireZeroReplace(inp, onChange){
  inp.addEventListener('keydown', (e) => {
    if (e.key.length === 1 && /\d/.test(e.key)) {
      if (inp.value === "0" && inp.selectionStart === 0 && inp.selectionEnd === 0) {
        e.preventDefault(); inp.value = e.key; onChange();
      }
    }
  });
  inp.addEventListener('paste', () => {
    setTimeout(() => { const v = parseInt(inp.value || "0", 10) || 0; inp.value = String(v); onChange(); }, 0);
  });
}

/* === í’ˆëª© ì…ë ¥ í…Œì´ë¸” ë Œë”ë§ === */
function buildTable(){
  const tb=el("#inputTable tbody"); tb.innerHTML="";
  ITEMS[state.cat].forEach(name=>{
    const isOrtho = ORTHO_ITEMS.has(name);
    const isTwoChar = (name==="ìˆ˜ã€€ê±´" || name==="ê¸°ã€€íƒ€");
    const tr=document.createElement("tr");
    tr.className = isOrtho ? "kind-ortho" : "";
    tr.innerHTML = `
      <td class="item-name${isTwoChar?' k2':''}">${name}</td>
      <td class="qtyCell">
        <button type="button" class="chip ctrl minus" data-delta="-1">-1</button>
        <span class="qtyInputWrap">
          <input type="number" inputmode="numeric" value="0" aria-label="${name} ìˆ˜ëŸ‰" />
        </span>
        <button type="button" class="chip ctrl plus" data-delta="+1">+1</button>
      </td>`;
    const inp=tr.querySelector("input");
    const draft=getDraft();
    const init=Object.prototype.hasOwnProperty.call(draft,name)?(parseInt(draft[name])||0):0;
    inp.value=String(init); inp.dataset.prev=String(init);

    try{
      inp.setAttribute('readonly','readonly');
      inp.setAttribute('inputmode','none');
      inp.style.caretColor = 'transparent';
      const openCalc = (e)=>{
        e.preventDefault();
        openQtyKeypad({
          title: name,
          onConfirm: (result)=>{
            const prev = parseInt(inp.dataset.prev || "0") || 0;
            const cur  = parseInt(result || "0") || 0;
            inp.value = String(cur);
            setDraftQty(name, cur);
            maybeBuzz(prev, cur);
            inp.dataset.prev = String(cur);
            refreshTotalUI();
          }
        });
      };
      inp.addEventListener('click', openCalc);
      inp.addEventListener('focus', openCalc);
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); openCalc(e); } });
    }catch(_){}

    const _closeModalOrig = window.closeModal;
    window.closeModal = function(sel){
      _closeModalOrig && _closeModalOrig(sel);
      if (sel === '#qtyCalcModal'){
        try{
          qcReset("+");
          const b = document.getElementById("qcExpr"), ent = document.getElementById("qcEntry");
          if (b) b.textContent = ""; if (ent) ent.value = "";
        }catch(_){}
      }
    };
   tr.querySelectorAll("[data-delta]").forEach(btn=>{
  // í´ë¦­ ì‹œ ë¦¬í”Œ/ìŠ¤í”„ë§
  btn.addEventListener('click', e=>{ addRipple(e); springOnce(btn); });

  const delta = parseInt(btn.dataset.delta, 10);
  const apply = () => {
    const prev = parseInt(inp.dataset.prev || "0") || 0;
    const v = (parseInt(inp.value || "0") || 0) + delta;
    inp.value = v;
    setDraftQty(name, v);
    maybeBuzz(prev, v);
    inp.dataset.prev = String(v);
    refreshTotalUI();
  };

  // â–¶ í´ë¦­ 1íšŒì— ì†Œë¦¬ + ì§„ë™
  btn.addEventListener('click', () => {
    apply();
    try { playSnd("#btnClickSound"); } catch(_) {}
    if (navigator.vibrate) navigator.vibrate(12);   // âœ… ì§„ë™ ì¶”ê°€
  });

  // â–¶ ê¸¸ê²Œ ëˆ„ë¥¼ ë•Œ ë°˜ë³µì‹œì—ë„ ì†Œë¦¬/ì§„ë™ (ë„ˆë¬´ ì‹œë„ëŸ½ì§€ ì•Šê²Œ ê°„ê²© ì¡°ì ˆ)
  let _lastBeep = 0;
  attachHoldRepeat(btn, () => {
    apply();
    const now = Date.now();
    if (now - _lastBeep > 220) {                   // âœ… 0.22ì´ˆ ê°„ê²©ìœ¼ë¡œë§Œ ì†Œë¦¬
      try { playSnd("#btnClickSound"); } catch(_) {}
      _lastBeep = now;
    }
    if (navigator.vibrate) navigator.vibrate(8);   // âœ… ê° ìŠ¤í…ë§ˆë‹¤ ì§§ê²Œ ì§„ë™
  });
});

    tb.appendChild(tr);
  });

  if(state.cat==="ê¸°íƒ€"){
    const noteRow=document.createElement("tr");
    noteRow.innerHTML=`<td colspan="2" style="text-align:left;padding:12px;font-size:14px;color:#64748b;">ê¸°íƒ€í’ˆëª© : ì¤‘í™˜ì˜, ê³ ê´€ì ˆ, ì–‘ìª½ëˆ, ì–‘ìª½ê³ ë¬´ì¤„</td>`;
    tb.appendChild(noteRow);
  }
  refreshTotalUI();
  fitCardToFooter();
}

/* === ì œì¶œ í™•ì¸ ë° ë°ì´í„° ì €ì¥ === */
function buildConfirmSummaryHTML() {
  const ward = (state.ward || "").toString().trim() || "ë¯¸ì„ íƒ";
  const dateStr = document.querySelector("#issueDate").value || new Date().toISOString().slice(0,10);
  const draft = (function(){ try { return JSON.parse(localStorage.getItem(LS.draft(state.ward))||"{}"); } catch(_) { return {}; } })();

  let rows = [];
  Object.keys(draft).forEach(k => { const v = parseInt(draft[k] || "0", 10) || 0; if (v !== 0) rows.push([k, v]); });
  rows.sort((a,b)=> b[1]-a[1]);

  const total = rows.reduce((a, [,v]) => a + v, 0);
  if (total === 0) return `<p>ì œì¶œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ 0)</p>`;

  const MAX = 12;
  const moreHtml = rows.length > MAX ? `<li class="more" style="margin-top:8px;color:#64748b">ì™¸ ${rows.length - MAX}ê°œ í•­ëª©â€¦</li>` : "";

  const colored = (name)=> (typeof COLORED_ITEMS!=="undefined" && COLORED_ITEMS.has && COLORED_ITEMS.has(name));
  const ortho = (name)=> (typeof ORTHO_ITEMS !=="undefined" && ORTHO_ITEMS.has && ORTHO_ITEMS.has(name));
  const lv = (v)=> v>=20 ? "lv3" : (v>=15 ? "lv2" : (v>=10 ? "lv1" : ""));

  const list = rows.slice(0, MAX).map(([k,v]) => `
    <li class="itemRow ${colored(k)?'isColored':''} ${ortho(k)?'isOrtho':''}">
      <span class="label">${k}</span>
      <span class="qtyBadge ${lv(v)}">${v.toLocaleString()}ê°œ</span>
    </li>`).join("");

  return `
    <div class="confirmHeader">
      <span class="date"><b>${dateStr}</b></span> Â· <span class="ward"><b>${ward}</b>ë³‘ë™</span>
    </div>
    <p class="confirmSub" style="margin:0 0 6px;color:#475569">ì•„ë˜ ë‚´ì—­ìœ¼ë¡œ ì œì¶œí• ê¹Œìš”?</p>
    <ul class="confirmList">${list}${moreHtml}</ul>
    <div class="confirmTotal"><span>í•©ê³„</span><strong>${total.toLocaleString()}ê°œ</strong></div>`;
}

function openConfirmSubmit() {
  const summary = document.getElementById("confirmSummary");
  if (summary) summary.innerHTML = buildConfirmSummaryHTML();
  if (typeof openModal === "function") {
    openModal("#confirmModal", "#csOk");
  } else {
    if (confirm("ì…ë ¥í•˜ì‹  ìˆ˜ëŸ‰ì„ ì œì¶œí• ê¹Œìš”?")) saveAll();
  }
}


document.addEventListener("click", async (e) => {
  const id = (e.target && e.target.id) || "";

  if (id === "csCancel") {
    if (typeof closeModal === "function") closeModal("#confirmModal");
    return;
  }

  if (id === "csOk") {
    // í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
    if (typeof closeModal === "function") closeModal("#confirmModal");

    // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
    const ov = document.getElementById("loadingOverlay");
    if (ov) ov.style.display = "flex";

    try {
      // ì‹¤ì œ ì €ì¥ ì§„í–‰
      await saveAll();
    } finally {
      // ì €ì¥ ëë‚˜ë©´ ë¡œë”© ìˆ¨ê¹€ (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘)
      if (ov) ov.style.display = "none";
    }
    return;
  }
});

async function saveAll(){
  const ward=(state.ward||"").toString().trim();
  if(!ward){ alert("ë³‘ë™ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
  const issue=el("#issueDate").value;
  let ts=issue?(()=>{const [y,m,d]=issue.split("-").map(Number); return new Date(y,m-1,d,12,0,0,0).getTime();})():Date.now();

  const draft=getDraft(); const batch=[];
  ALL_ITEMS.forEach(item=>{
    const q=(parseInt(draft[item]||"0")||0);
    if(q!==0) batch.push({ts, yyyymm:new Date(ts).toISOString().slice(0,7), ward, item, qty:q});
  });
  if(!batch.length){ alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ 0)"); return; }

  const logs=getLogs(); batch.forEach(b=>logs.unshift(b)); setLogs(logs.slice(0,10000));
  let ok=false; try{ if(window.__fb){ await window.__fb.saveLogsToRTDB(batch); ok=true; } }catch(e){ console.warn(e); tgLog("saveAll() ì‹¤íŒ¨:", e); }
  if(ok){
    const cur=getLogs(), keyOf=L=>[L.ts,L.ward,L.item,L.qty].join("|");
    const rm=new Set(batch.map(keyOf));
    setLogs(cur.filter(L=>!rm.has(keyOf(L))));
  }

  const cleared={}; ALL_ITEMS.forEach(i=>cleared[i]=0); setDraft(cleared);
  Array.from(document.querySelectorAll("#inputTable tbody input")).forEach(inp=>{ inp.value="0"; inp.dataset.prev="0"; });
 // â–·â–·â–· (4) saveAll ì œì¶œ ì‚¬ìš´ë“œ ë³€ê²½ì½”ë“œ ì‹œì‘ â–·â–·â–·
refreshTotalUI();
// (ë³€ê²½) RTDB ì €ì¥ ì„±ê³µ(ok===true)ì¼ ë•Œë§Œ ì œì¶œ ì‚¬ìš´ë“œ ì¬ìƒ
if (ok) playSnd("#submitSound");
openModal('#submitModal', '#smOk');
showToast("ì €ì¥ ì™„ë£Œ", "RTDB ë™ê¸°í™” & ë¡œì»¬ ë°±ì—…");

if(document.body.classList.contains("mode-stats")){
  const d=new Date(ts).toISOString().slice(0,10);
  el("#dateStart").value=d; el("#dateEnd").value=d; await renderStats();
}
// â–·â–·â–· (4) saveAll ì œì¶œ ì‚¬ìš´ë“œ ë³€ê²½ì½”ë“œ ì¢…ë£Œ â–·â–·â–·

}

/* === í†µê³„ í™”ë©´ ê´€ë ¨ í•¨ìˆ˜ === */
function colorStyle(item,val){
  if(!COLORED_ITEMS.has(item)) return "";
  const v=Number(val)||0;
  if(v>=20) return ' style="color:#dc2626;font-weight:800"';
  if(v>=15) return ' style="color:#1d4ed8;font-weight:800"';
  if(v>=10) return ' style="color:#b45309;font-weight:800"';
  return '';
}
function rangeSelect(logs,sStr,eStr,wardFilter){
  const [s,e]=rangeMsByDates(sStr,eStr);
  return logs.filter(L=>L.ts>=s&&L.ts<e&&(wardFilter==="ì „ì²´"||(L.ward||"").toString().trim()===wardFilter));
}
function renderPivot(logs,s,e,wardFilter){
  const selected=rangeSelect(logs,s,e,wardFilter);
  const wards=(wardFilter==="ì „ì²´")?WARDS:WARDS.filter(w=>w===wardFilter);
  const items=ALL_ITEMS; const p={}; wards.forEach(w=>p[w]={}); items.forEach(i=>wards.forEach(w=>p[w][i]=0));
  selected.forEach(L=>{
    if(!(L.ward in p)) p[L.ward]={};
    if(typeof p[L.ward][L.item]!=="number") p[L.ward][L.item]=0;
    p[L.ward][L.item]+=Number(L.qty)||0;
  });
  return {p,wards,items};
}
function shrinkBigNumbers(root){
  Array.from(root.querySelectorAll('[data-num] > .num')).forEach(span=>{
    const len=(span.textContent||'').trim().length;
    if(len>=5) span.classList.add('d5');
    else if(len===4) span.classList.add('d4');
    else if(len>=3) span.classList.add('d3');
  });
}

/* === ì°¨íŠ¸ ê´€ë ¨ í•¨ìˆ˜ === */
let __mergedCache = [];
let lineChart=null, dowChart=null;

function fmtYYYYMMDD(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
function dateRangeArray(sStr,eStr){
  const [sMs,eMs]=rangeMsByDates(sStr,eStr);
  const arr=[]; for(let t=sMs; t<eMs; t+=86400000){ arr.push(new Date(t)); }
  return arr;
}
function buildDailySeries(item, sStr, eStr, wardFilter){
  const days = dateRangeArray(sStr,eStr);
  const map = Object.create(null);
  days.forEach(d=>map[fmtYYYYMMDD(d)]=0);
  const selected = rangeSelect(__mergedCache, sStr, eStr, wardFilter);
  selected.forEach(L=>{
    if(item!=="ëª¨ë“  í’ˆëª© í•©ê³„" && L.item!==item) return;
    const key = fmtYYYYMMDD(new Date(L.ts));
    if(!(key in map)) map[key]=0;
    map[key]+= Number(L.qty)||0;
  });
  const labels = days.map(d=>fmtYYYYMMDD(d));
  const values = labels.map(k=>map[k]||0);
  return { labels, values };
}
function buildDowSeries(values, labels){
  const dnames = ["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  const sums = {1:0,2:0,3:0,4:0,5:0,6:0};
  labels.forEach((dstr, i)=>{
    const w = new Date(dstr + "T00:00:00").getDay();
    if (w === 0) return;
    sums[w] = (sums[w] || 0) + (values[i] || 0);
  });
  return { labels: dnames, values: [1,2,3,4,5,6].map(i => sums[i] || 0) };
}
function ensureChartItemOptions(){
  const sel = el("#chartItem");
  if(sel.options.length) return;
  const opts = ["ëª¨ë“  í’ˆëª© í•©ê³„", ...ALL_ITEMS];
  opts.forEach(x=>{ const o=document.createElement("option"); o.value=o.textContent=x; sel.appendChild(o); });
}
function renderCharts(){
  ensureChartItemOptions();
  const item = el("#chartItem").value || "ëª¨ë“  í’ˆëª© í•©ê³„";
  const s = el("#dateStart").value, e = el("#dateEnd").value, ward = el("#wardFilter").value||"ì „ì²´";
  const {labels,values} = buildDailySeries(item, s, e, ward);
  const lc = el("#lineChart").getContext("2d");
  if (lineChart) lineChart.destroy();
  lineChart = new Chart(lc, {
    type:"line",
    data:{ labels, datasets:[{ label:`${item} ì¼ìë³„`, data:values, tension:.25, fill:false }]},
    options:{ responsive:true, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.parsed.y.toLocaleString()} ê°œ` } } }, scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:10 } }, y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });

  const anchorStr = e || new Date().toISOString().slice(0,10);
  const anchor = new Date(anchorStr + "T00:00:00");
  const day = anchor.getDay();
  const mon = new Date(anchor);
  mon.setDate(anchor.getDate() - ((day + 6) % 7));
  const sat = new Date(mon);
  sat.setDate(mon.getDate() + 5);
  const today = new Date(); today.setHours(0,0,0,0);
  const realEnd = new Date(Math.min(sat.getTime(), today.getTime(), anchor.getTime()));
  const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  const { labels: weekLabels, values: weekValues } = buildDailySeries(item, ymd(mon), ymd(realEnd), ward);
  const { labels: dowLabels, values: dowValues } = buildDowSeries(weekValues, weekLabels);

  const bc = el("#dowChart").getContext("2d");
  if (dowChart) dowChart.destroy();
  dowChart = new Chart(bc, {
    type:"bar",
    data:{ labels:dowLabels, datasets:[{ label:`${item} ìš”ì¼ë³„ í•©ê³„(ì£¼ê°„)`, data:dowValues }]},
    options:{ responsive:true, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.parsed.y.toLocaleString()} ê°œ` } } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });
}

/* === í†µê³„ í™”ë©´ ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜ === */
async function renderStats(){
  const today=new Date().toISOString().slice(0,10);
  const s=el("#dateStart").value||today;
  const e=el("#dateEnd").value||today;
  const wardFilter=el("#wardFilter").value||"ì „ì²´";
  if(!s||!e) return;

  if(window.__fb && typeof window.__fb.startStatsLiveWatcher==="function"){
    const prevDayStart = new Date(s + "T00:00:00");
    prevDayStart.setDate(prevDayStart.getDate() - 1);
    const anchor = new Date((e || new Date().toISOString().slice(0,10)) + "T00:00:00");
    const weekMon = new Date(anchor);
    weekMon.setDate(anchor.getDate() - ((anchor.getDay() + 6) % 7));
    const sevenDaysBeforeS = new Date(prevDayStart);
    sevenDaysBeforeS.setDate(prevDayStart.getDate() - 7);
    const watchStart = new Date(Math.max(sevenDaysBeforeS.getTime(), Math.min(weekMon.getTime(), prevDayStart.getTime())));

    window.__fb.startStatsLiveWatcher(watchStart, new Date(e+"T00:00:00"), (logsRT)=>{
      const [sMs,eMs]=rangeMsByDates(s,e);
      const prevStartMs = Math.max(sevenDaysBeforeS.getTime(), Math.min(weekMon.getTime(), sMs - 24*60*60*1000));
      let logsLS=[];
      try{ logsLS=getLogs().filter(L=>L.ts>=prevStartMs && L.ts<eMs);}catch(_){}

      const merged = [];
      const rtSeenComposite = new Set();
      for (const L of logsRT) { merged.push(L); const key = [L.ts, L.ward, L.item, L.qty].join("|"); rtSeenComposite.add(key); }
      for (const L of logsLS) { const key = [L.ts, L.ward, L.item, L.qty].join("|"); if (!rtSeenComposite.has(key)) merged.push(L); }
      __mergedCache = merged;

      let html = '';
      const items = ALL_ITEMS;
      let periodTotals;

            if (wardFilter === "ì „ì²´") {
        // 1) í”¼ë²— ê°€ì ¸ì˜¤ê¸°
        const { p, wards, items } = renderPivot(merged, s, e, wardFilter);

        // 2) ìˆœìœ„ì—ì„œ ì œì™¸í•  ë³‘ë™
        const rankExcludes = new Set(["ë¦°ë„¨ì‹¤", "ê¸°íƒ€"]);

        // 3) 'ìˆ˜ê±´' í•­ëª© ì œì™¸ í•¨ìˆ˜
        const isTowel = (name) => name.replace(/\s+/g, "") === "ìˆ˜ê±´";

        // 4) ë³‘ë™ë³„ í•©ê³„ë¥¼ ê³„ì‚° (ìˆ˜ê±´ ì œì™¸)
        const wardTotals = wards.map(w => ({
            ward: w,
            total: items.reduce((a, i) => a + (isTowel(i) ? 0 : (p[w]?.[i] || 0)), 0)
        }));

        // 5) ë³‘ë™ë³„ í•©ê³„ë¥¼ êµ¬í•´ ìˆœìœ„ ë§¤ê¸°ê¸°
        const rankedWards = wardTotals
            .filter(item => !rankExcludes.has(item.ward) && item.total > 0) // ì œì™¸ ë³‘ë™ ë° í•©ê³„ 0 í•„í„°ë§
            .sort((a, b) => b.total - a.total); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

        // 6) ìƒìœ„ 3ê°œ ë³‘ë™ì˜ ìˆœìœ„ë¥¼ Mapìœ¼ë¡œ ì €ì¥ (ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•´)
        const rankMap = new Map();
        rankedWards.slice(0, 3).forEach((item, index) => {
            rankMap.set(item.ward, index + 1); // 1, 2, 3ë“± ì €ì¥
        });

        html = `<table class="statsTable"><thead><tr><th><span class="wardName">ë³‘ë™</span></th>${items.map(i => `<th class="rot">${i}</th>`).join("")}</tr></thead><tbody>`;
        wards.forEach((w, rowIdx) => {
            // 7) í˜„ì¬ ë³‘ë™ì˜ ë“±ìˆ˜ë¥¼ ê°€ì ¸ì˜´
            const rank = rankMap.get(w);
            // 8) ë“±ìˆ˜(rank)ì— ë”°ë¼ data-rank ì†ì„± ì¶”ê°€
            const rankAttr = rank ? `data-rank="${rank}"` : '';
            html += `<tr ${rankAttr}><td><span class="wardName">${w}</span></td>${items.map(i => { const v = (p[w]?.[i] || 0); return `<td data-num="1"><span class="num"${colorStyle(i, v)}>${v}</span></td>`; }).join("")}</tr>`;
        });
 periodTotals=items.map(i=>wards.reduce((a,w)=>a+(p[w]?.[i]||0),0));
        html+=`<tr class="total-row"><th><span class="wardName">í•©ê³„</span></th>${periodTotals.map((v,idx)=>`<th data-num="1"><span class="num"${colorStyle(items[idx],v)}>${v}</span></th>`).join("")}</tr>`;
        html+=`</tbody></table>`;
      } else {
        const datesInRange = dateRangeArray(s, e);
        const dailyData = {};
        rangeSelect(merged, s, e, wardFilter).forEach(L => {
          const dateStr = fmtYYYYMMDD(new Date(L.ts));
          if (!dailyData[dateStr]) { dailyData[dateStr] = Object.fromEntries(items.map(it => [it, 0])); }
          dailyData[dateStr][L.item] += (Number(L.qty) || 0);
        });
        html = `<table class="statsTable"><thead><tr><th>ë‚ ì§œ</th>${items.map(i => `<th class="rot">${i}</th>`).join("")}</tr></thead><tbody>`;
        const periodTotalsByItem = Object.fromEntries(items.map(it => [it, 0]));
        datesInRange.forEach(dateObj => {
          const dateStr = fmtYYYYMMDD(dateObj);
          const dayData = dailyData[dateStr] || Object.fromEntries(items.map(it => [it, 0]));
          html += `<tr><td>${dateStr.slice(5).replace('-', '/')}</td>`;
          items.forEach(item => { const v = dayData[item] || 0; html += `<td data-num="1"><span class="num"${colorStyle(item, v)}>${v}</span></td>`; periodTotalsByItem[item] += v; });
          html += `</tr>`;
        });
        periodTotals = items.map(item => periodTotalsByItem[item]);
        html += `<tr class="total-row"><th>í•©ê³„</th>${periodTotals.map((v, idx) => `<th data-num="1"><span class="num"${colorStyle(items[idx], v)}>${v}</span></th>`).join("")}</tr>`;
        html += `</tbody></table>`;
      }
      el("#statsWrap").innerHTML = html;

      const daysCount = Math.max(1, Math.round((new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24)) + 1);
      let sumHtml = `<table class="summaryTable"><thead><tr><th>í’ˆëª©</th><th>ì „ì¼ ì‚¬ìš©ëŸ‰</th><th>ì¼í‰ê·  ì‚¬ìš©ëŸ‰</th><th>ê¸°ê°„í•©ê³„</th></tr></thead><tbody>`;
      const prevDate = new Date(e + "T00:00:00");
      prevDate.setDate(prevDate.getDate() - 1);
      const prevYmd = `${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,"0")}-${String(prevDate.getDate()).padStart(2,"0")}`;
      const [pS, pE] = rangeMsByDates(prevYmd, prevYmd);
      const prevByItem = Object.fromEntries(items.map(it => [it, 0]));
      for (const L of __mergedCache) {
        if (L.ts >= pS && L.ts < pE && (wardFilter === "ì „ì²´" || String(L.ward||"").trim() === wardFilter)) { prevByItem[L.item] = (prevByItem[L.item] || 0) + (Number(L.qty) || 0); }
      }
      items.forEach((it, idx) => {
        const psum = periodTotals[idx] || 0;
        const avg = Math.round(psum / daysCount);
        const prev = prevByItem[it] || 0;
        const cleanText = it.replace(/ã€€/g, '');
        const len = cleanText.length;
        const itemClass = len < 4 ? 'item-name-justify' : '';
        const charsHtml = cleanText.split('').map(c => `<span>${c}</span>`).join('');
        sumHtml += `<tr><td class="${itemClass}">${charsHtml}</td><td${colorStyle(it, prev)}>${prev}</td><td${colorStyle(it, avg)}>${avg}</td><td${colorStyle(it, psum)}>${psum}</td></tr>`;
      });
      sumHtml += `</tbody></table>`;
      el("#statsSummary").innerHTML = sumHtml;
      shrinkBigNumbers(el("#statsWrap").querySelector("table"));
      el("#statsEmpty").style.display = "none";
      ensureChartItemOptions();
      renderCharts();
    });
  }
}

/* === ë°ì´í„° ë‚´ë³´ë‚´ê¸° (XLSX) === */
function exportXLSX(){
  const table=document.querySelector("#statsWrap table"); if(!table){ alert("í†µê³„ í‘œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  const s=el("#dateStart").value||"", e=el("#dateEnd").value||"", ward=el("#wardFilter").value||"ì „ì²´";
  const ws=XLSX.utils.table_to_sheet(table,{origin:"A2"});
  const title=`${s} ~ ${e} ${ward}ë³‘ë™ ì¶œê³ ëŸ‰`;
  XLSX.utils.sheet_add_aoa(ws,[[title]],{origin:"A1"});
  const lastCol=table.rows[0].cells.length-1;
  ws["!merges"]=ws["!merges"]||[]; ws["!merges"].push({s:{r:0,c:0},e:{r:0,c:lastCol}});
  ws["A1"].s={font:{bold:true,sz:14},alignment:{horizontal:"center",vertical:"center"}};
  ws["!rows"]=ws["!rows"]||[]; ws["!rows"][0]={hpt:22};
  const daysCount = Math.max(1, Math.round((new Date(e) - new Date(s)) / (1000*60*60*24)) + 1);
  const tBody = table.tBodies[0];
  const lastRow = tBody.rows[tBody.rows.length-1];
  const totals = Array.from(lastRow.cells).slice(1).map(c=>parseInt(c.innerText)||0);
  const avgs = totals.map(v=>Math.round(v/daysCount));
  XLSX.utils.sheet_add_aoa(ws,[["ì¼í‰ê· ", ...avgs]],{origin:-1});
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"í†µê³„");
  XLSX.writeFile(wb,`stats_${s}_to_${e}.xlsx`);
}
function exportChartXLSX(){
  const s=el("#dateStart").value||"", e=el("#dateEnd").value||"", ward=el("#wardFilter").value||"ì „ì²´";
  const item = el("#chartItem").value || "ëª¨ë“  í’ˆëª© í•©ê³„";
  if(!s || !e){ alert("ê¸°ê°„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
  const {labels,values} = buildDailySeries(item, s, e, ward);
  const {labels: dowLabels, values: dowValues} = buildDowSeries(values, labels);
  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.aoa_to_sheet([["ë‚ ì§œ","ìˆ˜ëŸ‰"], ...labels.map((d,i)=>[d,values[i]])]);
  XLSX.utils.book_append_sheet(wb, ws1, "ì¼ìì¶”ì´");
  const ws2 = XLSX.utils.aoa_to_sheet([["ìš”ì¼","í•©ê³„"], ...dowLabels.map((n,i)=>[n,dowValues[i]])]);
  XLSX.utils.book_append_sheet(wb, ws2, "ìš”ì¼í•©ê³„");
  XLSX.writeFile(wb, `trend_${item}_${s}_to_${e}.xlsx`);
}

/* === ë²„íŠ¼ ìƒí˜¸ì‘ìš© (Hold & Ripple) === */
function attachHoldRepeat(btn, onStep){
  let timer = null;
  const firstDelay = 450, interval = 150;
  let started = false;
  const start = (e) => {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    if (started) return;
    started = true;
    onStep();
    timer = setTimeout(function tick(){ onStep(); timer = setTimeout(tick, interval); }, firstDelay);
  };
  const stop = () => { started = false; if (timer){ clearTimeout(timer); timer = null; } };
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchstart', start, { passive:false });
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>{ btn.addEventListener(ev, stop); });
}
function addRipple(e){
  const btn=e.currentTarget, rect=btn.getBoundingClientRect(), span=document.createElement('span');
  const size=Math.max(rect.width, rect.height);
  span.className='ripple'; span.style.width=span.style.height=size+'px';
  span.style.left=(e.clientX-rect.left-size/2)+'px';
  span.style.top=(e.clientY-rect.top-size/2)+'px';
  span.style.position='absolute'; span.style.borderRadius='50%'; span.style.transform='scale(0)';
  span.style.animation='ripple .5s ease-out'; span.style.background='rgba(255,255,255,.5)'; span.style.pointerEvents='none';
  btn.appendChild(span); setTimeout(()=>span.remove(), 500);
}
function showToast(msg, sub){
  const t=document.getElementById('toast');
  if(msg) document.getElementById('toastText').textContent = msg;
  if(sub) t.querySelector('.sub').textContent=sub;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1800);
}

/* === ìƒë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì œì–´ === */
function moveTopSlider(section){
  const idx = ["input","stats","guest","admin"].indexOf(section);
  const slider = document.getElementById('navSlider');
  if (slider && idx >= 0) slider.style.transform = `translateX(${idx*100}%)`;
}
function setTopActive(section){
  document.querySelectorAll('.navTab').forEach(b=>{ b.classList.toggle('active', b.dataset.section===section); });
  moveTopSlider(section);
}
function goSection(section){
  if (section === 'guest'){
    const url = `ë°©ëª…ë¡.html${state.ward ? ('?ward=' + encodeURIComponent(state.ward)) : ''}`;
    location.href = url;
    return;
  }
  if (section === 'admin'){ openAdminGate(); return; }
  state.section = section;
  setTopActive(section);
  if (section === 'stats'){
    document.body.classList.add("mode-stats");
    el("#sec-input").style.display="none";
    el("#sec-stats").style.display="block";
    const chosen=el("#issueDate").value||new Date().toISOString().slice(0,10);
    el("#dateStart").value=chosen; el("#dateEnd").value=chosen;
    renderStats();
  } else {
    document.body.classList.remove("mode-stats");
    el("#sec-input").style.display="block";
    el("#sec-stats").style.display="none";
    fitCardToFooter();
  }
}

/* === ê°„ì†Œí™” í—¤ë” ì œì–´ === */
function todayYmd(){
  const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function syncMiniHeader(){
  const wardTxt = (state.ward||"").toString().trim() || "ë¯¸ì„ íƒ";
  const dateTxt = el("#issueDate")?.value || todayYmd();
  const cw = el("#curWard"), cd = el("#curDate");
  if (cw) cw.textContent = wardTxt;
  if (cd) cd.textContent = dateTxt;
}
function wireMiniHeader(){
  const btn = el("#editHeaderBtn");
  if (btn){ btn.onclick = (e)=>{ try{ addRipple && addRipple(e); }catch(_){} openModal("#headerEditModal", "#wardSelect"); }; }
  const cancel = el("#heCancel");
  if (cancel){ cancel.onclick = ()=> closeModal("#headerEditModal"); }
  const save = el("#heSave");
  if (save){ save.onclick = ()=>{ closeModal("#headerEditModal"); syncMiniHeader(); }; }
  const wSel = el("#wardSelect"), dInp = el("#issueDate");
  if (wSel) wSel.addEventListener("change", syncMiniHeader);
  if (dInp) dInp.addEventListener("change", syncMiniHeader);
}

/* === ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ === */
function debounce(fn,delay=200){ let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),delay); }; }

/* === ë³‘ë™ ë¯¸ì„ íƒ ì‹œ ì•ˆë‚´ ë¡œì§ === */
function isWardSelected(){ return (state.ward || "").toString().trim() !== ""; }
function showWardPromptModal(){ openModal('#wardPromptModal', '#wpOk'); playSnd("#warnSound"); }

/* === í˜ì´ì§€ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë°”ì¸ë”© === */
window.addEventListener("DOMContentLoaded",()=>{
  el('#wpOk').onclick = () => { closeModal('#wardPromptModal'); openModal('#headerEditModal', '#wardSelect'); };
  ['click', 'mousedown', 'touchstart'].forEach(eventType => {
    document.body.addEventListener(eventType, (e) => {
      if (isWardSelected()) return;
      const restrictedTargets = '#inputTable input, #inputTable button, .tabs .tab, #saveAll';
      if (e.target.closest(restrictedTargets) && !e.target.closest('#editHeaderBtn')) {
        if (eventType === 'touchstart') { if (e.cancelable) e.preventDefault(); } else { e.preventDefault(); }
        e.stopPropagation();
        if (!window.__wardPromptOpen) {
          window.__wardPromptOpen = true;
          showWardPromptModal();
          setTimeout(() => { window.__wardPromptOpen = false; }, 400);
        }
      }
    }, { capture: true, passive: false });
  });

  const urlApp=new URL(location.href).searchParams.get("app"); if(urlApp==="1"){localStorage.setItem("appMode","1");} if(urlApp==="0"){localStorage.removeItem("appMode");}
  const ua=(navigator.userAgent||"")+" "+(navigator.vendor||"");
  if((window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||/\b; wv\b/i.test(ua)||/\bMyLinenApp\b/i.test(ua)||localStorage.getItem('appMode')==='1'){ document.body.classList.add("app"); const b=el("#appDownloadBtn"); if(b) b.style.display="none"; }
  const urlWard=new URL(location.href).searchParams.get("ward");
  if(urlWard){ state.ward=(urlWard||"").toString().trim(); localStorage.setItem(LS.ward,state.ward); }
  el("#wardSelect").value=state.ward;
  el("#wardSelect").onchange=e=>{ state.ward=(e.target.value||"").toString().trim(); localStorage.setItem(LS.ward,state.ward); buildTable(); fitCardToFooter(); };
  const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  el("#issueDate").value=`${yyyy}-${mm}-${dd}`;
  el("#dateStart").value=`${yyyy}-${mm}-${dd}`;
  el("#dateEnd").value=`${yyyy}-${mm}-${dd}`;

  syncMiniHeader();
  wireMiniHeader();
  buildTable();
  refreshTotalUI();
  fitCardToFooter();

  window.addEventListener('resize', fitCardToFooter);
  window.addEventListener('orientationchange', fitCardToFooter);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', fitCardToFooter);
  window.addEventListener('resize', ()=> sizeModalBody('#confirmModal', 0.5));
  if (window.visualViewport) window.visualViewport.addEventListener('resize', ()=> sizeModalBody('#confirmModal', 0.5));

  el("#saveAll").addEventListener('click', addRipple);
  el("#saveAll").onclick = (e) => {
    if (!isWardSelected()) return;
    try { addRipple && addRipple(e); } catch(_) {}
    openConfirmSubmit();
  };
  el("#exportXLSXBtn").addEventListener('click', addRipple);
  el("#exportXLSXBtn").onclick=exportXLSX;
  el("#appDownloadBtn").addEventListener('click', addRipple);

  function closeDownloadModal(){ closeModal('#downloadModal'); }
  el("#dlCancel").onclick = closeDownloadModal;
  el("#dlConfirm").onclick = () => { closeDownloadModal(); const url = LATEST_DIRECT; if(url && url.startsWith("http")) window.location.href = url; else alert("ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); };
  el("#downloadModal").addEventListener("click",(e)=>{ if(e.target === e.currentTarget) closeDownloadModal(); });
  el('#submitModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeModal('#submitModal'); });
  el('#smOk').onclick = ()=> closeModal('#submitModal');

  const tabs = Array.from(document.querySelectorAll(".tab"));
  const slider = document.getElementById('tabSlider');
  function moveSlider(){ const idx = ["ì‹œíŠ¸","í™˜ìë³µ","ê¸°íƒ€"].indexOf(state.cat); slider.style.transform = `translateX(${idx*100}%)`; }
  tabs.forEach(t=>{
    t.setAttribute('role','tab');
    t.setAttribute('aria-selected', t.classList.contains('active') ? 'true' : 'false');
    t.setAttribute('tabindex', t.classList.contains('active') ? '0' : '-1');
    t.onclick=()=>{
      if (!isWardSelected()) return;
      state.cat=t.dataset.cat;
      tabs.forEach(x=>{
        const isActive = (x === t);
        x.classList.toggle("active", isActive);
        x.setAttribute('aria-selected', isActive ? 'true' : 'false');
        x.setAttribute('tabindex', isActive ? '0' : '-1');
      });
      moveSlider();
      buildTable();
      fitCardToFooter();
      playSnd("#tabSound");
    };
  });
  moveSlider();

  const rerender=debounce(()=>{ renderStats(); },200);
  ["#dateStart","#dateEnd","#wardFilter"].forEach(sel=>{
    const n=el(sel); n&&n.addEventListener("change",rerender); n&&n.addEventListener("input",rerender);
  });

  ensureChartItemOptions();
  el("#chartItem").addEventListener("change", ()=> renderCharts());
  el("#exportChartXLSXBtn").addEventListener("click", (event)=>{ addRipple(event); exportChartXLSX(); });

  document.querySelectorAll('.navTab').forEach(btn=>{
    btn.addEventListener('click', ()=> goSection(btn.dataset.section));
  });

  const urlTab = new URL(location.href).searchParams.get("tab");
  goSection(urlTab === "stats" ? "stats" : "input");
});
</script>
<script>
(function blockIOSZoom(){
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (/\bMacintosh\b/.test(ua) && navigator.maxTouchPoints > 1);
  if (!isIOS) return;

  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) { e.preventDefault(); }
    lastTouchEnd = now;
  }, { passive:false });

  ['gesturestart','gesturechange','gestureend'].forEach(evt=>{
    document.addEventListener(evt, function(e){ e.preventDefault(); }, { passive:false });
  });
})();
</script>
<script>
let deferredPrompt = null;
let canInstall = false;

if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").then(reg => {
      reg.addEventListener("updatefound", () => { console.log("[SW] update found"); });
    }).catch(err => console.warn("[SW] register failed:", err));
  });
  let refreshed = false;
  navigator.serviceWorker.addEventListener("controllerchange", () => {
    if (refreshed) return;
    refreshed = true;
    try { typeof closeModal === "function" && closeModal("#pwaInstallModal"); } catch(_) {}
    location.reload();
  });
}

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  canInstall = true;
  const b = document.getElementById("appDownloadBtn");
  if (b) b.style.display = "block";
});

window.addEventListener("appinstalled", () => {
  deferredPrompt = null;
  canInstall = false;
  const b = document.getElementById("appDownloadBtn");
  if (b) b.style.display = "none";
  if (typeof showToast === "function") showToast("ì„¤ì¹˜ ì™„ë£Œ", "í™ˆ í™”ë©´ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”");
});

function isIOS() {
  const ua = navigator.userAgent || "";
  const isTouchMac = /Macintosh/.test(ua) && navigator.maxTouchPoints > 1;
  return /iPhone|iPad|iPod/.test(ua) || isTouchMac;
}
function isStandalone() {
  return (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) || (window.navigator.standalone === true);
}

const APK_URL = (typeof LATEST_DIRECT === "string" && LATEST_DIRECT) ? LATEST_DIRECT : "https://github.com/bangat/linenward/releases/latest/download/WardLinen.apk";

function openAPKModal() {
  if (typeof openModal === "function" && document.querySelector("#downloadModal")) { openModal('#downloadModal', '#dlConfirm'); }
  else { location.href = APK_URL; }
}
function openIOSInstallModal() {
  if (typeof openModal === "function" && document.querySelector("#iosInstallModal")) { openModal('#iosInstallModal', '#iosOk'); }
  else { alert("Safari â†’ ê³µìœ  â†’ 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”."); }
}
function openPwaInstallModal() {
  if (typeof openModal === "function") { openModal("#pwaInstallModal", "#piConfirm"); sizeModalBody("#pwaInstallModal", 0.5); }
}
function closeModalIfExists(sel) {
  if (typeof closeModal === "function" && document.querySelector(sel)) closeModal(sel);
}
async function triggerInstallPrompt() {
  if (!deferredPrompt) return;
  const p = deferredPrompt;
  deferredPrompt = null;
  canInstall = false;
  try {
    await p.prompt();
    const { outcome } = await p.userChoice;
    if (outcome === "accepted") return;
    if (isIOS()) { openIOSInstallModal(); return; }
    openAPKModal();
  } catch {
    if (isIOS()) { openIOSInstallModal(); return; }
    openAPKModal();
  }
}
document.addEventListener("click", (e) => {
  const id = (e.target && e.target.id) || "";
  if (id === "piConfirm") {
    closeModalIfExists('#pwaInstallModal');
    if (deferredPrompt) triggerInstallPrompt();
    else { if (isIOS()) openIOSInstallModal(); else openAPKModal(); }
  }
  if (id === "piCancel") { closeModalIfExists('#pwaInstallModal'); }
  if (id === "iosOk" || id === "iosClose") { closeModalIfExists('#iosInstallModal'); }
  if (id === "dlConfirm") { closeModalIfExists('#downloadModal'); location.href = APK_URL; }
});

(function wireInstallButton(){
  const btn = document.getElementById("appDownloadBtn");
  if (!btn) return;
  if (isStandalone()) { btn.style.display = "none"; return; }
  btn.onclick = (event) => {
    try { typeof addRipple === "function" && addRipple(event); } catch(_) {}
    if (isIOS()) { openIOSInstallModal(); return; }
    openPwaInstallModal();
  };
})();
</script>
<script>
(function(){
  const p = new URLSearchParams(location.search);
  if(p.get("back")!=="1") return;

  const style = document.createElement("style");
  style.textContent = `
    .backFab{
      position:fixed; top:10px; right:10px; z-index:9999;
      height:36px; padding:0 12px; border-radius:10px;
      background:#ffffff; color:#1f2937; font-weight:800; border:1px solid #e5e7eb;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
    }
    .backFab:active{ transform:translateY(1px); }
  `;
  document.head.appendChild(style);

  const btn = document.createElement("button");
  btn.className = "backFab";
  btn.textContent = "â† ë’¤ë¡œê°€ê¸°";
  btn.onclick = ()=> history.back();

  document.body.appendChild(btn);
})();
</script>

<script>
  feather.replace();

  // â–·â–·â–· JS(force-light-guard-plus) ì‹œì‘ â–·â–·â–·
  try{
    const htmlEl = document.documentElement;

    const clearDarkArtifacts = () => {
      // 1) html ì¸ë¼ì¸ filter ì œê±°
      const styleAttr = (htmlEl.getAttribute('style')||'').toLowerCase();
      if (styleAttr.includes('filter')) htmlEl.style.filter = 'none';

      // 2) data-darkreader-* ì†ì„± ì œê±° (í™•ì¥/ë¸Œë¼ìš°ì € ë‹¤í¬)
      if (htmlEl.hasAttribute('data-darkreader-mode')) htmlEl.removeAttribute('data-darkreader-mode');
      if (htmlEl.hasAttribute('data-darkreader-scheme')) htmlEl.removeAttribute('data-darkreader-scheme');

      // 3) ì£¼ì…ëœ ë‹¤í¬ ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
      const badStyles = Array.from(document.querySelectorAll('style.darkreader, style[id*="darkreader"], link[rel="stylesheet"][data-darkreader]'));
      badStyles.forEach(n => { try{ n.parentNode && n.parentNode.removeChild(n); }catch(_){} });

      // 4) ë¼ì´íŠ¸ íŒíŠ¸ ìœ ì§€
      htmlEl.style.colorScheme = 'light';
    };

    // ìµœì´ˆ 1íšŒ
    clearDarkArtifacts();

    // html ì†ì„±/ìŠ¤íƒ€ì¼ ë³€í™” ê°ì‹œ
    new MutationObserver(clearDarkArtifacts).observe(htmlEl, { attributes: true, attributeFilter: ['style','data-darkreader-mode','data-darkreader-scheme'] });
    // headì— ì£¼ì…ë˜ëŠ” style/link ê°ì‹œ
    new MutationObserver(clearDarkArtifacts).observe(document.head || document.documentElement, { childList: true, subtree: true });

    // í™”ë©´ íšŒì „/ì¬ê°œ ì‹œ ì¬í™•ì¸ (ëª¨ë°”ì¼ì—ì„œ ë‹¤í¬ê°€ ë‹¤ì‹œ ë¶™ëŠ” ê²½ìš°)
    window.addEventListener('pageshow', clearDarkArtifacts);
    window.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') clearDarkArtifacts(); });
  }catch(_){}
  // â–·â–·â–· JS(force-light-guard-plus) ì¢…ë£Œ â–·â–·â–·
</script>


<div id="loadingOverlay" style="display:none">
  <div class="spinner"></div>
  <div>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”â€¦</div>
</div>
</script>

</body>
</html>

