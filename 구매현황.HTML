<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>발주·입고 현황</title>

  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
      --r-lg:16px; --shadow-1:0 4px 16px rgba(15,23,42,.08);
      --ok:#16a34a; --danger:#ef4444; --done:#e8f7ee; --light-red:#f43f5e;
    }
    *{box-sizing:border-box}
    html,body{-webkit-text-size-adjust:100%; overflow-x:hidden;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;}
    .wrap{max-width:980px;margin:10px auto;padding:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-1);padding-bottom:72px}
    .card-head{padding:12px;display:grid;gap:10px}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1 1 auto}

    .btn{
      border:1px solid var(--border);background:#fff;border-radius:12px;
      padding:0 12px;height:34px;font-weight:800;cursor:pointer;font-size:13px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      white-space:nowrap; min-width:64px;
    }
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.green{background:var(--ok);color:#fff;border-color:var(--ok)}
    .btn.ghost{background:#f8fafc;border-color:var(--border);color:#334155}
    .btn:active{transform:translateY(1px)}

    input[type="date"], input[type="number"]{
      border:1px solid var(--border);border-radius:12px;padding:0 8px;height:34px;font-size:13px;background:#fff;outline:none;min-width:0;text-align:center;
    }
    input[type="number"]{ width:68px; }
    input:focus{box-shadow:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);border-color:transparent}

    .subtabs{ display:flex; gap:6px; align-items:center; }
    .subtab{ padding:8px 10px; font-weight:900; color:#5b677a; background:transparent; border:none; border-bottom:3px solid transparent; cursor:pointer;}
    .subtab.active{ color:var(--accent); border-bottom-color:var(--accent); }

    .datebar{ display:flex; gap:8px; align-items:center; padding:0 6px; }

    .itemline{ display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); padding:6px; }
    .itemtabs{ display:flex; gap:6px; flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .itemtabs::-webkit-scrollbar{height:6px}
    .itemtab{ padding:8px 12px; font-weight:900; color:#5b677a; background:transparent; border:none; border-bottom:3px solid transparent; cursor:pointer; white-space:nowrap;}
    .itemtab.active{ color:var(--accent); border-bottom-color:var(--accent); }

    .patient-tabs{ display:flex; gap:6px; padding:6px 6px 0 6px;}
    .ptab{ padding:6px 10px; font-weight:900; color:#5b677a; background:#f8fafc; border:1px solid var(--border); border-bottom:2px solid transparent; border-radius:10px; cursor:pointer; white-space:nowrap;}
    .ptab.active{ color:#fff; background:var(--accent); border-color:var(--accent); }

    .table-wrap{border-radius:12px;border:1px solid var(--border);margin:8px 6px;overflow:hidden}
    table{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);font-size:12px;height:30px}
    td,th{border-bottom:1px solid var(--border);padding:6px 8px;text-align:center;font-size:12px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .is-orders table tbody td:first-child{ text-align:center; }

    .tbl-receipts td, .tbl-receipts th { vertical-align: middle; }
    .tbl-receipts td:nth-child(2), .tbl-receipts th:nth-child(2){ width:80px; }
    .tbl-receipts td:nth-child(3), .tbl-receipts th:nth-child(3){ width:70px; }
    .tbl-receipts td:nth-child(4), .tbl-receipts th:nth-child(4){ width:65px; }
    .o-cell, .pcell{ font-variant-numeric: tabular-nums; }
    .pcell{ text-align:center; overflow:visible; min-width:3.5ch; }
    .done td{ background:var(--done); }
    .over td:last-child{ color:var(--light-red); font-weight:800; }
    .name-cell{ position:relative; }
    .badge-dot{ position:absolute; right:4px; top:4px; width:14px; height:14px; border-radius:999px; background:#ef4444; color:#fff; font-weight:900; font-size:10px; display:flex; align-items:center; justify-content:center; line-height:12px; }
    .is-hidden{ display:none !important; }

    .progress{height:16px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:6px}
    .progress > div{height:100%;background:var(--accent);text-align:center;font-size:11px;color:#fff;line-height:16px}

    .savebar{
      position:fixed; left:0; right:0; bottom:0; z-index:300;
      background:#fff; border-top:1px solid var(--border); box-shadow:0 -6px 16px rgba(15,23,42,.08);
      padding:10px; display:flex; gap:10px; align-items:center; justify-content:flex-end;
    }
    .savebar .btn{height:42px; border-radius:12px; font-size:15px; padding:0 16px;}

    .sec-title{font-weight:900; font-size:13px; color:#334155; padding:8px 10px; margin:6px 6px 0;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-head">
        <div class="row">
          <div class="subtabs" role="tablist" aria-label="발주/입고 전환">
            <button id="tab-orders" class="subtab active" data-mode="orders">발주현황</button>
            <button id="tab-receipts" class="subtab" data-mode="receipts">입고현황</button>
          </div>
        </div>

        <div class="datebar">
          <input id="dateFrom" type="date" aria-label="시작 날짜" />
          <span style="color:#94a3b8">~</span>
          <input id="dateTo"   type="date" aria-label="종료 날짜" />
        </div>

        <div style="padding:6px 6px 0">
          <div id="gaugeStats" style="font-size:12px;color:#475569;margin:4px 0 2px">전체 발주수량 0개 · 전체 입고수량 0개 — 0% 입고됨</div>
          <div class="progress" aria-label="진행률">
            <div id="progressBarInner" style="width:0%">0%</div>
          </div>
        </div>

        <div id="ordersTopLine" class="itemline">
          <div id="tabsWrap" class="itemtabs" role="tablist" aria-label="구분 탭">
            <button class="itemtab active" data-tab="sheet">시트류</button>
            <button class="itemtab" data-tab="patient">환자복</button>
            <button class="itemtab" data-tab="summary">발주내역</button>
          </div>
          <div class="spacer"></div>
          <!-- 상단 엑셀 버튼 삭제됨 -->
        </div>

        <div id="patientTabs" class="patient-tabs" style="display:none">
          <button class="ptab active" data-kind="normal">일반환의</button>
          <button class="ptab" data-kind="ortho">정형환의</button>
        </div>
      </div>

      <div id="formBox"></div>
    </div>
  </div>

  <div class="savebar">
    <button id="btnExcelBottom" class="btn green"><i data-feather="download"></i> 엑셀로 내려받기</button>
    <button id="btnSaveBottom" class="btn primary"><i data-feather="save"></i> <span id="saveLabel">발주 저장</span></button>
  </div>

  <div id="toast" role="status" aria-live="polite" style="display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:60px;background:#111827;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;"></div>

  <script type="module">
    /* ───────── Firebase 시작 ───────── */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, push, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
      authDomain: "hallymlinen.firebaseapp.com",
      databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
      projectId: "hallymlinen",
      storageBucket: "hallymlinen.appspot.com",
      messagingSenderId: "867775830688",
      appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
      measurementId: "G-T02ZFK18L3"
    };
    const app  = initializeApp(firebaseConfig);
    const rtdb = getDatabase(app);
    /* ───────── Firebase 종료 ───────── */

    /* ───────── 유틸/상수 시작 ───────── */
    const SHEET_PRIORITY = ["대시트","반시트","베갯잇","수건","중환의","얼음포","억제대"];
    const NORMAL_SIZES = ["4XL","3XL","2XL","XL","L","M","S"];
    const ORTHO_SIZES  = ["3XL","2XL","XL","L","M","S"];
    const HIP_SIZES    = ["XL","L","M"];
    const makeName = (prefix,size)=> `${prefix}${size}`;

    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const pad2 = n => String(n).padStart(2,'0');
    const ymOf = (d)=> (d||'').slice(0,7);
    function ymRange(fromDate, toDate){
      if(!fromDate || !toDate) return [];
      const fs = new Date(fromDate), ts = new Date(toDate);
      let y=fs.getFullYear(), m=fs.getMonth()+1;
      const out=[];
      while(y<ts.getFullYear() || (y===ts.getFullYear() && m<=ts.getMonth()+1)){
        out.push(`${y}-${pad2(m)}`); m++; if(m>12){m=1;y++; }
      }
      return out;
    }
    function yearMonths(y){ const out=[]; for(let m=1;m<=12;m++) out.push(`${y}-${pad2(m)}`); return out; }
    function showToast(msg='완료'){
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display='block';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.display='none', 1600);
    }
    /* ───────── 유틸/상수 종료 ───────── */

    /* ───────── 상태 ───────── */
    const state = {
      mode:'orders', tab:'sheet',
      dateFrom:'', dateTo:'',
      snapshot:null,
      draftOrders:{ sheet:new Map(), patient:new Map() },
      patientKind:'normal'
    };

    /* ───────── DB ───────── */
    async function getStatusOnce(){
      const snap = await get(ref(rtdb, 'purchase_status'));
      return snap.exists() ? (snap.val()||{}) : {};
    }
    async function batchAddOrders(entries, ym){
      const updates = {};
      entries.forEach(({itemName, qty, topBottom})=>{
        if(!qty) return;
        const k = push(ref(rtdb)).key;
        updates[`purchase_status/${itemName}/name`] = itemName;
        updates[`purchase_status/${itemName}/orders/${ym}/${k}`] = {qty:Number(qty)||0, topBottom: topBottom||'', ts:Date.now()};
      });
      if(Object.keys(updates).length) await update(ref(rtdb), updates);
    }
    async function batchAddReceipts(entries, ym, day){
      const updates = {};
      entries.forEach(({itemName, qty, topBottom})=>{
        if(!qty) return;
        const k = push(ref(rtdb)).key;
        updates[`purchase_status/${itemName}/name`] = itemName;
        updates[`purchase_status/${itemName}/receipts/${ym}/${k}`] = {day:Number(day)||1, qty:Number(qty)||0, topBottom: topBottom||'', ts:Date.now()};
      });
      if(Object.keys(updates).length) await update(ref(rtdb), updates);
    }

    /* ───────── 초기화 ───────── */
    document.addEventListener('DOMContentLoaded', ()=>{
      const t = new Date();
      const ymd = `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`;
      $('#dateFrom').value = ymd; state.dateFrom=ymd;
      $('#dateTo').value   = ymd; state.dateTo=ymd;

      $$('.subtab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('.subtab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          state.mode = btn.dataset.mode;

          const showOrdersUI = (state.mode === 'orders');
          $('#ordersTopLine').style.display = showOrdersUI ? 'flex' : 'none';
          $('#patientTabs').style.display   = (showOrdersUI && state.tab==='patient') ? 'flex' : 'none';
          $('#saveLabel').textContent = (state.mode==='orders') ? '발주 저장' : '입고 완료';

          renderBody(); refreshProgress();
        });
      });

      $$('.itemtab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('.itemtab').forEach(b=> b.classList.toggle('active', b===btn));
          state.tab = btn.dataset.tab;
          $('#patientTabs').style.display = (state.mode==='orders' && state.tab==='patient') ? 'flex' : 'none';
          renderBody();
        });
      });

      $$('.ptab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('.ptab').forEach(b=> b.classList.toggle('active', b===btn));
          state.patientKind = btn.dataset.kind;
          if(state.tab==='patient' && state.mode==='orders') renderBody();
        });
      });

      $('#dateFrom').addEventListener('change', ()=>{ state.dateFrom = $('#dateFrom').value; renderBody(); refreshProgress(); });
      $('#dateTo').addEventListener('change',   ()=>{ state.dateTo   = $('#dateTo').value;   renderBody(); refreshProgress(); });

      $('#btnSaveBottom').addEventListener('click', onSaveAll);
      $('#btnExcelBottom').addEventListener('click', onExportHorizontalExcel);

      renderBody(); refreshProgress();
      if (window.feather && typeof feather.replace === 'function') {
        feather.replace({ width:'1em', height:'1em' });
      }
    });

    /* ───────── 렌더 (주문/입고) ───────── */
    async function renderBody(){
      if(!state.snapshot) state.snapshot = await getStatusOnce();
      const container = $('#formBox'); container.innerHTML='';
      container.classList.toggle('is-orders', state.mode==='orders');

      if(state.mode==='orders') renderOrdersUI(container);
      else await renderReceiptsUI(container);
    }

    function renderOrdersUI(container){
      if(state.tab==='sheet'){
        container.innerHTML = `
          <div class="table-wrap">
            <table>
              <thead><tr><th>품목</th><th>수량</th></tr></thead>
              <tbody>
                ${SHEET_PRIORITY.map(n=>`
                  <tr>
                    <td>${n}</td>
                    <td><input type="number" min="0" inputmode="numeric" class="q-sheet" data-item="${n}" value="${state.draftOrders.sheet.get(n)||''}"/></td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>`;
        $$('.q-sheet').forEach(i=> i.addEventListener('input', e=>{
          const v = Number(e.target.value||0);
          if(v>0) state.draftOrders.sheet.set(e.target.dataset.item, v); else state.draftOrders.sheet.delete(e.target.dataset.item);
        }));
      }else if(state.tab==='patient'){
        const sizes = state.patientKind==='normal' ? NORMAL_SIZES : ORTHO_SIZES;
        const prefix = state.patientKind==='normal' ? '일반환의' : '정형환의';
        const rows = [];
        sizes.forEach(sz=>['상의','하의'].forEach(tb=>{
          const key = `${makeName(prefix,sz)}__${tb}`; rows.push({label:prefix,size:sz,tb,key});
        }));
        container.innerHTML = `
          <div class="table-wrap">
            <table>
              <thead><tr><th style="text-align:left; padding-left:8px;">품목</th><th>사이즈</th><th>상/하</th><th>수량</th></tr></thead>
              <tbody>
                ${rows.map(r=>`
                  <tr>
                    <td style="text-align:left; padding-left:8px;">${r.label}</td><td>${r.size}</td><td>${r.tb}</td>
                    <td><input type="number" min="0" inputmode="numeric" class="q-pt" data-key="${r.key}" value="${state.draftOrders.patient.get(r.key)||''}" /></td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>`;
        $$('.q-pt').forEach(i=> i.addEventListener('input', e=>{
          const v = Number(e.target.value||0);
          if(v>0) state.draftOrders.patient.set(e.target.dataset.key, v); else state.draftOrders.patient.delete(e.target.dataset.key);
        }));
      }else{
        renderOrderSummaryWithMonthly(container);
      }
    }

    async function renderReceiptsUI(container){
      const months = ymRange(state.dateFrom, state.dateTo);
      const data = state.snapshot||{};
      if(months.length===0){ container.innerHTML=''; return; }

      const sumBy = (name, path, tb='')=>{
        return months.reduce((acc, m)=>{
          const node = (((data[name]||{})[path]||{})[m])||{};
          const arr = Object.values(node).filter(e=> (tb? (e.topBottom||'')===tb : true));
          return acc + arr.reduce((s,e)=> s+(Number(e.qty)||0),0);
        },0);
      };

      const sheetRows = SHEET_PRIORITY.map(n=>{
        const o = sumBy(n,'orders'); if(o<=0) return '';
        const r = sumBy(n,'receipts');
        const done = r>=o ? 'done' : '';
        const over = r>o ? 'over' : '';
        const prDisp = (r<=o) ? `${Math.round((r/o)*100)}%` : `-${Math.round((r-o)/o*100)}%`;
        const overCnt = Math.max(0, r - o);
        const badgeClass = overCnt ? '' : 'is-hidden';
        return `<tr class="rec-row ${done} ${over}" data-item="${n}" data-tb="">
  <td class="name-cell"><span class="name">${n}</span><span class="badge-dot ${badgeClass}" title="추가입고 ${overCnt}개">+</span></td>
  <td class="o-cell"><span class="o" data-o="${o}" data-r="${r}">${o}/${r}</span></td>
  <td><input type="number" min="0" inputmode="numeric" class="rq" data-item="${n}" data-tb="" /></td>
  <td class="pcell">${prDisp}</td>
</tr>`;
      }).filter(Boolean).join('');

      const buildPatientTable = (prefix, sizes, withTB=true, aliasText='')=>{
        const rows=[];
        sizes.forEach(sz=>{
          const name = makeName(prefix, sz);
          if(withTB){
            ['상의','하의'].forEach(tb=>{
              const o = sumBy(name,'orders',tb);
              if(o>0){
                const r = sumBy(name,'receipts',tb);
                const done = r>=o ? 'done' : '';
                const over = r>o ? 'over' : '';
                const prDisp = (r<=o) ? `${Math.round((r/o)*100)}%` : `-${Math.round((r-o)/o*100)}%`;
                const label = `${aliasText}${sz}${tb==='상의'?'상의':'하의'}`;
                const overCnt = Math.max(0, r - o);
                const badgeClass = overCnt ? '' : 'is-hidden';
                rows.push(`<tr class="rec-row ${done} ${over}" data-item="${name}" data-tb="${tb}">
  <td class="name-cell"><span class="name">${label}</span><span class="badge-dot ${badgeClass}" title="추가입고 ${overCnt}개">+</span></td>
  <td class="o-cell"><span class="o" data-o="${o}" data-r="${r}">${o}/${r}</span></td>
  <td><input type="number" min="0" inputmode="numeric" class="rq" data-item="${name}" data-tb="${tb}" /></td>
  <td class="pcell">${prDisp}</td>
</tr>`);
              }
            });
          }else{
            const o = sumBy(name,'orders');
            if(o>0){
              const r = sumBy(name,'receipts');
              const done = r>=o ? 'done' : '';
              const over = r>o ? 'over' : '';
              const prDisp = (r<=o) ? `${Math.round((r/o)*100)}%` : `-${Math.round((r-o)/o*100)}%`;
              const label = `고관절${sz}`;
              const overCnt = Math.max(0, r - o);
              const badgeClass = overCnt ? '' : 'is-hidden';
              rows.push(`<tr class="rec-row ${done} ${over}" data-item="${name}" data-tb="">
  <td class="name-cell"><span class="name">${label}</span><span class="badge-dot ${badgeClass}" title="추가입고 ${overCnt}개">+</span></td>
  <td class="o-cell"><span class="o" data-o="${o}" data-r="${r}">${o}/${r}</span></td>
  <td><input type="number" min="0" inputmode="numeric" class="rq" data-item="${name}" data-tb="" /></td>
  <td class="pcell">${prDisp}</td>
</tr>`);
            }
          }
        });
        if(rows.length===0) return '';
        return `<div class="table-wrap"><table class="tbl-receipts">
          <thead><tr><th>품목</th><th>발주량</th><th>입고량</th><th>진행률</th></tr></thead>
          <tbody>${rows.join('')}</tbody>
        </table></div>`;
      };

      container.innerHTML = `
        <div class="table-wrap">
          <table class="tbl-receipts">
            <thead><tr><th>품목</th><th>발주량</th><th>입고량</th><th>진행률</th></tr></thead>
            <tbody>${sheetRows}</tbody>
          </table>
        </div>
        ${buildPatientTable('일반환의', NORMAL_SIZES, true, '일반')}
        ${buildPatientTable('정형환의', ORTHO_SIZES, true, '정형')}
        ${buildPatientTable('고관절', HIP_SIZES, false)}
      `;

      $$('.rq').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const tr = e.target.closest('tr');
          const oEl = tr.querySelector('.o');
          const o = Number(oEl.dataset.o), r0 = Number(oEl.dataset.r);
          const v = Number(e.target.value||0);
          const rNew = r0 + v;
          oEl.textContent = `${o}/${rNew}`;
          const pcell = tr.querySelector('.pcell');
          tr.classList.toggle('done', rNew>=o);
          const isOver = rNew>o;
          tr.classList.toggle('over', isOver);
          const badge = tr.querySelector('.badge-dot');
          if(isOver){
            const over = rNew - o;
            pcell.textContent = `-${Math.round((over/o)*100)}%`;
            badge.classList.remove('is-hidden');
            badge.title = `추가입고 ${over}개`;
          }else{
            pcell.textContent = `${Math.round((rNew/o)*100)}%`;
            badge.classList.add('is-hidden');
          }
        });
      });
    }

    /* ───────── 저장: 발주=시작월, 입고=종료월+일 ───────── */
    async function onSaveAll(){
      const ymOrders   = ymOf(state.dateFrom);
      const ymReceipts = ymOf(state.dateTo);
      const day        = Number((state.dateTo||'').split('-')[2]||'1');

      if(state.mode==='orders'){
        const entries = [];
        state.draftOrders.sheet.forEach((qty, item)=>{ if(qty>0) entries.push({itemName:item, qty}); });
        state.draftOrders.patient.forEach((qty, key)=>{
          const [itemName, tb] = key.split('__'); if(qty>0) entries.push({itemName, qty, topBottom:tb});
        });
        if(entries.length===0){ alert('발주 입력값이 없습니다.'); return; }
        await batchAddOrders(entries, ymOrders);
        state.draftOrders.sheet.clear(); state.draftOrders.patient.clear();
        showToast('발주 저장 완료');
      }else{
        const entries = [];
        $$('.rq').forEach(inp=>{
          const qty = Number(inp.value||0);
          if(qty>0){
            const itemName = inp.dataset.item, tb = inp.dataset.tb||'';
            entries.push({itemName, topBottom:tb, qty});
          }
        });
        if(entries.length===0){ alert('입고 입력값이 없습니다.'); return; }
        await batchAddReceipts(entries, ymReceipts, day);
        showToast('입고 완료');
      }
      state.snapshot = await getStatusOnce();
      renderBody(); refreshProgress();
    }

    /* ───────── 발주내역(해당년도 자동) ───────── */
    function renderOrderSummaryWithMonthly(container){
      const now = new Date();
      const year = now.getFullYear();
      const monthsAsc = yearMonths(year);
      const months = [...monthsAsc].sort((a,b)=> a<b ? 1 : (a>b ? -1 : 0));
      const data = state.snapshot||{};

      const sumOrdersAcross = (name, tb='')=>{
        return monthsAsc.reduce((acc,m)=>{
          const ord = (((data[name]||{}).orders||{})[m])||{};
          const arr = Object.values(ord).filter(e=> tb? (e.topBottom||'')===tb : true);
          return acc + arr.reduce((s,e)=> s+(Number(e.qty)||0),0);
        },0);
      };
      const sumOrdersByMonth = (name, month, tb='')=>{
        const ord = (((data[name]||{}).orders||{})[month])||{};
        const arr = Object.values(ord).filter(e=> tb? (e.topBottom||'')===tb : true);
        return arr.reduce((s,e)=> s+(Number(e.qty)||0),0);
      };

      const sumRows=[];
      SHEET_PRIORITY.forEach(n=>{ const o=sumOrdersAcross(n); if(o>0) sumRows.push({label:n, qty:o}); });
      const pushPtSum=(prefix, sizes, alias)=>{
        sizes.forEach(sz=>{
          const nm = makeName(prefix, sz);
          ['상의','하의'].forEach(tb=>{
            const o=sumOrdersAcross(nm, tb); if(o>0) sumRows.push({label:`${alias}${sz}${tb==='상의'?'상의':'하의'}`, qty:o});
          });
        });
      };
      pushPtSum('일반환의', NORMAL_SIZES, '일반');
      pushPtSum('정형환의', ORTHO_SIZES, '정형');
      HIP_SIZES.forEach(sz=>{
        const nm=makeName('고관절', sz);
        const o=sumOrdersAcross(nm); if(o>0) sumRows.push({label:`고관절${sz}`, qty:o});
      });

      const buildMonthlyBlocks = ()=>{
        return months.map(m=>{
          const mRows=[];
          SHEET_PRIORITY.forEach(n=>{
            const v = sumOrdersByMonth(n, m);
            if(v>0) mRows.push({label:n, qty:v});
          });
          const pushPtMonth=(prefix, sizes, alias)=>{
            sizes.forEach(sz=>{
              const nm = makeName(prefix, sz);
              ['상의','하의'].forEach(tb=>{
                const v = sumOrdersByMonth(nm, m, tb);
                if(v>0) mRows.push({label:`${alias}${sz}${tb==='상의'?'상의':'하의'}`, qty:v});
              });
            });
          };
          pushPtMonth('일반환의', NORMAL_SIZES, '일반');
          pushPtMonth('정형환의', ORTHO_SIZES, '정형');
          HIP_SIZES.forEach(sz=>{
            const nm = makeName('고관절', sz);
            const v = sumOrdersByMonth(nm, m);
            if(v>0) mRows.push({label:`고관절${sz}`, qty:v});
          });

          if(mRows.length===0) return '';
          return `
            <div class="sec-title">월별 내역 · ${m}</div>
            <div class="table-wrap">
              <table>
                <thead><tr><th style="text-align:left; padding-left:8px;">품목</th><th>발주량</th></tr></thead>
                <tbody>
                  ${mRows.map(r=>`<tr><td style="text-align:left; padding-left:8px;">${r.label}</td><td>${r.qty}</td></tr>`).join('')}
                </tbody>
              </table>
            </div>`;
        }).join('');
      };

      container.innerHTML = `
        <div class="sec-title">발주내역 · 합산</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th style="text-align:left; padding-left:8px;">품목</th><th>발주량</th></tr></thead>
            <tbody>
              ${sumRows.map(r=>`<tr><td style="text-align:left; padding-left:8px;">${r.label}</td><td>${r.qty}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
        ${buildMonthlyBlocks()}
      `;
    }

    /* ───────── 진행률 ───────── */
    async function refreshProgress(){
      if(!state.snapshot) state.snapshot = await getStatusOnce();
      const months = ymRange(state.dateFrom, state.dateTo);
      const data = state.snapshot||{};
      let totO=0, totR=0;
      months.forEach(m=>{
        Object.values(data).forEach(it=>{
          totO += Object.values(((it.orders||{})[m])||{}).reduce((s,e)=> s+(Number(e.qty)||0),0);
          totR += Object.values(((it.receipts||{})[m])||{}).reduce((s,e)=> s+(Number(e.qty)||0),0);
        });
      });
      const p = totO>0 ? Math.round((totR/totO)*100) : (totR>0?100:0);
      const bar = $('#progressBarInner'); bar.style.width = Math.min(100,p)+'%'; bar.textContent = Math.min(100,p)+'%';
      const overTxt = (totR<=totO)? `${p}%` : `-${Math.round((totR-totO)/totO*100)}%`;
      $('#gaugeStats').textContent = `전체 발주수량 ${totO}개 · 전체 입고수량 ${totR}개 — ${overTxt} 입고됨`;
    }

    /* ───────── 엑셀 내보내기(입고 없는 달은 '입고'열 생성 안 함, 완전 무활동 달은 제외) ───────── */
    async function onExportHorizontalExcel(){
      if(!state.snapshot) state.snapshot=await getStatusOnce();
      const all=state.snapshot||{};
      const monthsAll=ymRange(state.dateFrom, state.dateTo);

      // (1) 완전 무활동 달 제거(발주 0 & 입고 0)
      const activeMonths = monthsAll.filter(m=>{
        let has=false;
        for(const it of Object.values(all)){
          const ord=((it.orders||{})[m])||{};
          const rec=((it.receipts||{})[m])||{};
          const so = Object.values(ord).reduce((s,e)=> s+(Number(e.qty)||0),0);
          const sr = Object.values(rec).reduce((s,e)=> s+(Number(e.qty)||0),0);
          if(so>0 || sr>0){ has=true; break; }
        }
        return has;
      });

      const wb=new ExcelJS.Workbook();

      // 품목 행 정의
      const itemsRows = [];
      SHEET_PRIORITY.forEach(n=> itemsRows.push({label:n, key:n, tb:''}));
      [['일반환의', NORMAL_SIZES, '일반'], ['정형환의', ORTHO_SIZES, '정형']].forEach(([prefix, sizes, alias])=>{
        sizes.forEach(sz=>{
          ['상의','하의'].forEach(tb=>{
            const key = makeName(prefix, sz);
            itemsRows.push({label:`${alias}${sz}${tb==='상의'?'상의':'하의'}`, key, tb});
          });
        });
      });
      HIP_SIZES.forEach(sz=> itemsRows.push({label:`고관절${sz}`, key:makeName('고관절', sz), tb:''}));

      // 합계 유틸
      const sumOrdersMonth = (it, m, tb='')=>{
        const node=((it.orders||{})[m])||{};
        return Object.values(node).filter(e=> tb? (e.topBottom||'')===tb : true)
          .reduce((s,e)=> s+(Number(e.qty)||0),0);
      };
      const sumReceiptsMonthDay = (it, m, day, tb='')=>{
        const node=((it.receipts||{})[m])||{};
        return Object.values(node)
          .filter(e=> (tb? (e.topBottom||'')===tb : true) && Number(e.day||1)===day)
          .reduce((s,e)=> s+(Number(e.qty)||0),0);
      };
      const sumRange = (it, tb, kind, monthsList)=>{
        return monthsList.reduce((acc,mm)=>{
          const node=((it[kind]||{})[mm])||{};
          const arr=Object.values(node).filter(e=> tb? (e.topBottom||'')===tb : true);
          return acc+arr.reduce((s,e)=> s+(Number(e.qty)||0),0);
        },0);
      };

      // (2) 월별 '입고 날짜' 존재 여부/목록(있을 때만 입고 열 생성)
      const monthToDays = {};
      const hasRecv = {};
      activeMonths.forEach(m=>{
        const daysSet = new Set();
        itemsRows.forEach(r=>{
          const it = all[r.key]||{};
          const node = ((it.receipts||{})[m])||{};
          Object.values(node).forEach(e=>{
            if((r.tb? (e.topBottom||'')===r.tb : true) && (Number(e.qty)||0)>0){
              daysSet.add(Number(e.day||1));
            }
          });
        });
        const list = Array.from(daysSet).sort((a,b)=>a-b);
        monthToDays[m] = list;
        hasRecv[m] = list.length>0;
      });

      // 시트1: 요약
      const wsSum=wb.addWorksheet('요약');
      wsSum.addRow(['품목','발주량','입고량','진행률']);
      wsSum.columns=[{width:20},{width:12},{width:12},{width:12}];
      itemsRows.forEach(r=>{
        const it=all[r.key]||{};
        const o=sumRange(it,r.tb,'orders',activeMonths);
        const v=sumRange(it,r.tb,'receipts',activeMonths);
        if(o>0 || v>0){
          const pct = (o>0) ? (v<=o? `${Math.round(v/o*100)}%` : `-${Math.round((v-o)/o*100)}%`) : (v>0?'100%':'0%');
          wsSum.addRow([r.label,o,v,pct]);
        }
      });

      // 시트2: 발주월별(가로) — 'YYYY-MM발주' + (입고 있는 달만) 'M월 D일 입고' 열
      const wsOrders=wb.addWorksheet('발주월별(가로)');
      const headers = [];
      activeMonths.forEach(m=>{
        const mm = Number(m.slice(5,7));
        headers.push(`${m}발주`);               // 발주 헤더 가독성↑
        if(hasRecv[m]) monthToDays[m].forEach(d=> headers.push(`${mm}월 ${d}일 입고`));
      });
      wsOrders.addRow(['품목', ...headers]);

      // 열 너비
      const widths = [{width:20}];
      activeMonths.forEach(m=>{
        widths.push({width:12});                // 'YYYY-MM발주'
        if(hasRecv[m]) monthToDays[m].forEach(()=> widths.push({width:13}));
      });
      wsOrders.columns = widths;

      // 행 데이터
      itemsRows.forEach(r=>{
        const it=all[r.key]||{};
        const row = [];
        activeMonths.forEach(m=>{
          row.push(sumOrdersMonth(it,m,r.tb));             // 발주 합계
          if(hasRecv[m]) monthToDays[m].forEach(d=> row.push(sumReceiptsMonthDay(it,m,d,r.tb)));
        });
        if(row.some(v=>v>0)) wsOrders.addRow([r.label, ...row]);
      });

      // 공통 스타일
      [wsSum, wsOrders].forEach(ws=>{
        ws.getRow(1).font={bold:true,color:{argb:'FFFFFFFF'}};
        ws.getRow(1).alignment={vertical:'middle',horizontal:'center'};
        ws.getRow(1).eachCell(cell=>{
          cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF2563EB'}};
          cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
        });
        for(let r=2; r<=ws.rowCount; r++){
          ws.getRow(r).eachCell((c,ci)=>{
            c.alignment={vertical:'middle',horizontal:(ci===1?'left':'center')};
            c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
          });
        }
      });

      const buf=await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), `구매현황_${state.dateFrom}_${state.dateTo}.xlsx`);
    }
  </script>
</body>
</html>