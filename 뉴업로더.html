<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>구매현황 업로더</title>
  <style>
    :root{
      color-scheme: light; --bg:#f4f7fb; --card:#fff; --text:#0f172a; --muted:#5b677a; --border:#e6eaf2; --accent:#2563eb;
      --r:14px; --shadow:0 10px 30px rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Apple SD Gothic Neo,sans-serif}
    .wrap{max-width:980px;margin:16px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:24px}
    h1{margin:0 0 8px;font-size:20px}
    label{display:block;margin:12px 0 6px;color:#334155;font-weight:800;font-size:14px;}
    .btn{
        display:flex; align-items:center; justify-content:center;
        width:100%; height:48px; margin-top:16px;
        padding:10px 16px;border:none;border-radius:12px;
        background:linear-gradient(180deg,#4f83ff,#2563eb);
        color:#fff;font-weight:900;font-size:16px;cursor:pointer;
    }
    .btn:disabled{background: #a5b4fc; cursor:not-allowed}
    .log{font-family:ui-monospace,Consolas,monospace;background:#0b1220;color:#bfe0ff;padding:12px;border-radius:10px;white-space:pre-wrap;min-height:160px;font-size:12px; line-height: 1.6;}
    table{border-collapse:collapse;width:100%;margin-top:8px}
    th,td{border:1px solid var(--border);padding:6px 8px;font-size:12px; text-align:center;}
    th{background:#f1f5fb}
    .ok{color:#16a34a} .warn{color:#f59e0b} .err{color:#ef4444}
    #preview {
        overflow-x: auto; -webkit-overflow-scrolling: touch;
        border: 1px solid var(--border); border-radius: 8px; margin-top: 8px;
    }
    #preview table { margin-top: 0; border: none; width: auto; min-width: 100%; }
    #file-upload-area {
        margin-top: 16px;
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
    }
    #file-upload-area:hover, #file-upload-area.dragover {
        background-color: #f8fafc;
        border-color: var(--accent);
    }
    #file-upload-area .upload-icon {
        width: 40px; height: 40px;
        color: var(--accent);
        margin: 0 auto 12px;
    }
    #file-upload-area .upload-text {
        font-weight: 600;
        color: var(--muted);
    }
    #file-upload-area .file-name {
        margin-top: 8px;
        font-weight: 800;
        color: var(--accent);
        font-size: 14px;
    }
    input[type="file"] { display: none; }
    @media (max-width: 640px) {
        .wrap { margin: 0; padding: 0; }
        .card { border-radius: 0; border-left:0; border-right:0; padding: 18px; }
        h1 { font-size: 18px; }
        p { font-size: 14px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>구매현황 엑셀 업로더</h1>
    <p style="margin:0 0 10px;color:#475569">'구매현황' 앱에서 내려받은 엑셀(.xlsx)을 업로드하세요.</p>

    <input type="file" id="filePick" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
    <label for="filePick" id="file-upload-area">
        <div class="upload-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        </div>
        <div class="upload-text">파일을 선택하거나 여기에 드래그하세요</div>
        <div class="file-name" id="fileName"></div>
    </label>
    <button id="runBtn" class="btn" disabled>업로드 시작</button>
    <label style="margin-top:16px">진행 로그</label>
    <div id="log" class="log"></div>
    <div id="sheetArea" style="margin-top:16px;display:none">
      <label>시트 미리보기</label>
      <select id="sheetSel"></select>
      <div id="preview"></div>
    </div>
  </div>
</div>

<script>
/* ○○○○ 기본 DOM 헬퍼 시작 ○○○○ */
const $ = s => document.querySelector(s);
const logEl = $("#log");
const log = (m, cls = '') => {
  console[cls === 'err' ? 'error' : 'log'](m);
  const span = document.createElement('span');
  span.className = cls;
  span.textContent = m + '\n';
  logEl.appendChild(span);
  logEl.scrollTop = logEl.scrollHeight;
};
/* ○○○○ 기본 DOM 헬퍼 종료 ○○○○ */

let workbook = null, sheetNames = [];

const fileInput = $("#filePick");
const uploadArea = $("#file-upload-area");

const handleFileSelect = (file) => {
    if (!file) return;
    $("#fileName").textContent = file.name;
    logEl.textContent = "";
    try {
        const reader = new FileReader();
        reader.onload = (e) => {
            workbook = XLSX.read(e.target.result, { type: 'array' });
            sheetNames = workbook.SheetNames || [];
            if (!sheetNames.length) { log("시트를 찾을 수 없습니다.", 'err'); return; }
            const sel = $("#sheetSel");
            sel.innerHTML = sheetNames.map(n => `<option value="${n}">${n}</option>`).join("");
            $("#sheetArea").style.display = "block";
            renderPreview(sel.value);
            log(`엑셀 로드 성공: 시트 ${sheetNames.length}개`);
            updateButtonState();
        };
        reader.readAsArrayBuffer(file);
    } catch (err) { log(`엑셀 파싱 실패: ${err.message}`, 'err'); }
}

function updateButtonState() {
    $("#runBtn").disabled = !workbook;
}

fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
$("#sheetSel").addEventListener('change', () => renderPreview($("#sheetSel").value));
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelect(e.dataTransfer.files[0]);
    }
});

function renderPreview(name) {
  if (!workbook) return;
  const ws = workbook.Sheets[name];
  const rows2d = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
  let html = `<table>`;
  rows2d.slice(0, 20).forEach((row, i) => { html += `<tr>${row.map(cell => `<${i===0?'th':'td'}>${String(cell)}</${i===0?'th':'td'}>`).join("")}</tr>`; });
  $("#preview").innerHTML = html + `</table>`;
}

function mapLabelToApp(label) {
    const s = String(label || '').trim();
    if (s === '종합') return null;
    const sheetItems = ["대시트","반시트","베갯잇","수건","중환의","얼음포","억제대","고관절XL","고관절L","고관절M"];
    if (sheetItems.includes(s)) return { item: s, topBottom: '' };
    const match = s.match(/^(일반|정형)(상의|하의)의?(4XL|3XL|2XL|XL|L|M|S)$/);
    if (match) {
        const [_, kind, tb, size] = match;
        const prefix = kind === '일반' ? '일반환의' : '정형환의';
        return { item: `${prefix}${size}`, topBottom: tb };
    }
    return null;
}

function buildRecordsFromSheet(ws, sheetName, year) {
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
    if (rows.length < 2) return { records: [], months: new Set(), items: new Set(), year };
    const header = rows[0].map(h => String(h || '').trim());
    const dataRows = rows.slice(1);
    const records = [], monthsInSheet = new Set(), itemsInSheet = new Set();
    const isMonthlyOrders = sheetName.includes('발주월별');
    const isDailyReceipts = sheetName.includes('입고_날짜별');

    const carryOverColIndex = header.findIndex(h => h.includes('이월'));
    const hasCarryOver = carryOverColIndex !== -1;

    for (const row of dataRows) {
        const mapped = mapLabelToApp(row[0]);
        if (!mapped) continue;
        const { item, topBottom } = mapped;
        itemsInSheet.add(item);

        if (isMonthlyOrders && hasCarryOver) {
            const carryOverQty = Number(row[carryOverColIndex]);
            if (carryOverQty > 0) {
                const yearMatch = sheetName.match(/(\d{2})년/);
                const currentYear = yearMatch ? `20${yearMatch[1]}` : new Date().getFullYear();
                const monthKey = `${currentYear}-01`;
                monthsInSheet.add(monthKey);
                records.push({ item, topBottom, qty: carryOverQty, section: 'orders', monthKey, note: `${currentYear - 1}년 이월분` });
            }
        }

        for (let c = 1; c < header.length; c++) {
            if (hasCarryOver && c === carryOverColIndex) continue;
            const qty = Number(row[c]);
            if (!qty || qty <= 0) continue;

            let recordData = null;
            if (isMonthlyOrders) {
                const match = header[c].match(/^(\d{2})년\s*(\d{1,2})월$/);
                if (match) {
                    year = `20${match[1]}`;
                    const monthKey = `${year}-${String(match[2]).padStart(2, '0')}`;
                    monthsInSheet.add(monthKey);
                    recordData = { section: 'orders', monthKey };
                }
            } else if (isDailyReceipts) {
                const match = header[c].match(/^(\d{1,2})월\s*(\d{1,2})일$/);
                if (match && year) {
                    const monthKey = `${year}-${String(match[1]).padStart(2, '0')}`;
                    monthsInSheet.add(monthKey);
                    recordData = { section: 'receipts', monthKey, day: Number(match[2]) };
                }
            }
            if (recordData) records.push({ item, topBottom, qty, ...recordData });
        }
    }
    return { records, months: monthsInSheet, items: itemsInSheet, year };
}

async function deleteAndUpload(section, sheetName, year) {
    if (!sheetName) {
        log(`[${section.toUpperCase()}] 관련 시트(${section === 'orders' ? '발주월별' : '입고_날짜별'})를 찾을 수 없어 건너뜁니다.`, 'warn');
        return year;
    }

    log(`[시작] '${sheetName}' 시트 처리 중...`);
    const ws = workbook.Sheets[sheetName];
    const result = buildRecordsFromSheet(ws, sheetName, year);

    if (result.records.length === 0) {
        log(`> '${sheetName}' 시트에서 처리할 데이터가 없습니다.`, 'warn');
        return result.year || year;
    }

    log(`> '${sheetName}' 시트에서 ${result.records.length}개 데이터 발견. (기준 연도: ${result.year})`);

    log(`> 새 데이터 추가 중...`);
    const addUpdates = {};
    for (const r of result.records) {
        const key = `${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
        const path = `purchase_status/${r.item}/${r.section}/${r.monthKey}/${key}`;
        const data = r.section === 'orders'
          ? { qty: r.qty, topBottom: r.topBottom, ts: r.ts || Date.now(), note: r.note || '' }
          : { qty: r.qty, topBottom: r.topBottom, day: r.day };
        addUpdates[path] = data;
    }

    try {
        const addRes = await fetch('https://updatepurchasedata-t7cbh6uw5a-uc.a.run.app', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ updates: addUpdates })
        });
        if (!addRes.ok) throw new Error(`데이터 업로드 실패 ${addRes.status}`);
        log(`> '${sheetName}' 데이터 처리 완료.`, 'ok');
    } catch (error) {
        throw new Error(`데이터 업로드 중 오류: ${error.message}`);
    }

    return result.year || year;
}

$("#runBtn").addEventListener('click', async () => {
  if (!workbook) { 
    log("엑셀 파일을 먼저 선택하세요.", 'err'); 
    return; 
  }

  $("#runBtn").disabled = true;
  logEl.textContent = "";

  try {
    let year = new Date().getFullYear().toString();
    const orderSheetName = sheetNames.find(name => name.includes('발주월별(선택월)'));
    const receiptSheetName = sheetNames.find(name => name.includes('입고_날짜별(전체)'));

    if (orderSheetName) {
      year = await deleteAndUpload('orders', orderSheetName, year);
    } else {
      log("발주월별 시트를 찾을 수 없습니다.", 'warn');
    }

    if (receiptSheetName && year) {
      await deleteAndUpload('receipts', receiptSheetName, year);
    } else if (receiptSheetName && !year) {
      log("연도 정보 없이 입고 데이터를 처리할 수 없습니다.", 'err');
    } else {
      log("입고_날짜별 시트를 찾을 수 없습니다.", 'warn');
    }

    log(`[완료] 모든 데이터 처리 성공`, 'ok');
  } catch (e) {
    log(`[오류] ${e.message}`, 'err');
  } finally {
    $("#runBtn").disabled = false;
  }
});
</script>
</body>
</html>
