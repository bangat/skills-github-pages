<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>출근부 · 관리자</title>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
    --r-lg:16px; --shadow-1:0 4px 16px rgba(15,23,42,.08);
    --focus:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);
  }
  *{box-sizing:border-box}
  html,body{-webkit-text-size-adjust:100%; overflow-x:hidden;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;}
  .wrap{max-width:980px;margin:10px auto;padding:10px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-1)}

  /* 상단 탭: 3개 동일폭 */
  .topTabs{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:8px;
    margin:0 0 10px 0;
    padding:0 2px;
  }
  .topTabs a{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    height:40px;padding:0 14px;border:1px solid var(--border);border-radius:12px;
    background:#fff;color:#0f172a;text-decoration:none;font-weight:800;font-size:15px;
    white-space:nowrap;min-width:0;overflow:hidden;text-overflow:ellipsis;
  }
  .topTabs a .icon{ width:1em;height:1em;stroke-width:2.5;vertical-align:-0.15em; stroke:var(--accent); }
  .topTabs a[aria-current="page"]{ background:var(--accent); color:#fff; border-color:var(--accent); pointer-events:none; }
  .topTabs a[aria-current="page"] .icon{ stroke:#fff; }
  .topTabs a:active{ transform:translateY(1px); }

  .card-head{padding:12px;display:grid;gap:10px}
  .title{font-size:20px;font-weight:800}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"], input[type="month"], input[type="email"], select{
    border:1px solid var(--border);border-radius:12px;padding:0 12px;height:42px;font-size:15px;background:#fff;outline:none;min-width:0;width:100%;
  }
  input:focus, select:focus{box-shadow:var(--focus);border-color:transparent}
  .btn{
    border:1px solid var(--border);background:#fff;border-radius:12px;
    padding:0 12px;height:42px;font-weight:700;cursor:pointer;font-size:15px;
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
  }
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn:active{transform:translateY(1px)}
  .icon{ width:1em;height:1em;stroke-width:2.5;vertical-align:-0.15em; }
  .table-wrap{border-radius:12px;border:1px solid var(--border);margin:8px 12px;overflow:hidden}
  table{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);font-size:12.5px;height:32px}
  td,th{border-bottom:1px solid var(--border);padding:6px;text-align:center;font-size:12.5px;white-space:nowrap}
  tbody tr:hover{background:#f7fbff}
  .date-col{width:36px;font-weight:700}
  .name-col{width:50px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .time-col{width:60px}
  .note-col{width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sun{color:#ef4444}
  .sat{color:#2563eb}
  .app-hide{display:none}
  .card-foot{display:none}
  .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:12px;z-index:100;background:rgba(15,23,42,.5)}
  .modal{width:min(560px, 94vw);background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(15,23,42,.12);overflow:hidden}
  .modal-hd{padding:14px 18px;border-bottom:1px solid var(--border);font-weight:800;font-size:18px}
  .modal-bd{padding:16px 18px;display:grid;gap:12px}
  .modal-ft{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
  .row-inline{display:grid;grid-template-columns:98px 1fr;gap:10px;align-items:center}
  .row-inline .wfit{width:140px}
  .hidden{display:none!important}
  @media (max-width: 480px){
    .modal{width:96vw;border-radius:16px}
    .modal-bd{gap:10px}
    .row-inline{grid-template-columns:1fr;gap:6px}
    .row-inline .wfit{width:100%}
    input[type="text"], input[type="month"], input[type="email"], select, input[type="time"]{
      height:48px;font-size:16px
    }
    .modal-ft{position:sticky;bottom:0;background:#fff}
  }
  #toast{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:#16a34a;color:#fff;padding:10px 14px;border-radius:12px;
    box-shadow:var(--shadow-1);display:none;z-index:250;font-weight:700
  }
  #emailBackdrop.kb-safe{ align-items:flex-end; padding-bottom:calc(env(safe-area-inset-bottom,0px) + 8px); }
  #emailBackdrop.kb-safe .modal{ width:100%; max-width:640px; border-radius:14px 14px 0 0; }

  /* ── 공지 모달: 서브탭 + 내역 테이블/토글 ───────────────── */
  .subTabs{ display:flex; gap:6px; }
  .subTabs button{
    flex:0 0 auto; height:36px; padding:0 12px; border-radius:10px; border:1px solid var(--border);
    background:#fff; font-weight:700; cursor:pointer;
  }
  .subTabs button.active{ background:var(--accent); color:#fff; border-color:var(--accent); }

  .nh-modal{ width:min(860px,96vw); }
  .nh-bd{ padding:0; }
  .nh-table{ max-height:min(62vh,540px); overflow:auto; border-top:1px solid var(--border); border-bottom:1px solid var(--border); }
  .nh-table table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; font-size:13.5px; }
  .nh-table thead th{ position:sticky; top:0; background:#f8fafc; z-index:1; height:36px; padding:8px 10px; text-align:left; color:#334155; border-bottom:1px solid var(--border); }
  .nh-table tbody td{ height:56px; padding:8px 10px; border-bottom:1px solid var(--border); vertical-align:middle; }
  .nh-table tbody tr:hover{ background:#f7fbff; }
  .nh-table td,.nh-table th{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .nh-title{ font-weight:800; }
  .nh-meta{ color:#6b7280; font-size:12px; margin-top:2px; }
  .nh-badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-weight:700; font-size:12px; }
  .nh-badge.on{ border-color:#dbeafe; background:#eff6ff; color:#1d4ed8; }

  /* 토글 스위치 */
  .switch{ position:relative; width:46px; height:26px; }
  .switch input{ display:none; }
  .slider{
    position:absolute; inset:0; background:#e5e7eb; border-radius:999px; transition:.18s;
    border:1px solid #d1d5db;
  }
  .slider::before{
    content:""; position:absolute; left:2px; top:2px; width:20px; height:20px; background:#fff; border-radius:50%;
    box-shadow:0 1px 2px rgba(0,0,0,.15); transition:.18s;
  }
  .switch input:checked + .slider{ background:#3b82f6; border-color:#3b82f6; }
  .switch input:checked + .slider::before{ transform:translateX(20px); }

  @media (max-width:560px){
    .nh-table thead th:nth-child(2){ width:74px }
    .nh-table thead th:nth-child(3){ width:120px }
  }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
      authDomain: "hallymlinen.firebaseapp.com",
      databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
      projectId: "hallymlinen",
      storageBucket: "hallymlinen.appspot.com",
      messagingSenderId: "867775830688",
      appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
      measurementId: "G-T02ZFK18L3"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    signInAnonymously(auth).catch((e)=> console.error("Anonymous sign-in failed:", e));

    const pad2 = n => String(n).padStart(2,'0');
    const ymKey = (y,m)=>`${y}-${pad2(m)}`;
    const nameKey = s => (String(s||'').trim().replace(/[.#$\[\]/]/g,'_') || 'NONAME');

    async function saveDayToFirebase({y,m,day,name,inT,outT,note,leave,ot}){
      const token = localStorage.getItem('adminToken');
      if (!token) return alert("인증 토큰이 없습니다. 다시 로그인해주세요.");
      const url = 'https://us-central1-hallymlinen.cloudfunctions.net/saveAttendanceData';
      const path = `/attendance/${ymKey(y,m)}/${nameKey(name)}/${pad2(day)}`;
      const payload = { y, m, day, name: String(name||'').trim(), in: String(inT||''), out: String(outT||''), note: String(note||''), leave: String(leave||''), ot: String(ot||'') };
      const res = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify({path,payload}) });
      if(!res.ok) throw new Error(`Server error: ${res.status}`);
    }

    async function loadMonthFromFirebase(y,m,name){
      const token = localStorage.getItem('adminToken');
      if (!token) { alert("인증 토큰이 없습니다. 다시 로그인해주세요."); window.location.href='./index.html'; return {}; }
      const url = new URL('https://us-central1-hallymlinen.cloudfunctions.net/getAttendanceData');
      url.searchParams.append('year', y); url.searchParams.append('month', m); url.searchParams.append('name', name);
      const res = await fetch(url,{ headers:{'Authorization':`Bearer ${token}`}});
      if(!res.ok){ if(res.status===403){ localStorage.removeItem('adminToken'); window.location.href='./index.html'; } throw new Error(`Server error: ${res.status}`); }
      return await res.json();
    }

    function applyMonthDataToTable(y,m,data){
      const rows = Array.from(document.querySelectorAll('#tbody tr'));
      rows.forEach((tr, i)=>{
        const day = i+1;
        const rec = data[pad2(day)];
        if(!rec) return;
        const [ , , inCell, outCell, , noteCell] = tr.children;
        if (rec.in)  inCell.textContent  = rec.in;
        if (rec.out) outCell.textContent = rec.out;
        const hlabel = (typeof window.dynamicHolidayLabel === 'function') ? window.dynamicHolidayLabel(y,m,day) : '';
        const merged = (typeof window.addLabelOnce === 'function') ? window.addLabelOnce(String(rec.note||''), hlabel) : (String(rec.note||'') + (hlabel ? ` / ${hlabel}` : ''));
        noteCell.textContent = merged;
      });
    }

    window.saveDayToFirebase = saveDayToFirebase;
    window.loadMonthFromFirebase = loadMonthFromFirebase;
    window.applyMonthDataToTable = applyMonthDataToTable;
  </script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, push, update, get, query, orderByChild, limitToLast, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
      authDomain: "hallymlinen.firebaseapp.com",
      databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
      projectId: "hallymlinen",
      storageBucket: "hallymlinen.appspot.com",
      messagingSenderId: "867775830688",
      appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
      measurementId: "G-T02ZFK18L3"
    };
    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    if (!auth.currentUser) signInAnonymously(auth).catch(e=>console.error('notice auth fail:', e));

    const rtdb = getDatabase(app);
    window.__noticeRTDB = { rtdb, ref, push, update, get, query, orderByChild, limitToLast, remove };
  </script>
</head>

<body>
  <div class="wrap">
    <nav class="topTabs" aria-label="상단 탭">
      <a href="#" aria-current="page"><i class="icon" data-feather="calendar"></i>출근부</a>
      <a href="./구매현황.html"><i class="icon" data-feather="bar-chart-2"></i>구매관리</a>
      <a href="#" id="openNoticeAdmin"><i class="icon" data-feather="megaphone"></i>공지관리</a>
    </nav>

    <div class="card">
      <div class="card-head">
        <div class="title">출근부</div>
        <div class="grid-2">
          <input id="nameInput" type="text" placeholder="이름" />
          <input id="monthInput" type="month" />
        </div>
        <div class="grid-btns">
          <button id="genBtn" class="btn primary"><i class="icon" data-feather="download-cloud"></i>출근표 불러오기</button>
          <button id="clearBtn" class="btn"><i class="icon" data-feather="trash-2"></i>초기화</button>
        </div>
        <div class="grid-btns">
          <button id="xlsxBtn" class="btn"><i class="icon" data-feather="file-text"></i>엑셀로 내려받기</button>
          <button id="emailBtn" class="btn"><i class="icon" data-feather="send"></i>메일로 전송</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="date-col">날짜</th>
              <th class="name-col">이름</th>
              <th class="time-col">출근</th>
              <th class="time-col">퇴근</th>
              <th class="app-hide">본인서명</th>
              <th class="note-col">비고</th>
              <th class="app-hide">담당자확인</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="editBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modal-hd" id="editTitle">근무 상태 편집</div>
      <div class="modal-bd">
        <div class="row-inline"><label>대상 날짜</label><input id="editDate" type="text" readonly /></div>
        <div class="row-inline">
          <label>휴가 사용</label>
          <select id="leaveSel">
            <option value="">선택 안 함</option><option value="annual">연차</option><option value="half">반차</option><option value="family">조가</option>
          </select>
        </div>
        <div class="row-inline">
          <label>시간 조정</label>
          <div class="row" style="gap:10px">
            <input id="timeIn"  type="text" inputmode="numeric" pattern="\\d{2}:\\d{2}" placeholder="예: 06:00" class="wfit" />
            <span>~</span>
            <input id="timeOut" type="text" inputmode="numeric" pattern="\\d{2}:\\d{2}" placeholder="예: 15:30" class="wfit" />
          </div>
        </div>
        <div class="row-inline">
          <label>휴무</label>
          <div class="row" style="gap:10px">
            <label style="display:flex;align-items:center;gap:8px"><input id="dayOffCheck" type="checkbox" /><span>휴무로 표시</span></label>
          </div>
        </div>
        <div class="row-inline"><label>비고</label><input id="editNote" type="text" placeholder="엑셀 비고란에 들어갑니다" /></div>
      </div>
      <div class="modal-ft">
        <button class="btn" id="editCancel"><i class="icon" data-feather="x"></i>닫기</button>
        <button class="btn primary" id="editApply"><i class="icon" data-feather="check-circle"></i>적용</button>
      </div>
    </div>
  </div>

  <div id="emailBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="emailTitle" style="width:min(420px,92vw)">
      <div class="modal-hd" id="emailTitle">메일로 전송</div>
      <div class="modal-bd">
        <div class="row-inline"><label>받는 메일</label><input id="emailTo" type="email" placeholder="example@domain.com" /></div>
      </div>
      <div class="modal-ft"><button class="btn" id="emailCancel"><i class="icon" data-feather="x"></i>취소</button><button class="btn primary" id="emailSend"><i class="icon" data-feather="send"></i>전송</button></div>
    </div>
  </div>

  <div id="bootSpinner" class="modal-backdrop" style="z-index:190; background:rgba(255,255,255,0.7); display:none">
    <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
      <div class="spinner" style="width:44px;height:44px;border:5px solid #ccc;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite"></div>
      <div style="font-weight:600;color:#2563eb">데이터 불러오는중...</div>
    </div>
  </div>
  <div id="loadingSpinner" class="modal-backdrop" style="z-index:200; background:rgba(255,255,255,0.7)">
    <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
      <div class="spinner" style="width:48px;height:48px;border:5px solid #ccc;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite"></div>
      <div style="font-weight:600;color:#2563eb">메일 전송중...</div>
    </div>
  </div>
  <style>@keyframes spin { from { transform:rotate(0deg);} to { transform:rotate(360deg);} }</style>
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){ if(window.feather && typeof feather.replace==='function'){ feather.replace({width:'1em',height:'1em'}); }})();
  </script>

  <input id="naId" type="hidden" />
  <div id="noticeAdminModal" class="modal-backdrop" style="display:none; z-index:99999;">
    <div class="modal nh-modal" role="dialog" aria-modal="true" aria-labelledby="noticeAdminTitle">
      <div class="modal-hd" id="noticeAdminTitle">공지관리</div>
      <div class="modal-bd" style="gap:14px">
        <div class="subTabs" role="tablist">
          <button id="tabCompose" class="active" data-tab="compose">작성</button>
          <button id="tabHistory" data-tab="history">내역</button>
        </div>

        <section id="paneCompose">
          <div class="row-inline" style="gap:10px;">
            <label style="min-width:72px; font-weight:800;">대상</label>
            <select id="naWard" style="flex:1;">
              <option value="전체" selected>전체 공지</option>
              <option>93</option><option>83</option><option>73</option><option>71</option>
              <option>63</option><option>62</option><option>61</option>
              <option>52</option><option>51</option><option>42</option><option>41</option>
              <option>기타</option>
            </select>
          </div>
          <div class="row" style="margin-top:8px;">
            <label style="font-weight:800;">제목</label>
            <input id="naTitle" type="text" placeholder="예) 오늘(9/11) 수거 지연 안내" style="width:100%;">
          </div>
          <div class="row" style="margin-top:8px;">
            <label style="font-weight:800;">내용</label>
            <textarea id="naBody" rows="5" placeholder="공지 내용을 입력하세요." style="width:100%;"></textarea>
          </div>
          <div class="row-inline" style="gap:10px; margin-top:8px;">
            <label style="min-width:72px; font-weight:800;">유효기간</label>
            <input id="naFrom" type="date" style="flex:1;"><span aria-hidden="true">~</span><input id="naTo" type="date" style="flex:1;">
          </div>
          <div class="row-inline" style="gap:10px; margin-top:8px;">
            <label style="min-width:72px; font-weight:800;">상태</label>
            <select id="naActive" style="flex:1;"><option value="1" selected>활성</option><option value="0">비활성</option></select>
          </div>
        </section>

        <section id="paneHistory" class="hidden">
          <div class="nh-table">
            <table>
              <colgroup>
                <col />               <col style="width:90px" />  <col style="width:160px" /> </colgroup>
              <thead>
                <tr><th>제목</th><th>대상</th><th>상태</th></tr>
              </thead>
              <tbody id="nhBody"></tbody>
            </table>
          </div>
        </section>
      </div>
      <div class="modal-ft" style="display:flex; gap:8px; padding:12px;">
        <button type="button" class="btn" id="naCancel">닫기</button>
        <button type="button" class="btn primary" id="naSave">저장</button>
      </div>
    </div>
  </div>

  <script>
    const pad2 = n => String(n).padStart(2,'0');
    const DEFAULT_IN  = '06 : 00';
    const DEFAULT_OUT = '15 : 30';
    const qs  = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    const nameInput  = qs('#nameInput');
    const monthInput = qs('#monthInput');
    const genBtn     = qs('#genBtn');
    const clearBtn   = qs('#clearBtn');
    const xlsxBtn    = qs('#xlsxBtn');
    const emailBtn   = qs('#emailBtn');
    const tbody      = qs('#tbody');

    const LS_KEY_LAST_NAME = 'att:lastName';
    function setLastNameCache(v){ try{ localStorage.setItem(LS_KEY_LAST_NAME, String(v||'').trim()); }catch(_e){} }
    function getLastNameCache(){ try{ return localStorage.getItem(LS_KEY_LAST_NAME) || ''; }catch(_e){ return ''; } }
    nameInput.addEventListener('change', ()=> setLastNameCache(nameInput.value));
    nameInput.addEventListener('blur',   ()=> setLastNameCache(nameInput.value));
    genBtn.addEventListener('click',     ()=> setLastNameCache(nameInput.value));

    const LS_KEY_LAST_EMAIL = 'att:lastEmail';
    function setLastEmailCache(v){ try{ localStorage.setItem(LS_KEY_LAST_EMAIL, String(v||'').trim()); }catch(_e){} }
    function getLastEmailCache(){ try{ return localStorage.getItem(LS_KEY_LAST_EMAIL) || ''; }catch(_e){ return ''; } }

    const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxLS7c2bcl50k5LMOqC8Axx7PUZN-h5mN-MuNQddNcjc9P2BhWPxmaSPAWWbzhDRK8/exec';
    function showBootSpinner(){ const el = document.getElementById('bootSpinner'); if (el) el.style.display = 'flex'; }
    function hideBootSpinner(){ const el = document.getElementById('bootSpinner'); if (el) el.style.display = 'none'; }
    fetch(GAS_WEBAPP_URL, { method: 'POST', headers: {'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({ ping: true }) }).catch(()=>{});

    const HOLIDAY_MAP = new Map();
    function normalizeHolidayName(s){ if(!s) return ''; s = String(s).replace(/\s+/g, ' ').trim(); s = s.replace(/^쉬는 날\s*/i, ''); s = s.replace(/^\(대체\)\s*/i, ''); s = s.replace(/대체공휴일(?:\s*\(.+?\))?/g, '대체공휴일'); return s; }
    function consolidateNames(arr){ const uniq = Array.from(new Set(arr.map(normalizeHolidayName).filter(Boolean))); uniq.sort((a,b)=>b.length-a.length); const kept = []; uniq.forEach(n=>{ if(!kept.some(k=>k.includes(n) && k!==n)) kept.push(n); }); return kept.join(' / '); }
    async function loadHolidays(year){ try{ const url = `${GAS_WEBAPP_URL}?fn=holidays&year=${year}`; const res = await fetch(url, { method:'GET' }); const json = await res.json(); if(json.ok && Array.isArray(json.items)){ HOLIDAY_MAP.clear(); const bucket = new Map(); json.items.forEach(({date,name})=>{ const arr = bucket.get(date) || []; arr.push(name); bucket.set(date, arr); }); bucket.forEach((names, date)=>{ HOLIDAY_MAP.set(date, consolidateNames(names)); }); (function applyAltForLunarHolidays(){ const entries = Array.from(HOLIDAY_MAP.entries()).filter(([_, name]) => /추석|설날/.test(name)); if (!entries.length) return; entries.sort((a,b)=> a[0] < b[0] ? -1 : a[0] > b[0] ? 1 : 0); const clusters = []; let curr = []; const toDate = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }; const isNextDay = (a,b)=> { const da = toDate(a), db = toDate(b); return (db - da) === 24*60*60*1000; }; entries.forEach(([dateStr, name], i)=>{ if (i===0) { curr.push([dateStr, name]); return; } const prev = entries[i-1][0]; if (isNextDay(prev, dateStr)) curr.push([dateStr, name]); else { clusters.push(curr); curr = [[dateStr, name]]; } }); if (curr.length) clusters.push(curr); clusters.forEach(cluster=>{ const hasSunday = cluster.some(([dateStr])=> new Date(dateStr).getDay() === 0); if (hasSunday) { const [lastDate] = cluster[cluster.length - 1]; HOLIDAY_MAP.set(lastDate, '대체공휴일'); } }); })(); try{ const [currY, currM] = (monthInput.value||'').split('-').map(Number); if (currY === year) { qsa('#tbody tr').forEach((tr, idx)=>{ const day = idx+1; const [dateCell, , , , , noteCell] = tr.children; const hlabel = dynamicHolidayLabel(currY, currM, day); if (hlabel) { noteCell.textContent = addLabelOnce(noteCell.textContent, hlabel); dateCell.classList.add('sun'); } }); } }catch(_e){} } }catch(e){ console.warn('공휴일 로드 실패:', e); } }
    function dynamicHolidayLabel(y, m, d){ const key = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; if(HOLIDAY_MAP.has(key)) return HOLIDAY_MAP.get(key); const md = `${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const fixed = {'01-01':'신정','03-01':'삼일절','05-05':'어린이날','06-06':'현충일','08-15':'광복절','10-03':'개천절','10-09':'한글날','12-25':'성탄절'}; return fixed[md] || ''; }

    (function initMonth(){ const d=new Date(); monthInput.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; })();
    const addLabelOnce = (note, label) => !label ? (note||'') : !note ? label : (note.includes(label) ? note : `${note} / ${label}`);

    function buildTable(ym, name){
      tbody.innerHTML='';
      if(!ym){ alert('월을 선택하세요.'); return; }
      const [y,m] = ym.split('-').map(Number);
      const lastDay = new Date(y, m, 0).getDate();
      for(let day=1; day<=lastDay; day++){
        const dt = new Date(y, m-1, day);
        const dow = dt.getDay();
        const isSun=dow===0, isSat=dow===6;
        const tr = document.createElement('tr');
        const dateCell = document.createElement('td'); dateCell.className = 'date-col ' + (isSun?'sun':isSat?'sat':'' ); dateCell.style.textAlign='center'; dateCell.textContent = day;
        const nameCell = document.createElement('td'); nameCell.className='name-col'; nameCell.textContent = name || '';
        const inCell  = document.createElement('td'); inCell.className='time-col';
        const outCell = document.createElement('td'); outCell.className='time-col';
        const signCell = document.createElement('td'); signCell.className='app-hide';
        const noteCell = document.createElement('td'); noteCell.className='note-col';
        const apprCell = document.createElement('td'); apprCell.className='app-hide';
        const hlabel = dynamicHolidayLabel(y,m,day);
        if (isSun) { inCell.textContent  = '휴'; outCell.textContent = '무'; }
        else if (!hlabel) { inCell.textContent  = DEFAULT_IN; outCell.textContent = DEFAULT_OUT; }
        if (hlabel) { noteCell.textContent = addLabelOnce(noteCell.textContent, hlabel); dateCell.classList.add('sun'); }
        tr.addEventListener('click', ()=> openEditModal({y,m,day,dow,isSun,isSat}, tr));
        tr.append(dateCell, nameCell, inCell, outCell, signCell, noteCell, apprCell);
        tbody.appendChild(tr);
      }
    }

    const editBackdrop = qs('#editBackdrop'); const editDate  = qs('#editDate'); const leaveSel  = qs('#leaveSel'); const editNote  = qs('#editNote');
    const timeIn  = qs('#timeIn'); const timeOut = qs('#timeOut');
    function normalizeHHMM(raw){ let s = String(raw||'').trim(); if(!s) return ''; s = s.replace(/[^\d]/g,''); if(s.length===1) s = '0'+s+'00'; else if(s.length===2) s = s + '00'; else if(s.length===3) s = '0' + s; else if(s.length>4) s = s.slice(0,4); const hh = Math.min(parseInt(s.slice(0,2),10)||0, 23); const mm = Math.min(parseInt(s.slice(2,4),10)||0, 59); return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
    const toTimeValue = (s) => { s = String(s||'').trim(); const m = s.match(/(\d{1,2})\s*:\s*(\d{2})/); return m ? `${m[1].padStart(2,'0')}:${m[2]}` : ''; };
    const toCellValue = (s) => { const m = String(s||'').match(/(\d{1,2}):(\d{2})/); return m ? `${m[1].padStart(2,'0')} : ${m[2]}` : ''; };
    function bindTimeAutoFormat(el){ if(!el) return; el.addEventListener('input', ()=>{ const v = el.value.replace(/[^\d]/g,''); if(v.length===0){ el.value=''; return; } if(v.length<=2){ el.value = v; return; } el.value = v.slice(0,2) + ':' + v.slice(2,4); }); el.addEventListener('blur', ()=>{ el.value = normalizeHHMM(el.value); }); }
    bindTimeAutoFormat(timeIn); bindTimeAutoFormat(timeOut);

    const chipsWrap = qs('#timeChips');
    function addMinutesToHHMM(hhmm, addMin){ const m = String(hhmm||'').match(/(\d{1,2}):(\d{2})/); if(!m) return ''; let h = parseInt(m[1],10), mm = parseInt(m[2],10); let total = h*60 + mm + (addMin|0); if (total < 0) total = 0; h = Math.floor(total/60); mm = total%60; return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
    chipsWrap?.addEventListener('click', (e)=>{ const btn = e.target.closest('.chip'); if(!btn) return; if (typeof dayOffCheck !== 'undefined' && dayOffCheck){ dayOffCheck.checked = false; } if (timeIn)  timeIn.disabled = false; if (timeOut) timeOut.disabled = false; if(btn.dataset.set){ const [which, val] = btn.dataset.set.split(':'); if(which==='in' && timeIn) timeIn.value = val; if(which==='out'&& timeOut) timeOut.value = val; }else if(btn.dataset.inc){ const [which, mins] = btn.dataset.inc.split(':'); if(which==='out' && timeOut){ const cur = timeOut.value || '15:30'; timeOut.value = addMinutesToHHMM(cur, parseInt(mins,10)); } } });
    function showToast(msg='저장 완료'){ const t = qs('#toast'); if(!t) return; t.textContent = msg; t.style.display = 'block'; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=> t.style.display='none', 1500); }

    const dayOffCheck = qs('#dayOffCheck');
    function isCellHolidayMark(inVal, outVal){ return inVal === '휴' && outVal === '무'; }
    dayOffCheck?.addEventListener('change', ()=>{ const disabled = dayOffCheck.checked; if (timeIn)  timeIn.disabled  = disabled; if (timeOut) timeOut.disabled = disabled; });

    let currentRow=null, currentMeta=null;
    function openEditModal(meta, tr){
      currentRow = tr; currentMeta=meta;
      const [ , , inCell, outCell, , noteCell] = tr.children;
      editDate.value = `${meta.y}-${pad2(meta.m)}-${pad2(meta.day)}`;
      editNote.value = noteCell.textContent || '';
      const inVal  = (inCell.textContent||'').trim();
      const outVal = (outCell.textContent||'').trim();
      leaveSel.value = (inVal==='연'&&outVal==='차') ? 'annual' : (inVal==='반'&&outVal==='차') ? 'half' : (inVal==='조'&&outVal==='가') ? 'family' : '';
      timeIn.value  = (inVal.match(/(\d{1,2})\s*:\s*(\d{2})/)||[])[0]?.replace(/\s/g,'') || '';
      timeOut.value = (outVal.match(/(\d{1,2})\s*:\s*(\d{2})/)||[])[0]?.replace(/\s/g,'') || '';
      if (dayOffCheck){ dayOffCheck.checked = isCellHolidayMark(inVal, outVal); const disabled = dayOffCheck.checked; if (timeIn)  timeIn.disabled  = disabled; if (timeOut) timeOut.disabled = disabled; }
      editBackdrop.style.display='flex';
    }
    function closeEditModal(){ editBackdrop.style.display='none'; }
    qs('#editCancel').addEventListener('click', closeEditModal);
    qs('#editApply').addEventListener('click', ()=>{
      if(!currentRow) return;
      const [dateCell, , inCell, outCell, , noteCell] = currentRow.children;
      const isSunday = /sun/.test(dateCell.className);
      const [yy,mm2,dd] = editDate.value.split('-').map(Number);
      const isHoliday = !!dynamicHolidayLabel(yy,mm2,dd);
      if(leaveSel.value==='annual'){ inCell.textContent='연'; outCell.textContent='차'; }
      else if(leaveSel.value==='half'){ inCell.textContent='반'; outCell.textContent='차'; }
      else if(leaveSel.value==='family'){ inCell.textContent='조'; outCell.textContent='가'; }
      else{
        if (dayOffCheck && dayOffCheck.checked){ inCell.textContent='휴'; outCell.textContent='무'; }
        else{
          const tIn  = (timeIn?.value||'').trim(); const tOut = (timeOut?.value||'').trim();
          if(tIn || tOut){ inCell.textContent = tIn ? tIn.replace(':',' : ') : ''; outCell.textContent = tOut ? tOut.replace(':',' : ') : ''; }
          else{ if(isHoliday || isSunday){ inCell.textContent=''; outCell.textContent=''; } else { inCell.textContent=DEFAULT_IN; outCell.textContent=DEFAULT_OUT; } }
        }
      }
      const [y,m,day] = editDate.value.split('-').map(Number);
      const hlabel = dynamicHolidayLabel(y,m,day);
      noteCell.textContent = (window.addLabelOnce? window.addLabelOnce((qs('#editNote').value||'').trim(), hlabel) : (qs('#editNote').value||'').trim());
      (async ()=>{
        const nm = (nameInput.value||'').trim();
        await window.saveDayToFirebase({ y, m, day, name:nm, inT:(inCell.textContent||'').trim(), outT:(outCell.textContent||'').trim(), note:(noteCell.textContent||'').trim(), leave:(leaveSel.value||'') });
        showToast('저장 완료');
      })().catch(console.warn);
      closeEditModal();
    });

    async function makeWorkbook(){ const ym = monthInput.value; if(!ym){ alert('월을 선택하세요.'); throw new Error('no-month'); } const [y,m] = ym.split('-').map(Number); const nm = (nameInput.value||'').trim(); const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('출근표', { pageSetup:{ paperSize:9, orientation:'portrait', margins:{left:0,right:0,top:0,bottom:0.1,header:0,footer:0}, horizontalCentered:true, verticalCentered:true, fitToPage:true, fitToWidth:1, fitToHeight:0 } }); const baseFont = {name:'맑은 고딕', size:12}; ws.getColumn(1).width = 6.25; ws.getColumn(2).width = 9.75; ws.getColumn(3).width = 12.88; ws.getColumn(4).width = 12.88; ws.getColumn(5).width = 12.88; ws.getColumn(6).width = 9.75; ws.getColumn(7).width = 5.35; ws.getColumn(8).width = 11; ws.getRow(1).height = 14.25; ws.getRow(2).height = 36.75; ws.getRow(3).height = 29.25; ws.getRow(4).height = 25; ws.mergeCells('G1:G2'); const g1 = ws.getCell('G1'); const g2 = ws.getCell('G2'); g1.value = '결\n재\n란'; g1.font  = {name:'맑은 고딕', size:11, bold:true}; g1.alignment = { vertical:'middle', horizontal:'center', wrapText:true }; g2.alignment = g1.alignment; ['G1','G2'].forEach(a=>{ ws.getCell(a).border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }); const h1 = ws.getCell('H1'); h1.value='팀장'; h1.font={name:'맑은 고딕',size:11}; h1.alignment={vertical:'middle',horizontal:'center'}; const h2 = ws.getCell('H2'); h2.value=''; ['H1','H2'].forEach(a=>{ ws.getCell(a).border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }); ws.mergeCells('A3:H3'); const t = ws.getCell('A3'); t.value = `${y}년 ${m}월 린넨실(직원) 출근표`; t.font  = {name:'맑은 고딕', size:18, bold:true}; t.alignment = {vertical:'middle', horizontal:'center'}; ws.getCell('A4').value='날짜'; ws.getCell('B4').value='이름'; ws.getCell('C4').value='출근시각'; ws.getCell('D4').value='퇴근시각'; ws.getCell('E4').value='본인서명'; ws.getCell('F4').value='비고'; ws.mergeCells('F4:G4'); ws.getCell('H4').value='담당자확인'; ['A4','B4','C4','D4','E4','F4','H4'].forEach(a=>{ const c=ws.getCell(a); c.font={...baseFont, bold:true}; c.alignment={vertical:'middle',horizontal:'center'}; c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF1F5F9'}}; c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }); const lastDay = new Date(y, m, 0).getDate(); const startRow = 5; for(let d=1; d<=lastDay; d++){ const rIdx = startRow + d - 1; const r = ws.getRow(rIdx); r.height = 22; const dateObj = new Date(y, m-1, d); const dow = dateObj.getDay(); const isSun=dow===0, isSat=dow===6; const tr = qsa('#tbody tr')[d-1]; let [ , , inT, outT, , noteText] = tr ? Array.from(tr.children).map(td=> (td.textContent||'').trim()) : [null,null,'','','','']; if(isSun){ inT='휴'; outT='무'; } else{ if(!inT)  inT=DEFAULT_IN; if(!outT) outT=DEFAULT_OUT; } const hlabel = dynamicHolidayLabel(y,m,d); noteText = addLabelOnce(noteText, hlabel); ws.getCell(rIdx,1).value=d; ws.getCell(rIdx,2).value=(nameInput.value||'').trim(); ws.getCell(rIdx,3).value=inT; ws.getCell(rIdx,4).value=outT; ws.getCell(rIdx,5).value=''; ws.getCell(rIdx,6).value=noteText||''; ws.mergeCells(`F${rIdx}:G${rIdx}`); ws.getCell(rIdx,8).value=''; for(let c=1;c<=8;c++){ if(c===7) continue; const cell=ws.getCell(rIdx,c); cell.font=baseFont; cell.alignment={vertical:'middle',horizontal:(c===6?'left':'center')}; cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; } ws.getCell(rIdx,6).alignment = { vertical:'middle', horizontal:'left', wrapText:false }; if(isSat){ ws.getCell(rIdx,1).font={...baseFont,color:{argb:'FF2563EB'}}; } if(isSun || hlabel){ ws.getCell(rIdx,1).font={...baseFont,color:{argb:'FFEF4444'}}; } } ws.eachRow(row=> row.eachCell(cell=>{ cell.font = cell.font || baseFont; })); const fileName = `${y}-${pad2(m)}-출근부.xlsx`; return {wb, fileName}; }

    xlsxBtn.addEventListener('click', async ()=>{ try{ const {wb,fileName} = await makeWorkbook(); const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName); }catch(e){ if(e.message!=='no-month') console.error(e); } });

    const emailBackdrop = qs('#emailBackdrop'); const emailTo = qs('#emailTo'); const emailSend = qs('#emailSend'); const emailCancel = qs('#emailCancel');
    function closeEmailModal(){ emailBackdrop.style.display = 'none'; emailBackdrop.classList.remove('kb-safe'); emailBackdrop.style.paddingBottom = '0px'; }
    emailBtn.addEventListener('click', ()=>{ const cachedEmail = getLastEmailCache(); if (cachedEmail && !String(emailTo.value||'').trim()){ emailTo.value = cachedEmail; } emailBackdrop.style.display='flex'; setTimeout(()=>{ emailTo.focus(); emailBackdrop.classList.add('kb-safe'); emailTo.scrollIntoView({block:'center'}); }, 0); });
    emailCancel.addEventListener('click', closeEmailModal);
    emailTo.addEventListener('focus', ()=>{ emailBackdrop.classList.add('kb-safe'); });
    emailTo.addEventListener('blur', ()=>{ if (emailBackdrop.style.display === 'flex') return; emailBackdrop.classList.remove('kb-safe'); });
    (function(){ const vv = window.visualViewport; if(!vv) return; const onResize = ()=>{ const gap = Math.max(0, window.innerHeight - vv.height); if (gap > 80) emailBackdrop.classList.add('kb-safe'); emailBackdrop.style.paddingBottom = (gap>0 ? (gap + 16) : 0) + 'px'; }; vv.addEventListener('resize', onResize); vv.addEventListener('scroll', onResize); })();
    function blobToDataUrl(blob){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(blob); }); }
    emailSend.addEventListener('click', async ()=>{ const to = (emailTo.value||'').trim(); if(!to){ alert('받는 메일을 입력하세요.'); return; } const spinner = qs('#loadingSpinner'); spinner.style.display = 'flex'; try{ const {wb,fileName} = await makeWorkbook(); const buf = await wb.xlsx.writeBuffer(); const blob = new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); const dataUrl = await blobToDataUrl(blob); const monthTxt = Number(monthInput.value.split('-')[1]); const subject = `한림병원 ${monthTxt}월 출근부 첨부합니다.`; const res = await fetch(GAS_WEBAPP_URL, { method: 'POST', headers: {'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({ to: to, subject: subject, message: '출근부 파일을 첨부합니다.', filename: fileName, attachment: dataUrl }) }); const json = await res.json(); if(!res.ok || !json.ok) throw new Error(json.error || `HTTP ${res.status}`); showToast('메일 전송 성공 ✅'); closeEmailModal(); }catch(err){ console.error(err); alert('메일 전송에 실패했어요. 엑셀 저장 후 메일 앱에서 첨부로 전송해 주세요.'); }finally{ spinner.style.display = 'none'; } });

    genBtn.addEventListener('click', async ()=>{ showBootSpinner(); try{ const [y,mm] = (monthInput.value || '').split('-').map(Number); if (y) await loadHolidays(y); const cached = getLastNameCache(); if (cached && !String(nameInput.value||'').trim()){ nameInput.value = cached; } buildTable(monthInput.value, nameInput.value.trim()); const nm = (nameInput.value||'').trim(); if (y && mm && nm){ const data = await window.loadMonthFromFirebase(y, mm, nm); window.applyMonthDataToTable(y, mm, data); } } finally { hideBootSpinner(); } });
    clearBtn.addEventListener('click', ()=> tbody.innerHTML='');

    (async ()=>{ showBootSpinner(); try{ const cached0 = getLastNameCache(); if (cached0) nameInput.value = cached0; buildTable(monthInput.value, nameInput.value.trim()); const [y,mm] = (monthInput.value || '').split('-').map(Number); if (y) { await loadHolidays(y); qsa('#tbody tr').forEach((tr, idx)=>{ const day = idx+1; const [dateCell, , , , , noteCell] = tr.children; const hlabel = dynamicHolidayLabel(y,mm,day); if(hlabel){ noteCell.textContent = addLabelOnce(noteCell.textContent, hlabel); dateCell.classList.add('sun'); } }); } const nm0 = (nameInput.value||'').trim(); if (y && mm && nm0){ const data0 = await window.loadMonthFromFirebase(y, mm, nm0); window.applyMonthDataToTable(y, mm, data0); } } finally { hideBootSpinner(); } })();
  </script>

  <script>
    const $ = (s)=>document.querySelector(s);

    document.addEventListener('click', (e) => {
      const id = (e.target && e.target.id) || (e.target.closest?.('[id]')?.id) || '';
      if (id === 'openNoticeAdmin'){ e.preventDefault(); switchNoticeTab('compose'); openNoticeAdmin(); }
    });

    // 탭 전환
    function switchNoticeTab(tab){
      const b1 = $('#tabCompose'), b2 = $('#tabHistory');
      const p1 = $('#paneCompose'), p2 = $('#paneHistory');
      if (tab==='history'){ b1.classList.remove('active'); b2.classList.add('active'); p1.classList.add('hidden'); p2.classList.remove('hidden'); loadNoticeHistory().catch(console.error); }
      else { b1.classList.add('active'); b2.classList.remove('active'); p1.classList.remove('hidden'); p2.classList.add('hidden'); }
    }
    $('#tabCompose').onclick = ()=> switchNoticeTab('compose');
    $('#tabHistory').onclick = ()=> switchNoticeTab('history');

    // 공지 작성/수정
    function openNoticeAdmin(editData){
      const m = $('#noticeAdminModal'); if(!m) return;
      const today = new Date().toISOString().slice(0,10);
      $('#naId').value      = editData?.id || '';
      $('#naWard').value    = editData?.ward || '전체';
      $('#naTitle').value   = editData?.title || '';
      $('#naBody').value    = editData?.body || '';
      $('#naFrom').value    = editData?.from || today;
      $('#naTo').value      = editData?.to   || today;
      $('#naActive').value  = (editData?.active ?? true) ? '1' : '0';
      m.style.display = 'block';
    }
    function closeNoticeAdmin(){ const m=$('#noticeAdminModal'); if(m) m.style.display='none'; }
    $('#naCancel').onclick = closeNoticeAdmin;

    $('#naSave').onclick = async () => {
      try{
        const id     = ($('#naId').value || '').trim();
        const ward   = ($('#naWard').value || '전체').trim();
        const title  = ($('#naTitle').value || '').trim();
        const body   = ($('#naBody').value || '').trim();
        const from   = $('#naFrom').value;
        const to     = $('#naTo').value;
        const active = $('#naActive').value === '1';
        if(!title || !body || !from || !to){ alert('대상/제목/내용/유효기간을 모두 입력하세요.'); return; }

        const { rtdb, ref, push, update } = (window.__noticeRTDB || {});
        if(!rtdb){ alert('데이터베이스 연결 실패'); return; }

        const now = Date.now();
        const post = { ward, title, body, from, to, active, ts: now };
        if (id) await update(ref(rtdb, `notices/${id}`), post);
        else { const newRef = await push(ref(rtdb,'notices'), post); await update(newRef, { id:newRef.key }); }

        alert('저장 완료');
        if (!$('#paneHistory').classList.contains('hidden')) await loadNoticeHistory();
      }catch(err){ console.error('notice-save error:', err); alert('공지 저장 중 오류가 발생했습니다.'); }
    };

    // 내역 로딩 + 만료 자동삭제
    async function loadNoticeHistory(){
      const { rtdb, ref, query, orderByChild, limitToLast, get, remove } = (window.__noticeRTDB || {});
      if (!rtdb) { alert('데이터베이스 연결 실패'); return; }
      const q = query(ref(rtdb, 'notices'), orderByChild('ts'), limitToLast(400));
      const snap = await get(q);

      const list = [];
      if (snap.exists()){
        const obj = snap.val();
        for (const k in obj) list.push(obj[k]);
        list.sort((a,b)=> b.ts - a.ts);
      }

      // 만료 삭제
      const todayStr = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      for (const it of list){
        if ((it.to||'') < todayStr && it.id){
          try{ await remove(ref(rtdb, `notices/${it.id}`)); }catch(_e){}
        }
      }
      // 삭제된 것 제외하고 다시 필터
      const filtered = list.filter(it => (it.to||'') >= todayStr);

      renderNoticeHistory(filtered);
    }

    function fmtTs(ts){
      const d = new Date(ts||0); if(!ts || isNaN(d)) return '-';
      const yy = String(d.getFullYear()).slice(2), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const h=String(d.getHours()).padStart(2,'0'), m=String(d.getMinutes()).padStart(2,'0');
      return `${yy}/${mm}/${dd} ${h}:${m}`;
    }

    function renderNoticeHistory(items){
      const tb = $('#nhBody'); tb.innerHTML='';
      items.forEach(it=>{
        const tr = document.createElement('tr');
        // 제목 셀(큰 제목 + 회색 메타)
        const tdTitle = document.createElement('td');
        tdTitle.style.textAlign='left';
        tdTitle.innerHTML = `
          <div class="nh-title">${escapeHtml(it.title||'')}</div>
          <div class="nh-meta">${fmtTs(it.ts)} · ${(it.from||'')} ~ ${(it.to||'')}</div>
        `;

        // 대상
        const tdWard = document.createElement('td');
        tdWard.textContent = it.ward || '전체';
        tdWard.style.textAlign = 'center';

        // 상태(토글 + 삭제)
        const tdState = document.createElement('td');
        tdState.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <label class="switch">
              <input type="checkbox" ${it.active?'checked':''} data-act="toggle" data-id="${it.id||''}">
              <span class="slider"></span>
            </label>
            <button class="btn" data-act="delete" data-id="${it.id||''}" style="height:32px">삭제</button>
          </div>
        `;

        tr.append(tdTitle, tdWard, tdState);
        tb.appendChild(tr);

        // 행 클릭 = 수정
        tr.addEventListener('click', async (e)=>{
          const targetBtn = e.target.closest('[data-act]');
          if (targetBtn) return; // 토글/삭제 클릭은 무시
          openNoticeAdmin(it);
          switchNoticeTab('compose');
        });
      });

      // 토글/삭제 핸들러
      tb.onclick = async (e)=>{
        const el = e.target.closest('[data-act]'); if(!el) return;
        const act = el.dataset.act, id = el.dataset.id;
        const { rtdb, ref, update, remove } = window.__noticeRTDB;

        if (act==='toggle'){
          const checked = e.target.checked;
          await update(ref(rtdb, `notices/${id}`), { active: !!checked });
        } else if (act==='delete'){
          if (!confirm('정말 삭제할까요? 되돌릴 수 없습니다.')) return;
          await remove(ref(rtdb, `notices/${id}`));
          await loadNoticeHistory();
        }
      };
    }

    function escapeHtml(s){
      return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }

    // 공지관리 열기
    function openNoticeAdminModal(){ const m = $('#noticeAdminModal'); if(m) m.style.display='block'; }
    function openNoticeAdmin(editData){ openNoticeAdminModal(); switchNoticeTab('compose');
      const today = new Date().toISOString().slice(0,10);
      $('#naId').value      = editData?.id || '';
      $('#naWard').value    = editData?.ward || '전체';
      $('#naTitle').value   = editData?.title || '';
      $('#naBody').value    = editData?.body || '';
      $('#naFrom').value    = editData?.from || today;
      $('#naTo').value      = editData?.to   || today;
      $('#naActive').value  = (editData?.active ?? true) ? '1' : '0';
    }
  </script>
</body>
</html>
