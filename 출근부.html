<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ï∂úÍ∑ºÎ∂Ä ¬∑ Í¥ÄÎ¶¨Ïûê</title>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <script>
    (async () => {
      const verifyTokenUrl = 'https://us-central1-hallymlinen.cloudfunctions.net/verifyAdminToken';
      const loginPage = './index.html';
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = loginPage;
        return;
      }
      try {
        const response = await fetch(verifyTokenUrl, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) {
          localStorage.removeItem('adminToken');
          window.location.href = loginPage;
        }
      } catch (error) {
        console.error('Token verification error:', error);
        window.location.href = loginPage;
      }
    })();
  </script>

  <!-- ‚ñ∑‚ñ∑‚ñ∑ Ï†ÑÏó≠ Ïä§ÌÉÄÏùº ÏãúÏûë ‚ñ∑‚ñ∑‚ñ∑ -->
  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --accent:#2563eb; --muted:#5b677a; --text:#0f172a; --border:#e6eaf2;
      --r-lg:16px; --shadow-1:0 4px 16px rgba(15,23,42,.08);
      --focus:0 0 0 2px rgba(37,99,235,.22),0 0 0 6px rgba(37,99,235,.1);
    }
    *{box-sizing:border-box}
    html,body{-webkit-text-size-adjust:100%; overflow-x:hidden;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Pretendard,Apple SD Gothic Neo,system-ui,sans-serif;}
    .wrap{max-width:980px;margin:10px auto;padding:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-1)}
    .topTabs{display:flex; gap:8px; margin:0 0 10px 0; padding:0 2px;}
    .topTabs a{
      flex:0 0 auto;
      display:inline-flex; align-items:center; gap:8px;
      height:40px; padding:0 14px;
      border:1px solid var(--border); border-radius:12px;
      background:#fff; color:#0f172a; text-decoration:none; font-weight:800; font-size:15px;
    }
    .topTabs a .icon{ width:1em; height:1em; stroke-width:2.5; vertical-align:-0.15em; }
    .topTabs a[aria-current="page"]{
      background:var(--accent); color:#fff; border-color:var(--accent);
      pointer-events:none;
    }
    .topTabs a:active{ transform:translateY(1px); }
    .card-head{padding:12px;display:grid;gap:10px}
    .title{font-size:20px;font-weight:800}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="month"], input[type="email"], select{
      border:1px solid var(--border);border-radius:12px;padding:0 12px;height:42px;font-size:15px;background:#fff;outline:none;min-width:0;width:100%;
    }
    input:focus, select:focus{box-shadow:var(--focus);border-color:transparent}
    .btn{
      border:1px solid var(--border);background:#fff;border-radius:12px;
      padding:0 12px;height:42px;font-weight:700;cursor:pointer;font-size:15px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn:active{transform:translateY(1px)}
    .icon{ width:1em; height:1em; stroke-width:2.5; vertical-align:-0.15em; }
    .table-wrap{border-radius:12px;border:1px solid var(--border);margin:8px 12px;overflow:hidden}
    table{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);font-size:12.5px;height:32px}
    td,th{border-bottom:1px solid var(--border);padding:6px;text-align:center;font-size:12.5px;white-space:nowrap}
    tbody tr:hover{background:#f7fbff}
    .date-col{width:36px;font-weight:700}
    .name-col{width:50px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time-col{width:60px}
    .note-col{width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sun{color:#ef4444}
    .sat{color:#2563eb}
    .app-hide{display:none}
    .card-foot{display:none}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:12px;z-index:100;background:rgba(15,23,42,.5)}
    .modal{width:min(560px, 94vw);background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(15,23,42,.12);overflow:hidden}
    .modal-hd{padding:14px 18px;border-bottom:1px solid var(--border);font-weight:800;font-size:18px}
    .modal-bd{padding:16px 18px;display:grid;gap:12px}
    .modal-ft{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    .row-inline{display:grid;grid-template-columns:98px 1fr;gap:10px;align-items:center}
    .row-inline .wfit{width:140px}
    .hidden{display:none!important}
    @media (max-width: 480px){
      .modal{width:96vw;border-radius:16px}
      .modal-bd{gap:10px}
      .row-inline{grid-template-columns:1fr;gap:6px}
      .row-inline .wfit{width:100%}
      input[type="text"], input[type="month"], input[type="email"], select, input[type="time"]{
        height:48px;font-size:16px
      }
      .modal-ft{position:sticky;bottom:0;background:#fff}
    }
    #toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#16a34a;color:#fff;padding:10px 14px;border-radius:12px;
      box-shadow:var(--shadow-1);display:none;z-index:250;font-weight:700
    }
    #emailBackdrop.kb-safe{
      align-items:flex-end;
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + 8px);
    }
    #emailBackdrop.kb-safe .modal{
      width:100%;
      max-width:640px;
      border-radius:14px 14px 0 0;
    }
    #toast {
      position:fixed;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      background:#16a34a;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      box-shadow:var(--shadow-1);
      display:none;
      z-index:250;
      font-weight:700;
    }
  </style>
  <!-- ‚ñ∑‚ñ∑‚ñ∑ Ï†ÑÏó≠ Ïä§ÌÉÄÏùº Ï¢ÖÎ£å ‚ñ∑‚ñ∑‚ñ∑ -->

  <!-- ExcelJS / FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- [2/4] Firebase SDK Î∞è ÏùµÎ™Ö Ïù∏Ï¶ù -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    
    // ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï
    const firebaseConfig = {
      apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
      authDomain: "hallymlinen.firebaseapp.com",
      databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
      projectId: "hallymlinen",
      storageBucket: "hallymlinen.appspot.com",
      messagingSenderId: "867775830688",
      appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
      measurementId: "G-T02ZFK18L3"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    signInAnonymously(auth).catch((error) => {
      console.error("Anonymous sign-in failed:", error);
    });

    // [3/4] ÏÑúÎ≤Ñ ÌÜµÏã† Ìï®ÏàòÎ°ú ÍµêÏ≤¥
    const pad2 = n => String(n).padStart(2,'0');
    const ymKey = (y,m)=>`${y}-${pad2(m)}`;
    const nameKey = s => (String(s||'').trim().replace(/[.#$\[\]/]/g,'_') || 'NONAME');

    async function saveDayToFirebase({y,m,day,name,inT,outT,note,leave,ot}){
        const token = localStorage.getItem('adminToken');
        if (!token) { return alert("Ïù∏Ï¶ù ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî."); }

        // üö® Ï§ëÏöî: Ïã§Ï†ú Î∞∞Ìè¨Îêú saveAttendanceData Ìï®Ïàò URLÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî!
        const url = 'https://us-central1-hallymlinen.cloudfunctions.net/saveAttendanceData';
        
        const path = `/attendance/${ymKey(y,m)}/${nameKey(name)}/${pad2(day)}`;
        const payload = { y, m, day, name: String(name||'').trim(), in: String(inT||''), out: String(outT||''), note: String(note||''), leave: String(leave||''), ot: String(ot||'') };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ path, payload })
        });
        if (!response.ok) throw new Error(`Server error: ${response.status}`);
    }

    async function loadMonthFromFirebase(y,m,name){
        const token = localStorage.getItem('adminToken');
        if (!token) {
            alert("Ïù∏Ï¶ù ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
            window.location.href = './index.html';
            return {};
        }

        // üö® Ï§ëÏöî: Ïã§Ï†ú Î∞∞Ìè¨Îêú getAttendanceData Ìï®Ïàò URLÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî!
        const url = new URL('https://us-central1-hallymlinen.cloudfunctions.net/getAttendanceData');
        url.searchParams.append('year', y);
        url.searchParams.append('month', m);
        url.searchParams.append('name', name);

        const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        
        if (!response.ok) {
            if (response.status === 403) {
                localStorage.removeItem('adminToken');
                window.location.href = './index.html';
            }
            throw new Error(`Server error: ${response.status}`);
        }
        return await response.json();
    }

    function applyMonthDataToTable(y,m,data){
      const rows = Array.from(document.querySelectorAll('#tbody tr'));
      rows.forEach((tr, i)=>{
        const day = i+1;
        const rec = data[pad2(day)];
        if(!rec) return;
        const [dateCell, , inCell, outCell, , noteCell] = tr.children;

        if (rec.in)  inCell.textContent  = rec.in;
        if (rec.out) outCell.textContent = rec.out;

        const hlabel = (typeof window.dynamicHolidayLabel === 'function')
          ? window.dynamicHolidayLabel(y,m,day) : '';
        const merged = (typeof window.addLabelOnce === 'function')
          ? window.addLabelOnce(String(rec.note||''), hlabel)
          : (String(rec.note||'') + (hlabel ? ` / ${hlabel}` : ''));
        noteCell.textContent = merged;
      });
    }

    window.saveDayToFirebase = saveDayToFirebase;
    window.loadMonthFromFirebase = loadMonthFromFirebase;
    window.applyMonthDataToTable = applyMonthDataToTable;
  </script>
</head>
<body>
  <div class="wrap">

    <nav class="topTabs" aria-label="ÏÉÅÎã® ÌÉ≠">
      <a href="#" aria-current="page"><i class="icon" data-feather="calendar"></i>Ï∂úÍ∑ºÎ∂Ä</a>
      <a href="./Íµ¨Îß§ÌòÑÌô©.html"><i class="icon" data-feather="bar-chart-2"></i>Íµ¨Îß§Í¥ÄÎ¶¨</a>
    </nav>

    <div class="card">
      <div class="card-head">
        <div class="title">Ï∂úÍ∑ºÎ∂Ä</div>
        <div class="grid-2">
          <input id="nameInput" type="text" placeholder="Ïù¥Î¶Ñ" />
          <input id="monthInput" type="month" />
        </div>
        <div class="grid-btns">
          <button id="genBtn" class="btn primary"><i class="icon" data-feather="download-cloud"></i>Ï∂úÍ∑ºÌëú Î∂àÎü¨Ïò§Í∏∞</button>
          <button id="clearBtn" class="btn"><i class="icon" data-feather="trash-2"></i>Ï¥àÍ∏∞Ìôî</button>
        </div>
        <div class="grid-btns">
          <button id="xlsxBtn" class="btn"><i class="icon" data-feather="file-text"></i>ÏóëÏÖÄÎ°ú ÎÇ¥Î†§Î∞õÍ∏∞</button>
          <button id="emailBtn" class="btn"><i class="icon" data-feather="send"></i>Î©îÏùºÎ°ú Ï†ÑÏÜ°</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="date-col">ÎÇ†Ïßú</th>
              <th class="name-col">Ïù¥Î¶Ñ</th>
              <th class="time-col">Ï∂úÍ∑º</th>
              <th class="time-col">Ìá¥Í∑º</th>
              <th class="app-hide">Î≥∏Ïù∏ÏÑúÎ™Ö</th>
              <th class="note-col">ÎπÑÍ≥†</th>
              <th class="app-hide">Îã¥ÎãπÏûêÌôïÏù∏</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="editBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modal-hd" id="editTitle">Í∑ºÎ¨¥ ÏÉÅÌÉú Ìé∏Ïßë</div>
      <div class="modal-bd">
        <div class="row-inline">
          <label>ÎåÄÏÉÅ ÎÇ†Ïßú</label>
          <input id="editDate" type="text" readonly />
        </div>
        <div class="row-inline">
          <label>Ìú¥Í∞Ä ÏÇ¨Ïö©</label>
          <select id="leaveSel">
            <option value="">ÏÑ†ÌÉù Ïïà Ìï®</option>
            <option value="annual">Ïó∞Ï∞®</option>
            <option value="half">Î∞òÏ∞®</option>
            <option value="family">Ï°∞Í∞Ä</option>
          </select>
        </div>
        <div class="row-inline">
          <label>ÏãúÍ∞Ñ Ï°∞Ï†ï</label>
          <div class="row" style="gap:10px">
            <input id="timeIn"  type="text" inputmode="numeric" pattern="\\d{2}:\\d{2}" placeholder="Ïòà: 06:00" class="wfit" />
            <span>~</span>
            <input id="timeOut" type="text" inputmode="numeric" pattern="\\d{2}:\\d{2}" placeholder="Ïòà: 15:30" class="wfit" />
          </div>
        </div>
        <div class="row-inline">
          <label>Ìú¥Î¨¥</label>
          <div class="row" style="gap:10px">
            <label style="display:flex;align-items:center;gap:8px">
              <input id="dayOffCheck" type="checkbox" />
              <span>Ìú¥Î¨¥Î°ú ÌëúÏãú</span>
            </label>
          </div>
        </div>
        <div class="row-inline">
          <label>ÎπÑÍ≥†</label>
          <input id="editNote" type="text" placeholder="ÏóëÏÖÄ ÎπÑÍ≥†ÎûÄÏóê Îì§Ïñ¥Í∞ëÎãàÎã§" />
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn" id="editCancel"><i class="icon" data-feather="x"></i>Îã´Í∏∞</button>
        <button class="btn primary" id="editApply"><i class="icon" data-feather="check-circle"></i>Ï†ÅÏö©</button>
      </div>
    </div>
  </div>

  <div id="emailBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="emailTitle" style="width:min(420px,92vw)">
      <div class="modal-hd" id="emailTitle">Î©îÏùºÎ°ú Ï†ÑÏÜ°</div>
      <div class="modal-bd">
        <div class="row-inline">
          <label>Î∞õÎäî Î©îÏùº</label>
          <input id="emailTo" type="email" placeholder="example@domain.com" />
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn" id="emailCancel"><i class="icon" data-feather="x"></i>Ï∑®ÏÜå</button>
        <button class="btn primary" id="emailSend"><i class="icon" data-feather="send"></i>Ï†ÑÏÜ°</button>
      </div>
    </div>
  </div>

  <!-- [4/4] Í∏∞Ï°¥ UI Î°úÏßÅ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
  <script>
    const pad2 = n => String(n).padStart(2,'0');
    const DEFAULT_IN  = '06 : 00';
    const DEFAULT_OUT = '15 : 30';
    const qs  = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    const nameInput  = qs('#nameInput');
    const monthInput = qs('#monthInput');
    const genBtn     = qs('#genBtn');
    const clearBtn   = qs('#clearBtn');
    const xlsxBtn    = qs('#xlsxBtn');
    const emailBtn   = qs('#emailBtn');
    const tbody      = qs('#tbody');
    
    const LS_KEY_LAST_NAME = 'att:lastName';
    function setLastNameCache(v){ try{ localStorage.setItem(LS_KEY_LAST_NAME, String(v||'').trim()); }catch(_e){} }
    function getLastNameCache(){ try{ return localStorage.getItem(LS_KEY_LAST_NAME) || ''; }catch(_e){ return ''; } }
    
    nameInput.addEventListener('change', ()=> setLastNameCache(nameInput.value));
    nameInput.addEventListener('blur',   ()=> setLastNameCache(nameInput.value));
    genBtn.addEventListener('click',     ()=> setLastNameCache(nameInput.value));
    
    const LS_KEY_LAST_EMAIL = 'att:lastEmail';
    function setLastEmailCache(v){ try{ localStorage.setItem(LS_KEY_LAST_EMAIL, String(v||'').trim()); }catch(_e){} }
    function getLastEmailCache(){ try{ return localStorage.getItem(LS_KEY_LAST_EMAIL) || ''; }catch(_e){ return ''; } }
    
    const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxLS7c2bcl50k5LMOqC8Axx7PUZN-h5mN-MuNQddNcjc9P2BhWPxmaSPAWWbzhDRK8/exec';
    
    function showBootSpinner(){ const el = document.getElementById('bootSpinner'); if (el) el.style.display = 'flex'; }
    function hideBootSpinner(){ const el = document.getElementById('bootSpinner'); if (el) el.style.display = 'none'; }
    
    fetch(GAS_WEBAPP_URL, { method: 'POST', headers: {'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({ ping: true }) }).catch(()=>{});
    
    const HOLIDAY_MAP = new Map();
    function normalizeHolidayName(s){ if(!s) return ''; s = String(s).replace(/\s+/g, ' ').trim(); s = s.replace(/^Ïâ¨Îäî ÎÇ†\s*/i, ''); s = s.replace(/^\(ÎåÄÏ≤¥\)\s*/i, ''); s = s.replace(/ÎåÄÏ≤¥Í≥µÌú¥Ïùº(?:\s*\(.+?\))?/g, 'ÎåÄÏ≤¥Í≥µÌú¥Ïùº'); return s; }
    function consolidateNames(arr){ const uniq = Array.from(new Set(arr.map(normalizeHolidayName).filter(Boolean))); uniq.sort((a,b)=>b.length-a.length); const kept = []; uniq.forEach(n=>{ if(!kept.some(k=>k.includes(n) && k!==n)) kept.push(n); }); return kept.join(' / '); }
    async function loadHolidays(year){ try{ const url = `${GAS_WEBAPP_URL}?fn=holidays&year=${year}`; const res = await fetch(url, { method:'GET' }); const json = await res.json(); if(json.ok && Array.isArray(json.items)){ HOLIDAY_MAP.clear(); const bucket = new Map(); json.items.forEach(({date,name})=>{ const arr = bucket.get(date) || []; arr.push(name); bucket.set(date, arr); }); bucket.forEach((names, date)=>{ HOLIDAY_MAP.set(date, consolidateNames(names)); }); (function applyAltForLunarHolidays(){ const entries = Array.from(HOLIDAY_MAP.entries()).filter(([_, name]) => /Ï∂îÏÑù|ÏÑ§ÎÇ†/.test(name)); if (!entries.length) return; entries.sort((a,b)=> a[0] < b[0] ? -1 : a[0] > b[0] ? 1 : 0); const clusters = []; let curr = []; const toDate = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }; const isNextDay = (a,b)=> { const da = toDate(a), db = toDate(b); return (db - da) === 24*60*60*1000; }; entries.forEach(([dateStr, name], i)=>{ if (i===0) { curr.push([dateStr, name]); return; } const prev = entries[i-1][0]; if (isNextDay(prev, dateStr)) curr.push([dateStr, name]); else { clusters.push(curr); curr = [[dateStr, name]]; } }); if (curr.length) clusters.push(curr); clusters.forEach(cluster=>{ const hasSunday = cluster.some(([dateStr])=> new Date(dateStr).getDay() === 0); if (hasSunday) { const [lastDate] = cluster[cluster.length - 1]; HOLIDAY_MAP.set(lastDate, 'ÎåÄÏ≤¥Í≥µÌú¥Ïùº'); } }); })(); try{ const [currY, currM] = (monthInput.value||'').split('-').map(Number); if (currY === year) { qsa('#tbody tr').forEach((tr, idx)=>{ const day = idx+1; const [dateCell, , , , , noteCell] = tr.children; const hlabel = dynamicHolidayLabel(currY, currM, day); if (hlabel) { noteCell.textContent = addLabelOnce(noteCell.textContent, hlabel); dateCell.classList.add('sun'); } }); } }catch(_e){} } }catch(e){ console.warn('Í≥µÌú¥Ïùº Î°úÎìú Ïã§Ìå®:', e); } }
    function dynamicHolidayLabel(y, m, d){ const key = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; if(HOLIDAY_MAP.has(key)) return HOLIDAY_MAP.get(key); const md = `${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const fixed = {'01-01':'Ïã†Ï†ï','03-01':'ÏÇºÏùºÏ†à','05-05':'Ïñ¥Î¶∞Ïù¥ÎÇ†','06-06':'ÌòÑÏ∂©Ïùº','08-15':'Í¥ëÎ≥µÏ†à','10-03':'Í∞úÏ≤úÏ†à','10-09':'ÌïúÍ∏ÄÎÇ†','12-25':'ÏÑ±ÌÉÑÏ†à'}; return fixed[md] || ''; }
    
    (function initMonth(){ const d=new Date(); monthInput.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; })();
    
    const addLabelOnce = (note, label) => !label ? (note||'') : !note ? label : (note.includes(label) ? note : `${note} / ${label}`);
    
    function buildTable(ym, name){ tbody.innerHTML=''; if(!ym){ alert('ÏõîÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.'); return; } const [y,m] = ym.split('-').map(Number); const lastDay = new Date(y, m, 0).getDate(); for(let day=1; day<=lastDay; day++){ const dt = new Date(y, m-1, day); const dow = dt.getDay(); const isSun=dow===0, isSat=dow===6; const tr = document.createElement('tr'); const dateCell = document.createElement('td'); dateCell.className = 'date-col ' + (isSun?'sun':isSat?'sat':'' ); dateCell.style.textAlign='center'; dateCell.textContent = day; const nameCell = document.createElement('td'); nameCell.className='name-col'; nameCell.textContent = name || ''; const inCell  = document.createElement('td'); inCell.className='time-col'; const outCell = document.createElement('td'); outCell.className='time-col'; const signCell = document.createElement('td'); signCell.className='app-hide'; const noteCell = document.createElement('td'); noteCell.className='note-col'; const apprCell = document.createElement('td'); apprCell.className='app-hide'; const hlabel = dynamicHolidayLabel(y,m,day); if (isSun) { inCell.textContent  = 'Ìú¥'; outCell.textContent = 'Î¨¥'; } else if (!hlabel) { inCell.textContent  = DEFAULT_IN; outCell.textContent = DEFAULT_OUT; } if (hlabel) { noteCell.textContent = addLabelOnce(noteCell.textContent, hlabel); dateCell.classList.add('sun'); } tr.addEventListener('click', ()=> openEditModal({y,m,day,dow,isSun,isSat}, tr)); tr.append(dateCell, nameCell, inCell, outCell, signCell, noteCell, apprCell); tbody.appendChild(tr); } }
    
    const editBackdrop = qs('#editBackdrop'); const editDate  = qs('#editDate'); const leaveSel  = qs('#leaveSel'); const editNote  = qs('#editNote');
    const timeIn  = qs('#timeIn'); const timeOut = qs('#timeOut');
    function normalizeHHMM(raw){ let s = String(raw||'').trim(); if(!s) return ''; s = s.replace(/[^\d]/g,''); if(s.length===1) s = '0'+s+'00'; else if(s.length===2) s = s + '00'; else if(s.length===3) s = '0' + s; else if(s.length>4) s = s.slice(0,4); const hh = Math.min(parseInt(s.slice(0,2),10)||0, 23); const mm = Math.min(parseInt(s.slice(2,4),10)||0, 59); return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
    const toTimeValue = (s) => { s = String(s||'').trim(); const m = s.match(/(\d{1,2})\s*:\s*(\d{2})/); return m ? `${m[1].padStart(2,'0')}:${m[2]}` : ''; };
    const toCellValue = (s) => { const m = String(s||'').match(/(\d{1,2}):(\d{2})/); return m ? `${m[1].padStart(2,'0')} : ${m[2]}` : ''; };
    function bindTimeAutoFormat(el){ if(!el) return; el.addEventListener('input', ()=>{ const v = el.value.replace(/[^\d]/g,''); if(v.length===0){ el.value=''; return; } if(v.length<=2){ el.value = v; return; } el.value = v.slice(0,2) + ':' + v.slice(2,4); }); el.addEventListener('blur', ()=>{ el.value = normalizeHHMM(el.value); }); }
    bindTimeAutoFormat(timeIn); bindTimeAutoFormat(timeOut);
    
    const chipsWrap = qs('#timeChips'); function addMinutesToHHMM(hhmm, addMin){ const m = String(hhmm||'').match(/(\d{1,2}):(\d{2})/); if(!m) return ''; let h = parseInt(m[1],10), mm = parseInt(m[2],10); let total = h*60 + mm + (addMin|0); if (total < 0) total = 0; h = Math.floor(total/60); mm = total%60; return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
    chipsWrap?.addEventListener('click', (e)=>{ const btn = e.target.closest('.chip'); if(!btn) return; if (typeof dayOffCheck !== 'undefined' && dayOffCheck){ dayOffCheck.checked = false; } if (timeIn)  timeIn.disabled = false; if (timeOut) timeOut.disabled = false; if(btn.dataset.set){ const [which, val] = btn.dataset.set.split(':'); if(which==='in' && timeIn) timeIn.value = val; if(which==='out'&& timeOut) timeOut.value = val; }else if(btn.dataset.inc){ const [which, mins] = btn.dataset.inc.split(':'); if(which==='out' && timeOut){ const cur = timeOut.value || '15:30'; timeOut.value = addMinutesToHHMM(cur, parseInt(mins,10)); } } });
    function showToast(msg='Ï†ÄÏû• ÏôÑÎ£å'){ const t = qs('#toast'); if(!t) return; t.textContent = msg; t.style.display = 'block'; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=> t.style.display='none', 1500); }
    
    const dayOffCheck = qs('#dayOffCheck'); function isCellHolidayMark(inVal, outVal){ return inVal === 'Ìú¥' && outVal === 'Î¨¥'; }
    dayOffCheck?.addEventListener('change', ()=>{ const disabled = dayOffCheck.checked; if (timeIn)  timeIn.disabled  = disabled; if (timeOut) timeOut.disabled = disabled; });
    
    let currentRow=null, currentMeta=null;
    function openEditModal(meta, tr){ currentRow = tr; currentMeta=meta; const [ , nameCell, inCell, outCell, , noteCell] = tr.children; editDate.value = `${meta.y}-${pad2(meta.m)}-${pad2(meta.day)}`; editNote.value = noteCell.textContent || ''; const inVal  = (inCell.textContent||'').trim(); const outVal = (outCell.textContent||'').trim(); leaveSel.value = (inVal==='Ïó∞'&&outVal==='Ï∞®') ? 'annual' : (inVal==='Î∞ò'&&outVal==='Ï∞®') ? 'half'   : (inVal==='Ï°∞'&&outVal==='Í∞Ä') ? 'family' : ''; timeIn.value  = toTimeValue(inVal); timeOut.value = toTimeValue(outVal); if (dayOffCheck){ dayOffCheck.checked = isCellHolidayMark(inVal, outVal); const disabled = dayOffCheck.checked; if (timeIn)  timeIn.disabled  = disabled; if (timeOut) timeOut.disabled = disabled; } editBackdrop.style.display='flex'; }
    function closeEditModal(){ editBackdrop.style.display='none'; }
    qs('#editCancel').addEventListener('click', closeEditModal);
    qs('#editApply').addEventListener('click', ()=>{ if(!currentRow) return; const [dateCell, nameCell, inCell, outCell, , noteCell] = currentRow.children; const isSunday = /sun/.test(dateCell.className); const [yy,mm2,dd] = editDate.value.split('-').map(Number); const isHoliday = !!dynamicHolidayLabel(yy,mm2,dd); if(leaveSel.value==='annual'){ inCell.textContent='Ïó∞'; outCell.textContent='Ï∞®'; } else if(leaveSel.value==='half'){ inCell.textContent='Î∞ò'; outCell.textContent='Ï∞®'; } else if(leaveSel.value==='family'){ inCell.textContent='Ï°∞'; outCell.textContent='Í∞Ä'; } else{ if (dayOffCheck && dayOffCheck.checked){ inCell.textContent  = 'Ìú¥'; outCell.textContent = 'Î¨¥'; }else{ const tIn  = toCellValue(timeIn?.value); const tOut = toCellValue(timeOut?.value); if(tIn || tOut){ inCell.textContent  = tIn || ''; outCell.textContent = tOut || ''; }else{ if(isHoliday || isSunday){ inCell.textContent=''; outCell.textContent=''; }else{ inCell.textContent=DEFAULT_IN; outCell.textContent=DEFAULT_OUT; } } } } const [y,m,day] = editDate.value.split('-').map(Number); const hlabel = dynamicHolidayLabel(y,m,day); noteCell.textContent = addLabelOnce(editNote.value.trim(), hlabel); (async ()=>{ const [y,m,day] = editDate.value.split('-').map(Number); const nm = (nameInput.value||'').trim(); const [ , , inCell2, outCell2, , noteCell2] = currentRow.children; await window.saveDayToFirebase({ y, m, day, name: nm, inT: (inCell2.textContent||'').trim(), outT: (outCell2.textContent||'').trim(), note: (noteCell2.textContent||'').trim(), leave: (leaveSel.value||'') }); showToast('Ï†ÄÏû• ÏôÑÎ£å'); })().catch(console.warn); closeEditModal(); });
    
    async function makeWorkbook(){ const ym = monthInput.value; if(!ym){ alert('ÏõîÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.'); throw new Error('no-month'); } const [y,m] = ym.split('-').map(Number); const nm = (nameInput.value||'').trim(); const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('Ï∂úÍ∑ºÌëú', { pageSetup:{ paperSize:9, orientation:'portrait', margins:{left:0,right:0,top:0,bottom:0.1,header:0,footer:0}, horizontalCentered:true, verticalCentered:true, fitToPage:true, fitToWidth:1, fitToHeight:0 } }); const baseFont = {name:'ÎßëÏùÄ Í≥†Îîï', size:12}; ws.getColumn(1).width = 6.25; ws.getColumn(2).width = 9.75; ws.getColumn(3).width = 12.88; ws.getColumn(4).width = 12.88; ws.getColumn(5).width = 12.88; ws.getColumn(6).width = 9.75; ws.getColumn(7).width = 5.35; ws.getColumn(8).width = 11; ws.getRow(1).height = 14.25; ws.getRow(2).height = 36.75; ws.getRow(3).height = 29.25; ws.getRow(4).height = 25; ws.mergeCells('G1:G2'); const g1 = ws.getCell('G1'); const g2 = ws.getCell('G2'); g1.value = 'Í≤∞\nÏû¨\nÎûÄ'; g1.font  = {name:'ÎßëÏùÄ Í≥†Îîï', size:11, bold:true}; g1.alignment = { vertical:'middle', horizontal:'center', wrapText:true }; g2.alignment = g1.alignment; ['G1','G2'].forEach(a=>{ ws.getCell(a).border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }); const h1 = ws.getCell('H1'); h1.value='ÌåÄÏû•'; h1.font={name:'ÎßëÏùÄ Í≥†Îîï',size:11}; h1.alignment={vertical:'middle',horizontal:'center'}; const h2 = ws.getCell('H2'); h2.value=''; ['H1','H2'].forEach(a=>{ ws.getCell(a).border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }); ws.mergeCells('A3:H3'); const t = ws.getCell('A3'); t.value = `${y}ÎÖÑ ${m}Ïõî Î¶∞ÎÑ®Ïã§(ÏßÅÏõê) Ï∂úÍ∑ºÌëú`; t.font  = {name:'ÎßëÏùÄ Í≥†Îîï', size:18, bold:true}; t.alignment = {vertical:'middle', horizontal:'center'}; ws.getCell('A4').value='ÎÇ†Ïßú'; ws.getCell('B4').value='Ïù¥Î¶Ñ'; ws.getCell('C4').value='Ï∂úÍ∑ºÏãúÍ∞Å'; ws.getCell('D4').value='Ìá¥Í∑ºÏãúÍ∞Å'; ws.getCell('E4').value='Î≥∏Ïù∏ÏÑúÎ™Ö'; ws.getCell('F4').value='ÎπÑÍ≥†'; ws.mergeCells('F4:G4'); ws.getCell('H4').value='Îã¥ÎãπÏûêÌôïÏù∏'; ['A4','B4','C4','D4','E4','F4','H4'].forEach(a=>{ const c=ws.getCell(a); c.font={...baseFont, bold:true}; c.alignment={vertical:'middle',horizontal:'center'}; c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF1F5F9'}}; c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }); const lastDay = new Date(y, m, 0).getDate(); const startRow = 5; for(let d=1; d<=lastDay; d++){ const rIdx = startRow + d - 1; const r = ws.getRow(rIdx); r.height = 22; const dateObj = new Date(y, m-1, d); const dow = dateObj.getDay(); const isSun=dow===0, isSat=dow===6; const tr = qsa('#tbody tr')[d-1]; let [ , , inT, outT, , noteText] = tr ? Array.from(tr.children).map(td=> (td.textContent||'').trim()) : [null,null,'','','','']; if(isSun){ inT='Ìú¥'; outT='Î¨¥'; } else{ if(!inT)  inT=DEFAULT_IN; if(!outT) outT=DEFAULT_OUT; } const hlabel = dynamicHolidayLabel(y,m,d); noteText = addLabelOnce(noteText, hlabel); ws.getCell(rIdx,1).value=d; ws.getCell(rIdx,2).value=(nameInput.value||'').trim(); ws.getCell(rIdx,3).value=inT; ws.getCell(rIdx,4).value=outT; ws.getCell(rIdx,5).value=''; ws.getCell(rIdx,6).value=noteText||''; ws.mergeCells(`F${rIdx}:G${rIdx}`); ws.getCell(rIdx,8).value=''; for(let c=1;c<=8;c++){ if(c===7) continue; const cell=ws.getCell(rIdx,c); cell.font=baseFont; cell.alignment={vertical:'middle',horizontal:(c===6?'left':'center')}; cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; } ws.getCell(rIdx,6).alignment = { vertical:'middle', horizontal:'left', wrapText:false }; if(isSat){ ws.getCell(rIdx,1).font={...baseFont,color:{argb:'FF2563EB'}}; } if(isSun || hlabel){ ws.getCell(rIdx,1).font={...baseFont,color:{argb:'FFEF4444'}}; } } ws.eachRow(row=> row.eachCell(cell=>{ cell.font = cell.font || baseFont; })); const fileName = `${y}-${pad2(m)}-Ï∂úÍ∑ºÎ∂Ä.xlsx`; return {wb, fileName}; }
    
    xlsxBtn.addEventListener('click', async ()=>{ try{ const {wb,fileName} = await makeWorkbook(); const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName); }catch(e){ if(e.message!=='no-month') console.error(e); } });
    
    const emailBackdrop = qs('#emailBackdrop'); const emailTo = qs('#emailTo'); const emailSend = qs('#emailSend'); const emailCancel = qs('#emailCancel');
    function closeEmailModal(){ emailBackdrop.style.display = 'none'; emailBackdrop.classList.remove('kb-safe'); emailBackdrop.style.paddingBottom = '0px'; }
    emailBtn.addEventListener('click', ()=>{ const cachedEmail = getLastEmailCache(); if (cachedEmail && !String(emailTo.value||'').trim()){ emailTo.value = cachedEmail; } emailBackdrop.style.display='flex'; setTimeout(()=>{ emailTo.focus(); emailBackdrop.classList.add('kb-safe'); emailTo.scrollIntoView({block:'center'}); }, 0); });
    emailCancel.addEventListener('click', closeEmailModal);
    emailTo.addEventListener('focus', ()=>{ emailBackdrop.classList.add('kb-safe'); });
    emailTo.addEventListener('blur', ()=>{ if (emailBackdrop.style.display === 'flex') return; emailBackdrop.classList.remove('kb-safe'); });
    (function attachViewportHook(){ const vv = window.visualViewport; if(!vv) return; const onResize = ()=>{ const gap = Math.max(0, window.innerHeight - vv.height); if (gap > 80) emailBackdrop.classList.add('kb-safe'); emailBackdrop.style.paddingBottom = (gap>0 ? (gap + 16) : 0) + 'px'; }; vv.addEventListener('resize', onResize); vv.addEventListener('scroll', onResize); })();
    function blobToDataUrl(blob){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(blob); }); }
    emailSend.addEventListener('click', async ()=>{ const to = (emailTo.value||'').trim(); if(!to){ alert('Î∞õÎäî Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; } const spinner = qs('#loadingSpinner'); spinner.style.display = 'flex'; try{ const {wb,fileName} = await makeWorkbook(); const buf = await wb.xlsx.writeBuffer(); const blob = new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); const dataUrl = await blobToDataUrl(blob); const monthTxt = Number(monthInput.value.split('-')[1]); const subject = `ÌïúÎ¶ºÎ≥ëÏõê ${monthTxt}Ïõî Ï∂úÍ∑ºÎ∂Ä Ï≤®Î∂ÄÌï©ÎãàÎã§.`; const res = await fetch(GAS_WEBAPP_URL, { method: 'POST', headers: {'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({ to: to, subject: subject, message: 'Ï∂úÍ∑ºÎ∂Ä ÌååÏùºÏùÑ Ï≤®Î∂ÄÌï©ÎãàÎã§.', filename: fileName, attachment: dataUrl }) }); const json = await res.json(); if(!res.ok || !json.ok) throw new Error(json.error || `HTTP ${res.status}`); showToast('Î©îÏùº Ï†ÑÏÜ° ÏÑ±Í≥µ ‚úÖ'); closeEmailModal(); }catch(err){ console.error(err); alert('Î©îÏùº Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî. ÏóëÏÖÄ Ï†ÄÏû• ÌõÑ Î©îÏùº Ïï±ÏóêÏÑú Ï≤®Î∂ÄÎ°ú Ï†ÑÏÜ°Ìï¥ Ï£ºÏÑ∏Ïöî.'); }finally{ spinner.style.display = 'none'; } });
    
    genBtn.addEventListener('click', async ()=>{ showBootSpinner(); try{ const [y,mm] = (monthInput.value || '').split('-').map(Number); if (y) await loadHolidays(y); const cached = getLastNameCache(); if (cached && !String(nameInput.value||'').trim()){ nameInput.value = cached; } buildTable(monthInput.value, nameInput.value.trim()); const nm = (nameInput.value||'').trim(); if (y && mm && nm){ const data = await window.loadMonthFromFirebase(y, mm, nm); window.applyMonthDataToTable(y, mm, data); } } finally { hideBootSpinner(); } });
    clearBtn.addEventListener('click', ()=> tbody.innerHTML='');
    
    (async ()=>{ showBootSpinner(); try{ const cached0 = getLastNameCache(); if (cached0) nameInput.value = cached0; buildTable(monthInput.value, nameInput.value.trim()); const [y,mm] = (monthInput.value || '').split('-').map(Number); if (y) { await loadHolidays(y); qsa('#tbody tr').forEach((tr, idx)=>{ const day = idx+1; const [dateCell, , , , , noteCell] = tr.children; const hlabel = dynamicHolidayLabel(y,mm,day); if(hlabel){ noteCell.textContent = addLabelOnce(noteCell.textContent, hlabel); dateCell.classList.add('sun'); } }); } const nm0 = (nameInput.value||'').trim(); if (y && mm && nm0){ const data0 = await window.loadMonthFromFirebase(y, mm, nm0); window.applyMonthDataToTable(y, mm, data0); } } finally { hideBootSpinner(); } })();
  </script>

  <div id="bootSpinner" class="modal-backdrop" style="z-index:190; background:rgba(255,255,255,0.7); display:none">
    <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
      <div class="spinner" style="width:44px;height:44px;border:5px solid #ccc;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite"></div>
      <div style="font-weight:600;color:#2563eb">Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§ÎäîÏ§ë...</div>
    </div>
  </div>
  
  <div id="loadingSpinner" class="modal-backdrop" style="z-index:200; background:rgba(255,255,255,0.7)">
    <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
      <div class="spinner" style="width:48px;height:48px;border:5px solid #ccc;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite"></div>
      <div style="font-weight:600;color:#2563eb">Î©îÏùº Ï†ÑÏÜ°Ï§ë...</div>
    </div>
  </div>
  <style>
    @keyframes spin { from { transform:rotate(0deg);} to { transform:rotate(360deg);} }
  </style>
  
  <div id="toast" role="status" aria-live="polite"></div>
  
  <script>
    (function() {
      if (window.feather && typeof feather.replace === 'function') {
        feather.replace({ width:'1em', height:'1em' });
      }
    })();
  </script>
</body>
</html>

